
 <!DOCTYPE HTML>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <title>k8s | Stan Zhou&#39;s Hexo Technical Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Stan Zhou">
    

    
    <meta name="description" content="K8SBig example is google orchestration (computing)automcatic management of them manifests system robust  common question why use k8s instead of docker swarm number 1 ad: docker swarm is built inK8S: f">
<meta name="keywords" content="kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s">
<meta property="og:url" content="http://223.95.78.227/2019/06/04/k8s/index.html">
<meta property="og:site_name" content="Stan Zhou&#39;s Hexo Technical Blog">
<meta property="og:description" content="K8SBig example is google orchestration (computing)automcatic management of them manifests system robust  common question why use k8s instead of docker swarm number 1 ad: docker swarm is built inK8S: f">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://i.imgur.com/Vv0KFxA.png">
<meta property="og:image" content="https://i.imgur.com/nEb2kOH.png">
<meta property="og:image" content="https://i.imgur.com/iUSOtXN.png">
<meta property="og:image" content="https://i.imgur.com/G9GkqlS.png">
<meta property="og:image" content="https://i.imgur.com/9FRKlUT.png">
<meta property="og:image" content="https://i.imgur.com/9QF8vkE.png">
<meta property="og:image" content="https://i.imgur.com/fkwUIA0.png">
<meta property="og:image" content="https://i.imgur.com/fkwUIA0.png">
<meta property="og:image" content="https://i.imgur.com/QhM7LEN.png">
<meta property="og:image" content="https://i.imgur.com/MrwaPyf.png">
<meta property="og:image" content="https://i.imgur.com/3tgbP7M.png">
<meta property="og:image" content="https://i.imgur.com/dadMM2m.jpg">
<meta property="og:image" content="https://i.imgur.com/oOLbvYT.jpg">
<meta property="og:image" content="https://i.imgur.com/zT2lk5f.jpg">
<meta property="og:image" content="https://i.imgur.com/FvK1lg2.png">
<meta property="og:image" content="https://i.imgur.com/1pQD2XE.png">
<meta property="og:image" content="https://i.imgur.com/KD5pigA.png">
<meta property="og:image" content="https://i.imgur.com/yZoC4kE.png">
<meta property="og:image" content="https://i.imgur.com/91K0spE.png">
<meta property="og:image" content="https://i.imgur.com/YRocsbG.png">
<meta property="og:image" content="https://i.imgur.com/VZihLCY.png">
<meta property="og:updated_time" content="2019-07-12T01:12:21.875Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="k8s">
<meta name="twitter:description" content="K8SBig example is google orchestration (computing)automcatic management of them manifests system robust  common question why use k8s instead of docker swarm number 1 ad: docker swarm is built inK8S: f">
<meta name="twitter:image" content="https://i.imgur.com/Vv0KFxA.png">
<meta name="twitter:creator" content="@stanosaka">

    
    <link rel="alternative" href="/atom.xml" title="Stan Zhou&#39;s Hexo Technical Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/toad.ico">
    
    
    <link rel="apple-touch-icon" href="/img/toadman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/toadman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/toadman.png" alt="Stan Zhou&#39;s Hexo Technical Blog" title="Stan Zhou&#39;s Hexo Technical Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Stan Zhou&#39;s Hexo Technical Blog">Stan Zhou&#39;s Hexo Technical Blog</a></h1>
				<h2 class="blog-motto">Innovation Evangelist</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:223.95.78.227">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/06/04/k8s/" title="k8s" itemprop="url">k8s</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stan Zhou" target="_blank" itemprop="author">Stan Zhou</a>
		
  <p class="article-time">
    <time datetime="2019-06-04T01:37:00.000Z" itemprop="datePublished"> Published 2019-06-04</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#K8S"><span class="toc-number">1.</span> <span class="toc-text">K8S</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Installing-Minikube"><span class="toc-number">2.</span> <span class="toc-text">Installing Minikube</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker-Overview"><span class="toc-number">3.</span> <span class="toc-text">Docker Overview</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pods"><span class="toc-number">4.</span> <span class="toc-text">Pods</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#writing-a-Pod"><span class="toc-number">4.1.</span> <span class="toc-text">writing a Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Services"><span class="toc-number">4.2.</span> <span class="toc-text">Services</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NodePort-and-ClusterIP"><span class="toc-number">4.3.</span> <span class="toc-text">NodePort and ClusterIP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod-selection-with-Labels"><span class="toc-number">4.4.</span> <span class="toc-text">Pod selection with Labels</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#REPLICASETS"><span class="toc-number">5.</span> <span class="toc-text">REPLICASETS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ReplicaSets"><span class="toc-number">5.1.</span> <span class="toc-text">ReplicaSets</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Writing-a-ReplicaSet"><span class="toc-number">5.2.</span> <span class="toc-text">Writing a ReplicaSet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Applying-a-ReplicaSet"><span class="toc-number">5.2.1.</span> <span class="toc-text">Applying a ReplicaSet</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Deployments"><span class="toc-number">6.</span> <span class="toc-text">Deployments</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Managing-Rollouts"><span class="toc-number">6.1.</span> <span class="toc-text">Managing Rollouts</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Networking-and-service-discovery"><span class="toc-number">7.</span> <span class="toc-text">Networking and service discovery</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Networking-Overview"><span class="toc-number">7.1.</span> <span class="toc-text">Networking Overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Namespace-kube-system"><span class="toc-number">7.2.</span> <span class="toc-text">Namespace-kube-system</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Accessing-MySQL-from-a-Pod"><span class="toc-number">7.3.</span> <span class="toc-text">Accessing MySQL from a Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-Discovery"><span class="toc-number">7.4.</span> <span class="toc-text">Service Discovery</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fully-Qualified-Domain-Names-FQDN"><span class="toc-number">7.5.</span> <span class="toc-text">Fully Qualified Domain Names (FQDN)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#An-introduction-to-Microservices"><span class="toc-number">7.6.</span> <span class="toc-text">An introduction to Microservices</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fleetman-Microservices-setting-the-scene"><span class="toc-number">7.7.</span> <span class="toc-text">Fleetman Microservices- setting the scene</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deploying-the-Queue"><span class="toc-number">7.8.</span> <span class="toc-text">Deploying the Queue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deploying-the-Position-Simulator"><span class="toc-number">7.9.</span> <span class="toc-text">Deploying the Position Simulator</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#inspecting-Pod-Logs"><span class="toc-number">7.9.1.</span> <span class="toc-text">inspecting Pod Logs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deploying-the-Position-Tracker"><span class="toc-number">7.10.</span> <span class="toc-text">Deploying the Position Tracker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deploying-the-API-Gateway"><span class="toc-number">7.11.</span> <span class="toc-text">Deploying the API Gateway</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deploying-the-Webapp"><span class="toc-number">7.12.</span> <span class="toc-text">Deploying the Webapp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Persistence"><span class="toc-number">8.</span> <span class="toc-text">Persistence</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#New-Release"><span class="toc-number">8.1.</span> <span class="toc-text">New Release!!</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Upgrading-to-a-Mongo-Pod"><span class="toc-number">8.2.</span> <span class="toc-text">Upgrading to a Mongo Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Volume-Mounts"><span class="toc-number">8.3.</span> <span class="toc-text">Volume Mounts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PersistentVolumeClaims"><span class="toc-number">8.4.</span> <span class="toc-text">PersistentVolumeClaims</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StorageClasses-and-Binding"><span class="toc-number">8.5.</span> <span class="toc-text">StorageClasses and Binding</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DEPLOYING-TO-THE-AWS-CLOUD"><span class="toc-number">9.</span> <span class="toc-text">DEPLOYING TO THE AWS CLOUD</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Getting-started-with-AWS"><span class="toc-number">9.1.</span> <span class="toc-text">Getting started with AWS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Introducing-Kops"><span class="toc-number">9.2.</span> <span class="toc-text">Introducing Kops</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Installing-the-Kops-Environment"><span class="toc-number">9.3.</span> <span class="toc-text">Installing the Kops Environment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configuring-your-first-cluster"><span class="toc-number">9.4.</span> <span class="toc-text">Configuring your first cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Running-the-Cluster"><span class="toc-number">9.5.</span> <span class="toc-text">Running the Cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Provisioning-SSD-drives-with-a-StorageClass"><span class="toc-number">9.6.</span> <span class="toc-text">Provisioning SSD drives with a StorageClass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deploying-the-Fleetman-Workload"><span class="toc-number">9.7.</span> <span class="toc-text">Deploying the Fleetman Workload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Setting-up-a-real-Domain-Name"><span class="toc-number">9.8.</span> <span class="toc-text">Setting up a real Domain Name</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Surviving-Node-Failure"><span class="toc-number">9.9.</span> <span class="toc-text">Surviving Node Failure</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Requirement"><span class="toc-number">9.9.1.</span> <span class="toc-text">Requirement</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Replicating-Pods"><span class="toc-number">9.10.</span> <span class="toc-text">Replicating Pods</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deleting-the-Cluster"><span class="toc-number">9.11.</span> <span class="toc-text">Deleting the Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Restarting-the-Cluster"><span class="toc-number">9.11.1.</span> <span class="toc-text">Restarting the Cluster</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Logging-a-Cluster"><span class="toc-number">10.</span> <span class="toc-text">Logging a Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introducing-the-ELK-ElasticStack"><span class="toc-number">10.1.</span> <span class="toc-text">Introducing the ELK/ElasticStack</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MONITORING-WITH-PROMETHEUS-AND-GRAFANA"><span class="toc-number">11.</span> <span class="toc-text">MONITORING WITH PROMETHEUS AND GRAFANA</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Monitoring-a-Cluster"><span class="toc-number">11.1.</span> <span class="toc-text">Monitoring a Cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Helm-Package-Manager"><span class="toc-number">11.2.</span> <span class="toc-text">Helm Package Manager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Installing-Prometheus-Operator"><span class="toc-number">11.3.</span> <span class="toc-text">Installing Prometheus Operator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Working-with-Grafana"><span class="toc-number">11.4.</span> <span class="toc-text">Working with Grafana</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-Alert-Manager"><span class="toc-number">12.</span> <span class="toc-text">The Alert Manager</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Alerting"><span class="toc-number">12.1.</span> <span class="toc-text">Alerting</span></a></li></ol></li></ol>
		
		</div>
		
		<h1 id="K8S"><a href="#K8S" class="headerlink" title="K8S"></a>K8S</h1><p>Big example is google</p>
<p>orchestration (computing)<br>automcatic management of them</p>
<p>manifests system robust </p>
<p>common question why use k8s instead of docker swarm</p>
<p>number 1 ad: docker swarm is built in<br>K8S: far richer, deploy do different cloud platforms<br>K8S is just far more popular<br>is a orchestration of choice.<br>K8S is the most in demand container orchestration system out there.</p>
<p>This course is a very practical course. It’s a use-case driven course </p>
<p>A Java-based with angular on the front-end.</p>
<h1 id="Installing-Minikube"><a href="#Installing-Minikube" class="headerlink" title="Installing Minikube"></a>Installing Minikube</h1><p>cut-down version-minikube<br><a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">https://kubernetes.io/docs/tasks/tools/install-minikube/</a></p>
<p>You might have an incompatibility between your distribution and the one that Minikube is expecting.<br>two command line tools: kubectl is the controller pogramme for k8s. and Minikube</p>
<p>Enable the Hyper-V role throught settings<br>when enable don’t use oracle virtual box</p>
<p>goo.gl/4yEFbF    for win 10 Professional</p>
<p>minikube start hangs forever on mac #2765</p>
<p>If you’re completely stuck then do ask me</p>
<h1 id="Docker-Overview"><a href="#Docker-Overview" class="headerlink" title="Docker Overview"></a>Docker Overview</h1><p>Difference between Docker Images and Container:<br>A container is an instance of docker images.<br>Docker container is the run time instance of images.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker image pull richardchesterwood/k8s-fleetman-webapp-angular:release0-5</span><br><span class="line">docker image ls</span><br><span class="line">docker container run -p 8080:80 -d richardchesterwood/k8s-fleetman-webapp-angular:release0-5</span><br><span class="line">docker container ls</span><br><span class="line">minikube ip</span><br><span class="line">docker container stop 2c5</span><br><span class="line">docker container rm 2c5</span><br></pre></td></tr></table></figure></p>
<h1 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h1><p>A pod is a group of one or more containers, with shared storage/network, and a specification for how to run the containers.</p>
<p>basic concept is Pod. A pod and a container are in a one to one relationship.</p>
<h2 id="writing-a-Pod"><a href="#writing-a-Pod" class="headerlink" title="writing a Pod"></a>writing a Pod</h2><p><code>kubectl get all</code> show everything we have defined in our Kubernetes cluster.</p>
<p><code>kubectl apply -f first-pod.yaml</code></p>
<p><code>kubectl describe pod webapp</code></p>
<p><code>kubectl exec webapp ls</code></p>
<p><code>kubectl -it exec webapp sh</code> it means get in interactively with teletype emulation. interactive</p>
<h2 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h2><p>Pods are not visible outside the cluster<br>Pods are designed to be very throw away things. Pods have short lifetimes. Pods regularly die.</p>
<p>Service has stable port, with a service we can connect to kubernetes cluster.</p>
<p>key vaule pairs app with some value.</p>
<p><img src="https://i.imgur.com/Vv0KFxA.png" alt="Services"></p>
<h2 id="NodePort-and-ClusterIP"><a href="#NodePort-and-ClusterIP" class="headerlink" title="NodePort and ClusterIP"></a>NodePort and ClusterIP</h2><p>ClusterIP</p>
<p>NodePort</p>
<h2 id="Pod-selection-with-Labels"><a href="#Pod-selection-with-Labels" class="headerlink" title="Pod selection with Labels"></a>Pod selection with Labels</h2><p><img src="https://i.imgur.com/nEb2kOH.png" alt="Pod secltion with Labels"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat first-pod.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp</span><br><span class="line">  labels:</span><br><span class="line">    app: webapp</span><br><span class="line">    release: &quot;0&quot;</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: webapp</span><br><span class="line">    image: richardchesterwood/k8s-fleetman-webapp-angular:release0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp-release-0-5</span><br><span class="line">  labels:</span><br><span class="line">    app: webapp</span><br><span class="line">    release: &quot;0-5&quot;</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: webapp</span><br><span class="line">    image: richardchesterwood/k8s-fleetman-webapp-angular:release0-5</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat webapp-service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-webapp</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: webapp</span><br><span class="line">   release: &quot;0-5&quot;</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 80</span><br><span class="line">     nodePort: 30080</span><br><span class="line"></span><br><span class="line"> type: NodePort</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f webapp-service.yaml</span><br><span class="line"></span><br><span class="line">kubectl describe svc fleetman-webapp</span><br><span class="line">Name:                     fleetman-webapp</span><br><span class="line">Namespace:                default</span><br><span class="line">Labels:                   &lt;none&gt;</span><br><span class="line">Annotations:              kubectl.kubernetes.io/last-applied-configuration=&#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Service&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;fleetman-webapp&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;ports&quot;:[&#123;&quot;name&quot;:&quot;http&quot;,&quot;nodeP...</span><br><span class="line">Selector:                 app=webapp,release=0</span><br><span class="line">Type:                     NodePort</span><br><span class="line">IP:                       10.108.217.186</span><br><span class="line">Port:                     http  80/TCP</span><br><span class="line">TargetPort:               80/TCP</span><br><span class="line">NodePort:                 http  30080/TCP</span><br><span class="line">Endpoints:                172.17.0.5:80</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br><span class="line"></span><br><span class="line">kubectl get po</span><br><span class="line">NAME                 READY     STATUS    RESTARTS   AGE</span><br><span class="line">webapp               1/1       Running   2          2h</span><br><span class="line">webapp-release-0-5   1/1       Running   0          8m</span><br><span class="line"></span><br><span class="line">kubectl get po --show-labels</span><br><span class="line">NAME                 READY     STATUS    RESTARTS   AGE       LABELS</span><br><span class="line">webapp               1/1       Running   2          2h        app=webapp,release=0</span><br><span class="line">webapp-release-0-5   1/1       Running   0          8m        app=webapp,release=0-5</span><br><span class="line"></span><br><span class="line">kubectl get po --show-labels -l release=0</span><br><span class="line">NAME      READY     STATUS    RESTARTS   AGE       LABELS</span><br><span class="line">webapp    1/1       Running   2          2h        app=webapp,release=0</span><br><span class="line"></span><br><span class="line">kubectl get po --show-labels -l release=1</span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure>
<h1 id="REPLICASETS"><a href="#REPLICASETS" class="headerlink" title="REPLICASETS"></a>REPLICASETS</h1><h2 id="ReplicaSets"><a href="#ReplicaSets" class="headerlink" title="ReplicaSets"></a>ReplicaSets</h2><p><img src="https://i.imgur.com/iUSOtXN.png" alt="ReplicaSets"><br>When Pod die, it will never come back.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all</span><br><span class="line"></span><br><span class="line">kubectl describe svc fleetman-webapp</span><br><span class="line"></span><br><span class="line">kubectl delete po webapp-release-0-5</span><br></pre></td></tr></table></figure>
<p>ReplicaSets specify how many instances of this pod do we want k8s running on time</p>
<h2 id="Writing-a-ReplicaSet"><a href="#Writing-a-ReplicaSet" class="headerlink" title="Writing a ReplicaSet"></a>Writing a ReplicaSet</h2><p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/#replicaset-v1-apps">ReplicaSet v1 apps</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat pods.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: ReplicaSet</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: webapp</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: webapp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-webapp-angular:release0-5</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: queue</span><br><span class="line">  labels:</span><br><span class="line">    app: queue</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: queue</span><br><span class="line">    image: richardchesterwood/k8s-fleetman-queue:release1</span><br></pre></td></tr></table></figure></p>
<h3 id="Applying-a-ReplicaSet"><a href="#Applying-a-ReplicaSet" class="headerlink" title="Applying a ReplicaSet"></a>Applying a ReplicaSet</h3><p>Delete all the Pods:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete po --all</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pods.yaml</span><br><span class="line">replicaset.apps &quot;webapp&quot; created</span><br><span class="line">pod &quot;queue&quot; created</span><br><span class="line"></span><br><span class="line">kubectl get all</span><br><span class="line">NAME               READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/queue          1/1       Running   0          58s</span><br><span class="line">pod/webapp-hzpcp   1/1       Running   0          58s</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.106.99.143    &lt;none&gt;        8161:30010/TCP   3h</span><br><span class="line">service/fleetman-webapp   NodePort    10.108.217.186   &lt;none&gt;        80:30080/TCP     23h</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          1d</span><br><span class="line"></span><br><span class="line">NAME                     DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/webapp   1         1         1         59s</span><br></pre></td></tr></table></figure>
<p>The difference between current and ready is, current is the number of containers that are running, and ready is the number of containers that are responding to requests.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe rs webapp</span><br><span class="line">Name:         webapp</span><br><span class="line">Namespace:    default</span><br><span class="line">Selector:     app=webapp</span><br><span class="line">Labels:       app=webapp</span><br><span class="line">Annotations:  kubectl.kubernetes.io/last-applied-configuration=&#123;&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;ReplicaSet&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;webapp&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;replicas&quot;:1,&quot;selector&quot;:&#123;&quot;match...</span><br><span class="line">Replicas:     1 current / 1 desired</span><br><span class="line">Pods Status:  1 Running / 0 Waiting / 0 Succeeded / 0 Failed</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=webapp</span><br><span class="line">  Containers:</span><br><span class="line">   webapp:</span><br><span class="line">    Image:        richardchesterwood/k8s-fleetman-webapp-angular:release0-5</span><br><span class="line">    Port:         &lt;none&gt;</span><br><span class="line">    Host Port:    &lt;none&gt;</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason            Age   From                   Message</span><br><span class="line">  ----    ------            ----  ----                   -------</span><br><span class="line">  Normal  SuccessfulCreate  4m    replicaset-controller  Created pod: webapp-hzpcp</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all</span><br><span class="line">NAME               READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/queue          1/1       Running   0          5m</span><br><span class="line">pod/webapp-hzpcp   1/1       Running   0          5m</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.106.99.143    &lt;none&gt;        8161:30010/TCP   3h</span><br><span class="line">service/fleetman-webapp   NodePort    10.108.217.186   &lt;none&gt;        80:30080/TCP     23h</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          1d</span><br><span class="line"></span><br><span class="line">NAME                     DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/webapp   1         1         1         5m</span><br><span class="line"></span><br><span class="line">kubectl delete po webapp-hzpcp</span><br><span class="line">pod &quot;webapp-hzpcp&quot; deleted</span><br><span class="line"></span><br><span class="line">kubectl get all</span><br><span class="line">NAME               READY     STATUS        RESTARTS   AGE</span><br><span class="line">pod/queue          1/1       Running       0          7m</span><br><span class="line">pod/webapp-hff5l   1/1       Running       0          3s</span><br><span class="line">pod/webapp-hzpcp   0/1       Terminating   0          7m</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.106.99.143    &lt;none&gt;        8161:30010/TCP   3h</span><br><span class="line">service/fleetman-webapp   NodePort    10.108.217.186   &lt;none&gt;        80:30080/TCP     23h</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          1d</span><br><span class="line"></span><br><span class="line">NAME                     DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/webapp   1         1         1         7m</span><br></pre></td></tr></table></figure>
<h1 id="Deployments"><a href="#Deployments" class="headerlink" title="Deployments"></a>Deployments</h1><p>It’s a replica set with one additional feature. With a deployment, we get automatic rolling updates with zero downtime.</p>
<p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/#deployment-v1-apps">Deployment API reference guide</a></p>
<p>A deployment as being an entity in Kubernetes that manages the replica set for you.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">cat pods.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: webapp</span><br><span class="line">  replicas: 2</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: webapp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-webapp-angular:release0</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: queue</span><br><span class="line">  labels:</span><br><span class="line">    app: queue</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: queue</span><br><span class="line">    image: richardchesterwood/k8s-fleetman-queue:release1</span><br><span class="line"></span><br><span class="line">kubectl apply -f pods.yaml</span><br><span class="line">deployment.apps &quot;webapp&quot; created</span><br><span class="line">pod &quot;queue&quot; unchanged</span><br><span class="line"></span><br><span class="line">kubectl get all</span><br><span class="line">NAME                          READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/queue                     1/1       Running   0          24m</span><br><span class="line">pod/webapp-7469fb7fd6-4mcth   1/1       Running   0          12s</span><br><span class="line">pod/webapp-7469fb7fd6-sv4rw   1/1       Running   0          12s</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.106.99.143    &lt;none&gt;        8161:30010/TCP   3h</span><br><span class="line">service/fleetman-webapp   NodePort    10.108.217.186   &lt;none&gt;        80:30080/TCP     23h</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          1d</span><br><span class="line"></span><br><span class="line">NAME                     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/webapp   2         2         2            2           12s</span><br><span class="line"></span><br><span class="line">NAME                                DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/webapp-7469fb7fd6   2         2         2         12s</span><br></pre></td></tr></table></figure>
<h2 id="Managing-Rollouts"><a href="#Managing-Rollouts" class="headerlink" title="Managing Rollouts"></a>Managing Rollouts</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout status deploy webapp</span><br><span class="line">deployment &quot;webapp&quot; successfully rolled out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl rollout status deploy webapp</span><br><span class="line">Waiting for rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for rollout to finish: 2 old replicas are pending termination...</span><br><span class="line">Waiting for rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting for rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting for rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">deployment &quot;webapp&quot; successfully rolled out</span><br><span class="line"></span><br><span class="line">kubectl rollout history deploy webapp</span><br><span class="line">deployments &quot;webapp&quot;</span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">2         &lt;none&gt;</span><br><span class="line">3         &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># Default command automatically go back to one version</span><br><span class="line"></span><br><span class="line">kubectl rollout undo deploy</span><br></pre></td></tr></table></figure>
<p>It’s really only for use in an emergency.</p>
<h1 id="Networking-and-service-discovery"><a href="#Networking-and-service-discovery" class="headerlink" title="Networking and service discovery"></a>Networking and service discovery</h1><h2 id="Networking-Overview"><a href="#Networking-Overview" class="headerlink" title="Networking Overview"></a>Networking Overview</h2><p><img src="https://i.imgur.com/G9GkqlS.png" alt="Networking Overview"></p>
<h2 id="Namespace-kube-system"><a href="#Namespace-kube-system" class="headerlink" title="Namespace-kube-system"></a>Namespace-kube-system</h2><p>A namespace is a way of partitioning your resources in Kubernetes into separate areas.</p>
<p><img src="https://i.imgur.com/9FRKlUT.png" alt="namespace"> </p>
<p><img src="https://i.imgur.com/9QF8vkE.png" alt="namespace"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ns</span><br><span class="line">NAME          STATUS    AGE</span><br><span class="line">default       Active    1d</span><br><span class="line">kube-public   Active    1d</span><br><span class="line">kube-system   Active    1d</span><br><span class="line"></span><br><span class="line">kubectl get po</span><br><span class="line">NAME                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">queue                     1/1       Running   0          3h</span><br><span class="line">webapp-7469fb7fd6-sg87f   1/1       Running   0          1h</span><br><span class="line">webapp-7469fb7fd6-znbxx   1/1       Running   0          1h</span><br><span class="line"></span><br><span class="line">kubectl get po -n kube-system</span><br><span class="line">NAME                                    READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns-576cbf47c7-kwq7n                1/1       Running   0          1d</span><br><span class="line">coredns-576cbf47c7-vt56b                1/1       Running   0          1d</span><br><span class="line">etcd-minikube                           1/1       Running   0          1d</span><br><span class="line">kube-addon-manager-minikube             1/1       Running   0          1d</span><br><span class="line">kube-apiserver-minikube                 1/1       Running   0          1d</span><br><span class="line">kube-controller-manager-minikube        1/1       Running   0          1d</span><br><span class="line">kube-proxy-cn982                        1/1       Running   0          1d</span><br><span class="line">kube-scheduler-minikube                 1/1       Running   0          1d</span><br><span class="line">kubernetes-dashboard-5bff5f8fb8-mqz9z   1/1       Running   0          1d</span><br><span class="line">storage-provisioner                     1/1       Running   0          1d</span><br><span class="line"></span><br><span class="line">kubectl get all -n kube-system</span><br><span class="line">NAME                                        READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-576cbf47c7-kwq7n                1/1       Running   0          1d</span><br><span class="line">pod/coredns-576cbf47c7-vt56b                1/1       Running   0          1d</span><br><span class="line">pod/etcd-minikube                           1/1       Running   0          1d</span><br><span class="line">pod/kube-addon-manager-minikube             1/1       Running   0          1d</span><br><span class="line">pod/kube-apiserver-minikube                 1/1       Running   0          1d</span><br><span class="line">pod/kube-controller-manager-minikube        1/1       Running   0          1d</span><br><span class="line">pod/kube-proxy-cn982                        1/1       Running   0          1d</span><br><span class="line">pod/kube-scheduler-minikube                 1/1       Running   0          1d</span><br><span class="line">pod/kubernetes-dashboard-5bff5f8fb8-mqz9z   1/1       Running   0          1d</span><br><span class="line">pod/storage-provisioner                     1/1       Running   0          1d</span><br><span class="line"></span><br><span class="line">NAME                           TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/kube-dns               ClusterIP   10.96.0.10     &lt;none&gt;        53/UDP,53/TCP   1d</span><br><span class="line">service/kubernetes-dashboard   ClusterIP   10.102.124.0   &lt;none&gt;        80/TCP          1d</span><br><span class="line"></span><br><span class="line">NAME                        DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/kube-proxy   1         1         1         1            1           &lt;none&gt;          1d</span><br><span class="line"></span><br><span class="line">NAME                                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/coredns                2         2         2            2           1d</span><br><span class="line">deployment.apps/kubernetes-dashboard   1         1         1            1           1d</span><br><span class="line"></span><br><span class="line">NAME                                              DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/coredns-576cbf47c7                2         2         2         1d</span><br><span class="line">replicaset.apps/kubernetes-dashboard-5bff5f8fb8   1         1         1         1d</span><br><span class="line"></span><br><span class="line">kubectl describe svc kube-dns -n kube-system</span><br><span class="line">Name:              kube-dns</span><br><span class="line">Namespace:         kube-system</span><br><span class="line">Labels:            k8s-app=kube-dns</span><br><span class="line">                   kubernetes.io/cluster-service=true</span><br><span class="line">                   kubernetes.io/name=KubeDNS</span><br><span class="line">Annotations:       prometheus.io/port=9153</span><br><span class="line">                   prometheus.io/scrape=true</span><br><span class="line">Selector:          k8s-app=kube-dns</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.96.0.10</span><br><span class="line">Port:              dns  53/UDP</span><br><span class="line">TargetPort:        53/UDP</span><br><span class="line">Endpoints:         172.17.0.2:53,172.17.0.3:53</span><br><span class="line">Port:              dns-tcp  53/TCP</span><br><span class="line">TargetPort:        53/TCP</span><br><span class="line">Endpoints:         172.17.0.2:53,172.17.0.3:53</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Accessing-MySQL-from-a-Pod"><a href="#Accessing-MySQL-from-a-Pod" class="headerlink" title="Accessing MySQL from a Pod"></a>Accessing MySQL from a Pod</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">cat networking-tests.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql</span><br><span class="line">  labels:</span><br><span class="line">     app: mysql</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">   - name: mysql</span><br><span class="line">     image: mysql:5</span><br><span class="line">     env:</span><br><span class="line">      # Use secret in real life</span><br><span class="line">      - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">        value: password</span><br><span class="line">      - name: MYSQL_DATABASE</span><br><span class="line">        value: fleetman</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: database</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">     app: mysql</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3306</span><br><span class="line">  type: ClusterIP</span><br><span class="line"></span><br><span class="line">kga</span><br><span class="line">NAME                          READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/mysql                     1/1       Running   0          3m</span><br><span class="line">pod/queue                     1/1       Running   0          18h</span><br><span class="line">pod/webapp-7469fb7fd6-sg87f   1/1       Running   0          17h</span><br><span class="line">pod/webapp-7469fb7fd6-znbxx   1/1       Running   0          17h</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/database          ClusterIP   10.101.3.159     &lt;none&gt;        3306/TCP         3m</span><br><span class="line">service/fleetman-queue    NodePort    10.106.99.143    &lt;none&gt;        8161:30010/TCP   21h</span><br><span class="line">service/fleetman-webapp   NodePort    10.108.217.186   &lt;none&gt;        80:30080/TCP     1d</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          1d</span><br><span class="line"></span><br><span class="line">NAME                     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/webapp   2         2         2            2           17h</span><br><span class="line"></span><br><span class="line">NAME                                DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/webapp-7469fb7fd6   2         2         2         17h</span><br><span class="line">replicaset.apps/webapp-74bd9697b4   0         0         0         17h</span><br><span class="line">replicaset.apps/webapp-8f948b66c    0         0         0         17h</span><br><span class="line"></span><br><span class="line">kubectl exec -it webapp-7469fb7fd6-sg87f sh</span><br><span class="line">/ # ls</span><br><span class="line">bin    etc    lib    mnt    root   sbin   sys    usr</span><br><span class="line">dev    home   media  proc   run    srv    tmp    var</span><br></pre></td></tr></table></figure>
<h2 id="Service-Discovery"><a href="#Service-Discovery" class="headerlink" title="Service Discovery"></a>Service Discovery</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">/ # nslookup database</span><br><span class="line">nslookup: can&apos;t resolve &apos;(null)&apos;: Name does not resolve</span><br><span class="line"></span><br><span class="line">Name:      database</span><br><span class="line">Address 1: 10.101.3.159 database.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line">kubectl exec -it webapp-7469fb7fd6-sg87f sh</span><br><span class="line">/ # mysql</span><br><span class="line">sh: mysql: not found</span><br><span class="line">/ # apk update</span><br><span class="line">fetch http://dl-cdn.alpinelinux.org/alpine/v3.7/main/x86_64/APKINDEX.tar.gz</span><br><span class="line">fetch http://dl-cdn.alpinelinux.org/alpine/v3.7/community/x86_64/APKINDEX.tar.gz</span><br><span class="line">v3.7.3-61-gd3d301001c [http://dl-cdn.alpinelinux.org/alpine/v3.7/main]</span><br><span class="line">v3.7.3-51-gf95d10fed7 [http://dl-cdn.alpinelinux.org/alpine/v3.7/community]</span><br><span class="line">OK: 9067 distinct packages available</span><br><span class="line">/ # apk add mysql-client</span><br><span class="line">(1/6) Installing mariadb-common (10.1.38-r1)</span><br><span class="line">(2/6) Installing ncurses-terminfo-base (6.0_p20171125-r1)</span><br><span class="line">(3/6) Installing ncurses-terminfo (6.0_p20171125-r1)</span><br><span class="line">(4/6) Installing ncurses-libs (6.0_p20171125-r1)</span><br><span class="line">(5/6) Installing mariadb-client (10.1.38-r1)</span><br><span class="line">(6/6) Installing mysql-client (10.1.38-r1)</span><br><span class="line">Executing busybox-1.27.2-r7.trigger</span><br><span class="line">OK: 53 MiB in 34 packages</span><br><span class="line"></span><br><span class="line"># mysql -h database -uroot -ppassword fleetman</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.26 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [fleetman]&gt; create table testable (test varchar(255));</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">MySQL [fleetman]&gt; show tables;</span><br><span class="line">+--------------------+</span><br><span class="line">| Tables_in_fleetman |</span><br><span class="line">+--------------------+</span><br><span class="line">| testable           |</span><br><span class="line">+--------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>Can find the ip address of any service that we like just by its name. And that’s called service discovery.</p>
<h2 id="Fully-Qualified-Domain-Names-FQDN"><a href="#Fully-Qualified-Domain-Names-FQDN" class="headerlink" title="Fully Qualified Domain Names (FQDN)"></a>Fully Qualified Domain Names (FQDN)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># nslookup database</span><br><span class="line">nslookup: can&apos;t resolve &apos;(null)&apos;: Name does not resolve</span><br><span class="line"></span><br><span class="line">Name:      database</span><br><span class="line">Address 1: 10.101.3.159 database.default.svc.cluster.local</span><br></pre></td></tr></table></figure>
<h2 id="An-introduction-to-Microservices"><a href="#An-introduction-to-Microservices" class="headerlink" title="An introduction to Microservices"></a>An introduction to Microservices</h2><p>Each microservice should be  Highly Cohesive and Lossely Coupled.</p>
<p>highly cohesive: each microservice should handlng one business requirement. Cohesive means that a microservice should have a single set of reponsibilities.</p>
<p>Each microservice will maintain its own data store. And that microservice will be really the only poart of the system that can read or write that data.</p>
<h2 id="Fleetman-Microservices-setting-the-scene"><a href="#Fleetman-Microservices-setting-the-scene" class="headerlink" title="Fleetman Microservices- setting the scene"></a>Fleetman Microservices- setting the scene</h2><p><img src="https://i.imgur.com/fkwUIA0.png" alt="scene"><br>The logic in the API gateway is typically some kind of a mapping. So it would be something like if the incoming request ends with /vehicles, then delegate the call to,<br>in this case, the position tracker.</p>
<p><a href="https://microservices.io/patterns/apigateway.html">API gateway pattern</a></p>
<h2 id="Deploying-the-Queue"><a href="#Deploying-the-Queue" class="headerlink" title="Deploying the Queue"></a>Deploying the Queue</h2><p><img src="https://i.imgur.com/fkwUIA0.png" alt="scene"></p>
<p>API gateway: a web front end which is implemented in Java script</p>
<p>Position tracker: back end, calcuating the speeds of vehicles and storing the positions of all the vehicles.</p>
<p>Queue: which is going to store the messages that are received from the vehicles as they move around the country.</p>
<p>Positon simulator: a testing microservice which is going to generate some positions of vehicles.</p>
<p>Delete all the Pods:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f .</span><br><span class="line">pod &quot;mysql&quot; deleted</span><br><span class="line">service &quot;database&quot; deleted</span><br><span class="line">deployment.apps &quot;webapp&quot; deleted</span><br><span class="line">pod &quot;queue&quot; deleted</span><br><span class="line">service &quot;fleetman-webapp&quot; deleted</span><br><span class="line">service &quot;fleetman-queue&quot; deleted</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f workloads.yaml</span><br><span class="line">kubectl describe pod queue-6bf9fd876-4xrqx</span><br><span class="line">Name:               queue-6bf9fd876-4xrqx</span><br><span class="line">Namespace:          default</span><br><span class="line">Priority:           0</span><br><span class="line">PriorityClassName:  &lt;none&gt;</span><br><span class="line">Node:               minikube/10.0.2.15</span><br><span class="line">Start Time:         Wed, 05 Jun 2019 15:14:40 +1000</span><br><span class="line">Labels:             app=queue</span><br><span class="line">                    pod-template-hash=6bf9fd876</span><br><span class="line">Annotations:        &lt;none&gt;</span><br><span class="line">Status:             Running</span><br><span class="line">IP:                 172.17.0.5</span><br><span class="line">Controlled By:      ReplicaSet/queue-6bf9fd876</span><br><span class="line">Containers:</span><br><span class="line">  webapp:</span><br><span class="line">    Container ID:   docker://f306dda43b8bf2eaab70449ecac022bb0b98e37b8b2be0d1b2e1b25eea9db1ac</span><br><span class="line">    Image:          richardchesterwood/k8s-fleetman-queue:release1</span><br><span class="line">    Image ID:       docker-pullable://richardchesterwood/k8s-fleetman-queue@sha256:bc2cb90a09aecdd8bce5d5f3a8dac17281ec7883077ddcfb8b7acfe2ab3b6afa</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Wed, 05 Jun 2019 15:14:41 +1000</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-nmqkz (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-nmqkz:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-nmqkz</span><br><span class="line">    Optional:    false</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  2m    default-scheduler  Successfully assigned default/queue-6bf9fd876-4xrqx to minikube</span><br><span class="line">  Normal  Pulled     2m    kubelet, minikube  Container image &quot;richardchesterwood/k8s-fleetman-queue:release1&quot; already present on machine</span><br><span class="line">  Normal  Created    2m    kubelet, minikube  Created container</span><br><span class="line">  Normal  Started    2m    kubelet, minikube  Started container</span><br><span class="line"></span><br><span class="line">kubectl apply -f services.yaml</span><br><span class="line">service &quot;fleetman-webapp&quot; created</span><br><span class="line">service &quot;fleetman-queue&quot; created</span><br><span class="line"></span><br><span class="line">kubectl apply -f services.yaml</span><br><span class="line">service &quot;fleetman-webapp&quot; created</span><br><span class="line">service &quot;fleetman-queue&quot; created</span><br><span class="line"></span><br><span class="line">minikube ip</span><br><span class="line">There is a newer version of minikube available (v1.1.0).  Download it here:</span><br><span class="line">https://github.com/kubernetes/minikube/releases/tag/v1.1.0</span><br><span class="line"></span><br><span class="line">To disable this notification, run the following:</span><br><span class="line">minikube config set WantUpdateNotification false</span><br><span class="line">192.168.99.118</span><br></pre></td></tr></table></figure>
<p>Open a web browser <a href="http://192.168.99.118:30010">http://192.168.99.118:30010</a>, click <strong>Manage ActiveMQ broker</strong>, enter username and password both admin.</p>
<h2 id="Deploying-the-Position-Simulator"><a href="#Deploying-the-Position-Simulator" class="headerlink" title="Deploying the Position Simulator"></a>Deploying the Position Simulator</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">cat workloads.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: queue</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: queue</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: queue</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-queue:release1</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: position-simulator</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: position-simulator</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: position-simulator</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-position-simulator:release1</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: producadskfjsjfsislfslsj</span><br><span class="line"></span><br><span class="line">kubectl apply -f workloads.yaml</span><br><span class="line">deployment.apps &quot;queue&quot; unchanged</span><br><span class="line">deployment.apps &quot;position-simulator&quot; configured</span><br><span class="line"></span><br><span class="line">kga</span><br><span class="line">NAME                                      READY     STATUS              RESTARTS   AGE</span><br><span class="line">pod/position-simulator-6f97fd485f-gplr8   0/1       ContainerCreating   0          7s</span><br><span class="line">pod/position-simulator-dff7b7599-2vbdd    0/1       ImagePullBackOff    0          2m</span><br><span class="line">pod/queue-6bf9fd876-4xrqx                 1/1       Running             0          50m</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.110.95.121    &lt;none&gt;        8161:30010/TCP,61616:30536/TCP   47m</span><br><span class="line">service/fleetman-webapp   NodePort    10.103.224.156   &lt;none&gt;        80:30080/TCP                     47m</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                          2d</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/position-simulator   1         2         1            0           2m</span><br><span class="line">deployment.apps/queue                1         1         1            1           50m</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/position-simulator-6f97fd485f   1         1         0         7s</span><br><span class="line">replicaset.apps/position-simulator-dff7b7599    1         1         0         2m</span><br><span class="line">replicaset.apps/queue-6bf9fd876                 1         1         1         50m</span><br><span class="line"></span><br><span class="line">kubectl describe pod position-simulator-6f97fd485f-gplr8</span><br><span class="line">Name:               position-simulator-6f97fd485f-gplr8</span><br><span class="line">Namespace:          default</span><br><span class="line">Priority:           0</span><br><span class="line">PriorityClassName:  &lt;none&gt;</span><br><span class="line">Node:               minikube/10.0.2.15</span><br><span class="line">Start Time:         Wed, 05 Jun 2019 16:05:27 +1000</span><br><span class="line">Labels:             app=position-simulator</span><br><span class="line">                    pod-template-hash=6f97fd485f</span><br><span class="line">Annotations:        &lt;none&gt;</span><br><span class="line">Status:             Running</span><br><span class="line">IP:                 172.17.0.7</span><br><span class="line">Controlled By:      ReplicaSet/position-simulator-6f97fd485f</span><br><span class="line">Containers:</span><br><span class="line">  webapp:</span><br><span class="line">    Container ID:   docker://2a4f677af3a8bd72f674543e13a4b84c3c86148791106a19270d86878091b09d</span><br><span class="line">    Image:          richardchesterwood/k8s-fleetman-position-simulator:release1</span><br><span class="line">    Image ID:       docker-pullable://richardchesterwood/k8s-fleetman-position-simulator@sha256:58ce4aa156469115a58be0bcfcec84bb7e42dd4552f83dcf5b6381234001108b</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Terminated</span><br><span class="line">      Reason:       Error</span><br><span class="line">      Exit Code:    1</span><br><span class="line">      Started:      Wed, 05 Jun 2019 16:05:56 +1000</span><br><span class="line">      Finished:     Wed, 05 Jun 2019 16:05:59 +1000</span><br><span class="line">    Ready:          False</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:</span><br><span class="line">      SPRING_PROFILES_ACTIVE:  producadskfjsjfsislfslsj</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-nmqkz (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             False</span><br><span class="line">  ContainersReady   False</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-nmqkz:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-nmqkz</span><br><span class="line">    Optional:    false</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age              From               Message</span><br><span class="line">  ----    ------     ----             ----               -------</span><br><span class="line">  Normal  Scheduled  33s              default-scheduler  Successfully assigned default/position-simulator-6f97fd485f-gplr8 to minikube</span><br><span class="line">  Normal  Pulling    32s              kubelet, minikube  pulling image &quot;richardchesterwood/k8s-fleetman-position-simulator:release1&quot;</span><br><span class="line">  Normal  Pulled     4s               kubelet, minikube  Successfully pulled image &quot;richardchesterwood/k8s-fleetman-position-simulator:release1&quot;</span><br><span class="line">  Normal  Created    0s (x2 over 4s)  kubelet, minikube  Created container</span><br><span class="line">  Normal  Started    0s (x2 over 4s)  kubelet, minikube  Started container</span><br><span class="line">  Normal  Pulled     0s               kubelet, minikube  Container image &quot;richardchesterwood/k8s-fleetman-position-simulator:release1&quot; already present on machine</span><br></pre></td></tr></table></figure>
<h3 id="inspecting-Pod-Logs"><a href="#inspecting-Pod-Logs" class="headerlink" title="inspecting Pod Logs"></a>inspecting Pod Logs</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs position-simulator-6f97fd485f-gplr8</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&apos;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &apos;_ | &apos;_| | &apos;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &apos;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::        (v1.4.0.RELEASE)</span><br><span class="line"></span><br><span class="line">2019-06-05 06:09:06.044  INFO 1 --- [           main] c.v.s.PositionsimulatorApplication       : Starting PositionsimulatorApplication v0.0.1-SNAPSHOT on position-simulator-6f97fd485f-gplr8 with PID 1 (/webapp.jar started by root in /)</span><br><span class="line">2019-06-05 06:09:06.056  INFO 1 --- [           main] c.v.s.PositionsimulatorApplication       : The following profiles are active: producadskfjsjfsislfslsj</span><br><span class="line">2019-06-05 06:09:06.151  INFO 1 --- [           main] s.c.a.AnnotationConfigApplicationContext : Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@5f4da5c3: startup date [Wed Jun 05 06:09:06 UTC 2019]; root of context hierarchy</span><br><span class="line">2019-06-05 06:09:07.265  WARN 1 --- [           main] s.c.a.AnnotationConfigApplicationContext : Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;journeySimulator&apos;: Injection of autowired dependencies failed; nested exception is java.lang.IllegalArgumentException: Could not resolve placeholder &apos;fleetman.position.queue&apos; in string value &quot;$&#123;fleetman.position.queue&#125;&quot;</span><br><span class="line">2019-06-05 06:09:07.273  INFO 1 --- [           main] utoConfigurationReportLoggingInitializer :</span><br><span class="line"></span><br><span class="line">Error starting ApplicationContext. To display the auto-configuration report enable debug logging (start with --debug)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2019-06-05 06:09:07.286 ERROR 1 --- [           main] o.s.boot.SpringApplication               : Application startup failed</span><br><span class="line"></span><br><span class="line">org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;journeySimulator&apos;: Injection of autowired dependencies failed; nested exception is java.lang.IllegalArgumentException: Could not resolve placeholder &apos;fleetman.position.queue&apos; in string value &quot;$&#123;fleetman.position.queue&#125;&quot;</span><br><span class="line">	at org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor.postProcessPropertyValues(AutowiredAnnotationBeanPostProcessor.java:355) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1214) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:543) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:482) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:306) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:230) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:302) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:197) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:776) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:861) ~[spring-context-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:541) ~[spring-context-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:759) [spring-boot-1.4.0.RELEASE.jar!/:1.4.0.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:369) [spring-boot-1.4.0.RELEASE.jar!/:1.4.0.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:313) [spring-boot-1.4.0.RELEASE.jar!/:1.4.0.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1185) [spring-boot-1.4.0.RELEASE.jar!/:1.4.0.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1174) [spring-boot-1.4.0.RELEASE.jar!/:1.4.0.RELEASE]</span><br><span class="line">	at com.virtualpairprogrammers.simulator.PositionsimulatorApplication.main(PositionsimulatorApplication.java:28) [classes!/:0.0.1-SNAPSHOT]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_131]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_131]</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_131]</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_131]</span><br><span class="line">	at org.springframework.boot.loader.MainMethodRunner.run(MainMethodRunner.java:48) [webapp.jar:0.0.1-SNAPSHOT]</span><br><span class="line">	at org.springframework.boot.loader.Launcher.launch(Launcher.java:87) [webapp.jar:0.0.1-SNAPSHOT]</span><br><span class="line">	at org.springframework.boot.loader.Launcher.launch(Launcher.java:50) [webapp.jar:0.0.1-SNAPSHOT]</span><br><span class="line">	at org.springframework.boot.loader.JarLauncher.main(JarLauncher.java:58) [webapp.jar:0.0.1-SNAPSHOT]</span><br><span class="line">Caused by: java.lang.IllegalArgumentException: Could not resolve placeholder &apos;fleetman.position.queue&apos; in string value &quot;$&#123;fleetman.position.queue&#125;&quot;</span><br><span class="line">	at org.springframework.util.PropertyPlaceholderHelper.parseStringValue(PropertyPlaceholderHelper.java:174) ~[spring-core-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.util.PropertyPlaceholderHelper.replacePlaceholders(PropertyPlaceholderHelper.java:126) ~[spring-core-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.core.env.AbstractPropertyResolver.doResolvePlaceholders(AbstractPropertyResolver.java:219) ~[spring-core-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.core.env.AbstractPropertyResolver.resolveRequiredPlaceholders(AbstractPropertyResolver.java:193) ~[spring-core-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.context.support.PropertySourcesPlaceholderConfigurer$2.resolveStringValue(PropertySourcesPlaceholderConfigurer.java:172) ~[spring-context-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory.resolveEmbeddedValue(AbstractBeanFactory.java:813) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.DefaultListableBeanFactory.doResolveDependency(DefaultListableBeanFactory.java:1039) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.DefaultListableBeanFactory.resolveDependency(DefaultListableBeanFactory.java:1019) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor$AutowiredFieldElement.inject(AutowiredAnnotationBeanPostProcessor.java:566) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.annotation.InjectionMetadata.inject(InjectionMetadata.java:88) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor.postProcessPropertyValues(AutowiredAnnotationBeanPostProcessor.java:349) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	... 24 common frames omitted</span><br></pre></td></tr></table></figure>
<p><code>kubectl logs -f position-simulator-6f97fd485f-gplr8</code> follow the log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">cat workloads.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: queue</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: queue</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: queue</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-queue:release1</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: position-simulator</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: position-simulator</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: position-simulator</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-position-simulator:release1</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line"></span><br><span class="line">kubectl apply -f workloads.yaml</span><br><span class="line">deployment.apps &quot;queue&quot; unchanged</span><br><span class="line">deployment.apps &quot;position-simulator&quot; configured</span><br><span class="line"></span><br><span class="line">kga</span><br><span class="line">NAME                                      READY     STATUS        RESTARTS   AGE</span><br><span class="line">pod/position-simulator-6d8769d8-ghtmw     1/1       Running       0          9s</span><br><span class="line">pod/position-simulator-6f97fd485f-gplr8   0/1       Terminating   6          8m</span><br><span class="line">pod/queue-6bf9fd876-4xrqx                 1/1       Running       0          59m</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.110.95.121    &lt;none&gt;        8161:30010/TCP,61616:30536/TCP   55m</span><br><span class="line">service/fleetman-webapp   NodePort    10.103.224.156   &lt;none&gt;        80:30080/TCP                     55m</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                          2d</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/position-simulator   1         1         1            1           10m</span><br><span class="line">deployment.apps/queue                1         1         1            1           59m</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/position-simulator-6d8769d8     1         1         1         9s</span><br><span class="line">replicaset.apps/position-simulator-6f97fd485f   0         0         0         8m</span><br><span class="line">replicaset.apps/position-simulator-dff7b7599    0         0         0         10m</span><br><span class="line">replicaset.apps/queue-6bf9fd876                 1         1         1         59m</span><br><span class="line"></span><br><span class="line">kubectl logs -f position-simulator-6d8769d8-ghtmw</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&apos;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &apos;_ | &apos;_| | &apos;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &apos;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::        (v1.4.0.RELEASE)</span><br><span class="line"></span><br><span class="line">2019-06-05 06:13:36.205  INFO 1 --- [           main] c.v.s.PositionsimulatorApplication       : Starting PositionsimulatorApplication v0.0.1-SNAPSHOT on position-simulator-6d8769d8-ghtmw with PID 1 (/webapp.jar started by root in /)</span><br><span class="line">2019-06-05 06:13:36.213  INFO 1 --- [           main] c.v.s.PositionsimulatorApplication       : The following profiles are active: production-microservice</span><br><span class="line">2019-06-05 06:13:36.361  INFO 1 --- [           main] s.c.a.AnnotationConfigApplicationContext : Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@443b7951: startup date [Wed Jun 05 06:13:36 UTC 2019]; root of context hierarchy</span><br><span class="line">2019-06-05 06:13:38.011  INFO 1 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup</span><br><span class="line">2019-06-05 06:13:38.016  INFO 1 --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Starting beans in phase 2147483647</span><br><span class="line">2019-06-05 06:13:38.041  INFO 1 --- [           main] c.v.s.PositionsimulatorApplication       : Started PositionsimulatorApplication in 2.487 seconds (JVM running for 3.201)</span><br><span class="line">2019-06-05 06:13:38.046  INFO 1 --- [           main] s.c.a.AnnotationConfigApplicationContext : Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@443b7951: startup date [Wed Jun 05 06:13:36 UTC 2019]; root of context hierarchy</span><br><span class="line">2019-06-05 06:13:38.048  INFO 1 --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Stopping beans in phase 2147483647</span><br><span class="line">2019-06-05 06:13:38.049  INFO 1 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Unregistering JMX-exposed beans on shutdown</span><br><span class="line">ca^H^H^C</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/QhM7LEN.png" alt="Digram"></p>
<h2 id="Deploying-the-Position-Tracker"><a href="#Deploying-the-Position-Tracker" class="headerlink" title="Deploying the Position Tracker"></a>Deploying the Position Tracker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">cat workloads.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: queue</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: queue</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: queue</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: queue</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-queue:release1</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: position-simulator</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: position-simulator</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: position-simulator</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: position-simulator</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-position-simulator:release1</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: position-tracker</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: position-tracker</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: position-tracker</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: position-tracker</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-position-tracker:release1</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line"></span><br><span class="line">kubectl apply -f workloads.yaml</span><br><span class="line">deployment.apps &quot;queue&quot; configured</span><br><span class="line">deployment.apps &quot;position-simulator&quot; configured</span><br><span class="line">deployment.apps &quot;position-tracker&quot; created</span><br><span class="line"></span><br><span class="line">kga</span><br><span class="line">NAME                                      READY     STATUS        RESTARTS   AGE</span><br><span class="line">pod/position-simulator-6d8769d8-ghtmw     0/1       Terminating   0          13m</span><br><span class="line">pod/position-simulator-7889db8b94-49qz2   1/1       Running       0          10s</span><br><span class="line">pod/position-tracker-86d694f997-5j6fm     1/1       Running       0          10s</span><br><span class="line">pod/queue-6bf9fd876-4xrqx                 1/1       Terminating   0          1h</span><br><span class="line">pod/queue-9668b9bb4-4pqxr                 1/1       Running       0          10s</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.110.95.121    &lt;none&gt;        8161:30010/TCP,61616:30536/TCP   1h</span><br><span class="line">service/fleetman-webapp   NodePort    10.103.224.156   &lt;none&gt;        80:30080/TCP                     1h</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                          2d</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/position-simulator   1         1         1            1           24m</span><br><span class="line">deployment.apps/position-tracker     1         1         1            1           10s</span><br><span class="line">deployment.apps/queue                1         1         1            1           1h</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/position-simulator-6d8769d8     0         0         0         13m</span><br><span class="line">replicaset.apps/position-simulator-6f97fd485f   0         0         0         21m</span><br><span class="line">replicaset.apps/position-simulator-7889db8b94   1         1         1         10s</span><br><span class="line">replicaset.apps/position-simulator-dff7b7599    0         0         0         24m</span><br><span class="line">replicaset.apps/position-tracker-86d694f997     1         1         1         10s</span><br><span class="line">replicaset.apps/queue-6bf9fd876                 0         0         0         1h</span><br><span class="line">replicaset.apps/queue-9668b9bb4                 1         1         1         10s</span><br><span class="line"></span><br><span class="line">kubectl describe pod position-tracker-86d694f997-5j6fm</span><br><span class="line">Name:               position-tracker-86d694f997-5j6fm</span><br><span class="line">Namespace:          default</span><br><span class="line">Priority:           0</span><br><span class="line">PriorityClassName:  &lt;none&gt;</span><br><span class="line">Node:               minikube/10.0.2.15</span><br><span class="line">Start Time:         Wed, 05 Jun 2019 16:26:58 +1000</span><br><span class="line">Labels:             app=position-tracker</span><br><span class="line">                    pod-template-hash=86d694f997</span><br><span class="line">Annotations:        &lt;none&gt;</span><br><span class="line">Status:             Running</span><br><span class="line">IP:                 172.17.0.7</span><br><span class="line">Controlled By:      ReplicaSet/position-tracker-86d694f997</span><br><span class="line">Containers:</span><br><span class="line">  position-tracker:</span><br><span class="line">    Container ID:   docker://c0203a7654c944a92f1b18b48d5c84917b9ecc791536429e6b02ca6248edb78f</span><br><span class="line">    Image:          richardchesterwood/k8s-fleetman-position-tracker:release1</span><br><span class="line">    Image ID:       docker-pullable://richardchesterwood/k8s-fleetman-position-tracker@sha256:5da78e936eb77677fbf30e528253a543badc76a5dd3a356b6d13e716da187298</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Wed, 05 Jun 2019 16:27:08 +1000</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:</span><br><span class="line">      SPRING_PROFILES_ACTIVE:  production-microservice</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-nmqkz (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-nmqkz:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-nmqkz</span><br><span class="line">    Optional:    false</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  1m    default-scheduler  Successfully assigned default/position-tracker-86d694f997-5j6fm to minikube</span><br><span class="line">  Normal  Pulling    1m    kubelet, minikube  pulling image &quot;richardchesterwood/k8s-fleetman-position-tracker:release1&quot;</span><br><span class="line">  Normal  Pulled     1m    kubelet, minikube  Successfully pulled image &quot;richardchesterwood/k8s-fleetman-position-tracker:release1&quot;</span><br><span class="line">  Normal  Created    1m    kubelet, minikube  Created container</span><br><span class="line">  Normal  Started    1m    kubelet, minikube  Started container</span><br><span class="line"></span><br><span class="line">kubectl logs -f position-tracker-86d694f997-5j6fm</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&apos;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &apos;_ | &apos;_| | &apos;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &apos;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::        (v1.4.0.RELEASE)</span><br><span class="line"></span><br><span class="line">2019-06-05 06:27:14.242  INFO 1 --- [           main] c.v.tracker.PositionTrackerApplication   : Starting PositionTrackerApplication v0.0.1-SNAPSHOT on position-tracker-86d694f997-5j6fm with PID 1 (/webapp.jar started by root in /)</span><br><span class="line">2019-06-05 06:27:14.297  INFO 1 --- [           main] c.v.tracker.PositionTrackerApplication   : The following profiles are active: production-microservice</span><br><span class="line">2019-06-05 06:27:15.147  INFO 1 --- [           main] ationConfigEmbeddedWebApplicationContext : Refreshing org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext@108c4c35: startup date [Wed Jun 05 06:27:15 UTC 2019]; root of context hierarchy</span><br><span class="line">2019-06-05 06:27:25.787  INFO 1 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat initialized with port(s): 8080 (http)</span><br><span class="line">2019-06-05 06:27:25.852  INFO 1 --- [           main] o.apache.catalina.core.StandardService   : Starting service Tomcat</span><br><span class="line">2019-06-05 06:27:25.854  INFO 1 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet Engine: Apache Tomcat/8.5.4</span><br><span class="line">2019-06-05 06:27:25.985  INFO 1 --- [ost-startStop-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line">2019-06-05 06:27:25.986  INFO 1 --- [ost-startStop-1] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 10877 ms</span><br><span class="line">2019-06-05 06:27:26.212  INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.ServletRegistrationBean  : Mapping servlet: &apos;dispatcherServlet&apos; to [/]</span><br><span class="line">2019-06-05 06:27:26.221  INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: &apos;characterEncodingFilter&apos; to: [/*]</span><br><span class="line">2019-06-05 06:27:26.222  INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: &apos;hiddenHttpMethodFilter&apos; to: [/*]</span><br><span class="line">2019-06-05 06:27:26.223  INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: &apos;httpPutFormContentFilter&apos; to: [/*]</span><br><span class="line">2019-06-05 06:27:26.223  INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: &apos;requestContextFilter&apos; to: [/*]</span><br><span class="line">2019-06-05 06:27:26.789  INFO 1 --- [           main] s.w.s.m.m.a.RequestMappingHandlerAdapter : Looking for @ControllerAdvice: org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext@108c4c35: startup date [Wed Jun 05 06:27:15 UTC 2019]; root of context hierarchy</span><br><span class="line">2019-06-05 06:27:26.900  INFO 1 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped &quot;&#123;[/vehicles/&#123;vehicleName&#125;],methods=[GET]&#125;&quot; onto public org.springframework.http.ResponseEntity&lt;com.virtualpairprogrammers.tracker.domain.VehiclePosition&gt; com.virtualpairprogrammers.tracker.rest.PositionReportsController.getLatestReportForVehicle(java.lang.String)</span><br><span class="line">2019-06-05 06:27:26.901  INFO 1 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped &quot;&#123;[/vehicles/],methods=[GET]&#125;&quot; onto public java.util.Collection&lt;com.virtualpairprogrammers.tracker.domain.VehiclePosition&gt; com.virtualpairprogrammers.tracker.rest.PositionReportsController.getUpdatedPositions(java.util.Date)</span><br><span class="line">2019-06-05 06:27:26.903  INFO 1 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped &quot;&#123;[/error],produces=[text/html]&#125;&quot; onto public org.springframework.web.servlet.ModelAndView org.springframework.boot.autoconfigure.web.BasicErrorController.errorHtml(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)</span><br><span class="line">2019-06-05 06:27:26.904  INFO 1 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped &quot;&#123;[/error]&#125;&quot; onto public org.springframework.http.ResponseEntity&lt;java.util.Map&lt;java.lang.String, java.lang.Object&gt;&gt; org.springframework.boot.autoconfigure.web.BasicErrorController.error(javax.servlet.http.HttpServletRequest)</span><br><span class="line">2019-06-05 06:27:26.948  INFO 1 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/webjars/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]</span><br><span class="line">2019-06-05 06:27:26.948  INFO 1 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]</span><br><span class="line">2019-06-05 06:27:26.991  INFO 1 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**/favicon.ico] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]</span><br><span class="line">2019-06-05 06:27:27.364  INFO 1 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup</span><br><span class="line">2019-06-05 06:27:27.414  INFO 1 --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Starting beans in phase 2147483647</span><br><span class="line">2019-06-05 06:27:28.408  INFO 1 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat started on port(s): 8080 (http)</span><br><span class="line">2019-06-05 06:27:28.436  INFO 1 --- [           main] c.v.tracker.PositionTrackerApplication   : Started PositionTrackerApplication in 17.136 seconds (JVM running for 20.295)</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/MrwaPyf.png" alt="ActiveMQ screenshot"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">cat services.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-webapp</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: webapp</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 80</span><br><span class="line">     nodePort: 30080</span><br><span class="line"></span><br><span class="line"> type: NodePort</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-queue</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: queue</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 8161</span><br><span class="line">     nodePort: 30010</span><br><span class="line"></span><br><span class="line">   - name: endpoint</span><br><span class="line">     port: 61616</span><br><span class="line"></span><br><span class="line"> type: NodePort</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-position-tracker</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: position-tracker</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 8080</span><br><span class="line"></span><br><span class="line"> type: ClusterIP</span><br><span class="line"></span><br><span class="line">kubectl apply -f services.yaml</span><br><span class="line">service &quot;fleetman-webapp&quot; unchanged</span><br><span class="line">service &quot;fleetman-queue&quot; unchanged</span><br><span class="line">service &quot;fleetman-position-tracker&quot; configured</span><br><span class="line"></span><br><span class="line">kga</span><br><span class="line">NAME                                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/position-simulator-589c64887f-lhl8g   1/1       Running   0          38m</span><br><span class="line">pod/position-tracker-86d694f997-5j6fm     1/1       Running   0          45m</span><br><span class="line">pod/queue-9668b9bb4-4pqxr                 1/1       Running   0          45m</span><br><span class="line"></span><br><span class="line">NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">service/fleetman-position-tracker   ClusterIP   10.104.177.133   &lt;none&gt;        8080/TCP                         3m</span><br><span class="line">service/fleetman-queue              NodePort    10.110.95.121    &lt;none&gt;        8161:30010/TCP,61616:30536/TCP   1h</span><br><span class="line">service/fleetman-webapp             NodePort    10.103.224.156   &lt;none&gt;        80:30080/TCP                     1h</span><br><span class="line">service/kubernetes                  ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                          2d</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/position-simulator   1         1         1            1           1h</span><br><span class="line">deployment.apps/position-tracker     1         1         1            1           45m</span><br><span class="line">deployment.apps/queue                1         1         1            1           1h</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/position-simulator-589c64887f   1         1         1         38m</span><br><span class="line">replicaset.apps/position-simulator-6d8769d8     0         0         0         58m</span><br><span class="line">replicaset.apps/position-simulator-6f97fd485f   0         0         0         1h</span><br><span class="line">replicaset.apps/position-simulator-7889db8b94   0         0         0         45m</span><br><span class="line">replicaset.apps/position-simulator-dff7b7599    0         0         0         1h</span><br><span class="line">replicaset.apps/position-tracker-86d694f997     1         1         1         45m</span><br><span class="line">replicaset.apps/queue-6bf9fd876                 0         0         0         1h</span><br><span class="line">replicaset.apps/queue-9668b9bb4                 1         1         1         45m</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/3tgbP7M.png" alt="Check"></p>
<h2 id="Deploying-the-API-Gateway"><a href="#Deploying-the-API-Gateway" class="headerlink" title="Deploying the API Gateway"></a>Deploying the API Gateway</h2><p>Add code in services.yaml file:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-api-gateway</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: api-gateway</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 8080</span><br><span class="line"></span><br><span class="line"> type: ClusterIP</span><br></pre></td></tr></table></figure></p>
<p>Add code in workloads.yaml file:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: api-gateway</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: api-gateway</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: api-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: api-gateway</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-api-gateway:release1</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br></pre></td></tr></table></figure></p>
<p><code>kubectl apply -f .</code></p>
<h2 id="Deploying-the-Webapp"><a href="#Deploying-the-Webapp" class="headerlink" title="Deploying the Webapp"></a>Deploying the Webapp</h2><p>Add for workloads.yaml file:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: webapp</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: webapp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-webapp-angular:release1</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br></pre></td></tr></table></figure></p>
<p>For serivce.yaml no change.</p>
<p><img src="https://i.imgur.com/dadMM2m.jpg" alt="final"></p>
<h1 id="Persistence"><a href="#Persistence" class="headerlink" title="Persistence"></a>Persistence</h1><h2 id="New-Release"><a href="#New-Release" class="headerlink" title="New Release!!"></a><strong>New Release!!</strong></h2><p>Release 2 is now available!</p>
<p>Please update all images to :release2 tag</p>
<p>New feature: vehicle tracking shows the history of each vehicle</p>
<hr>
<p>Change image in workloads.yaml from release1 to release2 by <code>:%s/release1/release2/g</code><br><img src="https://i.imgur.com/oOLbvYT.jpg" alt="release2"></p>
<h2 id="Upgrading-to-a-Mongo-Pod"><a href="#Upgrading-to-a-Mongo-Pod" class="headerlink" title="Upgrading to a Mongo Pod"></a>Upgrading to a Mongo Pod</h2><p><img src="https://i.imgur.com/zT2lk5f.jpg" alt="release3"></p>
<h2 id="Volume-Mounts"><a href="#Volume-Mounts" class="headerlink" title="Volume Mounts"></a>Volume Mounts</h2><p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/#volume-v1-core">Volume v1 core</a></p>
<h2 id="PersistentVolumeClaims"><a href="#PersistentVolumeClaims" class="headerlink" title="PersistentVolumeClaims"></a>PersistentVolumeClaims</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat storage.yaml</span><br><span class="line"># What do want?</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClain</span><br><span class="line">metadata:</span><br><span class="line">  name: mongo-pvc</span><br><span class="line">spec:</span><br><span class="line">  accessMode:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resouces:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># How do we want it implemented</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: local-storage</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 20Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: &quot;/mnt/somenew/dirctory/structure/&quot;</span><br><span class="line">    type: DirectoryOrCreate</span><br></pre></td></tr></table></figure>
<h2 id="StorageClasses-and-Binding"><a href="#StorageClasses-and-Binding" class="headerlink" title="StorageClasses and Binding"></a>StorageClasses and Binding</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"> cat mongo-stack.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mongodb</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mongodb</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: mongodb</span><br><span class="line">        image: mongo:3.6.12-xenial</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - name: mongo-persistent-storage</span><br><span class="line">            mountPath: /data/db</span><br><span class="line">      volumes:</span><br><span class="line">        - name: mongo-persistent-storage</span><br><span class="line">          # pointer to the configuration of HOW we want the mount to be implemented</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">             claimName: mongo-pvc</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fleetman-mongodb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: mongodb</span><br><span class="line">  ports:</span><br><span class="line">    - name: mongoport</span><br><span class="line">      port: 27017</span><br><span class="line">  type: ClusterIP</span><br><span class="line"></span><br><span class="line"> cat storage.yaml</span><br><span class="line"># What do want?</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: mongo-pvc</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: mylocalstorage</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># How do we want it implemented</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: local-storage</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: mylocalstorage</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 20Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: &quot;/mnt/somenew/dirctory/structure/&quot;</span><br><span class="line">    type: DirectoryOrCreate</span><br></pre></td></tr></table></figure>
<h1 id="DEPLOYING-TO-THE-AWS-CLOUD"><a href="#DEPLOYING-TO-THE-AWS-CLOUD" class="headerlink" title="DEPLOYING TO THE AWS CLOUD"></a>DEPLOYING TO THE AWS CLOUD</h1><h2 id="Getting-started-with-AWS"><a href="#Getting-started-with-AWS" class="headerlink" title="Getting started with AWS"></a>Getting started with AWS</h2><p><img src="https://i.imgur.com/FvK1lg2.png" alt="image1"></p>
<p><img src="https://i.imgur.com/1pQD2XE.png" alt="image2"></p>
<p><img src="https://i.imgur.com/KD5pigA.png" alt="image3"></p>
<p><img src="https://i.imgur.com/yZoC4kE.png" alt="ebs"></p>
<h2 id="Introducing-Kops"><a href="#Introducing-Kops" class="headerlink" title="Introducing Kops"></a>Introducing Kops</h2><p><a href="https://github.com/kubernetes/kops">Kops</a></p>
<p>This apparently is the easiest way to get a production-grade Kubernetes cluster up and running.</p>
<h2 id="Installing-the-Kops-Environment"><a href="#Installing-the-Kops-Environment" class="headerlink" title="Installing the Kops Environment"></a>Installing the Kops Environment</h2><p><a href="https://github.com/kubernetes/kops/blob/master/docs/aws.md">Deploy to aws</a></p>
<h2 id="Configuring-your-first-cluster"><a href="#Configuring-your-first-cluster" class="headerlink" title="Configuring your first cluster"></a>Configuring your first cluster</h2><p><a href="https://github.com/kubernetes/kops/blob/master/docs/aws.md#cluster-state-storage">Cluster State storage</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@foobar ~]$ export AWS_ACCESS_KEY_ID=$(aws configure get aws_access_key_id)</span><br><span class="line">[ec2-user@foobar ~]$ export AWS_SECRET_ACCESS_KEY=$(aws configure get aws_secret_access_key)</span><br><span class="line">[ec2-user@foobar ~]$ export NAME=fleetman.k8s.local</span><br><span class="line">[ec2-user@foobar ~]$ export KOPS_STATE_STORE=s3://stanzhou-state-storage</span><br><span class="line">[ec2-user@foobar ~]$ aws ec2 describe-availability-zones --region ap-southeast-2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;AvailabilityZones&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;State&quot;: &quot;available&quot;,</span><br><span class="line">            &quot;ZoneName&quot;: &quot;ap-southeast-2a&quot;,</span><br><span class="line">            &quot;Messages&quot;: [],</span><br><span class="line">            &quot;ZoneId&quot;: &quot;apse2-az1&quot;,</span><br><span class="line">            &quot;RegionName&quot;: &quot;ap-southeast-2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;State&quot;: &quot;available&quot;,</span><br><span class="line">            &quot;ZoneName&quot;: &quot;ap-southeast-2b&quot;,</span><br><span class="line">            &quot;Messages&quot;: [],</span><br><span class="line">            &quot;ZoneId&quot;: &quot;apse2-az3&quot;,</span><br><span class="line">            &quot;RegionName&quot;: &quot;ap-southeast-2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;State&quot;: &quot;available&quot;,</span><br><span class="line">            &quot;ZoneName&quot;: &quot;ap-southeast-2c&quot;,</span><br><span class="line">            &quot;Messages&quot;: [],</span><br><span class="line">            &quot;ZoneId&quot;: &quot;apse2-az2&quot;,</span><br><span class="line">            &quot;RegionName&quot;: &quot;ap-southeast-2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ kops create cluster --zones ap-southeast-2a,ap-southeast-2b,ap-southeast-2c $&#123;NAME&#125;</span><br><span class="line">I0607 06:10:02.189636    3468 create_cluster.go:519] Inferred --cloud=aws from zone &quot;ap-southeast-2a&quot;</span><br><span class="line">I0607 06:10:02.243690    3468 subnets.go:184] Assigned CIDR 172.20.32.0/19 to subnet ap-southeast-2a</span><br><span class="line">I0607 06:10:02.243802    3468 subnets.go:184] Assigned CIDR 172.20.64.0/19 to subnet ap-southeast-2b</span><br><span class="line">I0607 06:10:02.243857    3468 subnets.go:184] Assigned CIDR 172.20.96.0/19 to subnet ap-southeast-2c</span><br><span class="line">Previewing changes that will be made:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SSH public key must be specified when running with AWS (create with `kops create secret --name fleetman.k8s.local sshpublickey admin -i ~/.ssh/id_rsa.pub`)</span><br><span class="line"></span><br><span class="line">[ec2-user@foobar ~]$ ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa</span><br><span class="line">[ec2-user@foobar ~]$ kops create secret --name $&#123;NAME&#125; sshpublickey admin -i ~/.ssh/id_rsa.pub</span><br><span class="line">[ec2-user@foobar ~]$ kops edit ig nodes --name $&#123;NAME&#125;</span><br><span class="line">[ec2-user@foobar ~]$ kops get ig --name $&#123;NAME&#125;</span><br><span class="line">NAME                    ROLE    MACHINETYPE     MIN     MAX     ZONES</span><br><span class="line">master-ap-southeast-2a  Master  m3.medium       1       1       ap-southeast-2a</span><br><span class="line">nodes                   Node    t2.medium       3       5       ap-southeast-2a,ap-southeast-2b,ap-southeast-2c</span><br><span class="line">[ec2-user@foobar ~]$ kops edit ig master-ap-southeast-2a --name $&#123;NAME&#125;</span><br><span class="line">Edit cancelled, no changes made.</span><br></pre></td></tr></table></figure>
<h2 id="Running-the-Cluster"><a href="#Running-the-Cluster" class="headerlink" title="Running the Cluster"></a>Running the Cluster</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@i ~]$ kops update cluster $&#123;NAME&#125; --yes</span><br><span class="line">I0607 06:28:38.011102   32239 apply_cluster.go:559] Gossip DNS: skipping DNS validation</span><br><span class="line">I0607 06:28:38.263244   32239 executor.go:103] Tasks: 0 done / 94 total; 42 can run</span><br><span class="line">I0607 06:28:39.702035   32239 vfs_castore.go:729] Issuing new certificate: &quot;apiserver-aggregator-ca&quot;</span><br><span class="line">I0607 06:28:40.216189   32239 vfs_castore.go:729] Issuing new certificate: &quot;etcd-clients-ca&quot;</span><br><span class="line">I0607 06:28:40.356654   32239 vfs_castore.go:729] Issuing new certificate: &quot;etcd-peers-ca-main&quot;</span><br><span class="line">I0607 06:28:40.743191   32239 vfs_castore.go:729] Issuing new certificate: &quot;etcd-peers-ca-events&quot;</span><br><span class="line">I0607 06:28:40.824760   32239 vfs_castore.go:729] Issuing new certificate: &quot;etcd-manager-ca-events&quot;</span><br><span class="line">I0607 06:28:41.265388   32239 vfs_castore.go:729] Issuing new certificate: &quot;etcd-manager-ca-main&quot;</span><br><span class="line">I0607 06:28:41.373174   32239 vfs_castore.go:729] Issuing new certificate: &quot;ca&quot;</span><br><span class="line">I0607 06:28:41.551597   32239 executor.go:103] Tasks: 42 done / 94 total; 26 can run</span><br><span class="line">I0607 06:28:42.539134   32239 vfs_castore.go:729] Issuing new certificate: &quot;kube-scheduler&quot;</span><br><span class="line">I0607 06:28:42.891972   32239 vfs_castore.go:729] Issuing new certificate: &quot;kubecfg&quot;</span><br><span class="line">I0607 06:28:43.157916   32239 vfs_castore.go:729] Issuing new certificate: &quot;apiserver-proxy-client&quot;</span><br><span class="line">I0607 06:28:43.556052   32239 vfs_castore.go:729] Issuing new certificate: &quot;kubelet&quot;</span><br><span class="line">I0607 06:28:43.677894   32239 vfs_castore.go:729] Issuing new certificate: &quot;apiserver-aggregator&quot;</span><br><span class="line">I0607 06:28:43.748079   32239 vfs_castore.go:729] Issuing new certificate: &quot;kube-proxy&quot;</span><br><span class="line">I0607 06:28:44.025132   32239 vfs_castore.go:729] Issuing new certificate: &quot;kubelet-api&quot;</span><br><span class="line">I0607 06:28:44.589696   32239 vfs_castore.go:729] Issuing new certificate: &quot;kube-controller-manager&quot;</span><br><span class="line">I0607 06:28:44.730038   32239 vfs_castore.go:729] Issuing new certificate: &quot;kops&quot;</span><br><span class="line">I0607 06:28:44.864527   32239 executor.go:103] Tasks: 68 done / 94 total; 22 can run</span><br><span class="line">I0607 06:28:45.089177   32239 launchconfiguration.go:364] waiting for IAM instance profile &quot;masters.fleetman.k8s.local&quot; to be ready</span><br><span class="line">I0607 06:28:45.101954   32239 launchconfiguration.go:364] waiting for IAM instance profile &quot;nodes.fleetman.k8s.local&quot; to be ready</span><br><span class="line">I0607 06:28:55.483430   32239 executor.go:103] Tasks: 90 done / 94 total; 3 can run</span><br><span class="line">I0607 06:28:55.974524   32239 vfs_castore.go:729] Issuing new certificate: &quot;master&quot;</span><br><span class="line">I0607 06:28:56.119668   32239 executor.go:103] Tasks: 93 done / 94 total; 1 can run</span><br><span class="line">I0607 06:28:56.336766   32239 executor.go:103] Tasks: 94 done / 94 total; 0 can run</span><br><span class="line">I0607 06:28:56.407976   32239 update_cluster.go:291] Exporting kubecfg for cluster</span><br><span class="line">kops has set your kubectl context to fleetman.k8s.local</span><br><span class="line"></span><br><span class="line">Cluster is starting.  It should be ready in a few minutes.</span><br><span class="line"></span><br><span class="line">Suggestions:</span><br><span class="line"> * validate cluster: kops validate cluster</span><br><span class="line"> * list nodes: kubectl get nodes --show-labels</span><br><span class="line"> * ssh to the master: ssh -i ~/.ssh/id_rsa admin@api.fleetman.k8s.local</span><br><span class="line"> * the admin user is specific to Debian. If not using Debian please use the appropriate user based on your OS.</span><br><span class="line"> * read about installing addons at: https://github.com/kubernetes/kops/blob/master/docs/addons.md.</span><br><span class="line"></span><br><span class="line">[ec2-user@i ~]$ kops validate cluster</span><br><span class="line">Using cluster from kubectl context: fleetman.k8s.local</span><br><span class="line"></span><br><span class="line">Validating cluster fleetman.k8s.local</span><br><span class="line"></span><br><span class="line">INSTANCE GROUPS</span><br><span class="line">NAME                    ROLE    MACHINETYPE     MIN     MAX     SUBNETS</span><br><span class="line">master-ap-southeast-2a  Master  m3.medium       1       1       ap-southeast-2a</span><br><span class="line">nodes                   Node    t2.medium       3       5       ap-southeast-2a,ap-southeast-2b,ap-southeast-2c</span><br><span class="line"></span><br><span class="line">NODE STATUS</span><br><span class="line">NAME                                                    ROLE    READY</span><br><span class="line">ip-172-20-115-253.ap-southeast-2.compute.internal       node    True</span><br><span class="line">ip-172-20-39-212.ap-southeast-2.compute.internal        node    True</span><br><span class="line">ip-172-20-45-219.ap-southeast-2.compute.internal        master  True</span><br><span class="line">ip-172-20-89-8.ap-southeast-2.compute.internal          node    True</span><br><span class="line"></span><br><span class="line">Your cluster fleetman.k8s.local is ready</span><br><span class="line"></span><br><span class="line">[ec2-user@i ~]$ kubectl get all</span><br><span class="line">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes   ClusterIP   100.64.0.1   &lt;none&gt;        443/TCP   4m50s</span><br></pre></td></tr></table></figure>
<h2 id="Provisioning-SSD-drives-with-a-StorageClass"><a href="#Provisioning-SSD-drives-with-a-StorageClass" class="headerlink" title="Provisioning SSD drives with a StorageClass"></a>Provisioning SSD drives with a StorageClass</h2><p>We have a workloads yaml file, where we’d be finding the pods that we want to deploy to our cluster. We have mongostack which is a specialist file, just for the mongo database. We have storage.yaml, which is currently defining that we want to store the mongo data in a local directory on the host machine. And we have a yaml file for the services.</p>
<p>[aws ebs])<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#aws-ebs">https://kubernetes.io/docs/concepts/storage/storage-classes/#aws-ebs</a>)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@i ~]$ cat storage-aws.yaml</span><br><span class="line"># What do want?</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: mongo-pvc</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: cloud-ssd</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 7Gi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># How do we want it implemented</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: cloud-ssd</span><br><span class="line">provisioner: kubernetes.io/aws-ebs</span><br><span class="line">parameters:</span><br><span class="line">  type: gp2</span><br><span class="line"></span><br><span class="line">[ec2-user@ip-1 ~]$ kubectl get pvc</span><br><span class="line">NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">mongo-pvc   Bound    pvc-b2ed286e-88f3-11e9-b509-02985f983814   7Gi        RWO            cloud-ssd      3m45s</span><br><span class="line"></span><br><span class="line">[ec2-user@ip-1 ~]$ kubectl get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-b2ed286e-88f3-11e9-b509-02985f983814   7Gi        RWO            Delete           Bound    default/mongo-pvc   cloud-ssd               18s</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.imgur.com/91K0spE.png" alt="ebs volume created"></p>
<h2 id="Deploying-the-Fleetman-Workload"><a href="#Deploying-the-Fleetman-Workload" class="headerlink" title="Deploying the Fleetman Workload"></a>Deploying the Fleetman Workload</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-1-9 ~]$ cat services.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-webapp</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: webapp</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 80</span><br><span class="line"> type: LoadBalancer</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-queue</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: queue</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 8161</span><br><span class="line"></span><br><span class="line">   - name: endpoint</span><br><span class="line">     port: 61616</span><br><span class="line"></span><br><span class="line"> type: ClusterIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-position-tracker</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: position-tracker</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 8080</span><br><span class="line"></span><br><span class="line"> type: ClusterIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-api-gateway</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: api-gateway</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 8080</span><br><span class="line"></span><br><span class="line"> type: ClusterIP</span><br><span class="line"></span><br><span class="line">[ec2-user@ip-1-4-9 ~]$ cat workloads.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: queue</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: queue</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: queue</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: queue</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-queue:release2</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: position-simulator</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: position-simulator</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: position-simulator</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: position-simulator</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-position-simulator:release2</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: position-tracker</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: position-tracker</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: position-tracker</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: position-tracker</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-position-tracker:release3</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: api-gateway</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: api-gateway</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: api-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: api-gateway</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-api-gateway:release2</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: webapp</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: webapp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-webapp-angular:release2</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line">[ec2-user@-4-9 ~]$ kubectl apply -f .</span><br><span class="line">deployment.apps/mongodb unchanged</span><br><span class="line">service/fleetman-mongodb unchanged</span><br><span class="line">service/fleetman-webapp unchanged</span><br><span class="line">service/fleetman-queue unchanged</span><br><span class="line">service/fleetman-position-tracker unchanged</span><br><span class="line">service/fleetman-api-gateway unchanged</span><br><span class="line">persistentvolumeclaim/mongo-pvc unchanged</span><br><span class="line">storageclass.storage.k8s.io/cloud-ssd unchanged</span><br><span class="line">deployment.apps/queue configured</span><br><span class="line">deployment.apps/position-simulator configured</span><br><span class="line">deployment.apps/position-tracker unchanged</span><br><span class="line">deployment.apps/api-gateway configured</span><br><span class="line">deployment.apps/webapp configured</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get all</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/api-gateway-5d445d6f69-5gmm4          1/1     Running   0          82s</span><br><span class="line">pod/mongodb-5559556bf-jjkpw               1/1     Running   0          20m</span><br><span class="line">pod/position-simulator-7ffd4f8f68-2gnjr   1/1     Running   0          82s</span><br><span class="line">pod/position-tracker-5ff4fb7479-jjj9f     1/1     Running   0          11m</span><br><span class="line">pod/queue-75f4ddd795-6vn9d                1/1     Running   0          82s</span><br><span class="line">pod/webapp-689dd9b4f4-ntdpz               1/1     Running   0          82s</span><br><span class="line"></span><br><span class="line">NAME                                TYPE           CLUSTER-IP       EXTERNAL-IP                                                                    PORT(S)              AGE</span><br><span class="line">service/fleetman-api-gateway        ClusterIP      100.65.245.184   &lt;none&gt;                                                                         8080/TCP             11m</span><br><span class="line">service/fleetman-mongodb            ClusterIP      100.70.242.251   &lt;none&gt;                                                                         27017/TCP            20m</span><br><span class="line">service/fleetman-position-tracker   ClusterIP      100.70.48.51     &lt;none&gt;                                                                         8080/TCP             11m</span><br><span class="line">service/fleetman-queue              ClusterIP      100.65.176.119   &lt;none&gt;                                                                         8161/TCP,61616/TCP   11m</span><br><span class="line">service/fleetman-webapp             LoadBalancer   100.70.56.219    a660e0c5e88f611e9b50902985f98381-1044209190.ap-southeast-2.elb.amazonaws.com   80:30149/TCP         11m</span><br><span class="line">service/kubernetes                  ClusterIP      100.64.0.1       &lt;none&gt;                                                                         443/TCP              68m</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/api-gateway          1         1         1            1           11m</span><br><span class="line">deployment.apps/mongodb              1         1         1            1           20m</span><br><span class="line">deployment.apps/position-simulator   1         1         1            1           11m</span><br><span class="line">deployment.apps/position-tracker     1         1         1            1           11m</span><br><span class="line">deployment.apps/queue                1         1         1            1           11m</span><br><span class="line">deployment.apps/webapp               1         1         1            1           11m</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/api-gateway-5d445d6f69          1         1         1       82s</span><br><span class="line">replicaset.apps/api-gateway-6d7dccc464          0         0         0       11m</span><br><span class="line">replicaset.apps/mongodb-5559556bf               1         1         1       20m</span><br><span class="line">replicaset.apps/position-simulator-549554f4d9   0         0         0       11m</span><br><span class="line">replicaset.apps/position-simulator-7ffd4f8f68   1         1         1       82s</span><br><span class="line">replicaset.apps/position-tracker-5ff4fb7479     1         1         1       11m</span><br><span class="line">replicaset.apps/queue-75f4ddd795                1         1         1       82s</span><br><span class="line">replicaset.apps/queue-b46577b46                 0         0         0       11m</span><br><span class="line">replicaset.apps/webapp-689dd9b4f4               1         1         1       82s</span><br><span class="line">replicaset.apps/webapp-6cdd565c5                0         0         0       11m</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl log -f pod/position-tracker-5ff4fb7479-jjj9f</span><br><span class="line">log is DEPRECATED and will be removed in a future version. Use logs instead.</span><br><span class="line">2019-06-07 07:42:40.878 ERROR 1 --- [enerContainer-1] o.s.j.l.DefaultMessageListenerContainer  : Could not refresh JMS Connection for destination &apos;positionQueue&apos; - retrying using FixedBackOff&#123;interval=5000, currentAttempts=15, maxAttempts=unlimited&#125;. Cause: Could not connect to broker URL: tcp://fleetman-queue.default.svc.cluster.local:61616. Reason: java.net.SocketException: Socket closed</span><br><span class="line">2019-06-07 07:42:46.002  INFO 1 --- [enerContainer-1] o.s.j.l.DefaultMessageListenerContainer  : Successfully refreshed JMS Connection</span><br><span class="line">2019-06-07 07:42:47.440  INFO 1 --- [nio-8080-exec-8] org.mongodb.driver.connection            : Opened connection [connectionId&#123;localValue:3, serverValue:3&#125;] to fleetman-mongodb.default.svc.cluster.local:27017</span><br><span class="line">illljffkkkkerror: unexpected EOF</span><br></pre></td></tr></table></figure>
<p>Docker swarm uses a concept called a rooting, or routing, mesh to find the node that your web application is running on. None of that is used here, it uses a standard AWS load balancer to find the correct node.</p>
<h2 id="Setting-up-a-real-Domain-Name"><a href="#Setting-up-a-real-Domain-Name" class="headerlink" title="Setting up a real Domain Name"></a>Setting up a real Domain Name</h2><p>Add a CNAME record in your own domain to ELB address.</p>
<h2 id="Surviving-Node-Failure"><a href="#Surviving-Node-Failure" class="headerlink" title="Surviving Node Failure"></a>Surviving Node Failure</h2><h3 id="Requirement"><a href="#Requirement" class="headerlink" title="Requirement"></a>Requirement</h3><hr>
<p>Even in the vent of a Node (or Availability Zone) failure, the web site must be accessible</p>
<p>It doesn’t matter if reports from vehicles stop coming in, as long as service is restored within a few minutes</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@foobar ~]$ kubectl get pods</span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">api-gateway-5d445d6f69-5gmm4          1/1     Running   0          93m</span><br><span class="line">mongodb-5559556bf-jjkpw               1/1     Running   0          112m</span><br><span class="line">position-simulator-7ffd4f8f68-2gnjr   1/1     Running   0          93m</span><br><span class="line">position-tracker-5ff4fb7479-jjj9f     1/1     Running   0          103m</span><br><span class="line">queue-75f4ddd795-6vn9d                1/1     Running   0          93m</span><br><span class="line">webapp-689dd9b4f4-ntdpz               1/1     Running   0          93m</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get pods -o wide</span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE    IP           NODE                                                NOMINATED NODE</span><br><span class="line">api-gateway-5d445d6f69-5gmm4          1/1     Running   0          93m    100.96.3.5   ip-172-20-39-212.ap-southeast-2.compute.internal    &lt;none&gt;</span><br><span class="line">mongodb-5559556bf-jjkpw               1/1     Running   0          112m   100.96.1.4   ip-172-20-89-8.ap-southeast-2.compute.internal      &lt;none&gt;</span><br><span class="line">position-simulator-7ffd4f8f68-2gnjr   1/1     Running   0          93m    100.96.2.5   ip-172-20-115-253.ap-southeast-2.compute.internal   &lt;none&gt;</span><br><span class="line">position-tracker-5ff4fb7479-jjj9f     1/1     Running   0          103m   100.96.3.4   ip-172-20-39-212.ap-southeast-2.compute.internal    &lt;none&gt;</span><br><span class="line">queue-75f4ddd795-6vn9d                1/1     Running   0          93m    100.96.1.5   ip-172-20-89-8.ap-southeast-2.compute.internal      &lt;none&gt;</span><br><span class="line">webapp-689dd9b4f4-ntdpz               1/1     Running   0          93m    100.96.2.6   ip-172-20-115-253.ap-southeast-2.compute.internal   &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Replicating-Pods"><a href="#Replicating-Pods" class="headerlink" title="Replicating Pods"></a>Replicating Pods</h2><p>For our example, take the queue pod, give it two replicas and therefore, in the event of a node failure, one of the nodes will always survive. Unfortunately you can’t do that because this particular pod, the queue pod is stateful. In other words, it contains data. And because it contains data, if you replicate it, you’re going to end up with a kind of a split brain situation, where half the data is in one part, half the data is in the other part. And all kinds of chaos will follow on from that. Really what you’re aiming for with any pod is to make it stateless, so it’s not holding data.</p>
<h2 id="Deleting-the-Cluster"><a href="#Deleting-the-Cluster" class="headerlink" title="Deleting the Cluster"></a>Deleting the Cluster</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@foobar ~]$ export NAME=fleetman.k8s.local</span><br><span class="line">[ec2-user@foobar ~]$ kops delete cluster --name $&#123;NAME&#125; --yes</span><br><span class="line"></span><br><span class="line">State Store: Required value: Please set the --state flag or export KOPS_STATE_STORE.</span><br><span class="line">For example, a valid value follows the format s3://&lt;bucket&gt;.</span><br><span class="line">You can find the supported stores in https://github.com/kubernetes/kops/blob/master/docs/state.md.</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ export KOPS_STATE_STORE=s3://stanzhou-state-storage</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kops delete cluster --name $&#123;NAME&#125; --yes</span><br><span class="line">TYPE                    NAME                                                                            ID</span><br><span class="line">autoscaling-config      master-ap-southeast-2a.masters.fleetman.k8s.local-20190607062844                master-ap-southeast-2a.masters.fleetman.k8s.local-20190607062844</span><br><span class="line">autoscaling-config      nodes.fleetman.k8s.local-20190607062844                                         nodes.fleetman.k8s.local-20190607062844</span><br><span class="line">autoscaling-group       master-ap-southeast-2a.masters.fleetman.k8s.local                               master-ap-southeast-2a.masters.fleetman.k8s.local</span><br><span class="line">autoscaling-group       nodes.fleetman.k8s.local                                                        nodes.fleetman.k8s.local</span><br><span class="line">dhcp-options            fleetman.k8s.local                                                              dopt-0a0be88814a0c83a9</span><br><span class="line">iam-instance-profile    masters.fleetman.k8s.local                                                      masters.fleetman.k8s.local</span><br><span class="line">iam-instance-profile    nodes.fleetman.k8s.local                                                        nodes.fleetman.k8s.local</span><br><span class="line">iam-role                masters.fleetman.k8s.local                                                      masters.fleetman.k8s.local</span><br><span class="line">iam-role                nodes.fleetman.k8s.local                                                        nodes.fleetman.k8s.local</span><br><span class="line">instance                master-ap-southeast-2a.masters.fleetman.k8s.local                               i-012c7c446b65343d4</span><br><span class="line">instance                nodes.fleetman.k8s.local                                                        i-07583ee103342be9a</span><br><span class="line">instance                nodes.fleetman.k8s.local                                                        i-079cea61e4a7736b9</span><br><span class="line">instance                nodes.fleetman.k8s.local                                                        i-0bf949dbd290d81c3</span><br><span class="line">internet-gateway        fleetman.k8s.local                                                              igw-0a939d66d6e93e0d5</span><br><span class="line">keypair                 kubernetes.fleetman.k8s.local-fc:11:5b:a8:1d:16:4a:36:36:15:2d:9f:f3:69:d2:0a   kubernetes.fleetman.k8s.local-fc:11:5b:a8:1d:16:4a:36:36:15:2d:9f:f3:69:d2:0a</span><br><span class="line">load-balancer                                                                                           a660e0c5e88f611e9b50902985f98381</span><br><span class="line">load-balancer           api.fleetman.k8s.local                                                          api-fleetman-k8s-local-tkmafs</span><br><span class="line">route-table             fleetman.k8s.local                                                              rtb-06b591f24a01973f6</span><br><span class="line">security-group                                                                                          sg-07b79756088cf753c</span><br><span class="line">security-group          api-elb.fleetman.k8s.local                                                      sg-005c9b49b63793004</span><br><span class="line">security-group          masters.fleetman.k8s.local                                                      sg-07ef00367ce1a7b62</span><br><span class="line">security-group          nodes.fleetman.k8s.local                                                        sg-01f81918cdbaba212</span><br><span class="line">subnet                  ap-southeast-2a.fleetman.k8s.local                                              subnet-060ec2db19027cf6a</span><br><span class="line">subnet                  ap-southeast-2b.fleetman.k8s.local                                              subnet-0def003bdbfd97915</span><br><span class="line">subnet                  ap-southeast-2c.fleetman.k8s.local                                              subnet-0016862a30fe5f443</span><br><span class="line">volume                  a.etcd-events.fleetman.k8s.local                                                vol-0d21c97044fcc06dd</span><br><span class="line">volume                  a.etcd-main.fleetman.k8s.local                                                  vol-0f1c9f3e983c5848a</span><br><span class="line">volume                  fleetman.k8s.local-dynamic-pvc-b2ed286e-88f3-11e9-b509-02985f983814             vol-074914e494e4b656d</span><br><span class="line">vpc                     fleetman.k8s.local                                                              vpc-0775d4b463932d2f7</span><br><span class="line"></span><br><span class="line">load-balancer:api-fleetman-k8s-local-tkmafs     ok</span><br><span class="line">load-balancer:a660e0c5e88f611e9b50902985f98381  ok</span><br><span class="line">autoscaling-group:nodes.fleetman.k8s.local      ok</span><br><span class="line">keypair:kubernetes.fleetman.k8s.local-fc:11:5b:a8:1d:16:4a:36:36:15:2d:9f:f3:69:d2:0a   ok</span><br><span class="line">internet-gateway:igw-0a939d66d6e93e0d5  still has dependencies, will retry</span><br><span class="line">autoscaling-group:master-ap-southeast-2a.masters.fleetman.k8s.local     ok</span><br><span class="line">instance:i-012c7c446b65343d4    ok</span><br><span class="line">instance:i-07583ee103342be9a    ok</span><br><span class="line">instance:i-0bf949dbd290d81c3    ok</span><br><span class="line">instance:i-079cea61e4a7736b9    ok</span><br><span class="line">iam-instance-profile:nodes.fleetman.k8s.local   ok</span><br><span class="line">iam-instance-profile:masters.fleetman.k8s.local ok</span><br><span class="line">iam-role:nodes.fleetman.k8s.local       ok</span><br><span class="line">iam-role:masters.fleetman.k8s.local     ok</span><br><span class="line">subnet:subnet-0def003bdbfd97915 still has dependencies, will retry</span><br><span class="line">subnet:subnet-0016862a30fe5f443 still has dependencies, will retry</span><br><span class="line">autoscaling-config:nodes.fleetman.k8s.local-20190607062844      ok</span><br><span class="line">volume:vol-0d21c97044fcc06dd    still has dependencies, will retry</span><br><span class="line">autoscaling-config:master-ap-southeast-2a.masters.fleetman.k8s.local-20190607062844     ok</span><br><span class="line">volume:vol-0f1c9f3e983c5848a    still has dependencies, will retry</span><br><span class="line">subnet:subnet-060ec2db19027cf6a still has dependencies, will retry</span><br><span class="line">volume:vol-074914e494e4b656d    still has dependencies, will retry</span><br><span class="line">security-group:sg-005c9b49b63793004     still has dependencies, will retry</span><br><span class="line">security-group:sg-01f81918cdbaba212     still has dependencies, will retry</span><br><span class="line">security-group:sg-07b79756088cf753c     still has dependencies, will retry</span><br><span class="line">security-group:sg-07ef00367ce1a7b62     still has dependencies, will retry</span><br><span class="line">Not all resources deleted; waiting before reattempting deletion</span><br><span class="line">        route-table:rtb-06b591f24a01973f6</span><br><span class="line">        internet-gateway:igw-0a939d66d6e93e0d5</span><br><span class="line">        security-group:sg-005c9b49b63793004</span><br><span class="line">        subnet:subnet-060ec2db19027cf6a</span><br><span class="line">        security-group:sg-07b79756088cf753c</span><br><span class="line">        subnet:subnet-0016862a30fe5f443</span><br><span class="line">        subnet:subnet-0def003bdbfd97915</span><br><span class="line">        security-group:sg-07ef00367ce1a7b62</span><br><span class="line">        volume:vol-0d21c97044fcc06dd</span><br><span class="line">        dhcp-options:dopt-0a0be88814a0c83a9</span><br><span class="line">        volume:vol-074914e494e4b656d</span><br><span class="line">        security-group:sg-01f81918cdbaba212</span><br><span class="line">        volume:vol-0f1c9f3e983c5848a</span><br><span class="line">        vpc:vpc-0775d4b463932d2f7</span><br><span class="line">subnet:subnet-060ec2db19027cf6a still has dependencies, will retry</span><br><span class="line">subnet:subnet-0def003bdbfd97915 still has dependencies, will retry</span><br><span class="line">subnet:subnet-0016862a30fe5f443 still has dependencies, will retry</span><br><span class="line">volume:vol-074914e494e4b656d    still has dependencies, will retry</span><br><span class="line">volume:vol-0f1c9f3e983c5848a    still has dependencies, will retry</span><br><span class="line">internet-gateway:igw-0a939d66d6e93e0d5  still has dependencies, will retry</span><br><span class="line">volume:vol-0d21c97044fcc06dd    still has dependencies, will retry</span><br><span class="line">security-group:sg-01f81918cdbaba212     still has dependencies, will retry</span><br><span class="line">security-group:sg-005c9b49b63793004     still has dependencies, will retry</span><br><span class="line">security-group:sg-07ef00367ce1a7b62     still has dependencies, will retry</span><br><span class="line">security-group:sg-07b79756088cf753c     still has dependencies, will retry</span><br><span class="line">Not all resources deleted; waiting before reattempting deletion</span><br><span class="line">        volume:vol-074914e494e4b656d</span><br><span class="line">        security-group:sg-01f81918cdbaba212</span><br><span class="line">        volume:vol-0f1c9f3e983c5848a</span><br><span class="line">        vpc:vpc-0775d4b463932d2f7</span><br><span class="line">        route-table:rtb-06b591f24a01973f6</span><br><span class="line">        internet-gateway:igw-0a939d66d6e93e0d5</span><br><span class="line">        security-group:sg-005c9b49b63793004</span><br><span class="line">        subnet:subnet-060ec2db19027cf6a</span><br><span class="line">        subnet:subnet-0016862a30fe5f443</span><br><span class="line">        security-group:sg-07b79756088cf753c</span><br><span class="line">        volume:vol-0d21c97044fcc06dd</span><br><span class="line">        subnet:subnet-0def003bdbfd97915</span><br><span class="line">        security-group:sg-07ef00367ce1a7b62</span><br><span class="line">        dhcp-options:dopt-0a0be88814a0c83a9</span><br><span class="line">subnet:subnet-060ec2db19027cf6a still has dependencies, will retry</span><br><span class="line">subnet:subnet-0def003bdbfd97915 still has dependencies, will retry</span><br><span class="line">volume:vol-0f1c9f3e983c5848a    still has dependencies, will retry</span><br><span class="line">volume:vol-0d21c97044fcc06dd    still has dependencies, will retry</span><br><span class="line">internet-gateway:igw-0a939d66d6e93e0d5  still has dependencies, will retry</span><br><span class="line">volume:vol-074914e494e4b656d    still has dependencies, will retry</span><br><span class="line">subnet:subnet-0016862a30fe5f443 still has dependencies, will retry</span><br><span class="line">security-group:sg-07b79756088cf753c     still has dependencies, will retry</span><br><span class="line">security-group:sg-01f81918cdbaba212     still has dependencies, will retry</span><br><span class="line">security-group:sg-07ef00367ce1a7b62     still has dependencies, will retry</span><br><span class="line">security-group:sg-005c9b49b63793004     still has dependencies, will retry</span><br><span class="line">Not all resources deleted; waiting before reattempting deletion</span><br><span class="line">        route-table:rtb-06b591f24a01973f6</span><br><span class="line">        internet-gateway:igw-0a939d66d6e93e0d5</span><br><span class="line">        security-group:sg-005c9b49b63793004</span><br><span class="line">        subnet:subnet-060ec2db19027cf6a</span><br><span class="line">        subnet:subnet-0016862a30fe5f443</span><br><span class="line">        security-group:sg-07b79756088cf753c</span><br><span class="line">        volume:vol-0d21c97044fcc06dd</span><br><span class="line">        subnet:subnet-0def003bdbfd97915</span><br><span class="line">        security-group:sg-07ef00367ce1a7b62</span><br><span class="line">        dhcp-options:dopt-0a0be88814a0c83a9</span><br><span class="line">        volume:vol-074914e494e4b656d</span><br><span class="line">        security-group:sg-01f81918cdbaba212</span><br><span class="line">        volume:vol-0f1c9f3e983c5848a</span><br><span class="line">        vpc:vpc-0775d4b463932d2f7</span><br><span class="line">subnet:subnet-0def003bdbfd97915 still has dependencies, will retry</span><br><span class="line">subnet:subnet-060ec2db19027cf6a still has dependencies, will retry</span><br><span class="line">internet-gateway:igw-0a939d66d6e93e0d5  still has dependencies, will retry</span><br><span class="line">volume:vol-074914e494e4b656d    still has dependencies, will retry</span><br><span class="line">volume:vol-0d21c97044fcc06dd    ok</span><br><span class="line">volume:vol-0f1c9f3e983c5848a    ok</span><br><span class="line">security-group:sg-01f81918cdbaba212     still has dependencies, will retry</span><br><span class="line">subnet:subnet-0016862a30fe5f443 ok</span><br><span class="line">security-group:sg-07b79756088cf753c     still has dependencies, will retry</span><br><span class="line">security-group:sg-07ef00367ce1a7b62     still has dependencies, will retry</span><br><span class="line">security-group:sg-005c9b49b63793004     still has dependencies, will retry</span><br><span class="line">Not all resources deleted; waiting before reattempting deletion</span><br><span class="line">        dhcp-options:dopt-0a0be88814a0c83a9</span><br><span class="line">        volume:vol-074914e494e4b656d</span><br><span class="line">        security-group:sg-01f81918cdbaba212</span><br><span class="line">        vpc:vpc-0775d4b463932d2f7</span><br><span class="line">        route-table:rtb-06b591f24a01973f6</span><br><span class="line">        internet-gateway:igw-0a939d66d6e93e0d5</span><br><span class="line">        security-group:sg-005c9b49b63793004</span><br><span class="line">        subnet:subnet-060ec2db19027cf6a</span><br><span class="line">        security-group:sg-07b79756088cf753c</span><br><span class="line">        subnet:subnet-0def003bdbfd97915</span><br><span class="line">        security-group:sg-07ef00367ce1a7b62</span><br><span class="line">internet-gateway:igw-0a939d66d6e93e0d5  still has dependencies, will retry</span><br><span class="line">volume:vol-074914e494e4b656d    ok</span><br><span class="line">subnet:subnet-060ec2db19027cf6a still has dependencies, will retry</span><br><span class="line">security-group:sg-01f81918cdbaba212     still has dependencies, will retry</span><br><span class="line">security-group:sg-005c9b49b63793004     still has dependencies, will retry</span><br><span class="line">security-group:sg-07b79756088cf753c     still has dependencies, will retry</span><br><span class="line">subnet:subnet-0def003bdbfd97915 ok</span><br><span class="line">security-group:sg-07ef00367ce1a7b62     ok</span><br><span class="line">Not all resources deleted; waiting before reattempting deletion</span><br><span class="line">        security-group:sg-01f81918cdbaba212</span><br><span class="line">        vpc:vpc-0775d4b463932d2f7</span><br><span class="line">        route-table:rtb-06b591f24a01973f6</span><br><span class="line">        internet-gateway:igw-0a939d66d6e93e0d5</span><br><span class="line">        security-group:sg-005c9b49b63793004</span><br><span class="line">        subnet:subnet-060ec2db19027cf6a</span><br><span class="line">        security-group:sg-07b79756088cf753c</span><br><span class="line">        dhcp-options:dopt-0a0be88814a0c83a9</span><br><span class="line">subnet:subnet-060ec2db19027cf6a still has dependencies, will retry</span><br><span class="line">security-group:sg-005c9b49b63793004     still has dependencies, will retry</span><br><span class="line">security-group:sg-07b79756088cf753c     still has dependencies, will retry</span><br><span class="line">internet-gateway:igw-0a939d66d6e93e0d5  ok</span><br><span class="line">security-group:sg-01f81918cdbaba212     ok</span><br><span class="line">Not all resources deleted; waiting before reattempting deletion</span><br><span class="line">        dhcp-options:dopt-0a0be88814a0c83a9</span><br><span class="line">        vpc:vpc-0775d4b463932d2f7</span><br><span class="line">        route-table:rtb-06b591f24a01973f6</span><br><span class="line">        security-group:sg-005c9b49b63793004</span><br><span class="line">        subnet:subnet-060ec2db19027cf6a</span><br><span class="line">        security-group:sg-07b79756088cf753c</span><br><span class="line">subnet:subnet-060ec2db19027cf6a ok</span><br><span class="line">security-group:sg-005c9b49b63793004     ok</span><br><span class="line">security-group:sg-07b79756088cf753c     ok</span><br><span class="line">route-table:rtb-06b591f24a01973f6       ok</span><br><span class="line">vpc:vpc-0775d4b463932d2f7       ok</span><br><span class="line">dhcp-options:dopt-0a0be88814a0c83a9     ok</span><br><span class="line">Deleted kubectl config for fleetman.k8s.local</span><br><span class="line"></span><br><span class="line">Deleted cluster: &quot;fleetman.k8s.local&quot;</span><br></pre></td></tr></table></figure>
<h3 id="Restarting-the-Cluster"><a href="#Restarting-the-Cluster" class="headerlink" title="Restarting the Cluster"></a>Restarting the Cluster</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@foobar ~]$ history|grep export</span><br><span class="line">    4  export NAME=fleetman.k8s.local</span><br><span class="line">    6  export KOPS_STATE_STORE=s3://stanzhou-state-storage</span><br><span class="line"></span><br><span class="line">kops create cluster --zones ap-southeast-2a,ap-southeast-2b,ap-southeast-2c $&#123;NAME&#125;</span><br><span class="line"></span><br><span class="line">kops edit ig --name=fleetman.k8s.local nodes</span><br><span class="line">kops update cluster $&#123;NAME&#125; --yes</span><br><span class="line">kops validate cluster</span><br><span class="line">kubectl apply -f .</span><br><span class="line">kubectl get svc</span><br><span class="line">kubectl describe svc fleetman-webapp</span><br></pre></td></tr></table></figure>
<h1 id="Logging-a-Cluster"><a href="#Logging-a-Cluster" class="headerlink" title="Logging a Cluster"></a>Logging a Cluster</h1><h2 id="Introducing-the-ELK-ElasticStack"><a href="#Introducing-the-ELK-ElasticStack" class="headerlink" title="Introducing the ELK/ElasticStack"></a>Introducing the ELK/ElasticStack</h2><p><img src="https://i.imgur.com/YRocsbG.png" alt="ELK Stack"><br><img src="https://i.imgur.com/VZihLCY.png" alt="ELK Stack2"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get po</span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">api-gateway-5d445d6f69-kg68n          1/1     Running   0          19h</span><br><span class="line">mongodb-5559556bf-ghq5p               1/1     Running   0          19h</span><br><span class="line">position-simulator-7ffd4f8f68-kwlcb   1/1     Running   0          19h</span><br><span class="line">position-tracker-5ff4fb7479-2ctzt     1/1     Running   0          19h</span><br><span class="line">queue-75f4ddd795-wp2mh                1/1     Running   0          10h</span><br><span class="line">webapp-689dd9b4f4-php92               1/1     Running   0          19h</span><br><span class="line">webapp-689dd9b4f4-vgtpg               1/1     Running   0          19h</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get svc</span><br><span class="line">NAME                        TYPE           CLUSTER-IP       EXTERNAL-IP                                                                    PORT(S)              AGE</span><br><span class="line">fleetman-api-gateway        ClusterIP      100.67.195.111   &lt;none&gt;                                                                         8080/TCP             20h</span><br><span class="line">fleetman-mongodb            ClusterIP      100.68.143.136   &lt;none&gt;                                                                         27017/TCP            20h</span><br><span class="line">fleetman-position-tracker   ClusterIP      100.69.119.23    &lt;none&gt;                                                                         8080/TCP             20h</span><br><span class="line">fleetman-queue              ClusterIP      100.65.16.172    &lt;none&gt;                                                                         8161/TCP,61616/TCP   20h</span><br><span class="line">fleetman-webapp             LoadBalancer   100.70.168.148   ac185d1638c0311e9bef7028ed3b83c9-1696162465.ap-southeast-2.elb.amazonaws.com   80:31504/TCP         20h</span><br><span class="line">kubernetes                  ClusterIP      100.64.0.1       &lt;none&gt;                                                                         443/TCP              20h</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get svc -n kube-system</span><br><span class="line">NAME                    TYPE           CLUSTER-IP       EXTERNAL-IP                                                                   PORT(S)          AGE</span><br><span class="line">elasticsearch-logging   ClusterIP      100.68.193.244   &lt;none&gt;                                                                        9200/TCP         19h</span><br><span class="line">kibana-logging          LoadBalancer   100.67.153.183   a3c20f00a8c0811e9bef7028ed3b83c9-306741856.ap-southeast-2.elb.amazonaws.com   5601:32716/TCP   19h</span><br><span class="line">kube-dns                ClusterIP      100.64.0.10      &lt;none&gt;                                                                        53/UDP,53/TCP    20h</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl describe svc kibana-logging -n kube-system</span><br><span class="line">Name:                     kibana-logging</span><br><span class="line">Namespace:                kube-system</span><br><span class="line">Labels:                   addonmanager.kubernetes.io/mode=Reconcile</span><br><span class="line">                          k8s-app=kibana-logging</span><br><span class="line">                          kubernetes.io/cluster-service=true</span><br><span class="line">                          kubernetes.io/name=Kibana</span><br><span class="line">Annotations:              kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                            &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Service&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;addonmanager.kubernetes.io/mode&quot;:&quot;Reconcile&quot;,&quot;k8s-app&quot;:&quot;kibana...</span><br><span class="line">Selector:                 k8s-app=kibana-logging</span><br><span class="line">Type:                     LoadBalancer</span><br><span class="line">IP:                       100.67.153.183</span><br><span class="line">LoadBalancer Ingress:     a3c20f00a8c0811e9bef7028ed3b83c9-306741856.ap-southeast-2.elb.amazonaws.com</span><br><span class="line">Port:                     &lt;unset&gt;  5601/TCP</span><br><span class="line">TargetPort:               ui/TCP</span><br><span class="line">NodePort:                 &lt;unset&gt;  32716/TCP</span><br><span class="line">Endpoints:                100.96.1.5:5601</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h1 id="MONITORING-WITH-PROMETHEUS-AND-GRAFANA"><a href="#MONITORING-WITH-PROMETHEUS-AND-GRAFANA" class="headerlink" title="MONITORING WITH PROMETHEUS AND GRAFANA"></a>MONITORING WITH PROMETHEUS AND GRAFANA</h1><h2 id="Monitoring-a-Cluster"><a href="#Monitoring-a-Cluster" class="headerlink" title="Monitoring a Cluster"></a>Monitoring a Cluster</h2><p><a href="https://prometheus.io/">Prometheus</a><br><a href="https://grafana.com">Grafana</a><br>Concerntrate solely on integrating Grafana with Prometheus.</p>
<h2 id="Helm-Package-Manager"><a href="#Helm-Package-Manager" class="headerlink" title="Helm Package Manager"></a>Helm Package Manager</h2><p>The Kubernetes package manager <a href="https://helm.sh">Helm</a></p>
<p>Install Helm:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">wget https://get.helm.sh/helm-v2.14.1-linux-amd64.tar.gz</span><br><span class="line">tar zxvf helm-v2.14.1-linux-amd64.tar.gz</span><br><span class="line">sudo mv linux-amd64/helm /usr/local/bin/</span><br><span class="line">rm helm-v2.14.1-linux-amd64.tar.gz</span><br><span class="line">rm -rf ./linux-amd64/</span><br><span class="line">helm --help</span><br><span class="line">helm version</span><br><span class="line">helm init</span><br><span class="line"></span><br><span class="line">kubectl create serviceaccount --namespace kube-system tiller</span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span><br><span class="line"></span><br><span class="line">kubectl patch deploy --namespace kube-system tiller-deploy -p &apos;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;spec&quot;:&#123;&quot;serviceAccount&quot;:&quot;tiller&quot;&#125;&#125;&#125;&#125;&apos;</span><br></pre></td></tr></table></figure></p>
<p>Delete Helm:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm ls</span><br><span class="line">helm delete --purge my-special-installation</span><br><span class="line">kubectl get po</span><br></pre></td></tr></table></figure></p>
<h2 id="Installing-Prometheus-Operator"><a href="#Installing-Prometheus-Operator" class="headerlink" title="Installing Prometheus Operator"></a>Installing Prometheus Operator</h2><p><a href="https://github.com/helm/charts/tree/master/stable/prometheus-operator">install</a></p>
<p><code>helm install --name monitoring --namespace monitoring stable/prometheus-operator</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get all -n monitoring</span><br><span class="line">NAME                                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/alertmanager-monitoring-prometheus-oper-alertmanager-0   2/2     Running   0          4m</span><br><span class="line">pod/monitoring-grafana-c768bb86f-cgmj8                       2/2     Running   0          4m27s</span><br><span class="line">pod/monitoring-kube-state-metrics-6488587c6-zrjmg            1/1     Running   0          4m27s</span><br><span class="line">pod/monitoring-prometheus-node-exporter-5cp7v                1/1     Running   0          4m27s</span><br><span class="line">pod/monitoring-prometheus-node-exporter-75v99                1/1     Running   0          4m27s</span><br><span class="line">pod/monitoring-prometheus-node-exporter-jcl7r                1/1     Running   0          4m27s</span><br><span class="line">pod/monitoring-prometheus-node-exporter-vptns                1/1     Running   0          4m27s</span><br><span class="line">pod/monitoring-prometheus-oper-operator-7b54f56766-j8k6c     1/1     Running   0          4m27s</span><br><span class="line">pod/prometheus-monitoring-prometheus-oper-prometheus-0       3/3     Running   1          3m52s</span><br><span class="line"></span><br><span class="line">NAME                                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">service/alertmanager-operated                     ClusterIP   None             &lt;none&gt;        9093/TCP,6783/TCP   4m</span><br><span class="line">service/monitoring-grafana                        ClusterIP   100.70.116.236   &lt;none&gt;        80/TCP              4m28s</span><br><span class="line">service/monitoring-kube-state-metrics             ClusterIP   100.67.183.154   &lt;none&gt;        8080/TCP            4m28s</span><br><span class="line">service/monitoring-prometheus-node-exporter       ClusterIP   100.68.145.110   &lt;none&gt;        9100/TCP            4m28s</span><br><span class="line">service/monitoring-prometheus-oper-alertmanager   ClusterIP   100.70.75.68     &lt;none&gt;        9093/TCP            4m28s</span><br><span class="line">service/monitoring-prometheus-oper-operator       ClusterIP   100.66.237.147   &lt;none&gt;        8080/TCP            4m28s</span><br><span class="line">service/monitoring-prometheus-oper-prometheus     ClusterIP   100.67.205.22    &lt;none&gt;        9090/TCP            4m28s</span><br><span class="line">service/prometheus-operated                       ClusterIP   None             &lt;none&gt;        9090/TCP            3m53s</span><br><span class="line"></span><br><span class="line">NAME                                                 DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/monitoring-prometheus-node-exporter   4         4         4       4            4           &lt;none&gt;          4m27s</span><br><span class="line"></span><br><span class="line">NAME                                                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/monitoring-grafana                    1         1         1            1           4m27s</span><br><span class="line">deployment.apps/monitoring-kube-state-metrics         1         1         1            1           4m27s</span><br><span class="line">deployment.apps/monitoring-prometheus-oper-operator   1         1         1            1           4m27s</span><br><span class="line"></span><br><span class="line">NAME                                                             DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/monitoring-grafana-c768bb86f                     1         1         1       4m27s</span><br><span class="line">replicaset.apps/monitoring-kube-state-metrics-6488587c6          1         1         1       4m27s</span><br><span class="line">replicaset.apps/monitoring-prometheus-oper-operator-7b54f56766   1         1         1       4m27s</span><br><span class="line"></span><br><span class="line">NAME                                                                    DESIRED   CURRENT   AGE</span><br><span class="line">statefulset.apps/alertmanager-monitoring-prometheus-oper-alertmanager   1         1         4m</span><br><span class="line">statefulset.apps/prometheus-monitoring-prometheus-oper-prometheus       1         1         3m53s</span><br><span class="line"></span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl edit -n monitoring service/monitoring-prometheus-oper-prometheus</span><br><span class="line"></span><br><span class="line">Change type from ClusterIP to LoadBalancer</span><br><span class="line"></span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get all -n monitoring</span><br><span class="line">NAME                                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/alertmanager-monitoring-prometheus-oper-alertmanager-0   2/2     Running   0          16m</span><br><span class="line">pod/monitoring-grafana-c768bb86f-cgmj8                       2/2     Running   0          17m</span><br><span class="line">pod/monitoring-kube-state-metrics-6488587c6-zrjmg            1/1     Running   0          17m</span><br><span class="line">pod/monitoring-prometheus-node-exporter-5cp7v                1/1     Running   0          17m</span><br><span class="line">pod/monitoring-prometheus-node-exporter-75v99                1/1     Running   0          17m</span><br><span class="line">pod/monitoring-prometheus-node-exporter-jcl7r                1/1     Running   0          17m</span><br><span class="line">pod/monitoring-prometheus-node-exporter-vptns                1/1     Running   0          17m</span><br><span class="line">pod/monitoring-prometheus-oper-operator-7b54f56766-j8k6c     1/1     Running   0          17m</span><br><span class="line">pod/prometheus-monitoring-prometheus-oper-prometheus-0       3/3     Running   1          16m</span><br><span class="line"></span><br><span class="line">NAME                                              TYPE           CLUSTER-IP       EXTERNAL-IP                                                                    PORT(S)             AGE</span><br><span class="line">service/alertmanager-operated                     ClusterIP      None             &lt;none&gt;                                                                         9093/TCP,6783/TCP   16m</span><br><span class="line">service/monitoring-grafana                        ClusterIP      100.70.116.236   &lt;none&gt;                                                                         80/TCP              17m</span><br><span class="line">service/monitoring-kube-state-metrics             ClusterIP      100.67.183.154   &lt;none&gt;                                                                         8080/TCP            17m</span><br><span class="line">service/monitoring-prometheus-node-exporter       ClusterIP      100.68.145.110   &lt;none&gt;                                                                         9100/TCP            17m</span><br><span class="line">service/monitoring-prometheus-oper-alertmanager   ClusterIP      100.70.75.68     &lt;none&gt;                                                                         9093/TCP            17m</span><br><span class="line">service/monitoring-prometheus-oper-operator       ClusterIP      100.66.237.147   &lt;none&gt;                                                                         8080/TCP            17m</span><br><span class="line">service/monitoring-prometheus-oper-prometheus     LoadBalancer   100.67.205.22    a86903ccd8ce211e9bef7028ed3b83c9-1698452662.ap-southeast-2.elb.amazonaws.com   9090:32096/TCP      17m</span><br><span class="line">service/prometheus-operated                       ClusterIP      None             &lt;none&gt;                                                                         9090/TCP            16m</span><br><span class="line"></span><br><span class="line">NAME                                                 DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/monitoring-prometheus-node-exporter   4         4         4       4            4           &lt;none&gt;          17m</span><br><span class="line"></span><br><span class="line">NAME                                                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/monitoring-grafana                    1         1         1            1           17m</span><br><span class="line">deployment.apps/monitoring-kube-state-metrics         1         1         1            1           17m</span><br><span class="line">deployment.apps/monitoring-prometheus-oper-operator   1         1         1            1           17m</span><br><span class="line"></span><br><span class="line">NAME                                                             DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/monitoring-grafana-c768bb86f                     1         1         1       17m</span><br><span class="line">replicaset.apps/monitoring-kube-state-metrics-6488587c6          1         1         1       17m</span><br><span class="line">replicaset.apps/monitoring-prometheus-oper-operator-7b54f56766   1         1         1       17m</span><br><span class="line"></span><br><span class="line">NAME                                                                    DESIRED   CURRENT   AGE</span><br><span class="line">statefulset.apps/alertmanager-monitoring-prometheus-oper-alertmanager   1         1         16m</span><br><span class="line">statefulset.apps/prometheus-monitoring-prometheus-oper-prometheus       1         1         16m</span><br></pre></td></tr></table></figure>
<h2 id="Working-with-Grafana"><a href="#Working-with-Grafana" class="headerlink" title="Working with Grafana"></a>Working with Grafana</h2><p>change back from LoadBalancer to ClusterIP on service/monitoring-prometheus-oper-prometheus<br>change from ClusterIP to LoadBalancer on service/monitoring-grafana </p>
<h1 id="The-Alert-Manager"><a href="#The-Alert-Manager" class="headerlink" title="The Alert Manager"></a>The Alert Manager</h1><h2 id="Alerting"><a href="#Alerting" class="headerlink" title="Alerting"></a>Alerting</h2>  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/kubernetes/">kubernetes</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://223.95.78.227/2019/06/04/k8s/" data-title="k8s | Stan Zhou&#39;s Hexo Technical Blog" data-tsina="undefined" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2019/06/19/useful-commands/" title="useful commands">
  <strong>上一篇：</strong><br/>
  <span>
  useful commands</span>
</a>
</div>


<div class="next">
<a href="/2019/05/10/newvocabulary/"  title="New Vocabulary">
 <strong>下一篇：</strong><br/> 
 <span>New Vocabulary
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#K8S"><span class="toc-number">1.</span> <span class="toc-text">K8S</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Installing-Minikube"><span class="toc-number">2.</span> <span class="toc-text">Installing Minikube</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker-Overview"><span class="toc-number">3.</span> <span class="toc-text">Docker Overview</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pods"><span class="toc-number">4.</span> <span class="toc-text">Pods</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#writing-a-Pod"><span class="toc-number">4.1.</span> <span class="toc-text">writing a Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Services"><span class="toc-number">4.2.</span> <span class="toc-text">Services</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NodePort-and-ClusterIP"><span class="toc-number">4.3.</span> <span class="toc-text">NodePort and ClusterIP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod-selection-with-Labels"><span class="toc-number">4.4.</span> <span class="toc-text">Pod selection with Labels</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#REPLICASETS"><span class="toc-number">5.</span> <span class="toc-text">REPLICASETS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ReplicaSets"><span class="toc-number">5.1.</span> <span class="toc-text">ReplicaSets</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Writing-a-ReplicaSet"><span class="toc-number">5.2.</span> <span class="toc-text">Writing a ReplicaSet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Applying-a-ReplicaSet"><span class="toc-number">5.2.1.</span> <span class="toc-text">Applying a ReplicaSet</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Deployments"><span class="toc-number">6.</span> <span class="toc-text">Deployments</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Managing-Rollouts"><span class="toc-number">6.1.</span> <span class="toc-text">Managing Rollouts</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Networking-and-service-discovery"><span class="toc-number">7.</span> <span class="toc-text">Networking and service discovery</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Networking-Overview"><span class="toc-number">7.1.</span> <span class="toc-text">Networking Overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Namespace-kube-system"><span class="toc-number">7.2.</span> <span class="toc-text">Namespace-kube-system</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Accessing-MySQL-from-a-Pod"><span class="toc-number">7.3.</span> <span class="toc-text">Accessing MySQL from a Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-Discovery"><span class="toc-number">7.4.</span> <span class="toc-text">Service Discovery</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fully-Qualified-Domain-Names-FQDN"><span class="toc-number">7.5.</span> <span class="toc-text">Fully Qualified Domain Names (FQDN)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#An-introduction-to-Microservices"><span class="toc-number">7.6.</span> <span class="toc-text">An introduction to Microservices</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fleetman-Microservices-setting-the-scene"><span class="toc-number">7.7.</span> <span class="toc-text">Fleetman Microservices- setting the scene</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deploying-the-Queue"><span class="toc-number">7.8.</span> <span class="toc-text">Deploying the Queue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deploying-the-Position-Simulator"><span class="toc-number">7.9.</span> <span class="toc-text">Deploying the Position Simulator</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#inspecting-Pod-Logs"><span class="toc-number">7.9.1.</span> <span class="toc-text">inspecting Pod Logs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deploying-the-Position-Tracker"><span class="toc-number">7.10.</span> <span class="toc-text">Deploying the Position Tracker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deploying-the-API-Gateway"><span class="toc-number">7.11.</span> <span class="toc-text">Deploying the API Gateway</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deploying-the-Webapp"><span class="toc-number">7.12.</span> <span class="toc-text">Deploying the Webapp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Persistence"><span class="toc-number">8.</span> <span class="toc-text">Persistence</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#New-Release"><span class="toc-number">8.1.</span> <span class="toc-text">New Release!!</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Upgrading-to-a-Mongo-Pod"><span class="toc-number">8.2.</span> <span class="toc-text">Upgrading to a Mongo Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Volume-Mounts"><span class="toc-number">8.3.</span> <span class="toc-text">Volume Mounts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PersistentVolumeClaims"><span class="toc-number">8.4.</span> <span class="toc-text">PersistentVolumeClaims</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StorageClasses-and-Binding"><span class="toc-number">8.5.</span> <span class="toc-text">StorageClasses and Binding</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DEPLOYING-TO-THE-AWS-CLOUD"><span class="toc-number">9.</span> <span class="toc-text">DEPLOYING TO THE AWS CLOUD</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Getting-started-with-AWS"><span class="toc-number">9.1.</span> <span class="toc-text">Getting started with AWS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Introducing-Kops"><span class="toc-number">9.2.</span> <span class="toc-text">Introducing Kops</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Installing-the-Kops-Environment"><span class="toc-number">9.3.</span> <span class="toc-text">Installing the Kops Environment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configuring-your-first-cluster"><span class="toc-number">9.4.</span> <span class="toc-text">Configuring your first cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Running-the-Cluster"><span class="toc-number">9.5.</span> <span class="toc-text">Running the Cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Provisioning-SSD-drives-with-a-StorageClass"><span class="toc-number">9.6.</span> <span class="toc-text">Provisioning SSD drives with a StorageClass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deploying-the-Fleetman-Workload"><span class="toc-number">9.7.</span> <span class="toc-text">Deploying the Fleetman Workload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Setting-up-a-real-Domain-Name"><span class="toc-number">9.8.</span> <span class="toc-text">Setting up a real Domain Name</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Surviving-Node-Failure"><span class="toc-number">9.9.</span> <span class="toc-text">Surviving Node Failure</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Requirement"><span class="toc-number">9.9.1.</span> <span class="toc-text">Requirement</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Replicating-Pods"><span class="toc-number">9.10.</span> <span class="toc-text">Replicating Pods</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deleting-the-Cluster"><span class="toc-number">9.11.</span> <span class="toc-text">Deleting the Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Restarting-the-Cluster"><span class="toc-number">9.11.1.</span> <span class="toc-text">Restarting the Cluster</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Logging-a-Cluster"><span class="toc-number">10.</span> <span class="toc-text">Logging a Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introducing-the-ELK-ElasticStack"><span class="toc-number">10.1.</span> <span class="toc-text">Introducing the ELK/ElasticStack</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MONITORING-WITH-PROMETHEUS-AND-GRAFANA"><span class="toc-number">11.</span> <span class="toc-text">MONITORING WITH PROMETHEUS AND GRAFANA</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Monitoring-a-Cluster"><span class="toc-number">11.1.</span> <span class="toc-text">Monitoring a Cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Helm-Package-Manager"><span class="toc-number">11.2.</span> <span class="toc-text">Helm Package Manager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Installing-Prometheus-Operator"><span class="toc-number">11.3.</span> <span class="toc-text">Installing Prometheus Operator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Working-with-Grafana"><span class="toc-number">11.4.</span> <span class="toc-text">Working with Grafana</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-Alert-Manager"><span class="toc-number">12.</span> <span class="toc-text">The Alert Manager</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Alerting"><span class="toc-number">12.1.</span> <span class="toc-text">Alerting</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github Card</p>
<div class="github-card" data-github="stanosaka" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Devops/" title="Devops">Devops<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Jenkins/" title="Jenkins">Jenkins<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/CD-CI/" title="CD/CI">CD/CI<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/aws/" title="aws">aws<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/centos/" title="centos">centos<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/linux/" title="linux">linux<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/git/" title="git">git<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/tomcat/" title="tomcat">tomcat<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/saltstack/" title="saltstack">saltstack<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/zabbix/" title="zabbix">zabbix<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/ec2/" title="ec2">ec2<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/backup/" title="backup">backup<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/docker/" title="docker">docker<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Pipeline/" title="Pipeline">Pipeline<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/github/" title="github">github<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/nginx/" title="nginx">nginx<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/agile/" title="agile">agile<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/software-development/" title="software development">software development<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/agile-development/" title="agile development">agile development<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://zety.com/mycv/00root" target="_blank" title="Stan&#39;s resume">Stan&#39;s resume</a>
            
          </li>
        
          <li>
            
            	<a href="https://cloud.ibm.com/docs/tutorials?topic=solution-tutorials-tutorials" target="_blank" title="IBM cloud solution tutorial">IBM cloud solution tutorial</a>
            
          </li>
        
          <li>
            
            	<a href="https://github.com/aws-samples" target="_blank" title="AWS Samples">AWS Samples</a>
            
          </li>
        
          <li>
            
            	<a href="https://github.com/bikrambora/devlab-launchpad" target="_blank" title="Welcome to Dev Labs">Dev Labs</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.python.org/" target="_blank" title="Python doc">Python doc</a>
            
          </li>
        
          <li>
            
            	<a href="http://rogerdudler.github.io/git-guide" target="_blank" title="Git commands">Git commands</a>
            
          </li>
        
          <li>
            
            	<a href="https://docs.docker.com/engine/reference/builder/" target="_blank" title="Dockerfile reference">Dockerfile reference</a>
            
          </li>
        
          <li>
            
            	<a href="http://bit.ly/2mTQr8l" target="_blank" title="Linux Command line cheat sheet">Linux Command line cheat sheet</a>
            
          </li>
        
          <li>
            
            	<a href="http://bit.ly/2EPHxze" target="_blank" title="PowerShell Basic Cheat Sheet">PowerShell Basic Cheat Sheet</a>
            
          </li>
        
          <li>
            
            	<a href="http://sed.sourceforge.net/sed1line_zh-CN.html" target="_blank" title="sed cheatsheet">sed cheatsheet</a>
            
          </li>
        
          <li>
            
            	<a href="http://obsavus1p.bkt.clouddn.com/vim_cheat_sheet_for_programmers_print.png" target="_blank" title="vim cheatsheet">vim cheatsheet</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.gitbook.com/book/yeasy/docker_practice/details" target="_blank" title="Learn Docker">Learn Docker</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.unixhot.com/page/ops" target="_blank" title="运维知识体系">运维知识体系</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.tecmint.com/" target="_blank" title="tecmint">tecmint</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.lib.uts.edu.au" target="_blank" title="shoujin.wang@student.uts.edu.au">UTS Library</a>
            
          </li>
        
          <li>
            
            	<a href="https://7esl.com" target="_blank" title="ESL">ESL</a>
            
          </li>
        
          <li>
            
            	<a href="https://stanchou.wordpress.com" target="_blank" title="Stan&#39;s wordpress">Stan&#39;s wordpress</a>
            
          </li>
        
          <li>
            
            	<a href="https://docs.00root.com" target="_blank" title="Stan&#39;s gitbook">Stan&#39;s gitbook</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Stan live in Sydney. <br/>
			I am a lifelong technology learner.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/stanosaka" target="_blank" class="icon-github" title="github"></a>
		
		
		<a href="http://stackoverflow.com/users/6724938" target="_blank" class="icon-stack-overflow" title="stackoverflow"></a>
		
		
		<a href="https://twitter.com/stanosaka" target="_blank" class="icon-twitter" title="twitter"></a>
		
		
		<a href="https://www.facebook.com/stan.osaka" target="_blank" class="icon-facebook" title="facebook"></a>
		
		
		<a href="https://www.linkedin.com/in/00root" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		<a href="https://www.douban.com/people/btw01v" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/stan-22-82" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
		<a href="mailto:devops@cwzhou.win" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2019 
		
		<a href="/about" target="_blank" title="Stan Zhou">Stan Zhou</a>
		
		
		</p>
</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>


        
  	    <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
            <script>
               if (window.mermaid) {
                  mermaid.initialize({theme: 'forest'});
               }
            </script>
        



<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
