
 <!DOCTYPE HTML>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <title>Stan Zhou&#39;s Hexo Technical Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Stan Zhou">
    

    
    <meta name="description" content="Infrastructure as code">
<meta property="og:type" content="website">
<meta property="og:title" content="Stan Zhou&#39;s Hexo Technical Blog">
<meta property="og:url" content="http://223.95.78.227/page/3/index.html">
<meta property="og:site_name" content="Stan Zhou&#39;s Hexo Technical Blog">
<meta property="og:description" content="Infrastructure as code">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Stan Zhou&#39;s Hexo Technical Blog">
<meta name="twitter:description" content="Infrastructure as code">
<meta name="twitter:creator" content="@stanosaka">

    
    <link rel="alternative" href="/atom.xml" title="Stan Zhou&#39;s Hexo Technical Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/toad.ico">
    
    
    <link rel="apple-touch-icon" href="/img/toadman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/toadman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/toadman.png" alt="Stan Zhou&#39;s Hexo Technical Blog" title="Stan Zhou&#39;s Hexo Technical Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Stan Zhou&#39;s Hexo Technical Blog">Stan Zhou&#39;s Hexo Technical Blog</a></h1>
				<h2 class="blog-motto">Innovation Evangelist</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:223.95.78.227">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/07/15/splunk/" title="splunk" itemprop="url">splunk</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stan Zhou" target="_blank" itemprop="author">Stan Zhou</a>
		
  <p class="article-time">
    <time datetime="2019-07-15T00:40:04.000Z" itemprop="datePublished"> Published 2019-07-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="https://github.com/PacktPublishing/Splunk-7.x-Quick-Start-Guide">code</a></p>
<h1 id="What-is-Splunk"><a href="#What-is-Splunk" class="headerlink" title="What is Splunk?"></a>What is Splunk?</h1><p>Splunk is a software platform that collects and stores all this machine data in one place.<br><img src="https://i.imgur.com/wObsIBw.png" alt="splunk data sources and use cases"></p>
<h2 id="Splunk-products"><a href="#Splunk-products" class="headerlink" title="Splunk products"></a>Splunk products</h2><ul>
<li><strong>Splunk Enterprise</strong>: designed for on-premise deployments</li>
<li><strong>Splunk Cloud</strong>: a cloud-based <strong>software as a service (SaaS)</strong> version of Splunk Enterprise.</li>
<li><strong>Splunk Light</strong>: is designed to be a small-scale solution.</li>
<li><strong>Splunk Free</strong>: is a free version of the core Splunk Enterprise product that has limits on users(one user), ingestion volume (500 MB/day), and other features.</li>
</ul>
<p><strong>Splunk components</strong></p>
<ul>
<li>Universal forwarder</li>
<li>Indexer and indexer clusters</li>
<li>Search head and search head clusters</li>
<li>Deployment server</li>
<li>Deployer</li>
<li>Cluster master</li>
<li>License master</li>
<li>Heavy forwarder<br>Universal forwarders, indexers, and search heads constitute the majority of Splunk functionality; the other components provide supporting roles for larger clustered/distributed environments.<br><img src="https://i.imgur.com/sqJ8esH.png" alt="Splunk components in a distributed deployment"></li>
</ul>
<p>The <strong>universal forwarder (UF)</strong> is a free small-footprint version of Splunk Enterprise that is installed on each application, web, or other type of server to collect data from specified log files and forward this data to Splunk for indexing(storage). In A large Splunk deployment, you may have hundreds or thousands of forwards that consume and forward data for indexing.</p>
<p>An <strong>indexer</strong> is the Splunk component that creates and manages indexes, which is where machine data is stored. Indexers perform two main functions: parsing and storing data, which has been received from forwarders or other data sources into indexes, and searching and returning the indexed data in response to search requests.</p>
<p>An indexing cluster is a group of indexers that have been configured to work together to handle higher volumes of both incmoing data to be indexed and search requests to be serviced, as well as providing redundancy by keeping duplicate copies of indexed data spread across the cluster members.</p>
<p>A <strong>search head</strong> is an instance of Splunk Enterprise that handles search management functions. This includes providing a web-based user interface called Splunk Web, from which users issue search requests in what is called <strong>Search Processing Language (SPL)</strong>. Search reqeusts initiated by a user ( or a report or dashboard) are sent to one or more indexers to locate and return the requested data; the search head then formates the returned data for presentation to the user.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index=_internal | stats count by source, sourcetype</span><br></pre></td></tr></table></figure>
<p>an example of executing a simple search in Splunk Web. The SPL specifies searching in the <code>_internal</code> index, which is where Splunk saves data about its internal operations, and provides a count of the number of events in each log for Today. The SPL command specified an <code>index</code>, and then pipes the returned results to the <code>stats</code> command to return a <code>count</code> of all the events by their <code>source</code> and `sourcetype<br><img src="https://i.imgur.com/exMXaN5.jpg" alt="Simple search in Splunk Web"></p>
<p>A <strong>deployment server</strong> is a Splunk Enterprise instance that acts as a centralized configuration manager ofr a number of Splunk components, but which in practice is used to manage UFs.</p>
<p>A <strong>deployer</strong> is a Splunk Enterprise instance that is ued to distribute Splunk apps and certain other configuration updates to search head cluster memebers.</p>
<p>A <strong>cluster master</strong> is a Splunk Enterprise instance that coordinates the activities of an indexing cluster.</p>
<p>A <strong>license master</strong> is a single Splunk Enterprise instance that provides a licensing service for the multiple instances of Splunk that have been deployed in a distributed environment.</p>
<p>A <strong>heavy forwarder</strong> is an instance of Splunk Enterprise that can receive data from other forwarders or data sources and parse, index, and/or send data to another Splunk instance for indexing. </p>
<p>Splunk Enterprise also has a monitoring tool function called the <strong>monitoring console</strong>, which lets you view detailed topology and performance information about your entire distributed deployment from one interface. </p>
<p><img src="https://i.imgur.com/ElU7rTv.png" alt="Splunk data pipeline"></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/splunk/">splunk</a><a href="/tags/monitoring/">monitoring</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/07/13/terraform/" title="terraform" itemprop="url">terraform</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stan Zhou" target="_blank" itemprop="author">Stan Zhou</a>
		
  <p class="article-time">
    <time datetime="2019-07-13T03:29:54.000Z" itemprop="datePublished"> Published 2019-07-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="https://github.com/PacktPublishing/Hands-on-Infrastructure-Automation-with-Terraform-on-AWS">Supplemental content</a></p>
<h1 id="Install-Terraform-and-Tools-on-linux"><a href="#Install-Terraform-and-Tools-on-linux" class="headerlink" title="Install Terraform and Tools on linux"></a>Install Terraform and Tools on linux</h1><h2 id="Terraform-development-environment"><a href="#Terraform-development-environment" class="headerlink" title="Terraform development environment"></a>Terraform development environment</h2><ul>
<li>Terraform</li>
<li>aws account</li>
<li>aws cli with credentials configured</li>
<li>git</li>
<li>shell (bash, pwoershell, cmd, git-bash)</li>
<li>Text editor (visual studio code with Extensions terraform)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://releases.hashicorp.com/terraform/0.12.4/terraform_0.12.4_linux_amd64.zip</span><br><span class="line">unzip terraform_0.12.4_linux_amd64.zip</span><br><span class="line">sudo mv terraform /usr/local/bin</span><br><span class="line">terraform version</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="First-deployment-with-Terraform"><a href="#First-deployment-with-Terraform" class="headerlink" title="First deployment with Terraform"></a>First deployment with Terraform</h1><h2 id="Configuration-language-basics"><a href="#Configuration-language-basics" class="headerlink" title="Configuration language basics"></a>Configuration language basics</h2><p>Terraform uses HCL (Hashicorp configuration language)</p>
<ul>
<li>human friendliness</li>
<li>JSON is quite verbose and doesn’t support comments, is machine readable</li>
<li>YAML is quite easy to mess up indentation and it’s not always clear whether you should use a colon or hyphen(specially when you using nested maps and lists)- machine-friendly, which is designed to be written and modified by humans</li>
<li>can sue JSON as input to Terraform</li>
</ul>
<p><strong>main features of HCL</strong></p>
<ul>
<li>can have single-line comments, start with a double slash or a number sign</li>
<li>multi-line comments are wrapped in /*</li>
<li>Values assign syntax key = vaule</li>
<li>Strings are double bolded</li>
<li>Numbers, booleans, arrays, lists, objects, named maps or dictonaries</li>
<li>Interpolations, conditionals, and various build-in functions</li>
</ul>
<h2 id="Set-up-aws-provider"><a href="#Set-up-aws-provider" class="headerlink" title="Set up aws provider"></a>Set up aws provider</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir s3_backbone &amp;&amp; cd s3_backbone</span><br><span class="line">git init</span><br><span class="line">terraform init</span><br></pre></td></tr></table></figure>
<p>Provide: Terraform object that is responsible for managing the lifecycle of a resouce:</p>
<ul>
<li>Create, REad, Update, and Delete operations (CRUD)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat providers.tf</span><br><span class="line">provider &quot;aws&quot;&#123;</span><br><span class="line">  region = &quot;ap-southeast-2&quot;</span><br><span class="line">&#125;</span><br><span class="line">git add -A</span><br><span class="line">git commit -m &quot;Add aws provider&quot;</span><br><span class="line">terraform init</span><br><span class="line">git status</span><br><span class="line">echo &quot;.terraform&quot; &gt;&gt; .gitignore</span><br><span class="line">git status</span><br><span class="line">git add .gitignore&amp;&amp; git commit -m &quot;Add .gitignore&quot;</span><br><span class="line">terraform plan # creates an execution plan</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Deploy-an-s3-bucket-into-aws"><a href="#Deploy-an-s3-bucket-into-aws" class="headerlink" title="Deploy an s3 bucket into aws"></a>Deploy an s3 bucket into aws</h2><p>google terraform s3 bucket<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat s3.tf</span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;main&quot; &#123;</span><br><span class="line">  bucket = &quot;packt-terraform-section2-bucket-stan&quot;</span><br><span class="line">  acl    = &quot;private&quot;</span><br><span class="line">&#125;</span><br><span class="line">git add . &amp;&amp; git commit -m &quot;Add S3 bucket&quot;</span><br><span class="line">terraform plan</span><br><span class="line"># The output of this command is similar to what we get when we run the diff command on Linux: resources with a plus sign are going to be created, resources with the minus sign are going to be deleted, and resources with a tilde sign are going to be modified</span><br><span class="line">terraform apply</span><br><span class="line">git status</span><br><span class="line"># notice that Terraform also created a new file, terraform.tfstate</span><br><span class="line"># it&apos;s a JSON file, which contains some information about the bucket we just created. Terraform uses the state file to map real-world resources to your configuration, and keep track of metadata</span><br></pre></td></tr></table></figure></p>
<p><strong>What is state?</strong></p>
<ul>
<li>Desired state</li>
<li>Actual state</li>
<li>Known state<br>When we write our configuration files, we describe the desired state. This is how we want our infrastructure to be. Then there’s the actual state: this is how our infrastructure looks like, right now. You can get this actual state by exploring your infrastructure in the web console, or running some describe commands against the API. And to bridge these two states, there is the known state, which is stored in the state file. Terraform uses it to keep track of all resources it already created for this set of templates. In general, this known state should be the same as the actual state. When we run the plan command, Terraform performs a refresh, and then determines what actions are necessary to achieve the desired state specified in the configuration files. When you run the apply command, Terraform executes the planned actions, and then stores the updated actual state in the state file.</li>
</ul>
<p>for example, you went to the web console and manually changed something - Terraform will detect such changes, and unless they also exist in the desired state, it will revert them. So, if we are going to treat our <strong>infrastructure as code</strong>, we should get into the mindset of not changing our sources manually.</p>
<p>Make sure the state file is ignored by Git<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> cat .gitignore</span><br><span class="line">.terraform</span><br><span class="line"></span><br><span class="line">*.tfstate*</span><br><span class="line">git add -A &amp;&amp; git commit -m &quot;Ignore TF state&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="Structuring-the-project"><a href="#Structuring-the-project" class="headerlink" title="Structuring the project"></a>Structuring the project</h2><p>Typical project structure<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|-main.tf</span><br><span class="line">|-outputs.tf</span><br><span class="line">|-variables.tf</span><br></pre></td></tr></table></figure></p>
<p>group related resources together, and keep the configuration files to a manageable size - ideally, not longer than 200 lines of code.</p>
<h1 id="Modifying-resoureces"><a href="#Modifying-resoureces" class="headerlink" title="Modifying resoureces"></a>Modifying resoureces</h1><h2 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h2><p>Keep the code DRY- Don’t Repeat Yourself-SOFTWARE ENGINEERING PRICIPLE aimed at reducing interpretation of the same data</p>
<p>Terraform performs automatic conversion from string values to numeric and boolean values, based on context.</p>
<p>Maps are useful for selecting a value based on some other provided value.</p>
<p>A list value is an ordered sequence of strings, indexed by integers starting with 0.</p>
<p>Several ways to set variables:</p>
<ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat variables.tf</span><br><span class="line">variable &quot;s3_bucket_name&quot; &#123;</span><br><span class="line">        #default = &quot;packt-terraform-section2-bucket-stan&quot;</span><br><span class="line">        description = &quot;Name of the S3 bucket&quot;</span><br><span class="line">        type = &quot;string&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;s3_tags&quot; &#123;</span><br><span class="line">        type = &quot;map&quot;</span><br><span class="line"></span><br><span class="line">        default = &#123;</span><br><span class="line">                created_by = &quot;terraform&quot;</span><br><span class="line">                environment = &quot;test&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;s3_regions&quot; &#123;</span><br><span class="line">        type = &quot;list&quot;</span><br><span class="line">        default = [&quot;ap-southeast-2&quot;, &quot;us-west-2&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line">var.s3_bucket_name</span><br><span class="line">  Name of the S3 bucket</span><br><span class="line"></span><br><span class="line">  Enter a value: packt-terraform-section2-bucket-stan</span><br><span class="line"></span><br><span class="line">Refreshing Terraform state in-memory prior to plan...</span><br><span class="line">The refreshed state will be used to calculate this plan, but will not be</span><br><span class="line">persisted to local or remote state storage.</span><br><span class="line"></span><br><span class="line">aws_s3_bucket.main: Refreshing state... [id=packt-terraform-section2-bucket-stan]</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">terraform plan -var &apos;s3_bucket_name=&quot;packt-terraform-section2-bucket-stan&quot;&apos;</span><br><span class="line">Refreshing Terraform state in-memory prior to plan...</span><br><span class="line">The refreshed state will be used to calculate this plan, but will not be</span><br><span class="line">persisted to local or remote state storage.</span><br><span class="line"></span><br><span class="line">aws_s3_bucket.main: Refreshing state... [id=packt-terraform-section2-bucket-stan]</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>3.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TF_VAR_s3_bucket_name=&quot;packt-terraform-section2-bucket-stan&quot; terraform plan</span><br><span class="line">Refreshing Terraform state in-memory prior to plan...</span><br><span class="line">The refreshed state will be used to calculate this plan, but will not be</span><br><span class="line">persisted to local or remote state storage.</span><br><span class="line"></span><br><span class="line">aws_s3_bucket.main: Refreshing state... [id=packt-terraform-section2-bucket-stan]</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br></pre></td></tr></table></figure></p>
<p><strong>Variable definition files</strong></p>
<ul>
<li>We can also have multiple tfvars files, and pass them explicitly to Terraform using the var file flag. If we pass several files, Terraform will merge their values - and if a particular variable is defined in more than one variable file, the last value that is filed wins. </li>
<li>Terraform automatically loads all files which match terraform.tfvars or *.auto.tfvars from the current directory</li>
<li>Other files can be passed explicitly using -var-file flag<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat terraform.tfvars</span><br><span class="line">s3_bucket_name = &quot;packt-terraform-section2-bucket-stan&quot;</span><br><span class="line">terraform plan</span><br><span class="line">Refreshing Terraform state in-memory prior to plan...</span><br><span class="line">The refreshed state will be used to calculate this plan, but will not be</span><br><span class="line">persisted to local or remote state storage.</span><br><span class="line"></span><br><span class="line">aws_s3_bucket.main: Refreshing state... [id=packt-terraform-section2-bucket-stan]</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>String Interpolation</strong></p>
<ul>
<li>The process of evaluating a string expression and replacing all paceholders with their values<br><code>&quot;${var.s3_bucket_name}&quot;</code><br><strong>First-Class Expressions</strong><br><code>var.s3_bucket_name</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> cat s3.tf</span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;main&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.s3_bucket_name&#125;&quot;</span><br><span class="line">  acl    = &quot;private&quot;</span><br><span class="line"></span><br><span class="line">  tags   = &#123;</span><br><span class="line">    env = &quot;$&#123;lookup(var.s3_tags, &quot;environment&quot;)&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  region =&quot;$&#123;var.s3_regions[0]&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line">#Terraform console is a useful tool for automation scripts, as it allows you to access arbitrary attributes from a Terraform configuration.</span><br><span class="line">terraform console</span><br><span class="line">&gt; var.s3_tags</span><br><span class="line">&#123;</span><br><span class="line">  &quot;created_by&quot; = &quot;terraform&quot;</span><br><span class="line">  &quot;environment&quot; = &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line">&gt; var.s3_tags[&quot;environment&quot;]</span><br><span class="line">test</span><br><span class="line">&gt; exit</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Local-development-workflow"><a href="#Local-development-workflow" class="headerlink" title="Local development workflow"></a>Local development workflow</h2><p><strong>Using git to store state is a bad idea</strong></p>
<ul>
<li>maintenance overhead</li>
<li>secrets in plain text</li>
</ul>
<p><strong>State</strong></p>
<ul>
<li>Local state</li>
<li>Version Control</li>
<li>Remote state</li>
<li>Backends<ul>
<li>Terraform enterprise</li>
<li>S3</li>
<li>Consul: a service networking solution to connect and secure services across any runtime platform and public or private cloud.</li>
<li>Etcd</li>
<li>HTTP</li>
</ul>
</li>
</ul>
<p>Recommend using S3<br><strong>Local Values</strong></p>
<ul>
<li><strong>Input variables</strong> are similar to arguments of a function</li>
<li><strong>Local values</strong> are analogous to local variables within the function’s scope</li>
</ul>
<p>edit variables.tf file:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">        s3_tags= &#123;</span><br><span class="line">                created_by = &quot;terraform&quot;</span><br><span class="line">                environment = &quot;$&#123;var.environment&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>we can skip refreshing it again to save a couple of seconds, here. I will pass a flag, -refresh=false.<br>The state filei(terraform.tfstate) is also used to store some metadata, such as resource dependencies, or a pointer to the provider configuration in situations where multiple AWS providers are present. Another use is to store a cache of the attribute values for all the resources in the state. When we run terraform plan, Terraform must know the current state of resources, and by default it will query the providers and sync the latest attributes from all our resources. For large infrastructure, this can be too slow, and we may get throttled at the API level - so, as a performance improvement, there is an option to disable this behavior by passing refresh=false flag.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">terraform plan -refresh=false</span><br><span class="line"></span><br><span class="line">An execution plan has been generated and is shown below.</span><br><span class="line">Resource actions are indicated with the following symbols:</span><br><span class="line">-/+ destroy and then create replacement</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve  ##skip answer yes</span><br><span class="line"></span><br><span class="line">export TF_CLI_ARGS_apply=&quot;-auto-approve&quot;</span><br></pre></td></tr></table></figure></p>
<p><strong>Common Workflow</strong></p>
<ul>
<li>validate</li>
<li>plan</li>
<li>apply</li>
<li>fmt<br><a href="https://github.com/antonbabenko/pre-commit-terraform">Pre-Commit Hooks</a><h2 id="Deleting-Resources"><a href="#Deleting-Resources" class="headerlink" title="Deleting Resources"></a>Deleting Resources</h2>1.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">terraform plan -destroy</span><br><span class="line">terraform destroy</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="2">
<li>remove a resource from configuration and then run terraform plan &amp;&amp; terraform apply</li>
</ol>
<p>the 2nd one is more suted to CI/CD systems. You will most likely have some pipeline for provisioning your resources, but you may not necessarily have any automated way of destroying them, because this doesn’t happen that often. Another point is that, this way, you can destroy specific resources without having to pass special flags, which would require changes to automation scripts.</p>
<p><strong>Protect a resoure from deletion</strong><br>Use the life cycle meta-parameter.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lifecycle &#123;</span><br><span class="line">  prevent_destory = &quot;true&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Only protects against terraform destory.</p>
<h2 id="Managing-state"><a href="#Managing-state" class="headerlink" title="Managing state **"></a>Managing state <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></h2><p><a href="https://github.com/PacktPublishing/Hands-on-Infrastructure-Automation-with-Terraform-on-AWS/tree/master/Section_3">code</a></p>
<p><strong>set up the remote state backend</strong></p>
<ol>
<li>Create the Terraform configuration section</li>
</ol>
<p>This block is special, as it configures the behavior of Terraform itself, such as setting up a backend or requiring a minimum Terraform version to execute a configuration.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_version = &quot;&gt; 0.11.7&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>if we have some configuration which we can’t migrate to the latest version, for some reason, we can pin it to an older version in this block. Let’s set the current version.</p>
<p><strong>Manage terraform versions for each project by Terraform switcher</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># MacOS with brew</span><br><span class="line">brew install warrensbox/tap/tfswitch</span><br><span class="line"># Linux</span><br><span class="line">curl -L https://raw.githubusercontent.com/warrensbox/terraform-switcher/release/install.sh | bash</span><br><span class="line">tfswitch</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li><p>Add a backend</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">backend &quot;s3&quot; &#123;</span><br><span class="line">    bucket = &quot;packt-terraform-bucket-stan-test-ap-southeast-2&quot;</span><br><span class="line">    key = &quot;test/backbone&quot;</span><br><span class="line">    region = &quot;ap-southeast-2&quot;</span><br><span class="line">    encrypt = &quot;true&quot;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Apply</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m &quot;Configure remote state&quot;</span><br><span class="line">git clean -fdx #clean the repository of all unchecked files</span><br><span class="line">Removing .terraform/</span><br><span class="line">Removing terraform.tfstate</span><br><span class="line">Removing terraform.tfstate.backup</span><br><span class="line">terraform init</span><br><span class="line">terraform plan #there is no more local state file anymore</span><br></pre></td></tr></table></figure>
</li>
<li><p>configuration todo</p>
</li>
</ol>
<ul>
<li><p>enforce encryption by default (here use the default one, you can use KMS instead)<br>by edit s3.tf:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server_side_encryption_configuration &#123;</span><br><span class="line">  rule &#123;</span><br><span class="line">    apply_server_side_encryption_by_default &#123;</span><br><span class="line">       sse_algorithm = &quot;AES256&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>versioning: alwasy have a way back</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">versioning &#123;</span><br><span class="line">   enabled = true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lifecycle policy: Versioning will store all previous versions of the file, which will eventually bloat the bucket size. To reverse this, we can set a lifecycle policy. Remove all the version after 90 days. In your particular case, you might want to use a different value, or maybe move them to <strong>glacier storage</strong> instead of deleting the old files.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lifecycle_rule &#123;</span><br><span class="line">   id      = &quot;state&quot;</span><br><span class="line">   prefix  = &quot;state/&quot;</span><br><span class="line">   enabled = true</span><br><span class="line"></span><br><span class="line">   noncurrent_version_expiration &#123;</span><br><span class="line">      days = 90</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>Best Practices</strong></p>
<ul>
<li>Do not store state locally</li>
<li>Do not commit state to version control</li>
<li>If using S3:<ul>
<li>Enable versioning</li>
<li>Enforce encryption</li>
<li>Store state close to the infrastructure</li>
<li>Limit access to the bucket, consider enabling log in</li>
</ul>
</li>
</ul>
<h1 id="Building-a-multi-tier-environment"><a href="#Building-a-multi-tier-environment" class="headerlink" title="Building a multi-tier environment"></a>Building a multi-tier environment</h1><p><strong>What we will build?</strong></p>
<ul>
<li>Network layer-Virtual Private Cloud (VPC), internet gateway, public and private subnets, NAT gateway, and a bastion host)</li>
<li>Relational Database Service (RDS) instance running PostgreSQL</li>
<li>Elastic Container Service (ECS) cluster to host a dockerised app<br><strong>Provider Caching</strong></li>
<li><strong>terraform init</strong> downloads providers separately for each project</li>
<li>We can cache them by setting an environment variable<br>  export TF_PLUGIN_VACHE_DIR=”$HOME/.terraform.d/plugin-cache”<br><a href="https://github.com/PacktPublishing/Hands-on-Infrastructure-Automation-with-Terraform-on-AWS/tree/master/Section_4/vpc">code</a><br><img src="https://i.imgur.com/Rzhlc11.png" alt="AWS VPC"><br><strong>Count Meta-Parameter</strong></li>
<li>Available to all resources</li>
<li>Allows creating multiple copies of a resouce without repeating its configuration</li>
<li>Helps keep your infrastructure code <strong>DRY</strong><br><strong>Splat Expression</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_nat_gateway&quot; &quot;main&quot; &#123;</span><br><span class="line">  count         = &quot;$&#123;length(var.availability_zones)&#125;&quot;</span><br><span class="line">  subnet_id     = &quot;$&#123;element(aws_subnet.public.*.id, count.index)&#125;&quot;</span><br><span class="line">  allocation_id = &quot;$&#123;element(aws_eip.nat.*.id, count.index)&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>The challenge, here, is that the gateways need to reference the subnets and the IPS that we created, but because we used count, we don’t have a direct reference to each resource. We can resolve this by using a splat expression, which you can see in action where we reference the subnet ID and the allocation ID. A splat expression allows to obtain a list of attribute values from a set of resources created using the count argument. Notice this asterisk, which represents all values in the generated list.</p>
<h2 id="Organizing-data-with-output-variables"><a href="#Organizing-data-with-output-variables" class="headerlink" title="Organizing data with output variables"></a>Organizing data with output variables</h2><p><strong>Resources and data sources</strong></p>
<ul>
<li>Resources provide <strong>Create, Read, Update</strong>,and <strong>Delete</strong> functionality (CRUD)</li>
<li>Data srouces support <strong>read</strong> operations only<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data &quot;aws_ami&quot; &quot;amazon_linux&quot; &#123;</span><br><span class="line">  most_recent = true</span><br><span class="line">  filter &#123;</span><br><span class="line">    name   = &quot;name&quot;</span><br><span class="line">    values = [&quot;amzn-ami-*-x86_64-gp2&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>Output Variables</strong></p>
<ul>
<li>Expose important resource attributes and make tme easier to query</li>
<li>Outputs are exposed to the user and stored in the state file during terraform apply</li>
<li>A single output block configures a single variable<br><strong>Example Output</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output &quot;vpc_id&quot; &#123;</span><br><span class="line">   value = &quot;$&#123;aws_vpc.main.id&#125;&quot;</span><br><span class="line">   description = &quot;VPC id&quot;</span><br><span class="line">   sensitive = false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>After we run the apply once, the outputs are stored in the state file - so, the next time we need to get them, we can use <code>terraform output</code>.<br>or<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform output public_subnets</span><br></pre></td></tr></table></figure></p>
<p><strong>provider version</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> terraform providers</span><br><span class="line">.</span><br><span class="line">├── provider.aws 1.31</span><br><span class="line">└── provider.template</span><br><span class="line">ls -l ~/.terraform.d/plugin-cache/linux_amd64</span><br></pre></td></tr></table></figure></p>
<h2 id="Integrating-components-in-a-complex-environment"><a href="#Integrating-components-in-a-complex-environment" class="headerlink" title="Integrating components in a complex environment"></a>Integrating components in a complex environment</h2><p><img src="https://i.imgur.com/LcsUUkG.png" alt="Adding a database server"><br><strong>Steps to add a DB server</strong></p>
<ol>
<li>Create a VPC (done)</li>
<li>Add Subnets to the VPC (done)</li>
<li>Create a DB Subnet Group</li>
<li>Create a VPC Secruity Group</li>
<li>Create a DB Instance in the VPC</li>
</ol>
<p>Integrate separate Terraform configurations while keeping them in different projects</p>
<p>Remote state serves as a centralized source of truth:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> cat data_sources.tf</span><br><span class="line"># Remote state</span><br><span class="line">data &quot;terraform_remote_state&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  backend = &quot;s3&quot;</span><br><span class="line"></span><br><span class="line">  config &#123;</span><br><span class="line">    bucket = &quot;packt-terraform-bucket-stan-test-$&#123;var.region&#125;&quot;</span><br><span class="line">    key    = &quot;test/vpc&quot;</span><br><span class="line">    region = &quot;$&#123;var.region&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Remote state allows us to share information between current projects, and to build our infrastructures in small atomic configurations focused on one thing.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db_subnet_group.tf</span><br><span class="line">subnet_ids = [&quot;$&#123;data.terraform_remote_state.vpc.private_subnets&#125;&quot;]</span><br></pre></td></tr></table></figure></p>
<p>Notice the interpolation syntax that we use.first, specify that it’s a data source - then its type, terraform remote state. Then comes the name of particular remote state, VPC, and lastly the attribute that we are interested in. </p>
<h2 id="Using-templates"><a href="#Using-templates" class="headerlink" title="Using templates"></a>Using templates</h2><p><img src="https://i.imgur.com/IjCKZfO.png" alt="Application tier"><br>deploy a small but realistic web application into our VPC. Our app runs in Docker, so we will provision an LST container service cluster - <strong>ECS</strong> - to host it in our private subnets. We will use <strong>Fargate</strong>, which is a managed compute and orchestration engine, so we won’t need to maintain EC2 instances that run our containers. </p>
<p><strong>Use Terraform templates to compose complex string inputs</strong><br>App: a REST API for a todo applicaton, written in Go. It uses Postgres scale database as its backend.</p>
<p><a href="https://hub.docker.com/r/endofcake/go-todo-rest-api-example/">public image on Docker hub</a></p>
<ol>
<li>provision an ECS cluster<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat ecs_cluster.tf</span><br><span class="line">resource &quot;aws_ecs_cluster&quot; &quot;main&quot; &#123;</span><br><span class="line">  name = &quot;$&#123;var.ecs_cluster_name&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>Partitioning Infrastructure</strong></p>
<ul>
<li>If the resources are likely to be created and destryoed together, they belong together</li>
<li>If some resource can be used by multiple other resources, it’s better to keep it sparate (VPC,RDS, and ECS cluster)</li>
</ul>
<p>template eg.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">bastion.tf</span><br><span class="line"># User data</span><br><span class="line">data &quot;template_file&quot; &quot;user_data&quot; &#123;</span><br><span class="line">  template = &quot;$&#123;file(&quot;$&#123;path.module&#125;/templates/user_data.sh&quot;)&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/tmplates/user_data.sh</span><br><span class="line">#!/bin/env bash</span><br><span class="line"></span><br><span class="line">set -euo pipefail</span><br><span class="line">exec &gt; &gt;(tee /var/log/user-data.log|logger -t user-data -s 2&gt;/dev/console) 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">echo &quot;Starting user data...&quot;</span><br><span class="line">yum update -y</span><br><span class="line">yum install -y postgresql96.x86_64</span><br><span class="line">touch /home/ec2-user/success</span><br><span class="line">echo &quot;All done&quot;</span><br></pre></td></tr></table></figure></p>
<p>Next, I create template_cloudinit_config data source, and pull in the rendered template file. cloudinit_config allows us to compose multi-part user data scripts.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">data &quot;template_cloudinit_config&quot; &quot;user_data&quot; &#123;</span><br><span class="line">  gzip          = true</span><br><span class="line">  base64_encode = true</span><br><span class="line"></span><br><span class="line">  part &#123;</span><br><span class="line">    content_type = &quot;text/x-shellscript&quot;</span><br><span class="line">    content      = &quot;$&#123;data.template_file.user_data.rendered&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>If we run terraform apply with this configuration on Windows, it most likely wouldn’t work - the problem is that Windows use a different line break tag, which is not valid on Linux. Windows use both carriage return and line feed, while Linux only uses line feed. The easiest way to check the line break tag is to look at the bottom right corner of the editor. Anyway, long story short, we want to make sure that this script is valid, even if we deploy our configuration from a Windows machine. This is probably the only case where there is any difference between running Terraform on Linux and on Windows. There are two changes that you should make to resolve this.</p>
<ol>
<li><p>add a gitattributes file</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat .gitattributes</span><br><span class="line"># Always LF</span><br><span class="line">*.sh text eol=lf</span><br></pre></td></tr></table></figure>
</li>
<li><p>use EditorConfig plugin to define how our text editor displays and saves our code<br><img src="https://i.imgur.com/55JD2B3.png" alt="editorconfig plugin"> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat .editorconfig</span><br><span class="line">[*.sh]</span><br><span class="line">end_of_line = lf</span><br><span class="line">indent_size = 2</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><a href="https://github.com/stanosaka/Hands-on-Infrastructure-Automation-with-Terraform-on-AWS/tree/master/Section_4/ecs_app_todo">ecs app todo code</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~/terraform/ecs_app_todo|</span><br><span class="line">⇒  tree</span><br><span class="line">.</span><br><span class="line">├── cloudwatch.tf</span><br><span class="line">├── data_sources.tf</span><br><span class="line">├── ecs_task.tf</span><br><span class="line">├── graph.png</span><br><span class="line">├── iam.tf</span><br><span class="line">├── lb.tf</span><br><span class="line">├── outputs.tf</span><br><span class="line">├── providers.tf</span><br><span class="line">├── templates</span><br><span class="line">│   └── ecs_task.tpl</span><br><span class="line">├── terraform.tfvars</span><br><span class="line">└── variables.tf</span><br></pre></td></tr></table></figure></p>
<p>templates/ecs_task.tpl file: ECS task definition. It describes which Docker images to use, the required resources, and other configurations necessary to launch the containers. As you can see, it’s a JSON block, which I’ve extracted into a template. It requires a few parameters, mostly to set up the connection to the database. </p>
<p>ecs_task.tf file: This is the Terraform configuration of our ECS task. I’m using the familiar template file data source, and I’m passing the required variables using the vars parameter, which accepts a map of variables. Some of the variables come from the tfvars file, but many are imported from the remote state. </p>
<p>data_sources.tf file: If we check out our data sources, we see that we’re pulling in remote state from all three projects that we created earlier. </p>
<p>lb.tf file: another important resource that we are creating is the load balancer, which distributes income and application traffic across multiple targets, for high availability. It will also allow us to connect to our service from the public internet, and here is the security group which allows public access</p>
<p><strong>confirm it’s working</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">curl -d &apos;&#123;&quot;title&quot;:&quot;sample project&quot;&#125;&apos; -H &quot;Content-Type: application/json&quot; -X POST todoapp-alb-91218331.ap-southeast-2.elb.amazonaws.com/projects</span><br><span class="line">&#123;&quot;ID&quot;:1,&quot;CreatedAt&quot;:&quot;2019-07-21T12:20:38.881103057Z&quot;,&quot;UpdatedAt&quot;:&quot;2019-07-21T12:20:38.881103057Z&quot;,&quot;DeletedAt&quot;:null,&quot;title&quot;:&quot;sample project&quot;,&quot;archived&quot;:false,&quot;tasks&quot;:null&#125;</span><br><span class="line"></span><br><span class="line">curl todoapp-alb-91218331.ap-southeast-2.elb.amazonaws.com/projects</span><br><span class="line">[&#123;&quot;ID&quot;:1,&quot;CreatedAt&quot;:&quot;2019-07-21T12:20:38.881103Z&quot;,&quot;UpdatedAt&quot;:&quot;2019-07-21T12:20:38.881103Z&quot;,&quot;DeletedAt&quot;:null,&quot;title&quot;:&quot;sample project&quot;,&quot;archived&quot;:false,&quot;tasks&quot;:null&#125;]</span><br><span class="line"></span><br><span class="line">ssh bastion</span><br><span class="line">export PGPASSWORD=foobar</span><br><span class="line">export PGHOST=todoapp.foobar.ap-southeast-2.rds.amazonaws.com</span><br><span class="line">psql -U terraform -d todoapp</span><br><span class="line">todoapp=&gt; \d+</span><br><span class="line">                             List of relations</span><br><span class="line"> Schema |      Name       |   Type   |   Owner   |    Size    | Description</span><br><span class="line">--------+-----------------+----------+-----------+------------+-------------</span><br><span class="line"> public | projects        | table    | terraform | 16 kB      |</span><br><span class="line"> public | projects_id_seq | sequence | terraform | 8192 bytes |</span><br><span class="line"> public | tasks           | table    | terraform | 8192 bytes |</span><br><span class="line"> public | tasks_id_seq    | sequence | terraform | 8192 bytes |</span><br><span class="line">(4 rows)</span><br><span class="line">todoapp=&gt; select * from projects;</span><br><span class="line"> id |          created_at           |          updated_at           | deleted_at |     title      | archived</span><br><span class="line">----+-------------------------------+-------------------------------+------------+----------------+----------</span><br><span class="line">  1 | 2019-07-21 12:20:38.881103+00 | 2019-07-21 12:20:38.881103+00 |            | sample project | f</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure></p>
<h2 id="Working-with-dependency-graph"><a href="#Working-with-dependency-graph" class="headerlink" title="Working with dependency graph"></a>Working with dependency graph</h2><p><strong>Dependency graph</strong></p>
<ul>
<li>All resources in the configuration are organized into a graph</li>
<li>The graph is used to determine the order in which the resources are created<br><img src="https://i.imgur.com/9swFk8u.png" alt="Directed acyclic graph"><br>Terraform organizes all resources in a configuration in a directed acyclic graph. What this means in plain English is that the dependencies between the resources go in one direction, and there can be no cycles. So, no circular dependencies. When we run the plan command, Terraform builds this graph, checks whether there are any cycles, and then determines which operations can be run in parallel. By default, up to ten nodes in the graph can be processed concurrently. We can control this setting using the parallelism flag on the plan, apply, and destroy commands, but in most cases this is not required.<br><strong>Parallelism</strong></li>
<li>Up to 10 nodes can be processed concurrently by default</li>
<li>Conifgurable with <strong>-parallemism</strong> flag for plan, apply, and destroy commands (advanced setting)<br><strong>Dependencies</strong></li>
<li><p>Implicit-one resource references another resource using the interpolation syntax</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_lb&quot; &quot;todo_app&quot; &#123;</span><br><span class="line">    security_groups = [&quot;$&#123;aws_security_group.lb.id&#125;&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Explicit-using depends_on metaparameter<br> <code>depends_on = [&quot;aws_security_group.lb&quot;]</code></p>
</li>
</ul>
<p>Use explicit dependencies to resolve race conditions<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Have to set an explicit dependency here to avoid</span><br><span class="line">  # race condition with LB creation</span><br><span class="line">depends_on = [&quot;aws_lb_listener.todo_app&quot;]</span><br></pre></td></tr></table></figure></p>
<p><strong>tools</strong></p>
<ol>
<li><p><a href="http://graphviz.gitlab.io/download/">Graphviz</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">terraform graph|dot -Tpng &gt; graph.png</span><br><span class="line">terraform plan</span><br><span class="line">terraform graph -draw-cycles|dot -Tpng &gt; graph.png</span><br></pre></td></tr></table></figure>
</li>
<li><p><a href="https://github.com/28mm/blast-radius">blast radius</a></p>
</li>
</ol>
<h2 id="Main-takeaways"><a href="#Main-takeaways" class="headerlink" title="Main takeaways"></a>Main takeaways</h2><ul>
<li>Use outputs and remote state data source to integrate stacks of resources in a complex environment</li>
<li>Keep your code DRY by using <em>count</em> parameter and splat expressions</li>
<li>Use <strong>templates</strong> to generate complex string inputs, such as user data scripts or ECS task definitions</li>
</ul>
<h1 id="Creating-reusable-components-with-moduels"><a href="#Creating-reusable-components-with-moduels" class="headerlink" title="Creating reusable components with moduels"></a>Creating reusable components with moduels</h1><h2 id="Modules"><a href="#Modules" class="headerlink" title="Modules"></a>Modules</h2><ul>
<li>Self-contained packages of Terraform configurations that are managed as a group<br>When we want to avoid writing duplicate code in a general-purpose programming language, we usually write a library. In, Terraform, we can put our code in a <strong>module</strong>.</li>
<li>Improve code resue</li>
<li>Provide an abstration layer<br>for example, you may need to add a vault cluster to your environment, and the vault is another great Hashicorp tool which is used for managing secrets, which requires dozens of components - but instead of thinking about individual security groups or EC2 instances, you can treat all these resources as a single group which requires some parameters, and gives you a ready-to-use vault cluster. </li>
<li>Can be teated as blackbox</li>
<li>Share best practices within an organization</li>
<li>Versioned artifacts</li>
</ul>
<h2 id="Creating-the-first-module"><a href="#Creating-the-first-module" class="headerlink" title="Creating the first module"></a>Creating the first module</h2><ul>
<li>Root module:<ul>
<li>The current working dirctory holding Terraform files</li>
</ul>
</li>
<li>Child modules:<ul>
<li>All modules sourced by the root (parent) module<br><strong>Delaring Modules</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">module &quot;child&quot; &#123;</span><br><span class="line">source = &quot;./child&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ol>
<li>rename ecs app project to module.ecs_app_web<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat main.tf</span><br><span class="line">module &quot;child&quot; &#123;</span><br><span class="line">    source = &quot;../module.ecs_app_web&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>terraform get</strong></p>
<ul>
<li>terraform get: Download modules referenced in the root module</li>
<li>terraform get -update: Check the downloaded modules for updates and download the new versions. if present<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> terraform get -update</span><br><span class="line">- module.child</span><br><span class="line">  Updating source &quot;../module.ecs_app_web&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>When you run terraform get, the local modules will be simlinked into .terraform directory, so you can inspect what’s there if you notice some unexpected behavior.</p>
<ol start="2">
<li>copy terraform.tfvars and variables.tf, modify main.tf file, add<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">region = &quot;$&#123;var.region&#125;&quot; </span><br><span class="line">app_image_version = &quot;$&#123;var.app_image_version&#125;&quot; </span><br><span class="line">app_image_repository = &quot;$&#123;var.app_image_repository&#125;&quot; </span><br><span class="line">app_name = &quot;$&#123;var.app_name&#125;&quot; </span><br><span class="line">container_port = &quot;$&#123;var.container_port&#125;&quot; </span><br><span class="line">desired_count = &quot;$&#123;var.desired_count&#125;&quot; </span><br><span class="line">pgsslmode = &quot;$&#123;var.pgsslmode&#125;&quot; </span><br><span class="line">network_mode = &quot;$&#123;var.network_mode&#125;&quot; </span><br><span class="line">requires_compatibilities = &quot;$&#123;var.requires_compatibilities&#125;&quot; </span><br><span class="line">launch_type = &quot;$&#123;var.launch_type&#125;&quot; </span><br><span class="line">health_check_path = &quot;$&#123;var.health_check_path&#125;&quot;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>terraform providers</strong></p>
<ul>
<li>terraform providers:<ul>
<li>Print information about the providers used in the currrent configuration</li>
</ul>
</li>
<li>terraform providers [config-path]:<ul>
<li>Pass an explicit path to the configuration instead of using the current working directory by default<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> terraform providers</span><br><span class="line">.</span><br><span class="line">└── module.child</span><br><span class="line">    ├── provider.aws 1.31</span><br><span class="line">    ├── provider.template 1.0.0</span><br><span class="line">    └── provider.terraform</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>There is only one module, and it uses two providers - AWS and Template, plus a special provider called Terraform, which is responsible for working with the remote state backend.</p>
<p><strong>best practices</strong>: Keep explicit provider configurations only in the root module, and pass them down to descendant modules.</p>
<p><strong>Two wasy pass providers</strong></p>
<ul>
<li>the most common approach: let the descendant modules inherit the providers implicitly - that is, automatically</li>
<li>have several providers of the same type, and then pass them explicitly by alias; this can be useful if we need to create resources in different AWS regions, for example</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">root@stan-OptiPlex-380:~stan/Doc/Terraform/ecs_app_todo|master⚡</span><br><span class="line">⇒  mv ../module.ecs_app_web/providers.tf ./</span><br><span class="line">root@stan-OptiPlex-380:~stan/Doc/Terraform/ecs_app_todo|master⚡</span><br><span class="line">⇒  terraform init</span><br><span class="line">Initializing modules...</span><br><span class="line">- module.child</span><br><span class="line"></span><br><span class="line">Initializing the backend...</span><br><span class="line"></span><br><span class="line">Successfully configured the backend &quot;s3&quot;! Terraform will automatically</span><br><span class="line">use this backend unless the backend configuration changes.</span><br><span class="line"></span><br><span class="line">Initializing provider plugins...</span><br><span class="line">- Checking for available provider plugins on https://releases.hashicorp.com...</span><br><span class="line">- Downloading plugin for provider &quot;aws&quot; (1.31.0)...</span><br><span class="line">- Downloading plugin for provider &quot;template&quot; (1.0.0)...</span><br><span class="line"></span><br><span class="line">Terraform has been successfully initialized!</span><br><span class="line"></span><br><span class="line">You may now begin working with Terraform. Try running &quot;terraform plan&quot; to see</span><br><span class="line">any changes that are required for your infrastructure. All Terraform commands</span><br><span class="line">should now work.</span><br><span class="line"></span><br><span class="line">If you ever set or change modules or backend configuration for Terraform,</span><br><span class="line">rerun this command to reinitialize your working directory. If you forget, other</span><br><span class="line">commands will detect it and remind you to do so if necessary.</span><br><span class="line">root@stan-OptiPlex-380:~stan/Doc/Terraform/ecs_app_todo|master⚡</span><br><span class="line">⇒  terraform providers</span><br><span class="line">.</span><br><span class="line">├── provider.aws 1.31</span><br><span class="line">├── provider.template 1.0.0</span><br><span class="line">├── provider.terraform (from state)</span><br><span class="line">└── module.child</span><br><span class="line">    ├── provider.aws (inherited)</span><br><span class="line">    ├── provider.template (inherited)</span><br><span class="line">    └── provider.terraform</span><br></pre></td></tr></table></figure>
<p><strong>Use module-relative path for embedded files (${path.module})</strong></p>
<p><strong>Encapsulation</strong></p>
<ul>
<li>A language mechanism for restricting direct access to some of the object’s components</li>
</ul>
<p>we can choose to make the module as transparent as possible - and in this case, it would inject all dependencies from the root module, and keep no data sources in the child module</p>
<h1 id="Error-and-debug"><a href="#Error-and-debug" class="headerlink" title="Error and debug"></a>Error and debug</h1><ol>
<li>Error 1:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">Initializing the backend...</span><br><span class="line">Backend configuration changed!</span><br><span class="line"></span><br><span class="line">Terraform has detected that the configuration specified for the backend</span><br><span class="line">has changed. Terraform will now check for existing state in the backends.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Error inspecting states in the &quot;s3&quot; backend:</span><br><span class="line">    NoSuchBucket: The specified bucket does not exist</span><br><span class="line">        status code: 404, request id: E51C641611FF2763, host id: 9AN52en4R7RaZueavAicV5/N01SahL+Y1TZBT8TGnYBYYD5ywWxPKgkiiqDx8+FsgkwNNyadfSU=</span><br><span class="line"></span><br><span class="line">Prior to changing backends, Terraform inspects the source and destination</span><br><span class="line">states to determine what kind of migration steps need to be taken, if any.</span><br><span class="line">Terraform failed to load the states. The data in both the source and the</span><br><span class="line">destination remain unmodified. Please resolve the above error and try again.</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>Debug mode:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> TF_LOG=trace terraform init</span><br><span class="line">2019/07/21 11:50:39 [INFO] Terraform version: 0.11.7  41e50bd32a8825a84535e353c3674af8ce799161</span><br><span class="line">2019/07/21 11:50:39 [INFO] Go runtime version: go1.10.1</span><br><span class="line">2019/07/21 11:50:39 [INFO] CLI args: []string&#123;&quot;/root/.terraform.versions/terraform_0.11.7&quot;, &quot;init&quot;&#125;</span><br><span class="line">2019/07/21 11:50:39 [DEBUG] Attempting to open CLI config file: /root/.terraformrc</span><br><span class="line">2019/07/21 11:50:39 [DEBUG] File doesn&apos;t exist, but doesn&apos;t need to. Ignoring.</span><br><span class="line">2019/07/21 11:50:39 [INFO] CLI command args: []string&#123;&quot;init&quot;&#125;</span><br><span class="line">2019/07/21 11:50:39 [DEBUG] command: loading backend config file: /root/terraform/vpc</span><br><span class="line"></span><br><span class="line">Initializing the backend...</span><br><span class="line">2019/07/21 11:50:39 [TRACE] Preserving existing state linea</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>Error2:<br><img src="https://i.imgur.com/NvWneaV.png" alt="error2"><br>if ecs try to connect to localhost as rds, and couldnot connect sucessfully</li>
</ol>
<p>Debug:<br>ecs_task.tpl pg environment vars are all missing</p>
<!-- theme: spkane -->
<!-- _class: lead -->
<!-- $size: 16:9 -->
<h1 id="Terraform"><a href="#Terraform" class="headerlink" title="Terraform"></a>Terraform</h1><h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p><br></br><br><br></br></p>
<h6 id="Release-BUILD-RELEASE"><a href="#Release-BUILD-RELEASE" class="headerlink" title="Release %BUILD_RELEASE%"></a>Release %BUILD_RELEASE%</h6><hr>
<!-- _class: lead -->
<h1 id="Instructor"><a href="#Instructor" class="headerlink" title="Instructor"></a>Instructor</h1><h1 id="Sean-P-Kane"><a href="#Sean-P-Kane" class="headerlink" title="Sean P. Kane"></a>Sean P. Kane</h1><h3 id="spkane"><a href="#spkane" class="headerlink" title="@spkane"></a>@spkane</h3><p><img src="images/skane-2018-side-black-cropped.jpg" alt="bg right"></p>
<hr>
<!-- footer: Copyright © 2015-2020, Sean P. Kane (@spkane) -->
<!-- paginate: true -->
<!-- _class: lead -->
<h1 id="Follow-Along-Guide"><a href="#Follow-Along-Guide" class="headerlink" title="Follow Along Guide"></a><a href="https://gist.github.com/spkane/df02f7858f6bef9f045fa1c296f8146f">Follow Along Guide</a></h1><h2 id="Textual-Slides"><a href="#Textual-Slides" class="headerlink" title="Textual Slides"></a>Textual Slides</h2><hr>
<h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><ul>
<li>A recent computer and OS<ul>
<li>Recent Linux, OS X, or Windows 10</li>
<li>Reliable and fast internet connectivity</li>
</ul>
</li>
<li>Hashicorp Terraform</li>
</ul>
<hr>
<h1 id="Prerequisites-1"><a href="#Prerequisites-1" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><ul>
<li>A graphical web browser</li>
<li>A text editor</li>
<li>A software package manager</li>
<li>Git client</li>
<li>General comfort with the command line will be helpful.</li>
<li>[optional] tar, wget, curl, jq, SSH client</li>
</ul>
<hr>
<h1 id="A-Note-for-Windows-Users"><a href="#A-Note-for-Windows-Users" class="headerlink" title="A Note for Windows Users"></a>A Note for Windows Users</h1><p>This class was written from a largely Unix based perspective, but everything can be made to work in Windows with very little effort.</p>
<ul>
<li>Unix Variables<ul>
<li><code>export MY_VAR=test</code></li>
<li><code>echo ${MY_VAR}</code></li>
</ul>
</li>
<li>Windows 10 Variables (powershell)<ul>
<li><code>$env:my_var = &quot;test&quot;</code></li>
<li><code>Get-ChildItem Env:my_var</code></li>
</ul>
</li>
</ul>
<hr>
<h1 id="A-Note-About-Proxies"><a href="#A-Note-About-Proxies" class="headerlink" title="A Note About Proxies"></a>A Note About Proxies</h1><p>Proxies can interfere with some activities if they are not configured correctly.</p>
<hr>
<h1 id="Instructor-Environment"><a href="#Instructor-Environment" class="headerlink" title="Instructor Environment"></a>Instructor Environment</h1><ul>
<li><strong>Operating System</strong>: Mac OS X (v10.15.X+)</li>
<li><strong>Terminal</strong>: iTerm2 (Build 3.X.X+) - <a href="https://www.iterm2.com/">https://www.iterm2.com/</a></li>
<li><strong>Shell Customization</strong>: Bash-it - <a href="https://github.com/Bash-it/bash-it">https://github.com/Bash-it/bash-it</a></li>
<li><strong>Shell Prompt Theme</strong>: Starship - <a href="https://starship.rs/">https://starship.rs/</a></li>
<li><strong>Shell Prompt Font</strong>: Fira Code - <a href="https://github.com/tonsky/FiraCode">https://github.com/tonsky/FiraCode</a></li>
<li><strong>Text Editor</strong>: Visual Studio Code (v1.X.X+) - <a href="https://code.visualstudio.com/">https://code.visualstudio.com/</a></li>
</ul>
<hr>
<h1 id="Definition"><a href="#Definition" class="headerlink" title="Definition"></a>Definition</h1><ul>
<li><strong>ter·ra·form</strong></li>
<li><em>/ˈterəˌfôrm/</em><ul>
<li>(verb) to alter a planet for the purpose of sustaining life</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Hashicorp-Terraform"><a href="#Hashicorp-Terraform" class="headerlink" title="Hashicorp Terraform"></a>Hashicorp Terraform</h1><ul>
<li>Terraform is a tool that makes it possible to document and automate the creation, modification, and destruction of almost anything that can be managed by an API.</li>
<li>This means that it is finally conceivable to automate the management of everything that your software stacks needs to actually run in any environment, including cloud resources, DNS entries, CDN configuration, and much more.</li>
</ul>
<hr>
<h1 id="Installing-Terraform"><a href="#Installing-Terraform" class="headerlink" title="Installing Terraform"></a>Installing Terraform</h1><ul>
<li>Download:<ul>
<li><a href="https://www.terraform.io/downloads.html">https://www.terraform.io/downloads.html</a></li>
</ul>
</li>
<li>Unarchive and copy into your executable $PATH</li>
</ul>
<hr>
<h1 id="Version-0-12"><a href="#Version-0-12" class="headerlink" title="Version 0.12"></a>Version 0.12</h1><ul>
<li>Version 0.12 of terraform was a major release that included many significant improvements, but also included some breaking changes.</li>
<li>Be aware that code written for terraform 0.12 is not compatible with earlier releases and that in general, you should not use not use older terraform binaries with existing terraform managed infrastructure.</li>
</ul>
<hr>
<h1 id="Code-Setup"><a href="#Code-Setup" class="headerlink" title="Code Setup"></a>Code Setup</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$&#123;HOME&#125;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir class-terraform-starting</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$&#123;HOME&#125;</span>/class-terraform-starting</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/spkane/todo-for-terraform \</span></span><br><span class="line">    --config core.autocrlf=input</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> todo-for-terraform</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Exploring-Terraform"><a href="#Exploring-Terraform" class="headerlink" title="Exploring Terraform"></a>Exploring Terraform</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> terraform-infrastructure</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="HCL-amp-JSON"><a href="#HCL-amp-JSON" class="headerlink" title="HCL &amp; JSON"></a>HCL &amp; JSON</h1><ul>
<li>Hashicorp Configuration Language v2<ul>
<li><a href="https://github.com/hashicorp/hcl/tree/hcl2">https://github.com/hashicorp/hcl/tree/hcl2</a></li>
</ul>
</li>
<li><p>HCL is a JSON-compatible configuration language written by Hashicorp to be machine and human friendly.</p>
</li>
<li><p>HCL is intended to provide a less-verbose JSON style configuration language that supports comments, while also providing humans with a language that is easier to approach than YAML.</p>
</li>
</ul>
<hr>
<h1 id="Terraform-amp-Backends"><a href="#Terraform-amp-Backends" class="headerlink" title="Terraform &amp; Backends"></a>Terraform &amp; Backends</h1><ul>
<li>Open <code>main.tf</code><ul>
<li>Terraform block<ul>
<li>Define high-level requirements for this associated HCL. Terraform and provider version, etc.</li>
</ul>
</li>
<li>Backend block<ul>
<li>Define where remote state is stored and any information required to read and write it.</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Providers-1-of-2"><a href="#Providers-1-of-2" class="headerlink" title="Providers (1 of 2)"></a>Providers (1 of 2)</h1><ul>
<li>Providers<ul>
<li>Individual plugins that enable terraform to properly interact with an API.</li>
<li>These can range between Hashicorp’s officially supported providers to custom providers written by a single developer.</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Providers-2-of-2"><a href="#Providers-2-of-2" class="headerlink" title="Providers (2 of 2)"></a>Providers (2 of 2)</h1><ul>
<li>In this example we are using the <code>aws</code> and <code>ns1</code> providers.<ul>
<li><a href="https://github.com/terraform-providers/terraform-provider-aws">https://github.com/terraform-providers/terraform-provider-aws</a></li>
<li><a href="https://github.com/terraform-providers/terraform-provider-ns1">https://github.com/terraform-providers/terraform-provider-ns1</a></li>
</ul>
</li>
</ul>
<hr>
<h1 id="Variables-1"><a href="#Variables-1" class="headerlink" title="Variables"></a>Variables</h1><ul>
<li>Open <code>variables.tf</code><ul>
<li>Defines all the variables that you will be using and their default values.</li>
</ul>
</li>
<li>You will get errors if you use variables that are not defined in this file.</li>
</ul>
<hr>
<h1 id="Data-Sources"><a href="#Data-Sources" class="headerlink" title="Data Sources"></a>Data Sources</h1><ul>
<li>Open <code>data.tf</code></li>
<li>Using output as input<ul>
<li>Remote Terraform State</li>
<li>APIs</li>
<li>Scripts<ul>
<li>Open <code>bin/local-ip.sh</code></li>
</ul>
</li>
<li>etc</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Building-Infrastructure"><a href="#Building-Infrastructure" class="headerlink" title="Building Infrastructure"></a>Building Infrastructure</h1><ul>
<li><code>key-pairs.tf</code></li>
<li><code>backend.tf</code></li>
<li><code>frontend.tf</code></li>
<li><code>security-groups.tf</code></li>
</ul>
<hr>
<h1 id="Backend-Service"><a href="#Backend-Service" class="headerlink" title="Backend Service"></a>Backend Service</h1><ul>
<li>Open <code>key-pairs.tf</code><ul>
<li>SSH public key for system access</li>
</ul>
</li>
<li>Open <code>backend.tf</code><ul>
<li>Server Instance w/ basic provisioning</li>
<li>Setup of <code>todo</code> backend service</li>
</ul>
</li>
<li>The files in <code>./files</code> support the system provisioning.</li>
</ul>
<hr>
<h1 id="Frontend-Infrastructure"><a href="#Frontend-Infrastructure" class="headerlink" title="Frontend Infrastructure"></a>Frontend Infrastructure</h1><ul>
<li>Open <code>frontend.tf</code><ul>
<li>S3 bucket (file share) for Load Balancer Logs<ul>
<li>Security Policy for access to S3 bucket</li>
</ul>
</li>
<li>Load Balancer for backend <code>todo</code> service<ul>
<li>Listener</li>
<li>Target Group</li>
<li>Target Group Attachment</li>
</ul>
</li>
<li>DNS record for load balancer</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Firewall-Security"><a href="#Firewall-Security" class="headerlink" title="Firewall Security"></a>Firewall Security</h1><ul>
<li>Open <code>security-groups.tf</code><ul>
<li>SSH to the backend server</li>
<li>Traffic between load balancer and <code>todo</code> service</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Outputs"><a href="#Outputs" class="headerlink" title="Outputs"></a>Outputs</h1><ul>
<li>Open <code>outputs.tf</code><ul>
<li>Human and computer-readable data</li>
</ul>
</li>
</ul>
<hr>
<h1 id="The-Graph"><a href="#The-Graph" class="headerlink" title="The Graph"></a>The Graph</h1><p><img src="images/graph.png" alt="bg contain"></p>
<hr>
<h1 id="The-Setup"><a href="#The-Setup" class="headerlink" title="The Setup"></a>The Setup</h1><ul>
<li><code>terraform init</code></li>
</ul>
<hr>
<h1 id="The-Plan"><a href="#The-Plan" class="headerlink" title="The Plan"></a>The Plan</h1><ul>
<li><code>terraform plan</code></li>
</ul>
<hr>
<h1 id="The-Apply"><a href="#The-Apply" class="headerlink" title="The Apply"></a>The Apply</h1><ul>
<li><code>terraform apply</code><ul>
<li>If all looks good, answer: <code>yes</code></li>
</ul>
</li>
</ul>
<hr>
<h1 id="The-Outputs"><a href="#The-Outputs" class="headerlink" title="The Outputs"></a>The Outputs</h1><ul>
<li><code>terraform output</code></li>
</ul>
<hr>
<h1 id="The-State-File"><a href="#The-State-File" class="headerlink" title="The State File"></a>The State File</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state list</span><br><span class="line">$ terraform state show aws_instance.todo[0]</span><br><span class="line">$ terraform state pull &gt; \</span><br><span class="line">    $HOME/class-terraform-starting/state.json</span><br><span class="line">$ less $HOME/class-terraform-starting/state.json</span><br><span class="line">$ rm $HOME/class-terraform-starting/state.json</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Examine-the-Server"><a href="#Examine-the-Server" class="headerlink" title="Examine the Server"></a>Examine the Server</h1><ul>
<li><code>ssh -i $HOME/.ssh/oreilly_aws ubuntu@${todo_ip}</code></li>
<li><code>sudo systemctl status todo-list</code></li>
<li><code>exit</code></li>
<li><code>cd ..</code></li>
</ul>
<hr>
<h1 id="Test-the-Todo-API"><a href="#Test-the-Todo-API" class="headerlink" title="Test the Todo API"></a>Test the Todo API</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ source ./bin/ip_vars.sh</span><br><span class="line">$ curl -i http://todo-api.spkane.org:8080/</span><br><span class="line">$ curl -i http://todo-api.spkane.org:8080/ -X POST \</span><br><span class="line">    -H &apos;Content-Type: application/spkane.todo-list.v1+json&apos; \</span><br><span class="line">    -d &apos;&#123;&quot;description&quot;:&quot;go shopping&quot;,&quot;completed&quot;:false&#125;&apos;</span><br><span class="line">$ curl -i http://todo-api.spkane.org:8080/</span><br><span class="line">$ curl -i http://todo-api.spkane.org:8080/1 -X DELETE \</span><br><span class="line">    -H &apos;Content-Type: application/spkane.todo-list.v1+json&apos;</span><br><span class="line">$ curl -i http://todo-api.spkane.org:8080/</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Download-the-Todo-Provider"><a href="#Download-the-Todo-Provider" class="headerlink" title="Download the Todo Provider"></a>Download the Todo Provider</h1><ul>
<li>Open in your web browser:<ul>
<li><a href="https://github.com/spkane/todo-for-terraform/releases/tag/v1.0.0">https://github.com/spkane/todo-for-terraform/releases/tag/v1.0.0</a></li>
</ul>
</li>
<li>Download the <code>terraform-provider-todo</code> archive for your platform.</li>
</ul>
<hr>
<h1 id="Install-the-Todo-Provider"><a href="#Install-the-Todo-Provider" class="headerlink" title="Install the Todo Provider"></a>Install the Todo Provider</h1><ul>
<li><code>cd $HOME/Downloads</code><ul>
<li>or where ever you downloaded the archive to.</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ unzip terraform-provider-todo-*.zip</span><br><span class="line">$ mv terraform-provider-todo \</span><br><span class="line">    $HOME/class-terraform-starting/todo-for-terraform/terraform-tests/</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Copy-the-Code"><a href="#Copy-the-Code" class="headerlink" title="Copy the Code"></a>Copy the Code</h1><ul>
<li><code>cd $HOME/class-terraform-starting/todo-for-terraform</code></li>
<li><code>mkdir -p tf-code</code></li>
<li><code>cp -a terraform-tests tf-code</code></li>
<li><code>cd ./tf-code/terraform-tests</code></li>
</ul>
<hr>
<h1 id="Defining-Variables"><a href="#Defining-Variables" class="headerlink" title="Defining Variables"></a>Defining Variables</h1><ul>
<li>Open <code>variables.tf</code><ul>
<li>This is where we define variables we will use in the terraform code.</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Using-the-Todo-Provider"><a href="#Using-the-Todo-Provider" class="headerlink" title="Using the Todo Provider"></a>Using the Todo Provider</h1><ul>
<li>Open <code>main.tf</code><ul>
<li>Configure the todo provider<ul>
<li>Change <code>host = &quot;127.0.0.1&quot;</code> to <code>host = &quot;todo-api.spkane.org&quot;</code></li>
</ul>
</li>
<li>Create 5 new todos</li>
<li>Read 1 existing todo as a data source</li>
<li>Create 5 more new todos based on the data source</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Defining-Outputs"><a href="#Defining-Outputs" class="headerlink" title="Defining Outputs"></a>Defining Outputs</h1><ul>
<li>Open <code>outputs.tf</code><ul>
<li>Prints the IDs for all of the new todos</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Prepare-the-Data"><a href="#Prepare-the-Data" class="headerlink" title="Prepare the Data"></a>Prepare the Data</h1><ul>
<li>We need a todo with ID 1 to read in as an example data source:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -i http://todo-api.spkane.org:8080/</span><br><span class="line">curl -i http://todo-api.spkane.org:8080/ -X POST \</span><br><span class="line">    -H &apos;Content-Type: application/spkane.todo-list.v1+json&apos; \</span><br><span class="line">    -d &apos;&#123;&quot;description&quot;:&quot;go shopping&quot;,&quot;completed&quot;:false&#125;&apos;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="macOS-Catalina-Notice"><a href="#macOS-Catalina-Notice" class="headerlink" title="macOS Catalina+ Notice"></a>macOS Catalina+ Notice</h1><ul>
<li>You may need to whitelist the provider binary, since it is not signed.<ul>
<li>Run <code>./terraform-provider-todo</code><ul>
<li>Click <code>Cancel</code></li>
</ul>
</li>
<li>Go to <code>System Preferences</code> → <code>Security &amp; Privacy</code> → <code>General</code><ul>
<li>Click <code>Allow Anyway</code></li>
</ul>
</li>
<li>Run <code>./terraform-provider-todo</code><ul>
<li>Click <code>Open</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Apply-Terraform-Code"><a href="#Apply-Terraform-Code" class="headerlink" title="Apply Terraform Code"></a>Apply Terraform Code</h1><ul>
<li><code>terraform init</code></li>
<li><code>terrraform apply</code><ul>
<li><strong>Plan</strong>: 10 to add, 0 to change, 0 to destroy.<ul>
<li>If all looks good, answer: <code>yes</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Examine-the-Outputs"><a href="#Examine-the-Outputs" class="headerlink" title="Examine the Outputs"></a>Examine the Outputs</h1><ul>
<li><p><code>terraform output</code></p>
</li>
<li><p>You may notice that your IDs are likely not in order. This is because, by default terraform creates many of the resources in parallel and we have many students using the server at the same time.</p>
</li>
</ul>
<hr>
<h1 id="Examine-The-State-File"><a href="#Examine-The-State-File" class="headerlink" title="Examine The State File"></a>Examine The State File</h1><ul>
<li><p>Examine the state from one of the resulting todos</p>
<ul>
<li><code>state show todo.test1[0]</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># todo.test1[0]:</span><br><span class="line">resource &quot;todo&quot; &quot;test1&quot; &#123;</span><br><span class="line">    completed   = false</span><br><span class="line">    description = &quot;0-1 test todo&quot;</span><br><span class="line">    id          = &quot;6&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h1 id="The-Real-Object"><a href="#The-Real-Object" class="headerlink" title="The Real Object"></a>The Real Object</h1><ul>
<li>From the output of the last command, grab the ID and use it at the end of this command.</li>
<li><code>curl -i http://todo-api.spkane.org:8080/6</code></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 01 Jan 2020 20:13:45 GMT</span><br><span class="line">Content-Type: application/spkane.todo-list.v1+json</span><br><span class="line">Content-Length: 59</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[&#123;<span class="attr">"completed"</span>:<span class="literal">false</span>,<span class="attr">"description"</span>:<span class="string">"0-1 test todo"</span>,<span class="attr">"id"</span>:<span class="number">6</span>&#125;]</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Updating-Objects"><a href="#Updating-Objects" class="headerlink" title="Updating Objects"></a>Updating Objects</h1><ul>
<li>Change the 2 <code>count = 5</code> lines to read <code>count = 4</code></li>
<li>Add <code>(updated)</code> to the end of the first description string.</li>
</ul>
<hr>
<h1 id="Code-With-Edits"><a href="#Code-With-Edits" class="headerlink" title="Code With Edits"></a>Code With Edits</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;todo&quot; &quot;test1&quot; &#123;</span><br><span class="line">  count = 4</span><br><span class="line">  description = &quot;$&#123;count.index&#125;-1 test todo (updated)&quot;</span><br><span class="line">  completed = false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;todo&quot; &quot;test2&quot; &#123;</span><br><span class="line">  count = 4</span><br><span class="line">  description = &quot;$&#123;count.index&#125;-2 test todo (linked to $&#123;data.todo.foreign.id&#125;)&quot;</span><br><span class="line">  completed = false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Examine-The-First-amp-Last-Todo"><a href="#Examine-The-First-amp-Last-Todo" class="headerlink" title="Examine The First &amp; Last Todo"></a>Examine The First &amp; Last Todo</h1><ul>
<li><code>terraform state show todo.test1[0]</code></li>
<li><code>terraform state show todo.test1[4]</code></li>
</ul>
<hr>
<h1 id="Apply-The-Updates"><a href="#Apply-The-Updates" class="headerlink" title="Apply The Updates"></a>Apply The Updates</h1><ul>
<li><code>terrraform apply</code><ul>
<li><strong>Plan</strong>: 0 to add, 4 to change, 2 to destroy.<ul>
<li>If all looks good, answer: <code>yes</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Re-examine-The-First-amp-Last-Todo"><a href="#Re-examine-The-First-amp-Last-Todo" class="headerlink" title="Re-examine The First &amp; Last Todo"></a>Re-examine The First &amp; Last Todo</h1><ul>
<li><code>terraform state show todo.test1[0]</code><ul>
<li>The description should now be updated.</li>
</ul>
</li>
<li><code>terraform state show todo.test1[4]</code><ul>
<li>This should give you an error since it has now been deleted.</li>
</ul>
</li>
<li><code>terraform state show todo.test1[3]</code> will work however, since we only have 4 todos now.</li>
</ul>
<hr>
<h1 id="Prepare-to-Import"><a href="#Prepare-to-Import" class="headerlink" title="Prepare to Import"></a>Prepare to Import</h1><ul>
<li>Create a new todo by hand:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http://todo-api.spkane.org:8080/ -X POST \</span><br><span class="line">    -H &apos;Content-Type: application/spkane.todo-list.v1+json&apos; \</span><br><span class="line">    -d &apos;&#123;&quot;description&quot;:&quot;Imported Todo&quot;,&quot;completed&quot;:false&#125;&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>Note the ID in your output (<em>13</em> in this example): <code>{&quot;completed&quot;:false,&quot;description&quot;:&quot;Imported Todo&quot;,&quot;id&quot;:13}</code></li>
</ul>
<hr>
<h1 id="Modify-The-Code"><a href="#Modify-The-Code" class="headerlink" title="Modify The Code"></a>Modify The Code</h1><ul>
<li>In <code>main.tf</code> add:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;todo&quot; &quot;imported&quot; &#123;</span><br><span class="line">  description = &quot;Imported Todo&quot;</span><br><span class="line">  completed = false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Run-a-Plan"><a href="#Run-a-Plan" class="headerlink" title="Run a Plan"></a>Run a Plan</h1><ul>
<li><code>terraform plan</code><ul>
<li>You should see: <strong>Plan</strong>: 1 to add, 0 to change, 0 to destroy.</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># todo.imported will be created</span><br><span class="line">+ resource &quot;todo&quot; &quot;imported&quot; &#123;</span><br><span class="line">    + completed   = false</span><br><span class="line">    + description = &quot;Imported Todo&quot;</span><br><span class="line">    + id          = (known after apply)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Import-a-Pre-Existing-Todo"><a href="#Import-a-Pre-Existing-Todo" class="headerlink" title="Import a Pre-Existing Todo"></a>Import a Pre-Existing Todo</h1><ul>
<li>Import the ID of the Todo that you just created.<ul>
<li><code>terraform import todo.imported[0] 13</code></li>
</ul>
</li>
</ul>
<hr>
<h1 id="Re-run-the-Plan"><a href="#Re-run-the-Plan" class="headerlink" title="Re-run the Plan"></a>Re-run the Plan</h1><ul>
<li><code>terraform plan</code><ul>
<li>You should see<ul>
<li><strong>No changes. Infrastructure is up-to-date.</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Rename-a-Resource"><a href="#Rename-a-Resource" class="headerlink" title="Rename a Resource"></a>Rename a Resource</h1><ul>
<li>In <code>main.tf</code>:<ul>
<li>change the line <code>resource &quot;todo&quot; &quot;imported&quot; {</code> to read <code>resource &quot;todo&quot; &quot;primary&quot; {</code></li>
</ul>
</li>
<li>Run <code>terraform plan</code><ul>
<li>You should see<ul>
<li><strong>Plan</strong>: 1 to add, 0 to change, 1 to destroy.</li>
</ul>
</li>
</ul>
</li>
<li>This would delete one todo and create a new one.<ul>
<li>This is not what we want.</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Manipulating-State"><a href="#Manipulating-State" class="headerlink" title="Manipulating State"></a>Manipulating State</h1><ul>
<li><code>terraform state mv todo.imported todo.primary</code></li>
<li>Run <code>terraform plan</code><ul>
<li>You should see<ul>
<li><strong>No changes. Infrastructure is up-to-date.</strong></li>
</ul>
</li>
</ul>
</li>
<li>By moving the state of the existing resource to the new name, everything lines back up properly.</li>
</ul>
<hr>
<h1 id="Terraform-Modules"><a href="#Terraform-Modules" class="headerlink" title="Terraform Modules"></a>Terraform Modules</h1><ul>
<li>Blocks of re-useable Terraform code w/ inputs and outputs</li>
<li><code>cd ..</code></li>
<li><code>cp -a ../__modules .</code></li>
<li><code>cd __modules/todo-test-data</code></li>
</ul>
<hr>
<h1 id="Module-Variables"><a href="#Module-Variables" class="headerlink" title="Module Variables"></a>Module Variables</h1><ul>
<li>Open <code>variables.tf</code><ul>
<li>This files defines all the variables that the module uses and any default values.</li>
</ul>
</li>
</ul>
<hr>
<h1 id="The-Main-Module-Code"><a href="#The-Main-Module-Code" class="headerlink" title="The Main Module Code"></a>The Main Module Code</h1><ul>
<li>Open <code>main.tf</code><ul>
<li>This files will allow us to easily create two set of todos matching our specific requirements.</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Module-Outputs"><a href="#Module-Outputs" class="headerlink" title="Module Outputs"></a>Module Outputs</h1><ul>
<li>Open <code>outputs.tf</code><ul>
<li>If you think of modules like functions then outputs are return values.</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Prepare-to-Use-the-Module"><a href="#Prepare-to-Use-the-Module" class="headerlink" title="Prepare to Use the Module"></a>Prepare to Use the Module</h1><ul>
<li><code>cd ../../code/</code></li>
<li>Open <code>main.tf</code></li>
</ul>
<hr>
<h1 id="Utilize-the-Module-1-of-2"><a href="#Utilize-the-Module-1-of-2" class="headerlink" title="Utilize the Module (1 of 2)"></a>Utilize the Module (1 of 2)</h1><ul>
<li>Add:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">module &quot;series-data&quot; &#123;</span><br><span class="line">    source       = &quot;../__modules/todo-test-data&quot;</span><br><span class="line">    number       = 5</span><br><span class="line">    purpose      = &quot;testing&quot;</span><br><span class="line">    team_name    = &quot;oreilly&quot;</span><br><span class="line">    descriptions = [&quot;my first completed todo&quot;, &quot;my second completed todo&quot;,</span><br><span class="line">                    &quot;my third completed todo&quot;, &quot;my fourth completed todo&quot;,</span><br><span class="line">                    &quot;my fifth completed todo&quot;</span><br><span class="line">                   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Utilize-the-Module-2-of-2"><a href="#Utilize-the-Module-2-of-2" class="headerlink" title="Utilize the Module (2 of 2)"></a>Utilize the Module (2 of 2)</h1><ul>
<li>Open <code>outputs.tf</code></li>
<li>Add:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">output &quot;first_series_ids&quot; &#123;</span><br><span class="line">  value = &quot;$&#123;module.series-data.first_series_ids&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;second_series_ids&quot; &#123;</span><br><span class="line">  value = &quot;$&#123;module.series-data.second_series_ids&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Apply-the-Module"><a href="#Apply-the-Module" class="headerlink" title="Apply the Module"></a>Apply the Module</h1><ul>
<li><code>terraform init</code><ul>
<li>Initialize/download the module.</li>
</ul>
</li>
<li><code>terraform apply</code><ul>
<li>If all looks good, answer: <code>yes</code></li>
</ul>
</li>
</ul>
<hr>
<h1 id="Destroy-the-Todos"><a href="#Destroy-the-Todos" class="headerlink" title="Destroy the Todos"></a>Destroy the Todos</h1><ul>
<li><code>terraform destroy</code><ul>
<li><strong>Plan</strong>: 0 to add, 0 to change, 9 to destroy.<ul>
<li>If all looks good, answer: <code>yes</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Destroy-the-Infrastructure"><a href="#Destroy-the-Infrastructure" class="headerlink" title="Destroy the Infrastructure"></a>Destroy the Infrastructure</h1><ul>
<li><code>cd ../terraform-infrastructure/</code></li>
<li><code>terraform destroy</code><ul>
<li>If all looks good, answer: <code>yes</code></li>
</ul>
</li>
</ul>
<hr>
<h1 id="What-We-Have-Learned"><a href="#What-We-Have-Learned" class="headerlink" title="What We Have Learned"></a>What We Have Learned</h1><ul>
<li>How to install Terraform</li>
<li>The primary use case for Terraform</li>
<li>How to install a provider and what they are for</li>
<li>Creating, reading, updating, and deleting objects</li>
<li>Reading data sources &amp; importing existing objects</li>
<li>Making &amp; using modules</li>
<li>What the Terraform state is</li>
<li>and more…</li>
</ul>
<hr>
<!-- _class: lead -->
<h1 id="Additional-Reading"><a href="#Additional-Reading" class="headerlink" title="Additional Reading"></a>Additional Reading</h1><p><a href="https://www.terraformupandrunning.com/">Terraform: Up &amp; Running</a><br><a href="https://www.terraform.io/docs/index.html">Terraform Documentation</a></p>
<hr>
<!-- _class: lead -->
<h1 id="Additional-Learning-Resources"><a href="#Additional-Learning-Resources" class="headerlink" title="Additional Learning Resources"></a>Additional Learning Resources</h1><h2 id="https-learning-oreilly-com"><a href="#https-learning-oreilly-com" class="headerlink" title="https://learning.oreilly.com/"></a><a href="https://learning.oreilly.com/">https://learning.oreilly.com/</a></h2><hr>
<!-- _class: lead -->
<h1 id="Student-Survey"><a href="#Student-Survey" class="headerlink" title="Student Survey"></a>Student Survey</h1><p><strong>Please take a moment to fill out the class survey linked to in the chat channel.</strong></p>
<p>O’Reilly and I value your comments about the class.</p>
<p>Thank you!</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/aws/">aws</a><a href="/tags/terraform/">terraform</a><a href="/tags/automation/">automation</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/07/05/agile/" title="agile" itemprop="url">agile</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stan Zhou" target="_blank" itemprop="author">Stan Zhou</a>
		
  <p class="article-time">
    <time datetime="2019-07-05T01:10:42.858Z" itemprop="datePublished"> Published 2019-07-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Agile-is-a-movement"><a href="#Agile-is-a-movement" class="headerlink" title="Agile is a movement."></a>Agile is a movement.</h1><p>Movement: a group of people working together to advance their shared political, social, or artistic ideas.</p>
<h2 id="Early-agile-methodologies"><a href="#Early-agile-methodologies" class="headerlink" title="Early agile methodologies"></a>Early agile methodologies</h2><ul>
<li>1995: Scrum<ul>
<li>Iterative cycles of work</li>
<li>Emphasis on cross-functional collaboration</li>
</ul>
</li>
<li>Mid-90s: Crystal<ul>
<li>Emphasis on adaptability and “stretch-to-fit” process</li>
</ul>
</li>
<li>1990: XP<ul>
<li>Short, iterative cycles of work</li>
<li>Emphasis on collaboration between developers</li>
</ul>
</li>
</ul>
<p><img src="https://i.imgur.com/MjJqXdR.jpg" alt="agile manifesto"><br><strong>Agile Values</strong></p>
<ul>
<li>Increase cross-functional collaboration</li>
<li>Minimize works in progress (sepecs, etc)</li>
<li>Work in iterative cycles to incorporate change and get frequent feedback</li>
<li>Make time to reflect on how you work</li>
</ul>
<hr>
<h1 id="Agile-Development"><a href="#Agile-Development" class="headerlink" title="Agile Development"></a>Agile Development</h1><p><strong>born-on-the-cloud model</strong>: cloud as the primary platform for both consumed and delivered services<br>Agility to get projects up and running quickly<br>streamlined process by reducing transitions from Development to Operations</p>
<p>Java EE application with a Minimum Viable Product (MVP)<br>setup the cloud infrastructure and Toolchain using the Born-on-the-cloud approach</p>
<p>Hypothesis-driven development</p>
<p>ranked backlog, user stories, story points<br>tracking and delivering in Timeboxed iterations</p>
<p><strong>backlog</strong> is a prioritized list of features (User Stores) waiting to be scheduled and implemented</p>
<p>Note that among other things one of the most important responsibilities of the product owner role in Agile development methodology is to keep the backlog ranked by priority, and he or she can set the priorities by simply dragging the issues and ordering them, regardless of when they were added to the backlog</p>
<p>User stories: who, what, why<br>story points and planning poker</p>
<p><strong>user story</strong> is an informal, natural language description of a chunk of functionality that is of value from an end-user perspective<br>As a <who>, I want <what> so that <why></p>
<p><strong>Story Points</strong> are estimates of effort as influenced by the amount of work, complexity, risk, and uncertainty.</p>
<ul>
<li>(Adapted) Fibonacci sequence: 0,1,2,3,5,8,13,20,40,100</li>
</ul>
<p><strong>Planning Poker</strong> is a consensus-based, gamified technique for estimating<br>Timeboxing refers to the act of putting strict time boundaries around an action for activity</p>
<p>time boxed interrogations along with story points are important to measure the team velocity over time. For example you should track the total amount of story points that team delivers each iteration, and this way you’ll be able to determine on average the team velocity metric, or in other words how many story points on average the team is able to deliver. </p>
<p>Architecture breakdown</p>
<ul>
<li>User interface (html/css/javascript)</li>
<li>CRUD Service(REST APIs with JAX-RS)</li>
<li>Database(NoSQL)</li>
</ul>
<p><strong>Test-Driven Development (TDD)</strong> is a technique for building software by writing automate test cases before writing any code<br>why: focus on the outcome; helps to manage risk; enables fast iterations and continous integration; keeps the code clear, simple and testable;<br>grater confidence to make applicaton changes; documentation of how the system works</p>
<p>How:add a test-&gt;run all tests and see if the new one fails-&gt; write the code-&gt;run tests-&gt; refactor the code-&gt;repeat</p>
<p>A <strong>delivery pipeline</strong> is a sequence of automated stages that retrieve input and run jobs, such as builds, tests, and deployments.<br>It automates the continuous deployment of a project, with miniumum or no-human intervention.</p>
<ul>
<li>A Stage retrieves input and run jobs, such as builds,tests, and deployments.</li>
<li>Jobs run in discrete working directories in containers that are created for each pipeline run</li>
<li>By default, stages run sequentially after changes are delivered to source control</li>
</ul>
<p><strong>showcase the applicaton</strong>: At the end of the iteration before the retrospective meeting that is a showcase meaning, also know as demo meeting, where the work done is demonstrated to the stakeholders and feedback is obtaining. The showcase meeting starts by reviewing what we have committed in the form of user stories. And finally we demonstrate what we have accomplished in the form of working software, so we can acquire feedback on the product we are building.</p>
<p><strong>retrospective meeting</strong>: how to conduct<br>1st way:<br>What went well?<br>what could be improved?</p>
<p>2nd way:<br>Start doing</p>
<ul>
<li>continuous delivery<br>stop doing</li>
<li>time-bxed iterations<br>continue doing</li>
<li>ranked backlog</li>
</ul>
<h2 id="Common-Problems"><a href="#Common-Problems" class="headerlink" title="Common Problems"></a>Common Problems</h2><h2 id="Value-Focus"><a href="#Value-Focus" class="headerlink" title="Value/Focus"></a>Value/Focus</h2><table>
<thead>
<tr>
<th>Problems</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Not understanding the market</td>
<td>Hypothesis-driven development</td>
</tr>
<tr>
<td>Putting wrong products into the market</td>
<td>Minimum Viable Product (MVP)</td>
</tr>
<tr>
<td>Lack of focus on value</td>
<td>Timboxing/Iterations</td>
</tr>
</tbody>
</table>
<h2 id="Productivity-Speed-Cost"><a href="#Productivity-Speed-Cost" class="headerlink" title="Productivity/Speed/Cost"></a>Productivity/Speed/Cost</h2><table>
<thead>
<tr>
<th>Problems</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Too long to get projects up and running</td>
<td>Born on the Cloud</td>
</tr>
<tr>
<td>Slow to put products into market</td>
<td>MVP/Delivery pipeline/Continuous delivery</td>
</tr>
<tr>
<td>Too costly projects</td>
<td>Automation/Toolchain/Delivery pipeline</td>
</tr>
</tbody>
</table>
<h2 id="Communication-Visibility"><a href="#Communication-Visibility" class="headerlink" title="Communication/Visibility"></a>Communication/Visibility</h2><table>
<thead>
<tr>
<th>Problems</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Priorities aren’t clear</td>
<td>Ranked backlog</td>
</tr>
<tr>
<td>Requirements not reflecting the user’s needs</td>
<td>User stories</td>
</tr>
<tr>
<td>Poor team communication</td>
<td>Daily standup</td>
</tr>
<tr>
<td>Lack of visibility into the progress</td>
<td>Iteration wall/Showcase meeting</td>
</tr>
</tbody>
</table>
<h2 id="Quality-Control"><a href="#Quality-Control" class="headerlink" title="Quality/Control"></a>Quality/Control</h2><table>
<thead>
<tr>
<th>Problems</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Low quality products</td>
<td>Test driven development/Delivery pipeline</td>
</tr>
<tr>
<td>Lack of prcess improvement</td>
<td>Retrospective meeting/Continous improvement</td>
</tr>
<tr>
<td>Bad Requirements estimations</td>
<td>Story points/Planning poker</td>
</tr>
<tr>
<td>Not honouring past our commitments</td>
<td>Track team’s velocity</td>
</tr>
</tbody>
</table>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/agile/">agile</a><a href="/tags/software-development/">software development</a><a href="/tags/agile-development/">agile development</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/07/04/devops-as-a-service/" title="Devops As A Service" itemprop="url">Devops As A Service</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stan Zhou" target="_blank" itemprop="author">Stan Zhou</a>
		
  <p class="article-time">
    <time datetime="2019-07-03T23:54:43.000Z" itemprop="datePublished"> Published 2019-07-04</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><img src="https://i.imgur.com/5ci7g2C.png" alt="Imgur"><br>Business Requirements</p>
<ul>
<li>Start with business requirements</li>
<li>DevOps is about doing the work right</li>
<li>What about doing the right work? See<ul>
<li>(Agile) Portfolio Management- making sure the work you are doing is funded and delivering business value, and</li>
<li>Lean Control - making sure you get early engagement with control functions in your organisation (Audit, Compliance, Security, Architecture,<br>Accessibility, Marketing, etc.)</li>
</ul>
</li>
<li>Work/Requirements are comprised of<ul>
<li>features of business value (2-3 months), divided into …</li>
<li>sprints (2-3 weeks) and the sprints are made up of …</li>
<li>tasks (2-3 days of work)</li>
</ul>
</li>
</ul>
<p>Tasks</p>
<ul>
<li>2-3 days of work</li>
<li>Developers pull tasks off of a sprint queue</li>
<li>Sprint goals to demo working software at the end of each sprint</li>
</ul>
<p>Code</p>
<ul>
<li>Integrated continuously, Build continuously</li>
<li>All code is reviewed by another team member before committing</li>
<li>Feature branching or trunk-based development?</li>
<li>No long lived code branches</li>
</ul>
<p>Continuous Integration</p>
<ul>
<li>Code built continuously (multiple times per day)</li>
<li>Fast feedback -continous builds are very fast (&lt; 5mins)</li>
<li>Best practice build patterns/chains<ul>
<li>Compile, unit test, integration test, deploy artefacts</li>
</ul>
</li>
</ul>
<p>Metrics</p>
<ul>
<li>Code quality is vital</li>
<li>Code coverage measures test automation</li>
<li>Gold/silver/bronze accreditation</li>
</ul>
<p>Artifacts</p>
<ul>
<li>Green builds produce shippable artefacts (.jar, .dll, .exe, docker image)</li>
<li>Single store for all internal and external artefacts and libraries</li>
<li>Security policies around 3rd party libraries and external access</li>
</ul>
<p>Infrastructure as Code</p>
<ul>
<li>Operations roles change</li>
<li>Infrastructure provisioning and configuration is automated</li>
<li>Orchestration tools to provision infrastructure (Terraform, Cloud Formation for AWS)</li>
<li>Configuration management tools to install and manage software on provisioned infrastructure (Chef, Puppet, Ansible)</li>
<li>IaC is stored, tested and versioned in source code control</li>
<li>Organisational Change, move to Site Reliability Engineering (SRE)</li>
</ul>
<p>Service Mangement</p>
<ul>
<li>Approvals and change are automated</li>
<li>Products with higher levels of accreditation have lower change management overheads (more automation)</li>
</ul>
<p>Continous Deployment</p>
<ul>
<li>Infrastructure provisioned automatically</li>
<li>Configuration automated</li>
<li>Change approvals automated</li>
<li>Push button deployment to production</li>
</ul>
<p>Monitoring</p>
<ul>
<li>Observability driven design</li>
<li>Monitoring, logging, dash boarding early in the life-cycle</li>
<li>Issues and observations feed back to developers</li>
</ul>
<p>Security</p>
<ul>
<li>“Shift Left” security</li>
<li>“average total cost of a breach ranges from $2.2 million to $6.9 million”</li>
<li>Code vulnerability scanning in the build pipeline</li>
<li>Build fail if major/critical issues</li>
<li>Tools- CheckMarx, Fortify</li>
<li>Artefact scanning for security vulnerabilities</li>
<li>Firewalls to protect against 3rd party vulnerabilities</li>
<li>Tools - Nexus Lifecycle/Fiewall, BackDuck</li>
<li>Image scanning dof Docker images</li>
<li>Tools- AquaSec, Twistlock, Tennable, OpenSCAP</li>
</ul>
<p>Evolving DevOps @ Scale</p>
<p>Shadow DevOps -&gt; Enterprise DevOps -&gt; DevOps as a Service</p>
<p>10 years age -&gt; 5 years ago  -&gt; the future</p>
<p><img src="https://i.imgur.com/6Ei88Zz.jpg" alt="Enterprise Devops"><br><img src="https://i.imgur.com/jRJvY69.jpg" alt="Devops as a Service"><br><img src="https://i.imgur.com/kQNGOfS.jpg" alt="GitOps"><br><img src="https://i.imgur.com/Vvmeafo.jpg" alt="AWS DevOps"><br><img src="https://i.imgur.com/lwpUXVf.jpg" alt="Azure DevOps"></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Devops/">Devops</a><a href="/tags/aws/">aws</a><a href="/tags/git/">git</a><a href="/tags/Azure/">Azure</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/07/03/version-control/" title="version control" itemprop="url">version control</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stan Zhou" target="_blank" itemprop="author">Stan Zhou</a>
		
  <p class="article-time">
    <time datetime="2019-07-03T01:55:35.000Z" itemprop="datePublished"> Published 2019-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Common-Terminologies"><a href="#Common-Terminologies" class="headerlink" title="Common Terminologies"></a>Common Terminologies</h1><p><strong>Repository</strong>: A unit of storage and change tracking that represents a direcotry whose contents are tacked by Git</p>
<p><strong>Brach</strong>: A version of a repository that represents the current state of the set of files that constitute a repository</p>
<p><strong>Master</strong>: The frault or main branch, it is a version of the repository that is considered the single source of truth</p>
<p><strong>Refrence</strong>: A Git ref or reference is a name corresponding to a commit hash</p>
<p><strong>HEAD</strong>: A reference to the most recent commit on a branch</p>
<p><strong>Working Tree</strong>: This refers to the section in which we view and make changes to the files in branch</p>
<p><strong>Index</strong>: This is an area where Git holds files that have been changed, added, or removed in readiness for a commit</p>
<p><strong>Commit</strong>: This is an entry into Git’s history that represents a change made to a set of files at a given point in time</p>
<p><strong>Merge</strong>: A merge is the process of incorporating change from one branch to another</p>
<p><strong>Workflows</strong>: Workflows refer to the approach a team takes to introduce changes to a code base.</p>
<h2 id="Workflows"><a href="#Workflows" class="headerlink" title="Workflows"></a>Workflows</h2><p><strong>Gitflow workflow</strong></p>
<ul>
<li>This uses two branches: master and develop</li>
<li>The master branch is used to track release history, while the develop branch is used to track feature integration into the product.</li>
</ul>
<p><strong>Centralized workflow</strong></p>
<ul>
<li>This approach uses the master branch as the default development branch.</li>
<li>The changes are committed to the master branch.</li>
<li>It’s a suitable workflow for small size teams and teams transitioning from Apache Subversion.</li>
<li>In Apache Subversion, the trunk is the equivalent of the master branch.</li>
</ul>
<p><strong>Feature branch workflow</strong></p>
<ul>
<li>In this workflow, feature development is carried out in a dedicated branch.</li>
<li>The branch is then merged to the master once the intended changes are approved.</li>
</ul>
<p><strong>Forking workflow</strong></p>
<ul>
<li>The individual seeking to make a change to a repository, makes a copy of the desired repository in their respective GitHub account.</li>
<li>The changes are made in the copy of the source repository and then it’s merged to the source repository throught a pull request.</li>
</ul>
<h1 id="Navigating-GitHub"><a href="#Navigating-GitHub" class="headerlink" title="Navigating GitHub"></a>Navigating GitHub</h1><h2 id="Organizations"><a href="#Organizations" class="headerlink" title="Organizations"></a>Organizations</h2><p><strong>Role-based membership</strong></p>
<ul>
<li><p>Each personal account that is added to an organization can belong to one of the aforementioned roles.</p>
</li>
<li><p>The owner role is the most superior and is used to conduct administrative procedures.<br><strong>Repository level permissions</strong></p>
<pre class="mermaid">graph TD;
 Read-->Write;
 Write-->Admin;</pre></li>
<li>Teams or their respective members can be assigned read, write, or admin-level permissions to a repository.</li>
<li>Each level dictates activities that the assigned members undertake, with a varying degree of limitations.<br><strong>Teams</strong></li>
<li>There are members of an organization that can be grouped into teams, with the option of nesting the teams to match an organization’s structure.<br><strong>Multi-factor authentication</strong></li>
<li>Organizations support the enforcement of two-factor authentication as well as business-specific single sign-on approaches such as <strong>Security Assertion Markup Language (SAML)</strong> and <strong>System for Corss-domain Identity Management</strong> (SCIM).<h3 id="Market-place-install-codacy"><a href="#Market-place-install-codacy" class="headerlink" title="Market place install codacy"></a>Market place install codacy</h3></li>
</ul>
<h1 id="Runtime-config"><a href="#Runtime-config" class="headerlink" title="Runtime config"></a>Runtime config</h1><p>Git configurations are set in three levels:</p>
<ul>
<li>System-wide configuration<ul>
<li>set in the <strong>/etc/gitconfig</strong> file</li>
<li>access use <strong>git config –system</strong></li>
</ul>
</li>
<li>User specific configuraton<ul>
<li>~/.gitconfig</li>
<li>git config –global</li>
</ul>
</li>
<li>Repository-specific configuration<ul>
<li>Repository specific settings are set in the <strong>path_to_repository/.git/config</strong></li>
<li>An example of configuration is the GitHub URL of a repository, which set at this level.</li>
<li>There settings are accessed via <strong>git config –local</strong></li>
</ul>
</li>
</ul>
<h2 id="Removing-configuratoin"><a href="#Removing-configuratoin" class="headerlink" title="Removing configuratoin"></a>Removing configuratoin</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global --unset [section_name].[section_variable]</span><br></pre></td></tr></table></figure>
<p>exampel:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global --unset user.name</span><br></pre></td></tr></table></figure></p>
<p>create a ssh key:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -C foobar@cwzhou.win</span><br></pre></td></tr></table></figure></p>
<h1 id="Fundamentails-of-repositories"><a href="#Fundamentails-of-repositories" class="headerlink" title="Fundamentails of repositories"></a>Fundamentails of repositories</h1><p><strong>Tags</strong><br>There are used for the purpose of identifying specific significant points on a repository’s history.</p>
<ul>
<li><p>lightweight tages<br>Lightweight tags act as pointers to a specific commit. It only stores the reference to the commit: <strong>git tag v2.5</strong></p>
</li>
<li><p>annotated tags<br>Annotated tags act as pointers to a specific commit and additionally store information about the creator of the tag, the email, and date of creation:<br> <strong>git tag -a v2.6 -m “Support sdk version 3”</strong></p>
</li>
</ul>
<h1 id="Versioning-Commits"><a href="#Versioning-Commits" class="headerlink" title="Versioning Commits"></a>Versioning Commits</h1><p>In git, files can have the following statuses:</p>
<ul>
<li>Untracked: This is a file that exists in the working tree whose changes are not being monitored by Git and aren’t listed in the <strong>gitignore</strong> file.</li>
<li>Unstaged: This is a file whose changes are being tracked by Git; the file has been changed since the last commit and has yet to be moved to the <strong>index</strong>.</li>
<li>Staged: This is a file whose changes are being tracked by Git; the file has been changed since the last commit and has been moved to the index.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br></pre></td></tr></table></figure>
<ul>
<li>It’s used to retrieve the details of files that are untracked, unstaged, or staged.</li>
<li><strong>git status</strong> lists files in order of their statuses.</li>
<li>The <strong>git status</strong> output is lengthy in nature</li>
<li>To view a brief list and status, use the <strong>-s</strong> or <strong>–short</strong> option with the <strong>git status</strong> command.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">szhou@armitage:~/DevOps/github/foobar|master</span><br><span class="line">⇒  git branch ft-add-encapsulating-class</span><br><span class="line">szhou@armitage:~/DevOps/github/foobar|master</span><br><span class="line">⇒  git checkout ft-add-encapsulating-class</span><br><span class="line">Switched to branch &apos;ft-add-encapsulating-class&apos;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>ft is feature branch, bg for bug, fs for rolling out hard fixes, ch for<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add . &amp;&amp; git commit -m &quot;Added a class for match functions&quot; &amp;&amp; git push origin ft-add-encapsulating-class</span><br></pre></td></tr></table></figure></p>
<p><strong>git diff</strong></p>
<ul>
<li>The git diff command is uesed to compare one snapshot of changes to another.</li>
</ul>
<p>zoom in the change:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">szhou@armitage:~/DevOps/github/foobar|ft-add-encapsulating-class⚡</span><br><span class="line">⇒  git diff</span><br><span class="line">szhou@armitage:~/DevOps/github/foobar|ft-add-encapsulating-class⚡</span><br><span class="line">⇒  git diff src/lib</span><br><span class="line">szhou@armitage:~/DevOps/github/foobar|ft-add-encapsulating-class⚡</span><br><span class="line">⇒  git diff src/lib/compute.py</span><br></pre></td></tr></table></figure></p>
<p>Undo the change<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rest --hard</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git diff HEAD -- src/</span><br><span class="line">git log</span><br><span class="line">git diff master</span><br><span class="line">git diff --cached</span><br><span class="line">git diff ft-add-encapsulating-class..ft-support-multiplication-arithmetic</span><br></pre></td></tr></table></figure>
<p><strong>git add</strong></p>
<ul>
<li>is used to add files to the index from the working tree.</li>
<li>syntax: <strong>git add [options] [path_to_files]</strong></li>
</ul>
<p>The options used with <strong>git add</strong> include <strong>-n</strong> and <strong>–dry-run</strong>: simulates the behaviour of git add for the specified file.</p>
<p><strong>-f</strong> or <strong>–force</strong>: adds ignored files to the index.</p>
<p><strong>-i</strong> or <strong>–interactive</strong>: creates an interactive prompt that can be used for adding files from the working tree to the index.</p>
<p><strong>-por –patch</strong>: caters for adding portions of a file to the index.</p>
<p><strong>options</strong>:</p>
<ul>
<li>?: Print help</li>
<li>y: Stage this hunk</li>
<li>n: Do not stage this hunk</li>
<li>q: Exit or quit. Do not stage this hunk or any of the remaining hunks.</li>
<li>a: Stage this hunk and all later hunks in the specified files</li>
<li>d: Do not stage this hunk or any of the remaining hunks in the file</li>
<li>g: Select a hunk to go to</li>
<li>/: Search for the hunk that matches the specified regex pattern</li>
<li>j: Leave this hunk undecided; see the next undecided hunk</li>
<li>J: Leave this hunk undecided; see the next hunk</li>
<li>k: Leave this hunk undecided; see the previous undecided hunk</li>
<li>K: Leave this hunk undecided; see the previous hunk</li>
<li>s: Split the current hunk into more granular hunks</li>
<li>e: Manually edit the current hunk</li>
</ul>
<p><strong>git commit</strong></p>
<ul>
<li>The <strong>git commit</strong> command saves the files in the index.</li>
<li>The commit operation stores a message along with the commit.</li>
<li>This message describes the additions or alterations associated with the created snapshot.</li>
</ul>
<p>Note: the <strong>git commit</strong> command requires that a message be provided for each commit operation.<br><strong>options</strong>:</p>
<ul>
<li>-m [text] or –message [text]: associate the index file with the commit action</li>
<li>-a or -all: stage tracked files that are unstaged</li>
<li>-p or –patch: interactive patch tool</li>
<li>-C [commit hash] or –resue-message=[commit hash]: resue a commit message and the author information of the specified commit hash</li>
<li>-F [file] or –file=[file]: specifies a file from which a commit message should be obtained</li>
<li>-t [file] or –template [file]: specifies the commit message template file</li>
<li>-e or –edit: edits the provided commit message</li>
<li>–no-edit: uses the specified message as is</li>
<li>–author=[author]: overrides the details fo a commit author</li>
<li>–date=[date]: overrides the data details used in a commit</li>
<li>-q or –quiet: suppresses the summary message that’s returned after running the <strong>git commit</strong> command</li>
</ul>
<p><strong>git rm</strong></p>
<p>The <strong>git rm</strong> command performs two roles.</p>
<ul>
<li>Removes files from the working directory and the index</li>
<li>Remove files from index<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim src/lib/scientific.py</span><br><span class="line">git add . &amp;&amp; git commit -m &quot;Added sci module&quot;</span><br><span class="line">git rm src/lib/scientific.py</span><br><span class="line">git status</span><br><span class="line">git commit -m &quot;Removed sci module&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>git mv</strong></p>
<ul>
<li>used to rename or move a file or a directory</li>
<li>This command has two forms of implementation:<ul>
<li>git mv [options][source][destination]: used to rename a file</li>
<li>git mv [options][source]…[destination]: used to move a file</li>
</ul>
</li>
</ul>
<p><strong>git log command</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">git log --follow src/lib/advanced/advanced_compute.py</span><br><span class="line">git log --decorate=full</span><br><span class="line">git log --decorate=short</span><br><span class="line">git log --decorate=no</span><br><span class="line">git log -L 6,12:src/lib/compute.py</span><br><span class="line">git log -n 3</span><br><span class="line">git log -3</span><br><span class="line">git log --skip=4</span><br><span class="line">git log --since=01/01/2018</span><br><span class="line">git log --pretty=oneline</span><br><span class="line">git log --pretty=short</span><br><span class="line">git log --pretty=medium</span><br><span class="line">git log --pretty=format:&quot;%H %an&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="Amending-commits"><a href="#Amending-commits" class="headerlink" title="Amending commits"></a>Amending commits</h2><p>The most recent commit can be edited using the –amend option of the <strong>git commit</strong> command.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">git commit --amend</span><br><span class="line">git rebase -i HEAD~4  # retrv the last 4 commits</span><br><span class="line">pick 721d2ec Removed sci module</span><br><span class="line">pick fc150d2 Added sci module</span><br><span class="line">pick 4be4d85 Rename scientific module</span><br><span class="line">pick 9a8a4ea Moved scientific module</span><br><span class="line"></span><br><span class="line">change pick to reword save and quit the file.</span><br><span class="line"></span><br><span class="line">## change the file</span><br><span class="line">git rebase -i HEAD~3</span><br><span class="line">change pick to edit save and quit the file.</span><br><span class="line">vim src/lib/advanced/advanced_compute.py</span><br><span class="line">git status</span><br><span class="line">git add .</span><br><span class="line">git commit --amend</span><br><span class="line">git rebase --continue</span><br><span class="line">git log -4</span><br></pre></td></tr></table></figure></p>
<p><a href="https://dev.to/lydiahallie/cs-visualized-useful-git-commands-37p1">CS Visualized: Useful Git Commands</a></p>
<h1 id="Git-merge-with-No-Fast-Forward-technique"><a href="#Git-merge-with-No-Fast-Forward-technique" class="headerlink" title="Git merge with No-Fast-Forward technique"></a>Git merge with No-Fast-Forward technique</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">git-demo-project git:(demo-branch) ✗ git commit -am &quot;commit 1 from demo-branch&quot;</span><br><span class="line">[demo-branch 0280912] commit 1 from demo-branch</span><br><span class="line"> 1 file changed, 1 insertion(+)</span><br><span class="line"> create mode 100644 test-no-ff-merge-file</span><br><span class="line">➜  git-demo-project git:(demo-branch) echo &apos;line 2&apos; &gt;&gt; test-no-ff-merge-file</span><br><span class="line">➜  git-demo-project git:(demo-branch) ✗ git commit -am &quot;commit 2 from demo-branch&quot;</span><br><span class="line">[demo-branch ca0b8d0] commit 2 from demo-branch</span><br><span class="line"> 1 file changed, 1 insertion(+)</span><br><span class="line">➜  git-demo-project git:(demo-branch) git log --oneline</span><br><span class="line">➜  git-demo-project git:(demo-branch) cat test-no-ff-merge-file</span><br><span class="line">line 1</span><br><span class="line">line 2</span><br><span class="line">➜  git-demo-project git:(demo-branch) git checkout master</span><br><span class="line">Switched to branch &apos;master&apos;</span><br><span class="line">➜  git-demo-project git:(master) git log --oneline</span><br><span class="line">➜  git-demo-project git:(master) ls</span><br><span class="line">readme.md  testffmergefile  test.html</span><br><span class="line">➜  git-demo-project git:(master) git diff master demo-branch</span><br><span class="line">➜  git-demo-project git:(master) git merge demo-branch --no-ff</span><br><span class="line">Merge made by the &apos;recursive&apos; strategy.</span><br><span class="line"> test-no-ff-merge-file | 2 ++</span><br><span class="line"> 1 file changed, 2 insertions(+)</span><br><span class="line"> create mode 100644 test-no-ff-merge-file</span><br><span class="line">➜  git-demo-project git:(master) cat test-no-ff-merge-file</span><br><span class="line">line 1</span><br><span class="line">line 2</span><br><span class="line">➜  git-demo-project git:(master) git log --oneline --decorate --graph</span><br><span class="line">➜  git-demo-project git:(master) git branch -d demo-branch</span><br><span class="line">Deleted branch demo-branch (was ca0b8d0).</span><br></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/git/">git</a><a href="/tags/github/">github</a><a href="/tags/version-control/">version control</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/06/28/ansible/" title="ansible" itemprop="url">ansible</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stan Zhou" target="_blank" itemprop="author">Stan Zhou</a>
		
  <p class="article-time">
    <time datetime="2019-06-28T00:23:15.000Z" itemprop="datePublished"> Published 2019-06-28</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Ansible-configuration"><a href="#Ansible-configuration" class="headerlink" title="Ansible configuration"></a>Ansible configuration</h1><h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><p>for ubuntu:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apt-get install software-properties-common</span><br><span class="line">apt-add-repository ppa:ansible/ansible</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install ansible</span><br><span class="line">root@ansible-host:~# ansible --version</span><br><span class="line">ansible 2.8.1</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [u&apos;/root/.ansible/plugins/modules&apos;, u&apos;/usr/share/ansible/plugins/modules&apos;]</span><br><span class="line">  ansible python module location = /usr/lib/python2.7/dist-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = 2.7.12 (default, Nov 12 2018, 14:36:49) [GCC 5.4.0 20160609]</span><br></pre></td></tr></table></figure></p>
<h2 id="Gran-access-to-modes-machines"><a href="#Gran-access-to-modes-machines" class="headerlink" title="Gran access to modes/machines:"></a>Gran access to modes/machines:</h2><ul>
<li>ssh-keygen</li>
<li>ssh-copy-id<br><strong>Setup:</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp -R /etc/ansible local</span><br><span class="line">cd local</span><br><span class="line">edit ansible.cfg and hosts file</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="configuration-files"><a href="#configuration-files" class="headerlink" title="configuration files"></a>configuration files</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ANSIBLE_CONFIG #an environemtn variable</span><br><span class="line">ansible.cfg # in the current directory</span><br><span class="line">.ansible.cfg #in the home directory</span><br><span class="line">/etc/ansible/ansible.cfg</span><br></pre></td></tr></table></figure>
<h2 id="Ansible-inventory"><a href="#Ansible-inventory" class="headerlink" title="Ansible inventory"></a>Ansible inventory</h2><p><code>/etc/ansible/hosts</code><br>INI format, support host variables, group variables and group of group<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># add to /etc/ansible/hosts</span><br><span class="line">[demo_hosts]</span><br><span class="line">node01 ansible_user=ubuntu</span><br><span class="line">node02 ansible_user=ubuntu</span><br><span class="line"># add to /etc/hosts</span><br><span class="line">172.31.5.185 node01</span><br><span class="line">172.31.8.115 node02</span><br></pre></td></tr></table></figure></p>
<h2 id="Verify-Ansible-Inventory"><a href="#Verify-Ansible-Inventory" class="headerlink" title="Verify Ansible Inventory"></a>Verify Ansible Inventory</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">eval `ssh-agent -s`</span><br><span class="line">ssh-add ansible-key.pem</span><br><span class="line">ansible -m ping all</span><br><span class="line"># add to /etc/ansible/hosts</span><br><span class="line">[web_server]</span><br><span class="line">node01 ansible_user=ubuntu</span><br><span class="line"></span><br><span class="line">[db_server]</span><br><span class="line">node02 ansible_user=ubuntu</span><br><span class="line">ansible web-server -m ping</span><br><span class="line">ansible db-server -m ping</span><br></pre></td></tr></table></figure>
<h1 id="Local-automation-execution-using-Ansible"><a href="#Local-automation-execution-using-Ansible" class="headerlink" title="Local automation execution using Ansible"></a>Local automation execution using Ansible</h1><p><img src="https://imgur.com/CA9XqyK" alt="architecture type"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Example: Ad hoc Linux echo command against a local system</span><br><span class="line"></span><br><span class="line">#&gt; ansible all -i &quot;localhost,&quot; -c local -m shell -a &apos;echo hello DevOps World&apos;</span><br><span class="line">cat hellodevopsworld.yml</span><br><span class="line"># File name: hellodevopsworld.yml</span><br><span class="line">--- </span><br><span class="line">- hosts: all</span><br><span class="line"> tasks:</span><br><span class="line"> - shell: echo &quot;hello DevOps world&quot;</span><br><span class="line"></span><br><span class="line"># Running a Playbook from the command line:</span><br><span class="line">#&gt; ansible-playbook -i &apos;localhost,&apos; -c local hellodevopsworld.yml</span><br></pre></td></tr></table></figure></p>
<p><strong>Remote automation execution using Ansible</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Example command: execute the playbook hellodevopsworld.yml against rpi-01</span><br><span class="line">ansible-playbook -i &apos;rpi-01,&apos; -c local  ~/Learning/ansible/hellodevopsworld.yml</span><br></pre></td></tr></table></figure></p>
<h1 id="Run-and-execute-ansible-tasks"><a href="#Run-and-execute-ansible-tasks" class="headerlink" title="Run and execute ansible tasks"></a>Run and execute ansible tasks</h1><h2 id="Ansible-Command-Line"><a href="#Ansible-Command-Line" class="headerlink" title="Ansible Command Line"></a>Ansible Command Line</h2><p>Two ways: ad-hoc command and playbook</p>
<h3 id="Ansible-Ad-hoc-Commands"><a href="#Ansible-Ad-hoc-Commands" class="headerlink" title="Ansible Ad-hoc Commands"></a>Ansible Ad-hoc Commands</h3><p><code>ansible &lt;target&gt; -m &lt;module name&gt; -a arguments</code></p>
<p>support parallelism: <code>&lt;command&gt; -f</code></p>
<p><code>ansible demo_host -m copy -a &quot;src=/tmp/test1 dest=/tmp/test1&quot;</code> #-m means module, -a optional provided a list of arguments</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc -l</span><br><span class="line">ansible-doc copy</span><br><span class="line">ansible-doc -l|grep shell</span><br><span class="line">touch /tmp/test1</span><br><span class="line">ansible demo_hosts -m copy -a &quot;src=/tmp/test1 dest=/tmp/test1&quot;</span><br></pre></td></tr></table></figure>
<h2 id="Ansible-Facts"><a href="#Ansible-Facts" class="headerlink" title="Ansible Facts"></a>Ansible Facts</h2><p>A fact is a detail or piece of information collect from remote host. Can be use for grouping node, or filter node.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m setup</span><br><span class="line">ansible demo_host -m setup</span><br></pre></td></tr></table></figure></p>
<h2 id="Ansible-Variables"><a href="#Ansible-Variables" class="headerlink" title="Ansible Variables"></a>Ansible Variables</h2><p>Valid Variable names</p>
<ul>
<li>Cannot use “-“ (hyphen)</li>
<li>Can be alphanumeric</li>
<li>Should start with an alphabet</li>
</ul>
<p>Ansible Variables Naming Conventions</p>
<p>can define variables in Inventory, playbooks file and roles.</p>
<h2 id="Ansible-Sections"><a href="#Ansible-Sections" class="headerlink" title="Ansible Sections"></a>Ansible Sections</h2><ul>
<li>Target Section: sepecify the host group</li>
<li>Variable Section</li>
<li>Task Section : list all the task</li>
<li>Handler Section</li>
<li>Loops</li>
<li>Conditionals</li>
<li>Until</li>
<li>Notify<h2 id="Ansible-playbooks"><a href="#Ansible-playbooks" class="headerlink" title="Ansible playbooks"></a>Ansible playbooks</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@ansible-host:/home/ubuntu# cat sample.yaml</span><br><span class="line">---</span><br><span class="line">- hosts: demo_hosts</span><br><span class="line">  vars:</span><br><span class="line">      package1 : &quot;nginx&quot;</span><br><span class="line">      package2 : &quot;wget&quot;</span><br><span class="line">  tasks:</span><br><span class="line">   - name: Installing package nginx</span><br><span class="line">     apt: pkg=nginx state=installed update_cache=true</span><br><span class="line">     become: true</span><br><span class="line">   - name: Installing package wget</span><br><span class="line">     apt: name=&#123;&#123; package2 &#125;&#125; state=installed update_cache=true</span><br><span class="line">     become: true</span><br><span class="line">   - name: Copying test1 file</span><br><span class="line">     copy: src=/tmp/test11 dest=/tmp/test11</span><br><span class="line"></span><br><span class="line">ansible-doc apt ##check the manual for ansible apt</span><br><span class="line">ansible-playbook sample.yaml ## run ansible playbook</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Deep-Dive-Into-Ansible-Playbooks"><a href="#Deep-Dive-Into-Ansible-Playbooks" class="headerlink" title="Deep Dive Into Ansible Playbooks"></a>Deep Dive Into Ansible Playbooks</h1><h2 id="Install-Apache-with-Ansible-Playbook"><a href="#Install-Apache-with-Ansible-Playbook" class="headerlink" title="Install Apache with Ansible Playbook"></a>Install Apache with Ansible Playbook</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@ansible-host:~# cat apache_install.yaml</span><br><span class="line">---</span><br><span class="line">- hosts: web_portal</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Apt get update</span><br><span class="line">      apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">    - name: Install Apache2</span><br><span class="line">      apt: name=apache2 update_cache=no</span><br><span class="line"></span><br><span class="line">    - name: Copy data files</span><br><span class="line">      copy: src=index.html dest=/var/www/html/</span><br><span class="line"></span><br><span class="line">    - name: Stop the service</span><br><span class="line">      service: name=apache2 state=stopped</span><br><span class="line">root@ansible-host:~# ansible-playbook apache_install.yaml -b</span><br></pre></td></tr></table></figure>
<h2 id="Run-and-Stop-Service"><a href="#Run-and-Stop-Service" class="headerlink" title="Run and Stop Service"></a>Run and Stop Service</h2><h2 id="Template"><a href="#Template" class="headerlink" title="Template"></a>Template</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@ansible-host:~# cat current.html.j2</span><br><span class="line">this is my current file -</span><br><span class="line">my hostname is - &#123;&#123; ansible_hostname &#125;&#125;</span><br><span class="line">root@ansible-host:~# cat apache_install.yaml</span><br><span class="line">---</span><br><span class="line">- hosts: web_portal</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Apt get update</span><br><span class="line">      apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">    - name: Install Apache2</span><br><span class="line">      apt: name=apache2 update_cache=no</span><br><span class="line"></span><br><span class="line">    - name: Copy data files</span><br><span class="line">      copy: src=index.html dest=/var/www/html/</span><br><span class="line"></span><br><span class="line">    - name: Stop the service</span><br><span class="line">      service: name=apache2 state=stopped</span><br><span class="line"></span><br><span class="line">    - name: Copy template file</span><br><span class="line">      template: src=current.html.j2 dest=/var/www/html/current.html</span><br><span class="line">      notify:</span><br><span class="line">        - Start apache</span><br><span class="line">  handlers:</span><br><span class="line">    - name: Start apache</span><br><span class="line">      service: name=apache2 state=restarted</span><br><span class="line">### dry run ansible</span><br><span class="line">ansible-playbook apache_install.yaml -b --check</span><br></pre></td></tr></table></figure>
<h2 id="Debug-Statements-In-playbook"><a href="#Debug-Statements-In-playbook" class="headerlink" title="Debug Statements In playbook"></a>Debug Statements In playbook</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">root@ansible-host:~# cat apache_install.yaml</span><br><span class="line">---</span><br><span class="line">- hosts: web_portal</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Apt get update</span><br><span class="line">      apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">    - name: Install Apache2</span><br><span class="line">      apt: name=apache2 update_cache=no</span><br><span class="line"></span><br><span class="line">    - name: Copy data files</span><br><span class="line">      copy: src=index.html dest=/var/www/html/</span><br><span class="line">      register: copy_status</span><br><span class="line"></span><br><span class="line">    - name: Stop the service</span><br><span class="line">      service: name=apache2 state=stopped</span><br><span class="line"></span><br><span class="line">    - name: Copy template file</span><br><span class="line">      template: src=current.html.j2 dest=/var/www/html/current.html</span><br><span class="line">      notify:</span><br><span class="line">        - Start apache</span><br><span class="line"></span><br><span class="line">    - name: Copy status</span><br><span class="line">      debug: var=copy_status</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: Start apache</span><br><span class="line">      service: name=apache2 state=restarted</span><br><span class="line">root@ansible-host:~# ansible-playbook apache_install.yaml -b</span><br><span class="line"></span><br><span class="line">PLAY [web_portal] *************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ********************************************************************************************************************************</span><br><span class="line">ok: [node01]</span><br><span class="line"></span><br><span class="line">TASK [Apt get update] *********************************************************************************************************************************</span><br><span class="line"> [WARNING]: Could not find aptitude. Using apt-get instead</span><br><span class="line"></span><br><span class="line">changed: [node01]</span><br><span class="line"></span><br><span class="line">TASK [Install Apache2] ********************************************************************************************************************************</span><br><span class="line">ok: [node01]</span><br><span class="line"></span><br><span class="line">TASK [Copy data files] ********************************************************************************************************************************</span><br><span class="line">ok: [node01]</span><br><span class="line"></span><br><span class="line">TASK [Stop the service] *******************************************************************************************************************************</span><br><span class="line">ok: [node01]</span><br><span class="line"></span><br><span class="line">TASK [Copy template file] *****************************************************************************************************************************</span><br><span class="line">ok: [node01]</span><br><span class="line"></span><br><span class="line">TASK [Copy status] ************************************************************************************************************************************</span><br><span class="line">ok: [node01] =&gt; &#123;</span><br><span class="line">    &quot;copy_status&quot;: &#123;</span><br><span class="line">        &quot;changed&quot;: false,</span><br><span class="line">        &quot;checksum&quot;: &quot;9be1fe2ae3529c22cf8a1b0fd1edc53048dcf277&quot;,</span><br><span class="line">        &quot;dest&quot;: &quot;/var/www/html/index.html&quot;,</span><br><span class="line">        &quot;diff&quot;: &#123;</span><br><span class="line">            &quot;after&quot;: &#123;</span><br><span class="line">                &quot;path&quot;: &quot;/var/www/html/index.html&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;before&quot;: &#123;</span><br><span class="line">                &quot;path&quot;: &quot;/var/www/html/index.html&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;failed&quot;: false,</span><br><span class="line">        &quot;gid&quot;: 0,</span><br><span class="line">        &quot;group&quot;: &quot;root&quot;,</span><br><span class="line">        &quot;mode&quot;: &quot;0644&quot;,</span><br><span class="line">        &quot;owner&quot;: &quot;root&quot;,</span><br><span class="line">        &quot;path&quot;: &quot;/var/www/html/index.html&quot;,</span><br><span class="line">        &quot;size&quot;: 24,</span><br><span class="line">        &quot;state&quot;: &quot;file&quot;,</span><br><span class="line">        &quot;uid&quot;: 0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************************************************************************************</span><br><span class="line">node01                     : ok=7    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>
<h2 id="Loops-Conditionals-and-until-section"><a href="#Loops-Conditionals-and-until-section" class="headerlink" title="Loops, Conditionals and until section"></a>Loops, Conditionals and until section</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">root@ansible-host:~# cat apache_install.yaml</span><br><span class="line">---</span><br><span class="line">- hosts: web_portal</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Apt get update</span><br><span class="line">      apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">    - name: Install Apache2, nginx, nmap</span><br><span class="line">      apt: name=&#123;&#123; item &#125;&#125; update_cache=no</span><br><span class="line">      with_items:</span><br><span class="line">         - apache2</span><br><span class="line">         - nginx</span><br><span class="line">         - nmap</span><br><span class="line"></span><br><span class="line">    - name: Copy data files</span><br><span class="line">      copy: src=index.html dest=/var/www/html/</span><br><span class="line">      register: copy_status</span><br><span class="line"></span><br><span class="line">    - name: Stop the service</span><br><span class="line">      service: name=apache2 state=stopped</span><br><span class="line"></span><br><span class="line">    - name: Copy template file</span><br><span class="line">      template: src=current.html.j2 dest=/var/www/html/current.html</span><br><span class="line">      notify:</span><br><span class="line">        - Start apache</span><br><span class="line"></span><br><span class="line">    - name: Copy status</span><br><span class="line">      debug: var=copy_status</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: Start apache</span><br><span class="line">      service: name=apache2 state=restarted</span><br></pre></td></tr></table></figure>
<h1 id="Putting-it-all-together-with-ansible"><a href="#Putting-it-all-together-with-ansible" class="headerlink" title="Putting it all together with ansible"></a>Putting it all together with ansible</h1><h2 id="Ansible-vault"><a href="#Ansible-vault" class="headerlink" title="Ansible vault"></a>Ansible vault</h2><p>ansible-vault create foo.yml<br>ansible-vaule view foo.yml<br>ansible-playbook site.yml -ask-vault-pass</p>
<h2 id="Common-Ansible-Modules"><a href="#Common-Ansible-Modules" class="headerlink" title="Common Ansible Modules"></a>Common Ansible Modules</h2><ul>
<li>Setup module<br>ansible node01 -m setup</li>
<li>File module<br>ansible-doc file</li>
<li>Yum module<br>for redhat, centos</li>
<li>Apt module<br>for debian, ubuntu</li>
<li>Service module<br>for start and stop service</li>
<li>Copy module<br>which is used for copy the file</li>
<li>User module<br>ansible-doc user<br>ansible node01 -m user -a “user=stancloud” -b</li>
<li>Command module<br>ansible-doc command</li>
<li><p>Shell module<br>ansible node01 -m shell -a “tail /var/log/syslog”</p>
<h2 id="Ansible-Roles"><a href="#Ansible-Roles" class="headerlink" title="Ansible Roles"></a>Ansible Roles</h2><p>Roles are similar to project.</p>
<h3 id="roles-directory-structure"><a href="#roles-directory-structure" class="headerlink" title="roles directory structure"></a>roles directory structure</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">ansible-galaxy init stan</span><br><span class="line">- stan was created successfully</span><br><span class="line">root@ansible-host:/tmp# tree stan</span><br><span class="line">stan</span><br><span class="line">├── defaults</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── files</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── README.md</span><br><span class="line">├── tasks</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates</span><br><span class="line">├── tests</span><br><span class="line">│   ├── inventory</span><br><span class="line">│   └── test.yml</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yml</span><br><span class="line">roles/</span><br><span class="line">  role-name/</span><br><span class="line">     files/</span><br><span class="line">     templates/ #j2 files</span><br><span class="line">     tasks/</span><br><span class="line">        main.yml</span><br><span class="line">     handlers/</span><br><span class="line">        main.yml</span><br><span class="line">     vars/</span><br><span class="line">        main.yml</span><br><span class="line">     defaults/</span><br><span class="line">        main.yml</span><br><span class="line">     meta</span><br></pre></td></tr></table></figure>
</li>
<li><p>Common role</p>
</li>
<li>mySQL role</li>
<li>Apache role</li>
<li>WordPress role<h3 id="Deploy-wordpress"><a href="#Deploy-wordpress" class="headerlink" title="Deploy wordpress"></a>Deploy wordpress</h3></li>
</ul>
<h2 id="Ansible-Galaxy"><a href="#Ansible-Galaxy" class="headerlink" title="Ansible Galaxy"></a>Ansible Galaxy</h2><p>root@ansible-host:/tmp# ansible-galaxy install bennojoy.nginx</p>
<ul>
<li>downloading role ‘nginx’, owned by bennojoy</li>
<li>downloading role from <a href="https://github.com/bennojoy/nginx/archive/master.tar.gz">https://github.com/bennojoy/nginx/archive/master.tar.gz</a></li>
<li>extracting bennojoy.nginx to /root/.ansible/roles/bennojoy.nginx</li>
<li>bennojoy.nginx (master) was installed successfully<br><a href="http://jinja.pocoo.org">jinja</a><h1 id="Manage-aws-cloud-resouces-with-ansible"><a href="#Manage-aws-cloud-resouces-with-ansible" class="headerlink" title="Manage aws cloud resouces with ansible"></a>Manage aws cloud resouces with ansible</h1><h2 id="manage-aws-ec2-instances-with-ansible"><a href="#manage-aws-ec2-instances-with-ansible" class="headerlink" title="manage aws ec2 instances with ansible"></a>manage aws ec2 instances with ansible</h2>ansible-doc -l|grep aws<br>ansible-doc -l|grep ec2<h2 id="Deploy-new-aws-ec2-instances-using-ansible-playbook"><a href="#Deploy-new-aws-ec2-instances-using-ansible-playbook" class="headerlink" title="Deploy new aws ec2 instances using ansible playbook"></a>Deploy new aws ec2 instances using ansible playbook</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat ec2_create.yaml</span><br><span class="line">---</span><br><span class="line">- hosts: localhost</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Create AWS instances</span><br><span class="line">      ec2:</span><br><span class="line">        key_name: ansible-key</span><br><span class="line">        instance_type: t2.micro</span><br><span class="line">        image: ami-001dae151248753a2</span><br><span class="line">        count: 3</span><br><span class="line">        vpc_subnet_id: subnet-20615347</span><br><span class="line">        assign_public_ip: no</span><br><span class="line">        region: ap-southeast-2</span><br><span class="line"></span><br><span class="line">ansible-playbook -i &quot;localhost,&quot; -c local ec2_create.yaml</span><br></pre></td></tr></table></figure>
</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/ansbile/">ansbile</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/06/24/practical-jenkins/" title="practical jenkins" itemprop="url">practical jenkins</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stan Zhou" target="_blank" itemprop="author">Stan Zhou</a>
		
  <p class="article-time">
    <time datetime="2019-06-24T13:57:33.000Z" itemprop="datePublished"> Published 2019-06-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Practical-Jenkins-for-Production-Deployments"><a href="#Practical-Jenkins-for-Production-Deployments" class="headerlink" title="Practical Jenkins for Production Deployments"></a>Practical Jenkins for Production Deployments</h1><ul>
<li>Installation, configuration, and automation of Jenkins and its dependencies</li>
<li>Attention to high-availability, monitoring, management, and security</li>
<li>Utilizing distributed architectures and ability to work with diverse infrastructure platforms</li>
<li>Understanding and implementing pipeline as code with special attention to multi-branch pipeline</li>
<li>Being able to deploy code continously</li>
<li>Integration with extenal services for optimal workflow desgin</li>
</ul>
<h1 id="The-Development-Stages"><a href="#The-Development-Stages" class="headerlink" title="The Development Stages"></a>The Development Stages</h1><ul>
<li>Feature branch forked from devlop branch</li>
<li>Code added/modified and then build/test is executed against it</li>
<li>On success, the node is merged to the develop branch</li>
<li>More builds/tests are executed against the develop branch including integration tests</li>
<li>On success, the code is merged to the master branch</li>
<li>A tag is created and (optionally) a package is prepared for deployment</li>
<li>Next setps:<ul>
<li>The package is deployed to target systems by Jenkins</li>
<li>Jenkins triggers an event in another deployment tool</li>
<li>Acceptance testing is performed on the target systems (optional)</li>
</ul>
</li>
</ul>
<h1 id="What-is-Continuous-Integration"><a href="#What-is-Continuous-Integration" class="headerlink" title="What is Continuous Integration?"></a>What is Continuous Integration?</h1><ul>
<li>It is a development practice</li>
<li>A new feature is added by forking an integration branch</li>
<li>The new feature branch is tested before merging the code to the integration branch</li>
<li>Errors and problems are detected early</li>
<li>Testing and merging happens automatically without manual intervention</li>
<li>New code is added, modified, and merged regularly to the integration branch</li>
</ul>
<h1 id="What-is-Continous-Delivery"><a href="#What-is-Continous-Delivery" class="headerlink" title="What is Continous Delivery?"></a>What is Continous Delivery?</h1><ul>
<li>It is the practice of getting code into a deployable state</li>
<li>This is achieved irrespective of the size of the application or number of developers making commits</li>
<li>Includes new features, changes, bug fixes, etc</li>
<li>Makes sure that all changes are ready to be deployed at any time</li>
<li>Makes releases low risk and of higher quality</li>
<li>Depends on Continous Integration</li>
</ul>
<h1 id="What-is-Continous-Deployment"><a href="#What-is-Continous-Deployment" class="headerlink" title="What is Continous Deployment?"></a>What is Continous Deployment?</h1><ul>
<li>It is the process of automatic releases to production</li>
<li>It is the next step to Continous Delivery</li>
<li>The level of testing decides how good the release will be </li>
<li>Release happends in small batches and continuously</li>
<li>Gradual product improvement and increase in quality</li>
<li>The processes of Continous Integration and Continuous Delivery need to be perfect to ensure that releases are without issues</li>
<li>Relieves developers and administrators from the periodic taks of releasing</li>
</ul>
<h1 id="Setting-up-git-code-repositories-and-dependencies-for-Jenkins"><a href="#Setting-up-git-code-repositories-and-dependencies-for-Jenkins" class="headerlink" title="Setting up git, code repositories, and dependencies for Jenkins"></a>Setting up git, code repositories, and dependencies for Jenkins</h1><h2 id="Storage-for-Jenkins-Data"><a href="#Storage-for-Jenkins-Data" class="headerlink" title="Storage for Jenkins Data"></a>Storage for Jenkins Data</h2><ul>
<li>Setting up a dedicated storage</li>
<li>Run on physical hardware-rate configuration with multiple disks</li>
<li>Run on virtualized cloud platform-dedicated elastic volumes</li>
<li>Home directory - /var/lib/jenkins</li>
</ul>
<p>Create a new volume in aws ec2 Elastic Block Store, attach volume to ec2 jenkins master instance, run following commmands:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fdisk -l</span><br><span class="line">mkfs.ext4 /dev/xvdf</span><br><span class="line">mkdir -p /var/lib/jenkins</span><br><span class="line">vim /etc/fstab</span><br><span class="line">/dev/xvdf /var/lib/jenkins ext4 defaults 0 0</span><br><span class="line">mount /var/lib/jenkins</span><br><span class="line">df -h</span><br><span class="line">yum -y install java-1.8.0-openjdk</span><br></pre></td></tr></table></figure></p>
<h2 id="Installation-of-Jenkins-from-Packages-and-WAR-Files"><a href="#Installation-of-Jenkins-from-Packages-and-WAR-Files" class="headerlink" title="Installation of Jenkins from Packages and WAR Files"></a>Installation of Jenkins from Packages and WAR Files</h2><ol>
<li>from Packages<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum -y install java-1.8.0-openjdk</span><br><span class="line">wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br><span class="line">yum install -y jenkins</span><br><span class="line">systemctl start jenkins</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>If want to change the jenkins’ home directory vim /etc/sysconfig/jenkins<br>JENKINS_HOME=</p>
<ol start="2">
<li><p>from WAR files</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum intall -y tomcat</span><br><span class="line">cd /usr/share/tomcat.webapps/</span><br><span class="line">wget http://mirrors.jenkins.io/war-stable/latest/jenkins.war</span><br><span class="line">systemctl start tomcat</span><br><span class="line">access by ipaddress:8080/jenkins</span><br><span class="line">systemctl stop tomcat</span><br><span class="line">mkdir -p /opt/jenkins_home</span><br><span class="line">chown -R tomcat:tomcat /opt/jenkins_home</span><br><span class="line">vim /etc/tomcat/contxt.xml</span><br><span class="line"># At the end of file add a new line</span><br><span class="line">&lt;Environment name=&quot;JENKINS_HOME&quot; vaule=&quot;/opt/jenkins_home&quot; type=&quot;java.lang.String&quot; /&gt;</span><br><span class="line">systemctl start tomcat</span><br></pre></td></tr></table></figure>
</li>
<li><p>use docker containers</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">yum install -y docker-ce</span><br><span class="line">systemctl start docker</span><br><span class="line">docker pull jenkins/jenkins:lts</span><br><span class="line">docker run --name jenkins_master -d -p 8080:8080 -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="Configuring-reverse-proxy-and-setting-up-user-interface-for-jenkins"><a href="#Configuring-reverse-proxy-and-setting-up-user-interface-for-jenkins" class="headerlink" title="Configuring reverse proxy and setting up user interface for jenkins"></a>Configuring reverse proxy and setting up user interface for jenkins</h2><p>Install nginx:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">rpm -ihv https://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/epel-release-7-11.noarch.rpm</span><br><span class="line">yum install -y nginx</span><br><span class="line">vim /etc/nginx/nginx.conf delete server &#123; part &#125;</span><br><span class="line">vim /etc/nginx/conf.d/jenkins.conf </span><br><span class="line">upstream jenkins &#123;</span><br><span class="line">    server 127.0.0.1:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen      80 default;</span><br><span class="line">    server_name jenkins.course;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/jenkins.access.log;</span><br><span class="line">    error_log   /var/log/nginx/jenkins.error.log;</span><br><span class="line"></span><br><span class="line">    proxy_buffers 16 64k;</span><br><span class="line">    proxy_buffer_size 128k;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass  http://jenkins;</span><br><span class="line">        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line"></span><br><span class="line">        proxy_set_header    Host            $host;</span><br><span class="line">        proxy_set_header    X-Real-IP       $remote_addr;</span><br><span class="line">        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header    X-Forwarded-Proto $scheme;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>In Jenkins configuration Git plugin put git username and email address<br><img src="https://i.imgur.com/vZuSUgf.png" alt="setupcredentials"></p>
<h2 id="Automating-the-Jenkins-Installation-and-Configuration-Process"><a href="#Automating-the-Jenkins-Installation-and-Configuration-Process" class="headerlink" title="Automating the Jenkins Installation and Configuration Process"></a>Automating the Jenkins Installation and Configuration Process</h2><ul>
<li>Disabling the manual setup wizard</li>
<li>Automating the setup wizard steps</li>
<li>Creating puppet configuration to automate the installation and configuration process</li>
<li>Automating the process by applying the puppet module<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop jenkins</span><br><span class="line">vim /etc/system/jenkins</span><br><span class="line">modify JENKINS_JAVA_OPTIONS=&quot;-Djava.awt.headless=true -Djenkins.install.runSetupWizard=false&quot;</span><br><span class="line">mkdir -p /var/lib/jenkins/init/groovy.d</span><br><span class="line">vim /var/lib/jenkins/init/groovy.d/installPlugins.groovy</span><br><span class="line">#!groovy</span><br><span class="line"></span><br><span class="line">import jenkins.model.*</span><br><span class="line">import java.util.logging.Logger</span><br><span class="line"></span><br><span class="line">def logger = Logger.getLogger(&quot;&quot;)</span><br><span class="line">def installed = false</span><br><span class="line">def initialized = false</span><br><span class="line">def pluginParameter = &quot;ws-cleanup timestamper credentials-binding build-timeout antisamy-markup-formatter cloudbees-folder pipeline-stage-view pipeline-github-lib github-branch-source workflow-aggregator gradle ant mailer email-ext ldap pam-auth matrix-auth ssh-slaves github git&quot;</span><br><span class="line"></span><br><span class="line">def plugins = pluginParameter.split()</span><br><span class="line">logger.info(&quot;&quot; + plugins)</span><br><span class="line">def instance = Jenkins.getInstance()</span><br><span class="line">def pm = instance.getPluginManager()</span><br><span class="line">def uc = instance.getUpdateCenter()</span><br><span class="line">plugins.each &#123;</span><br><span class="line">  logger.info(&quot;Checking &quot; + it)</span><br><span class="line">  if (!pm.getPlugin(it)) &#123;</span><br><span class="line">    logger.info(&quot;Looking UpdateCenter for &quot; + it)</span><br><span class="line">    if (!initialized) &#123;</span><br><span class="line">      uc.updateAllSites()</span><br><span class="line">      initialized = true</span><br><span class="line">    &#125;</span><br><span class="line">    def plugin = uc.getPlugin(it)</span><br><span class="line">    if (plugin) &#123;</span><br><span class="line">      logger.info(&quot;Installing &quot; + it)</span><br><span class="line">        def installFuture = plugin.deploy()</span><br><span class="line">      while(!installFuture.isDone()) &#123;</span><br><span class="line">        logger.info(&quot;Waiting for plugin install: &quot; + it)</span><br><span class="line">        sleep(3000)</span><br><span class="line">      &#125;</span><br><span class="line">      installed = true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">if (installed) &#123;</span><br><span class="line">  logger.info(&quot;Plugins installed, initializing a restart!&quot;)</span><br><span class="line">  instance.save()</span><br><span class="line">  instance.restart()</span><br><span class="line">&#125;</span><br><span class="line">vim /var/lib/jenkins/init/groovy.d/security.groovy</span><br><span class="line">#!groovy</span><br><span class="line"></span><br><span class="line">import jenkins.model.*</span><br><span class="line">import hudson.security.*</span><br><span class="line">import jenkins.security.s2m.AdminWhitelistRule</span><br><span class="line">import hudson.security.csrf.DefaultCrumbIssuer</span><br><span class="line">import jenkins.model.Jenkins</span><br><span class="line"></span><br><span class="line">def instance = Jenkins.getInstance()</span><br><span class="line"></span><br><span class="line">def hudsonRealm = new HudsonPrivateSecurityRealm(false)</span><br><span class="line">hudsonRealm.createAccount(&quot;admin&quot;, &quot;admin&quot;)</span><br><span class="line">instance.setSecurityRealm(hudsonRealm)</span><br><span class="line"></span><br><span class="line">def strategy = new FullControlOnceLoggedInAuthorizationStrategy()</span><br><span class="line">strategy.setAllowAnonymousRead(false)</span><br><span class="line">instance.setAuthorizationStrategy(strategy)</span><br><span class="line">instance.save()</span><br><span class="line"></span><br><span class="line">Jenkins.instance.getInjector().getInstance(AdminWhitelistRule.class)</span><br><span class="line"></span><br><span class="line">def j = Jenkins.instance</span><br><span class="line">if(j.getCrumbIssuer() == null) &#123;</span><br><span class="line">    j.setCrumbIssuer(new DefaultCrumbIssuer(true))</span><br><span class="line">    j.save()</span><br><span class="line">    println &apos;CSRF Protection configuration has changed.  Enabled CSRF Protection.&apos;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">    println &apos;Nothing changed.  CSRF Protection already configured.&apos;</span><br><span class="line">&#125;</span><br><span class="line">chown -R jenkins:jenkins /var/lib/jenkins/init/groovy.d/*.groovy</span><br><span class="line">systemctl start jenkins</span><br><span class="line">tail -f /var/log/jenkins/jenkins.log</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="install-puppet"><a href="#install-puppet" class="headerlink" title="install puppet"></a>install puppet</h2><p>go to <a href="http://yum.puppetlabs.com/">puppet</a>, copy url link <a href="http://yum.puppetlabs.com/puppetlabs-release-pc1-el-7.noarch.rpm">puppetlabs-release-pc1-el-7.noarch.rpm</a>.<br>on the sever install the package by the command:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -ihv http://yum.puppetlabs.com/puppetlabs-release-pc1-el-7.noarch.rpm</span><br><span class="line"></span><br><span class="line">yum -y install puppet-agent</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br></pre></td><td class="code"><pre><span class="line">mkdir puppet</span><br><span class="line">cd puppet</span><br><span class="line">mkdir &#123;modules, manifests&#125;</span><br><span class="line">mkdir modules/jenkins</span><br><span class="line">mkdir modules/jenkins/&#123;manifests,files&#125;</span><br><span class="line">vim modules/jenkins/manifests.install.pp</span><br><span class="line">class jenkins::install &#123;</span><br><span class="line">    file &#123; &apos;jenkins_repo&apos;:</span><br><span class="line">        path   =&gt; &apos;/etc/yum.repos.d/jenkins.repo&apos;,</span><br><span class="line">        source =&gt; &apos;https://pkg.jenkins.io/redhat-stable/jenkins.repo&apos;,</span><br><span class="line">        ensure =&gt; present,</span><br><span class="line">        mode   =&gt; &apos;0644&apos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    exec &#123; &apos;jenkins_repo_key&apos;:</span><br><span class="line">        command   =&gt; &apos;/bin/rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key&apos;,</span><br><span class="line">        unless    =&gt; &apos;/bin/rpm -q jenkins&apos;,</span><br><span class="line">        subscribe =&gt; File[&apos;jenkins_repo&apos;],</span><br><span class="line">        require   =&gt; File[&apos;jenkins_repo&apos;]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    package &#123; &apos;epel-repo&apos;:</span><br><span class="line">        name   =&gt; &apos;epel-release&apos;,</span><br><span class="line">        ensure =&gt; present,</span><br><span class="line">        source =&gt; &apos;https://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/epel-release-7-11.noarch.rpm&apos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $packages = [ &apos;jenkins&apos;, &apos;java-1.8.0-openjdk&apos;, &apos;nginx&apos;, &apos;git&apos; ]</span><br><span class="line"></span><br><span class="line">    package &#123; $packages:</span><br><span class="line">        ensure    =&gt; present,</span><br><span class="line">        require   =&gt; [ File[&apos;jenkins_repo&apos;], Package[&apos;epel-repo&apos;] ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vim modules/jenkins/cofig.pp</span><br><span class="line">class jenkins::config &#123;</span><br><span class="line">    file &#123; &apos;groovy_script_directory&apos;:</span><br><span class="line">        path   =&gt; &apos;/var/lib/jenkins/init.groovy.d&apos;,</span><br><span class="line">        owner  =&gt; &apos;jenkins&apos;,</span><br><span class="line">        group  =&gt; &apos;jenkins&apos;,</span><br><span class="line">        mode   =&gt; &apos;0755&apos;,</span><br><span class="line">        ensure =&gt; directory</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file &#123; &apos;security_groovy_script&apos;:</span><br><span class="line">        path    =&gt; &apos;/var/lib/jenkins/init.groovy.d/security.groovy&apos;,</span><br><span class="line">        owner   =&gt; &apos;jenkins&apos;,</span><br><span class="line">        group   =&gt; &apos;jenkins&apos;,</span><br><span class="line">        source  =&gt; &apos;puppet:///modules/jenkins/security.groovy&apos;,</span><br><span class="line">        mode    =&gt; &apos;0644&apos;,</span><br><span class="line">        require =&gt; File[&apos;groovy_script_directory&apos;]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file &#123; &apos;plugins_groovy_script&apos;:</span><br><span class="line">        path    =&gt; &apos;/var/lib/jenkins/init.groovy.d/installPlugins.groovy&apos;,</span><br><span class="line">        owner   =&gt; &apos;jenkins&apos;,</span><br><span class="line">        group   =&gt; &apos;jenkins&apos;,</span><br><span class="line">        source  =&gt; &apos;puppet:///modules/jenkins/installPlugins.groovy&apos;,</span><br><span class="line">        mode    =&gt; &apos;0644&apos;,</span><br><span class="line">        require =&gt; File[&apos;groovy_script_directory&apos;]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file &#123; &apos;nginx_config_jenkins&apos;:</span><br><span class="line">        path   =&gt; &apos;/etc/nginx/conf.d/jenkins.conf&apos;,</span><br><span class="line">        owner  =&gt; &apos;root&apos;,</span><br><span class="line">        group  =&gt; &apos;root&apos;,</span><br><span class="line">        source =&gt; &apos;puppet:///modules/jenkins/jenkins.conf&apos;,</span><br><span class="line">        mode   =&gt; &apos;0644&apos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file &#123; &apos;nginx_config&apos;:</span><br><span class="line">        path   =&gt; &apos;/etc/nginx/nginx.conf&apos;,</span><br><span class="line">        owner  =&gt; &apos;root&apos;,</span><br><span class="line">        group  =&gt; &apos;root&apos;,</span><br><span class="line">        source =&gt; &apos;puppet:///modules/jenkins/nginx.conf&apos;,</span><br><span class="line">        mode   =&gt; &apos;0644&apos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file &#123; &apos;jenkins_sysconfig&apos;:</span><br><span class="line">        path   =&gt; &apos;/etc/sysconfig/jenkins&apos;,</span><br><span class="line">        owner  =&gt; &apos;root&apos;,</span><br><span class="line">        group  =&gt; &apos;root&apos;,</span><br><span class="line">        source =&gt; &apos;puppet:///modules/jenkins/jenkins&apos;,</span><br><span class="line">        mode   =&gt; &apos;0644&apos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vim modules/jenkins/service.pp</span><br><span class="line">class jenkins::service &#123;</span><br><span class="line">    service &#123; &apos;jenkins&apos;:</span><br><span class="line">        ensure =&gt; running</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    service &#123; &apos;nginx&apos;:</span><br><span class="line">        ensure =&gt; running</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vim modules/jenkins/init.pp</span><br><span class="line">class jenkins &#123;</span><br><span class="line">    include jenkins::install</span><br><span class="line">    include jenkins::config</span><br><span class="line">    include jenkins::service</span><br><span class="line"></span><br><span class="line">    Class[&apos;jenkins::install&apos;] -&gt; Class[&apos;jenkins::config&apos;] ~&gt; Class[&apos;jenkins::service&apos;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vim modules/jenkins/files/installPlugins.groovy</span><br><span class="line">#!groovy</span><br><span class="line"></span><br><span class="line">import jenkins.model.*</span><br><span class="line">import java.util.logging.Logger</span><br><span class="line"></span><br><span class="line">def logger = Logger.getLogger(&quot;&quot;)</span><br><span class="line">def installed = false</span><br><span class="line">def initialized = false</span><br><span class="line">def pluginParameter = &quot;ws-cleanup timestamper credentials-binding build-timeout antisamy-markup-formatter cloudbees-folder pipeline-stage-view pipeline-github-lib github-branch-source workflow-aggregator gradle ant mailer email-ext ldap pam-auth matrix-auth ssh-slaves github git&quot;</span><br><span class="line"></span><br><span class="line">def plugins = pluginParameter.split()</span><br><span class="line">logger.info(&quot;&quot; + plugins)</span><br><span class="line">def instance = Jenkins.getInstance()</span><br><span class="line">def pm = instance.getPluginManager()</span><br><span class="line">def uc = instance.getUpdateCenter()</span><br><span class="line">plugins.each &#123;</span><br><span class="line">  logger.info(&quot;Checking &quot; + it)</span><br><span class="line">  if (!pm.getPlugin(it)) &#123;</span><br><span class="line">    logger.info(&quot;Looking UpdateCenter for &quot; + it)</span><br><span class="line">    if (!initialized) &#123;</span><br><span class="line">      uc.updateAllSites()</span><br><span class="line">      initialized = true</span><br><span class="line">    &#125;</span><br><span class="line">    def plugin = uc.getPlugin(it)</span><br><span class="line">    if (plugin) &#123;</span><br><span class="line">      logger.info(&quot;Installing &quot; + it)</span><br><span class="line">        def installFuture = plugin.deploy()</span><br><span class="line">      while(!installFuture.isDone()) &#123;</span><br><span class="line">        logger.info(&quot;Waiting for plugin install: &quot; + it)</span><br><span class="line">        sleep(3000)</span><br><span class="line">      &#125;</span><br><span class="line">      installed = true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">if (installed) &#123;</span><br><span class="line">  logger.info(&quot;Plugins installed, initializing a restart!&quot;)</span><br><span class="line">  instance.save()</span><br><span class="line">  instance.restart()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vim modules/jenkins/files/jenkins.conf</span><br><span class="line">upstream jenkins &#123;</span><br><span class="line">    server 127.0.0.1:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen      80 default;</span><br><span class="line">    server_name jenkins.course;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/jenkins.access.log;</span><br><span class="line">    error_log   /var/log/nginx/jenkins.error.log;</span><br><span class="line"></span><br><span class="line">    proxy_buffers 16 64k;</span><br><span class="line">    proxy_buffer_size 128k;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass  http://jenkins;</span><br><span class="line">        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line"></span><br><span class="line">        proxy_set_header    Host            $host;</span><br><span class="line">        proxy_set_header    X-Real-IP       $remote_addr;</span><br><span class="line">        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header    X-Forwarded-Proto $scheme;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vim modules/jenkins/files/nginx.conf</span><br><span class="line"># For more information on configuration, see:</span><br><span class="line">#   * Official English Documentation: http://nginx.org/en/docs/</span><br><span class="line">#   * Official Russian Documentation: http://nginx.org/ru/docs/</span><br><span class="line"></span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line"># Load dynamic modules. See /usr/share/nginx/README.dynamic.</span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # Load modular configuration files from the /etc/nginx/conf.d directory.</span><br><span class="line">    # See http://nginx.org/en/docs/ngx_core_module.html#include</span><br><span class="line">    # for more information.</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vim modules/jenkins/files/security.groovy</span><br><span class="line">#!groovy</span><br><span class="line"></span><br><span class="line">import jenkins.model.*</span><br><span class="line">import hudson.security.*</span><br><span class="line">import jenkins.security.s2m.AdminWhitelistRule</span><br><span class="line">import hudson.security.csrf.DefaultCrumbIssuer</span><br><span class="line">import jenkins.model.Jenkins</span><br><span class="line"></span><br><span class="line">def instance = Jenkins.getInstance()</span><br><span class="line"></span><br><span class="line">def hudsonRealm = new HudsonPrivateSecurityRealm(false)</span><br><span class="line">hudsonRealm.createAccount(&quot;admin&quot;, &quot;admin&quot;)</span><br><span class="line">instance.setSecurityRealm(hudsonRealm)</span><br><span class="line"></span><br><span class="line">def strategy = new FullControlOnceLoggedInAuthorizationStrategy()</span><br><span class="line">strategy.setAllowAnonymousRead(false)</span><br><span class="line">instance.setAuthorizationStrategy(strategy)</span><br><span class="line">instance.save()</span><br><span class="line"></span><br><span class="line">Jenkins.instance.getInjector().getInstance(AdminWhitelistRule.class)</span><br><span class="line"></span><br><span class="line">def j = Jenkins.instance</span><br><span class="line">if(j.getCrumbIssuer() == null) &#123;</span><br><span class="line">    j.setCrumbIssuer(new DefaultCrumbIssuer(true))</span><br><span class="line">    j.save()</span><br><span class="line">    println &apos;CSRF Protection configuration has changed.  Enabled CSRF Protection.&apos;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">    println &apos;Nothing changed.  CSRF Protection already configured.&apos;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-172-31-2-108 ~]# tree puppet/</span><br><span class="line">puppet/</span><br><span class="line">├── manifests</span><br><span class="line">│   └── site.pp</span><br><span class="line">└── modules</span><br><span class="line">    └── jenkins</span><br><span class="line">        ├── files</span><br><span class="line">        │   ├── installPlugins.groovy</span><br><span class="line">        │   ├── jenkins</span><br><span class="line">        │   ├── jenkins.conf</span><br><span class="line">        │   ├── nginx.conf</span><br><span class="line">        │   └── security.groovy</span><br><span class="line">        └── manifests</span><br><span class="line">            ├── config.pp</span><br><span class="line">            ├── init.pp</span><br><span class="line">            ├── install.pp</span><br><span class="line">            └── service.pp</span><br><span class="line">cd puppet</span><br><span class="line">puppet apply --modulepath ./modules manifests/site.pp</span><br></pre></td></tr></table></figure>
<h2 id="Creating-build-jobs-from-user-interface-and-scripts"><a href="#Creating-build-jobs-from-user-interface-and-scripts" class="headerlink" title="Creating build jobs from user interface and scripts"></a>Creating build jobs from user interface and scripts</h2><p>1.Create a new freestyle jenkins job called python-job, configure ‘Source Code Management”-&gt;’Git’-&gt; Repo URL <a href="mailto:git@github.com">git@github.com</a>:szhouchoice/python-project.git.<br>“Build” -&gt; Execute shell, command <code>python *test.py</code></p>
<p>2.<code>mkdir jenkins_cmd; cd jenkins_cmd</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cp /var/lib/jenkins/jobs/python-job/config.xml .</span><br><span class="line">vim config.xml</span><br><span class="line">&lt;publishers&gt;</span><br><span class="line">    &lt;hudson.plugins.ws__cleanup.WsCleanup plugin=&quot;ws-cleanup@0.34&quot;&gt;</span><br><span class="line">      &lt;patterns class=&quot;empty-list&quot;/&gt;</span><br><span class="line">      &lt;deleteDirs&gt;true&lt;/deleteDirs&gt;</span><br><span class="line">      &lt;skipWhenFailed&gt;false&lt;/skipWhenFailed&gt;</span><br><span class="line">      &lt;cleanWhenSuccess&gt;true&lt;/cleanWhenSuccess&gt;</span><br><span class="line">      &lt;cleanWhenUnstable&gt;true&lt;/cleanWhenUnstable&gt;</span><br><span class="line">      &lt;cleanWhenFailure&gt;true&lt;/cleanWhenFailure&gt;</span><br><span class="line">      &lt;cleanWhenNotBuilt&gt;true&lt;/cleanWhenNotBuilt&gt;</span><br><span class="line">      &lt;cleanWhenAborted&gt;true&lt;/cleanWhenAborted&gt;</span><br><span class="line">      &lt;notFailBuild&gt;false&lt;/notFailBuild&gt;</span><br><span class="line">      &lt;cleanupMatrixParent&gt;false&lt;/cleanupMatrixParent&gt;</span><br><span class="line">      &lt;externalDelete&gt;&lt;/externalDelete&gt;</span><br><span class="line">    &lt;/hudson.plugins.ws__cleanup.WsCleanup&gt;</span><br><span class="line">curl -s &apos;http://localhost:8080/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,&quot;:&quot;,//crumb)&apos; -u admin:admin</span><br><span class="line"></span><br><span class="line">curl -s -XPOST &apos;http://localhost:8080/createItem?name=python-project-new&apos; -u admin:admin --data-binary @config.xml -H &quot;Jenkins-Crumb:384576fea44a8984fd1afe2474c8e951&quot; -H &quot;Content-Type:text/xml&quot;</span><br></pre></td></tr></table></figure></p>
<h1 id="High-availability-monitoring-and-management-of-jenkins-deployments"><a href="#High-availability-monitoring-and-management-of-jenkins-deployments" class="headerlink" title="High-availability, monitoring, and management of jenkins deployments"></a>High-availability, monitoring, and management of jenkins deployments</h1><ul>
<li>High-availability scenario of Jenkins ecosystem and support</li>
<li>Creating multiple Jenkins master nodes with shared data directory</li>
<li>Configuring HAProxy as a load balancer for the Jenkins masters</li>
<li>Testing the setup by failing nodes</li>
</ul>
<h2 id="Setting-up-multiple-Jenkins-Master-with-Load-Balancer-for-high-availability"><a href="#Setting-up-multiple-Jenkins-Master-with-Load-Balancer-for-high-availability" class="headerlink" title="Setting up multiple Jenkins Master with Load Balancer for high-availability"></a>Setting up multiple Jenkins Master with Load Balancer for high-availability</h2><p><img src="https://i.imgur.com/YnYwCzR.png" alt="High-Availability Setup"></p>
<h3 id="1-On-aws-ec2-create-3-instances-with-Centos-7-OS-1-for-haproxy-2-for-jenkins"><a href="#1-On-aws-ec2-create-3-instances-with-Centos-7-OS-1-for-haproxy-2-for-jenkins" class="headerlink" title="1. On aws ec2 create 3 instances with Centos 7 OS. 1 for haproxy 2 for jenkins"></a>1. On aws ec2 create 3 instances with Centos 7 OS. 1 for haproxy 2 for jenkins</h3><h3 id="2-Create-a-efs-on-aws-setup-up-efs-on-two-jenkins-ec2-instances-efs-security-group-need-create-a-new-one-open-nfs-port-to-everywhere"><a href="#2-Create-a-efs-on-aws-setup-up-efs-on-two-jenkins-ec2-instances-efs-security-group-need-create-a-new-one-open-nfs-port-to-everywhere" class="headerlink" title="2. Create a efs on aws, setup up efs on two jenkins ec2 instances. efs security group need create a new one open nfs port to everywhere"></a>2. Create a efs on aws, setup up efs on two jenkins ec2 instances. efs security group need create a new one open nfs port to everywhere</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum -y install nfs-utils</span><br><span class="line">vim /etc/fstab</span><br><span class="line">ap-southeast-2a.fs-foobar.efs.ap-southeast-2.amazonaws.com:/ /var/lib/jenkins/jobs nfs defaults 0 0</span><br><span class="line">systemctl stop jenkins</span><br><span class="line">mount /var/lib/jenkins/jobs</span><br><span class="line">df -h</span><br><span class="line">chown -R jenkins:jenkins /var/lib/jenkins/jobs</span><br><span class="line">ls -l /var/lib/jenkins/</span><br><span class="line">systemctl start jenkins</span><br></pre></td></tr></table></figure>
<h3 id="3-On-Jenkins-master-passive-node"><a href="#3-On-Jenkins-master-passive-node" class="headerlink" title="3. On Jenkins master passive node"></a>3. On Jenkins master passive node</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/jenkins_reload.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">crumb_id=$(curl -s &apos;http://localhost:8080/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,&quot;:&quot;,//crumb)&apos; -u admin:admin)</span><br><span class="line">curl -s -XPOST &apos;http://localhost:8080/reload&apos; -u admin:admin -H &quot;$crumb_id&quot;</span><br><span class="line">chmod +x /opt/jenkins_reload.sh</span><br><span class="line">vim /etc/cron.d/jenkins_reload.sh</span><br><span class="line">*/1 * * * * root /bin/bash /opt/jenkins_reload.sh #run every min</span><br></pre></td></tr></table></figure>
<h3 id="4-On-HA-Proxy-server"><a href="#4-On-HA-Proxy-server" class="headerlink" title="4. On HA Proxy server"></a>4. On HA Proxy server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">yum -y install haproxy</span><br><span class="line">cat /dev/null&gt; /etc/haproxy/haproxy.cfg</span><br><span class="line">vim /etc/haproxy/haproxy.cfg</span><br><span class="line">defaults</span><br><span class="line">  log  global</span><br><span class="line">  maxconn  2000</span><br><span class="line">  mode  http</span><br><span class="line">  option  redispatch</span><br><span class="line">  option  forwardfor</span><br><span class="line">  option  http-server-close</span><br><span class="line">  retries  3</span><br><span class="line">  timeout  http-request 10s</span><br><span class="line">  timeout  queue 1m</span><br><span class="line">  timeout  connect 10s</span><br><span class="line">  timeout  client 1m</span><br><span class="line">  timeout  server 1m</span><br><span class="line">  timeout  check 10s</span><br><span class="line"></span><br><span class="line">frontend ft_jenkins</span><br><span class="line">  bind *:80</span><br><span class="line">  default_backend  bk_jenkins</span><br><span class="line">  reqadd  X-Forwarded-Proto:\ http</span><br><span class="line"></span><br><span class="line">backend bk_jenkins</span><br><span class="line"> server jenkins1 172.31.2.108:8080 check</span><br><span class="line"> server jenkins2 172.31.2.132:8080 check backup</span><br><span class="line"></span><br><span class="line">systemctl start haproxy</span><br><span class="line">ps-ef|grep haproxy</span><br></pre></td></tr></table></figure>
<h2 id="Backing-up-and-restoring-Jenkins-data"><a href="#Backing-up-and-restoring-Jenkins-data" class="headerlink" title="Backing up and restoring Jenkins data"></a>Backing up and restoring Jenkins data</h2><h3 id="Steps-of-backup-and-resotre"><a href="#Steps-of-backup-and-resotre" class="headerlink" title="Steps of backup and resotre"></a>Steps of backup and resotre</h3><ul>
<li>Decide on what to back up (specific directories or everything)</li>
<li>Set up a dedicated local directory where backups would be stored</li>
<li>Decide the archiving method to use for the backup (.zip, tar.gz, and so on)</li>
<li>Set up a schedule for backups to take place</li>
<li>Configure a highly-available remove location where old backups can be transferred for archiving</li>
<li>Keep a certain number of the most recent backups to be readily available for restores</li>
<li>When restoring, unarchive the most recent backup and copy over files<h3 id="Backup-and-Restore-Methods"><a href="#Backup-and-Restore-Methods" class="headerlink" title="Backup and Restore Methods"></a>Backup and Restore Methods</h3></li>
<li>Use periodic Backup plugin available in Jenkins</li>
<li>Manually copy and archive files using scripts</li>
<li>Select a remote location for storing data such as S3, EFS, and so on</li>
<li>Use local tools such as scp, rsync, s3cmd, and son on to transfer data</li>
<li>Use specialized open source tools such as Amanda or Bacula to perform backups or enterprise tools such as Netbackup</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/jenkins_backups</span><br><span class="line">chown -R jenkins:jenkins /opt/jenkins_backups/</span><br></pre></td></tr></table></figure>
<p>Install plugin called Periodic Backup Manager, configure it as following:<br><img src="https://i.imgur.com/fvgXK7C.png" alt="periodicbackupconf"></p>
<p>click button Backup Now!</p>
<h2 id="Monitoring-Jenkins-components-and-data"><a href="#Monitoring-Jenkins-components-and-data" class="headerlink" title="Monitoring Jenkins components and data"></a>Monitoring Jenkins components and data</h2><h3 id="Install-plugin-monitoring-after-that-under-‘Manage-Jenkins’-will-have-Monitoring-of-Jenkins-master"><a href="#Install-plugin-monitoring-after-that-under-‘Manage-Jenkins’-will-have-Monitoring-of-Jenkins-master" class="headerlink" title="Install plugin monitoring, after that under ‘Manage Jenkins’ will have Monitoring of Jenkins master:"></a>Install plugin monitoring, after that under ‘Manage Jenkins’ will have Monitoring of Jenkins master:</h3><p><img src="https://i.imgur.com/88b0cnX.png" alt="Monitoring"></p>
<h3 id="install-configure-graphite-grafana"><a href="#install-configure-graphite-grafana" class="headerlink" title="install configure graphite grafana"></a>install configure graphite grafana</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">#Install EPEL repo</span><br><span class="line">rpm -ihv https://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/epel-release-7-11.noarch.rpm</span><br><span class="line"></span><br><span class="line">#Install Graphite and dependencies</span><br><span class="line">yum -y install graphite-web mysql mariadb-server MySQL-python net-tools mlocate wget python-carbon python-pip gcc python-devel libffi python-cffi cairo cairo-devel fontconfig freetype*</span><br><span class="line"></span><br><span class="line">#Start database server</span><br><span class="line">systemctl start mariadb</span><br><span class="line"></span><br><span class="line">#Configure database and perms</span><br><span class="line">mysql -e &quot;CREATE DATABASE graphite;&quot;</span><br><span class="line">mysql -e &quot;GRANT ALL PRIVILEGES ON graphite.* TO &apos;graphite&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;j3nk1nsdb&apos;;&quot;</span><br><span class="line">mysql -e &apos;FLUSH PRIVILEGES;&apos;</span><br><span class="line"></span><br><span class="line">#Edit file</span><br><span class="line">vi /etc/graphite-web/local_settings.py</span><br><span class="line"></span><br><span class="line">#Add content</span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    &apos;default&apos;: &#123;</span><br><span class="line">        &apos;NAME&apos;: &apos;graphite&apos;,</span><br><span class="line">        &apos;ENGINE&apos;: &apos;django.db.backends.mysql&apos;,</span><br><span class="line">        &apos;USER&apos;: &apos;graphite&apos;,</span><br><span class="line">        &apos;PASSWORD&apos;: &apos;j3nk1nsdb&apos;,</span><br><span class="line">        &apos;HOST&apos;: &apos;localhost&apos;,</span><br><span class="line">        &apos;PORT&apos;: &apos;3306&apos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#Change perms</span><br><span class="line">chown -R apache:apache /var/lib/graphite-web /usr/share/graphite/</span><br><span class="line"></span><br><span class="line">#Edit file</span><br><span class="line">vi /etc/httpd/conf.d/graphite-web.conf</span><br><span class="line"></span><br><span class="line">#Add content</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName graphite-web</span><br><span class="line">    DocumentRoot &quot;/usr/share/graphite/webapp&quot;</span><br><span class="line">    ErrorLog /var/log/httpd/graphite-web-error.log</span><br><span class="line">    CustomLog /var/log/httpd/graphite-web-access.log common</span><br><span class="line"></span><br><span class="line">    # Header set Access-Control-Allow-Origin &quot;*&quot;</span><br><span class="line">    # Header set Access-Control-Allow-Methods &quot;GET, OPTIONS&quot;</span><br><span class="line">    # Header set Access-Control-Allow-Headers &quot;origin, authorization, accept&quot;</span><br><span class="line">    # Header set Access-Control-Allow-Credentials true</span><br><span class="line"></span><br><span class="line">    WSGIScriptAlias / /usr/share/graphite/graphite-web.wsgi</span><br><span class="line">    WSGIImportScript /usr/share/graphite/graphite-web.wsgi process-group=%&#123;GLOBAL&#125; application-group=%&#123;GLOBAL&#125;</span><br><span class="line"></span><br><span class="line">    &lt;Location &quot;/content/&quot;&gt;</span><br><span class="line">        SetHandler None</span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line"></span><br><span class="line">    Alias /media/ &quot;/usr/lib/python2.7/site-packages/django/contrib/admin/media/&quot;</span><br><span class="line">    &lt;Location &quot;/media/&quot;&gt;</span><br><span class="line">        SetHandler None</span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line"></span><br><span class="line">   &lt;Directory &quot;/usr/share/graphite/&quot;&gt;</span><br><span class="line">    Require all granted</span><br><span class="line">    Order allow,deny</span><br><span class="line">    Allow from all</span><br><span class="line">   &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">#Edit file</span><br><span class="line">vi /etc/graphite-web/local_settings.py</span><br><span class="line"></span><br><span class="line">#Add content</span><br><span class="line">SECRET_KEY = &apos;jenkinsapp&apos;</span><br><span class="line"></span><br><span class="line">#Run command</span><br><span class="line">/usr/lib/python2.7/site-packages/graphite/manage.py syncdb</span><br><span class="line"># user admin password admin</span><br><span class="line"></span><br><span class="line">#Edit file</span><br><span class="line">vi /etc/yum.repos.d/grafana.repo</span><br><span class="line"></span><br><span class="line">#Add content</span><br><span class="line">[grafana]</span><br><span class="line">name=grafana</span><br><span class="line">baseurl=https://packagecloud.io/grafana/stable/el/6/$basearch</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://packagecloud.io/gpg.key https://grafanarel.s3.amazonaws.com/RPM-GPG-KEY-grafana</span><br><span class="line">sslverify=1</span><br><span class="line">sslcacert=/etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line"></span><br><span class="line">#Install grafana</span><br><span class="line">yum -y install grafana</span><br><span class="line"></span><br><span class="line">#Start services</span><br><span class="line">systemctl start carbon-cache</span><br><span class="line">systemctl start httpd</span><br><span class="line">systemctl start grafana-server</span><br></pre></td></tr></table></figure>
<p>1.Install jenkins plugin call ‘Metrics Graphite Reporting’<br>2.Go to Manage Jenkins -&gt; Configure Sytem-&gt; Graphite metrics report input Hostname ipaddress Port 2003 Prefix jenkins.<br>3.Access grafana server ipaddress:3000 -&gt; Add Graphite -&gt; http settings url <a href="http://localhost">http://localhost</a><br>4.Import grafana dashboard: go to grafana.com/dashboards search for Jenkins: Performance and health overview-&gt; copy id<br>5.<img src="https://i.imgur.com/jeagEZ9.png" alt="import dashboard"> Options grahite choose jenkins-test</p>
<h3 id="Install-monit"><a href="#Install-monit" class="headerlink" title="Install monit"></a>Install monit</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">yum install -y monit</span><br><span class="line">vim /etc/monitrc</span><br><span class="line">set mailserver smtp.gmail.com port 587</span><br><span class="line">    username &quot;EMAIL&quot; password &quot;PASSWORD&quot;</span><br><span class="line">    using tlsv12</span><br><span class="line">vim /etc/monit.d/jenkins</span><br><span class="line">check system $HOST</span><br><span class="line">    if loadavg (5min) &gt; 3 then alert</span><br><span class="line">    if loadavg (15min) &gt; 1 then alert</span><br><span class="line">    if memory usage &gt; 80% for 4 cycles then alert</span><br><span class="line">    if swap usage &gt; 20% for 4 cycles then alert</span><br><span class="line">    if cpu usage (user) &gt; 80% for 2 cycles then alert</span><br><span class="line">    if cpu usage (system) &gt; 20% for 2 cycles then alert</span><br><span class="line">    if cpu usage (wait) &gt; 80% for 2 cycles then alert</span><br><span class="line">    if cpu usage &gt; 200% for 4 cycles then alert</span><br><span class="line"></span><br><span class="line">check process jenkins with pidfile /var/run/jenkins.pid</span><br><span class="line">    start program = &quot;/bin/systemctl start jenkins&quot;</span><br><span class="line">    stop program  = &quot;/bin/systemctl stop jenkins&quot;</span><br><span class="line">    if failed host 192.168.33.200 port 8080 then restart</span><br><span class="line"></span><br><span class="line">check process nginx with pidfile /var/run/nginx.pid</span><br><span class="line">    start program = &quot;/bin/systemctl start nginx&quot;</span><br><span class="line">    stop program  = &quot;/bin/systemctl stop nginx&quot;</span><br><span class="line">    if failed host 192.168.33.200 port 80 then restart</span><br><span class="line"></span><br><span class="line">check filesystem jenkins_mount with path /dev/sda2</span><br><span class="line">    start program  = &quot;/bin/mount /var/lib/jenkins&quot;</span><br><span class="line">    stop program  = &quot;/bin/umount /var/lib/jenkins&quot;</span><br><span class="line">    if space usage &gt; 80% for 3 times within 5 cycles then alert</span><br><span class="line">    if space usage &gt; 99% then stop</span><br><span class="line">    if inode usage &gt; 30000 then alert</span><br><span class="line">    if inode usage &gt; 99% then stop</span><br><span class="line"></span><br><span class="line">check directory jenkins_home with path /var/lib/jenkins</span><br><span class="line">    if failed permission 755 then exec &quot;/bin/chmod 755 /var/lib/jenkins&quot;</span><br></pre></td></tr></table></figure>
<p>Enable gmail account Allow less secure apps to ‘on’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start monit</span><br><span class="line">tail -f /var/log/monit.log</span><br><span class="line"># test by systemctl stop jenkins</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.imgur.com/gG5igvY.png" alt="monit"></p>
<h2 id="Implementing-security-and-roles-for-Jenkins"><a href="#Implementing-security-and-roles-for-Jenkins" class="headerlink" title="Implementing security and roles for Jenkins"></a>Implementing security and roles for Jenkins</h2><h3 id="Jenkins-Security-best-practices"><a href="#Jenkins-Security-best-practices" class="headerlink" title="Jenkins Security best practices"></a>Jenkins Security best practices</h3><ul>
<li>Disable job execution on the mater and use slave nodes for builds</li>
<li>Use job restrictions plugin to confine specific jobs to specific nodes irrespective of the label used<br>install plugin job restrictions-&gt; Manage Jenkins-&gt; Manage Nodes<br><img src="https://imgur.com/1gwJ4gM" alt="restrict jobs execution at node"></li>
<li>Enable CSRF protection and update scripts to use crumbs<br><img src="https://i.imgur.com/9q0FIpP.png" alt="configure csrf"></li>
<li>Enable the slave to master access control<br><img src="https://i.imgur.com/lPoxSai.png" alt="config"></li>
<li>For large encironments, use role and matrix based authorization strategies to isolate project access<br>install plugin Role-based Authorization Strategy<br><img src="https://i.imgur.com/H0bz6rU.png" alt="Project-based Matrix Authorization Strategy"><br><img src="https://i.imgur.com/YkFDXf5.png" alt="Enable project-based security"><h3 id="use-LDAP-server-and-role-based-strategy"><a href="#use-LDAP-server-and-role-based-strategy" class="headerlink" title="use LDAP server and role-based strategy"></a>use LDAP server and role-based strategy</h3>1.ldap server config on centos 7<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line">yum -y install openldap-servers openldap-clients</span><br><span class="line">cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</span><br><span class="line">chown ldap. /var/lib/ldap/DB_CONFIG</span><br><span class="line">systemctl start slapd</span><br><span class="line"></span><br><span class="line">slappasswd -&gt; Enter new password twice -&gt; GENERATED_PASSWORD</span><br><span class="line"></span><br><span class="line">#New file</span><br><span class="line">config.ldif</span><br><span class="line"></span><br><span class="line">#Add content</span><br><span class="line">dn: olcDatabase=&#123;0&#125;config,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcRootPW</span><br><span class="line">olcRootPW: GENERATED_PASSWORD</span><br><span class="line"></span><br><span class="line">#Run commands</span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f config.ldif</span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif</span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif</span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif</span><br><span class="line"></span><br><span class="line">#New file</span><br><span class="line">domain.ldif</span><br><span class="line"></span><br><span class="line">#Add content</span><br><span class="line">dn: olcDatabase=&#123;1&#125;monitor,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to * by dn.base=&quot;gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth&quot;</span><br><span class="line">  read by dn.base=&quot;cn=Manager,dc=practicaljenkins,dc=com&quot; read by * none</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcSuffix</span><br><span class="line">olcSuffix: dc=practicaljenkins,dc=com</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcRootDN</span><br><span class="line">olcRootDN: cn=Manager,dc=practicaljenkins,dc=com</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcRootPW</span><br><span class="line">olcRootPW: &#123;SSHA&#125;mviTD7um1R+LygfAN01MzQOtK4ezm1ob</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword,shadowLastChange by</span><br><span class="line">  dn=&quot;cn=Manager,dc=practicaljenkins,dc=com&quot; write by anonymous auth by self write by * none</span><br><span class="line">olcAccess: &#123;1&#125;to dn.base=&quot;&quot; by * read</span><br><span class="line">olcAccess: &#123;2&#125;to * by dn=&quot;cn=Manager,dc=practicaljenkins,dc=com&quot; write by * read</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Run command</span><br><span class="line">ldapmodify -Y EXTERNAL -H ldapi:/// -f domain.ldif</span><br><span class="line"></span><br><span class="line">systemctl restart slapd</span><br><span class="line"></span><br><span class="line">#New file</span><br><span class="line">base.ldif</span><br><span class="line"></span><br><span class="line">#Add content</span><br><span class="line">dn: dc=practicaljenkins,dc=com</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: dcObject</span><br><span class="line">objectclass: organization</span><br><span class="line">o: practicaljenkins</span><br><span class="line">dc: practicaljenkins</span><br><span class="line"></span><br><span class="line">dn: cn=Manager,dc=practicaljenkins,dc=com</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">cn: Manager</span><br><span class="line">description: Directory Manager</span><br><span class="line"></span><br><span class="line">dn: ou=users,dc=practicaljenkins,dc=com</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line">ou: users</span><br><span class="line"></span><br><span class="line">dn: ou=groups,dc=practicaljenkins,dc=com</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line">ou: groups</span><br><span class="line"></span><br><span class="line">#Run command - enter password of slappasswd command when asked</span><br><span class="line"></span><br><span class="line">ldapadd -x -D cn=Manager,dc=practicaljenkins,dc=com -W -f base.ldif</span><br><span class="line"></span><br><span class="line">## configure phpldapadmin</span><br><span class="line">yum -y install httpd php php-mbstring php-pear</span><br><span class="line">systemctl start httpd</span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum clean all &amp;&amp; yum makecache fast &amp;&amp; yum update</span><br><span class="line">vim /etc/phpldapadmin/config.php</span><br><span class="line">&lt;?php</span><br><span class="line">$config-&gt;custom-&gt;session[&apos;blowfish&apos;] = &apos;d7458abe84f9622a42ce3f9e45dfc457&apos;;  # Autogenerated for ip-172-31-4-228.ap-southeast-2.compute.internal</span><br><span class="line"></span><br><span class="line">$config-&gt;custom-&gt;commands[&apos;cmd&apos;] = array(</span><br><span class="line">	&apos;entry_internal_attributes_show&apos; =&gt; true,</span><br><span class="line">	&apos;entry_refresh&apos; =&gt; true,</span><br><span class="line">	&apos;oslinks&apos; =&gt; true,</span><br><span class="line">	&apos;switch_template&apos; =&gt; true</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$config-&gt;custom-&gt;commands[&apos;script&apos;] = array(</span><br><span class="line">	&apos;add_attr_form&apos; =&gt; true,</span><br><span class="line">	&apos;add_oclass_form&apos; =&gt; true,</span><br><span class="line">	&apos;add_value_form&apos; =&gt; true,</span><br><span class="line">	&apos;collapse&apos; =&gt; true,</span><br><span class="line">	&apos;compare&apos; =&gt; true,</span><br><span class="line">	&apos;compare_form&apos; =&gt; true,</span><br><span class="line">	&apos;copy&apos; =&gt; true,</span><br><span class="line">	&apos;copy_form&apos; =&gt; true,</span><br><span class="line">	&apos;create&apos; =&gt; true,</span><br><span class="line">	&apos;create_confirm&apos; =&gt; true,</span><br><span class="line">	&apos;delete&apos; =&gt; true,</span><br><span class="line">	&apos;delete_attr&apos; =&gt; true,</span><br><span class="line">	&apos;delete_form&apos; =&gt; true,</span><br><span class="line">	&apos;draw_tree_node&apos; =&gt; true,</span><br><span class="line">	&apos;expand&apos; =&gt; true,</span><br><span class="line">	&apos;export&apos; =&gt; true,</span><br><span class="line">	&apos;export_form&apos; =&gt; true,</span><br><span class="line">	&apos;import&apos; =&gt; true,</span><br><span class="line">	&apos;import_form&apos; =&gt; true,</span><br><span class="line">	&apos;login&apos; =&gt; true,</span><br><span class="line">	&apos;logout&apos; =&gt; true,</span><br><span class="line">	&apos;login_form&apos; =&gt; true,</span><br><span class="line">	&apos;mass_delete&apos; =&gt; true,</span><br><span class="line">	&apos;mass_edit&apos; =&gt; true,</span><br><span class="line">	&apos;mass_update&apos; =&gt; true,</span><br><span class="line">	&apos;modify_member_form&apos; =&gt; true,</span><br><span class="line">	&apos;monitor&apos; =&gt; true,</span><br><span class="line">	&apos;purge_cache&apos; =&gt; true,</span><br><span class="line">	&apos;query_engine&apos; =&gt; true,</span><br><span class="line">	&apos;rename&apos; =&gt; true,</span><br><span class="line">	&apos;rename_form&apos; =&gt; true,</span><br><span class="line">	&apos;rdelete&apos; =&gt; true,</span><br><span class="line">	&apos;refresh&apos; =&gt; true,</span><br><span class="line">	&apos;schema&apos; =&gt; true,</span><br><span class="line">	&apos;server_info&apos; =&gt; true,</span><br><span class="line">	&apos;show_cache&apos; =&gt; true,</span><br><span class="line">	&apos;template_engine&apos; =&gt; true,</span><br><span class="line">	&apos;update_confirm&apos; =&gt; true,</span><br><span class="line">	&apos;update&apos; =&gt; true</span><br><span class="line">);</span><br><span class="line">$servers = new Datastore();</span><br><span class="line">$servers-&gt;newServer(&apos;ldap_pla&apos;);</span><br><span class="line">$servers-&gt;setValue(&apos;server&apos;,&apos;name&apos;,&apos;Stan Local LDAP Server&apos;);</span><br><span class="line">$servers-&gt;setValue(&apos;server&apos;,&apos;host&apos;,&apos;172.31.4.228&apos;);</span><br><span class="line">$servers-&gt;setValue(&apos;appearance&apos;,&apos;password_hash&apos;,&apos;&apos;);</span><br><span class="line">$servers-&gt;setValue(&apos;login&apos;,&apos;attr&apos;,&apos;dn&apos;);</span><br><span class="line">$servers-&gt;setValue(&apos;login&apos;,&apos;class&apos;,array(&apos;dc=practicaljenkins,dc=com&apos;));</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">systemctl restart httpd</span><br><span class="line">vim /etc/httpd/conf.d/phpldapadmin.conf</span><br><span class="line">#</span><br><span class="line">#  Web-based tool for managing LDAP servers</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">Alias /phpldapadmin /usr/share/phpldapadmin/htdocs</span><br><span class="line">Alias /ldapadmin /usr/share/phpldapadmin/htdocs</span><br><span class="line"></span><br><span class="line">&lt;Directory /usr/share/phpldapadmin/htdocs&gt;</span><br><span class="line">  &lt;IfModule mod_authz_core.c&gt;</span><br><span class="line">    # Apache 2.4</span><br><span class="line">    #Require local</span><br><span class="line">    Require all granted</span><br><span class="line">  &lt;/IfModule&gt;</span><br><span class="line">  &lt;IfModule !mod_authz_core.c&gt;</span><br><span class="line">    # Apache 2.2</span><br><span class="line">    Order Deny,Allow</span><br><span class="line">    Deny from all</span><br><span class="line">    Allow from 127.0.0.1</span><br><span class="line">    Allow from ::1</span><br><span class="line">  &lt;/IfModule&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">cat /etc/selinux/config</span><br><span class="line"></span><br><span class="line"># This file controls the state of SELinux on the system.</span><br><span class="line"># SELINUX= can take one of these three values:</span><br><span class="line">#     enforcing - SELinux security policy is enforced.</span><br><span class="line">#     permissive - SELinux prints warnings instead of enforcing.</span><br><span class="line">#     disabled - No SELinux policy is loaded.</span><br><span class="line">SELINUX=disabled</span><br><span class="line"># SELINUXTYPE= can take one of three values:</span><br><span class="line">#     targeted - Targeted processes are protected,</span><br><span class="line">#     minimum - Modification of targeted policy. Only selected processes are protected.</span><br><span class="line">#     mls - Multi Level Security protection.</span><br><span class="line">#SELINUXTYPE=targeted</span><br><span class="line"></span><br><span class="line">systemctl restart httpd</span><br><span class="line">systemctl enable slapd</span><br><span class="line">systemctl enable httpd</span><br><span class="line">netstat -atnulp</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Login to ipaddress/phpldapadmin<br>Ligin DN: cn=Manager,dc=practialjenkins.dc=com<br>Password: </p>
<p>Under ou=groups create a child entry-&gt; Generic: Posix Group<br>3 groups: admins, developers, devops</p>
<p>Under ou=users create Generic: User Account a b c</p>
<p>Under cn=admins Add new attribue mumberUid a<br>same for other groups</p>
<p>Configure Global Security<br><img src="https://i.imgur.com/JM1wDEf.png" alt="ldap config"><br>Group membership filter -&gt; (| (member={0}) (uniqueMember={0}) (memberUid={1}))</p>
<p>Under Authorization choose Role-Based Strategy</p>
<p>Under Manage Jenkins click Mange and Assign Roles -&gt; Manage Role-&gt; Role to add “admins, developers and devops”<br><img src="https://i.imgur.com/l1wUQY3.png" alt="managerole"></p>
<p>Assign Roles-&gt; User/group to add-&gt; admins, developers, and devops<br><img src="https://i.imgur.com/10Cbmz6.png" alt="assignrole"></p>
<p>User different user for login:<br><img src="https://i.imgur.com/R8fVL74.png" alt="login"></p>
<h2 id="Using-the-jenkinss-api-and-automating-plugin-management"><a href="#Using-the-jenkinss-api-and-automating-plugin-management" class="headerlink" title="Using the jenkinss api and automating plugin management"></a>Using the jenkinss api and automating plugin management</h2><p>get API token from ‘People’&gt; admin-&gt; configure-&gt;API Token</p>
<p>Automatically tirgger the build by:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -u admin:20fda2a6ed2ff7a8cf9db9dd50a0c2b0 &quot;http://localhost:8080/api/json?pretty=true&quot;</span><br><span class="line">curl -s &apos;http://localhost:8080/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,&quot;:&quot;,//crumb)&apos; -u admin:admin</span><br><span class="line">curl -X POST -u admin:20fda2a6ed2ff7a8cf9db9dd50a0c2b0 &quot;http://localhost:8080/job/python-job/build&quot; -H &quot;Jenkins-Crumb:f40b9f1084de9e60cca87085b30e6159&quot;</span><br></pre></td></tr></table></figure></p>
<p>Jenkins CLI:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget --auth-no-challenge &quot;http://localhost:8080/jnlpJars/jenkins-cli.jar&quot;</span><br><span class="line">java -jar jenkins-cli.jar -auth admin:20fda2a6ed2ff7a8cf9db9dd50a0c2b0 -s http://localhost:8080 help</span><br><span class="line">java -jar jenkins-cli.jar -auth admin:20fda2a6ed2ff7a8cf9db9dd50a0c2b0 -s http://localhost:8080 install-plugin aws-codebuild -deploy</span><br><span class="line">java -jar jenkins-cli.jar -auth admin:20fda2a6ed2ff7a8cf9db9dd50a0c2b0 -s http://localhost:8080 install-plugin http://updates.jenkins-ci.org/latest/ansicolor.hpi -deploy</span><br><span class="line">java -jar jenkins-cli.jar -auth admin:20fda2a6ed2ff7a8cf9db9dd50a0c2b0 -s http://localhost:8080 install-plugin http://updates.jenkins-ci.org/download/plugins/beaker-builder/1.6/beaker-builder.hpi -deploy</span><br></pre></td></tr></table></figure></p>
<h1 id="Integrating-Jenkins-with-external-services"><a href="#Integrating-Jenkins-with-external-services" class="headerlink" title="Integrating Jenkins with external services"></a>Integrating Jenkins with external services</h1><h2 id="Integrating-with-Github"><a href="#Integrating-with-Github" class="headerlink" title="Integrating with Github"></a>Integrating with Github</h2><p><img src="https://i.imgur.com/hkwPMqG.png" alt="workflow"></p>
<ul>
<li>Preparing Github and configuring Jenkins to work together<br>Github-&gt;Setting-&gt;Developer setting-&gt;Personal access tokens-&gt; Genere a new token-&gt; select scopes (repo:all |admin:repo_hook all| admin:org_hook)-&gt;copy token</li>
</ul>
<p>Jenkins-&gt;Add credentials-&gt; Kind username with password |scope global| username szhouchoice| password access token|id jenkins-secret<br>add another credentials-&gt; kind secret test-&gt; secret token|id jenkins-token-&gt;save</p>
<p>Username with password will use for multi-branch pipeline<br>secret text will be use in Global configuration for github server<br><img src="https://i.imgur.com/u4OVbH2.png" alt="github server setting"></p>
<p>Install GitHub Branch Source Plugin</p>
<ul>
<li>Configuring the Pipeline to create a code build workflow<br><a href="https://github.com/practicaljenkins/sample-php-project">project</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git add -A</span><br><span class="line">git commit -m &quot;adding code&quot;</span><br><span class="line">git push origin master</span><br><span class="line">git checkout -b develop</span><br><span class="line">git push orgin develop</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>In Jenkins-&gt; Create new Multibranch Pipeline-&gt;<br><img src="https://i.imgur.com/Tn2maPQ.png" alt="Branch sources setting"></p>
<ul>
<li>Testing the pipelines with different scenarios<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b feature-001</span><br><span class="line">vim src/ConnectTest.php</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>push feature branch to github<br><img src="https://i.imgur.com/JOkzC9O.png" alt="merge in github"><br>will trigger the build in Jenkins</p>
<h2 id="Integrating-with-Sonarqube"><a href="#Integrating-with-Sonarqube" class="headerlink" title="Integrating with Sonarqube"></a>Integrating with Sonarqube</h2><ul>
<li>setting up Sonarqube prerequisites for Jenkins</li>
<li>Install and configure Sonarqube plugin</li>
<li>Configure Jenkins pipeline for Sonarqube action</li>
<li>Generate Sonarqube analysis report from Jenkins pipeline</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Jenkins/">Jenkins</a><a href="/tags/Devops/">Devops</a><a href="/tags/CD-CI/">CD/CI</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/06/19/useful-commands/" title="useful commands" itemprop="url">useful commands</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stan Zhou" target="_blank" itemprop="author">Stan Zhou</a>
		
  <p class="article-time">
    <time datetime="2019-06-19T07:11:17.000Z" itemprop="datePublished"> Published 2019-06-19</time>
    
  </p>
</header>
    <div class="article-content">
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/vsftpd/vsftpd.conf&#123;,.bak&#125;</span><br><span class="line"></span><br><span class="line">[root@agent1 ~]# &gt;/etc/motd #删除文件内容</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@puppetmaster ~]# mv /etc/puppet/autosign.conf&#123;,.bak&#125;   #删除自动注册ACL列表</span><br><span class="line"></span><br><span class="line">[root@linux-node1 /]# grep &apos;^[a-z]&apos; /etc/elasticsearch/elasticsearch.yml</span><br><span class="line"></span><br><span class="line">sudo tar xfz pycharm-*.tar.gz -C /opt/</span><br><span class="line"></span><br><span class="line">nohup &amp; screen</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># send a command to be executed on the remote machine and send back the output:</span><br><span class="line">ssh -t user1@server1.packt.co.uk cat /etc/hosts</span><br><span class="line"></span><br><span class="line">#use SSH to send files between two machines to or from a remote machine, using the scp command:</span><br><span class="line">scp user1@server1.packt.co.uk:/home/user1/Desktop/file1.txt  ./Desktop/</span><br><span class="line"></span><br><span class="line">ssh key-based authentication</span><br><span class="line">ssh-keygen -t rsa -b 2048 -v</span><br><span class="line">ssh-copy-id user1@server1.packt.co.uk</span><br><span class="line"></span><br><span class="line">[root@ip-172-31-5-191 ~]# cat /tmp/passwd-truncated</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line">adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br><span class="line">lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span><br><span class="line">[root@ip-172-31-5-191 ~]# cut -d: -f2,3 /tmp/passwd-truncated</span><br><span class="line">x:0</span><br><span class="line">x:1</span><br><span class="line">x:2</span><br><span class="line">x:3</span><br><span class="line">x:4</span><br><span class="line">[root@ip-172-31-5-191 ~]# cut -d: -f2,3 --output-delimiter &quot; &quot; /tmp/passwd-truncated</span><br><span class="line">x 0</span><br><span class="line">x 1</span><br><span class="line">x 2</span><br><span class="line">x 3</span><br><span class="line">x 4</span><br><span class="line">[root@ip-172-31-5-191 ~]# egrep -v &apos;#|^$&apos; /etc/services |head -5 &gt; /tmp/services-truncated</span><br><span class="line">[root@ip-172-31-5-191 ~]# cat /tmp/services-truncated</span><br><span class="line">echo            7/tcp</span><br><span class="line">echo            7/udp</span><br><span class="line">discard         9/tcp           sink null</span><br><span class="line">discard         9/udp           sink null</span><br><span class="line">systat          11/tcp          users</span><br><span class="line">[root@ip-172-31-5-191 ~]# sed  &apos;s/ /*/g&apos; /tmp/services-truncated</span><br><span class="line">echo************7/tcp</span><br><span class="line">echo************7/udp</span><br><span class="line">discard*********9/tcp***********sink*null</span><br><span class="line">discard*********9/udp***********sink*null</span><br><span class="line">systat**********11/tcp**********users</span><br><span class="line">[root@ip-172-31-5-191 ~]# awk -F&apos; &apos; &apos;&#123;print $2&quot; &quot;$3&#125;&apos; /tmp/services-truncated</span><br><span class="line">7/tcp</span><br><span class="line">7/udp</span><br><span class="line">9/tcp sink</span><br><span class="line">9/udp sink</span><br><span class="line">11/tcp users</span><br><span class="line">[root@ip-172-31-5-191 ~]# # tr [CHARACTER_FROM] [CHARACTER_TO]</span><br><span class="line">[root@ip-172-31-5-191 ~]# cat /tmp/services-truncated |tr &apos;a&apos; &apos;X&apos;</span><br><span class="line">echo            7/tcp</span><br><span class="line">echo            7/udp</span><br><span class="line">discXrd         9/tcp           sink null</span><br><span class="line">discXrd         9/udp           sink null</span><br><span class="line">systXt          11/tcp          users</span><br><span class="line">[root@ip-172-31-5-191 ~]# cat /tmp/services-truncated |tr &apos;[a-z]&apos; &apos;[A-Z]&apos;</span><br><span class="line">ECHO            7/TCP</span><br><span class="line">ECHO            7/UDP</span><br><span class="line">DISCARD         9/TCP           SINK NULL</span><br><span class="line">DISCARD         9/UDP           SINK NULL</span><br><span class="line">SYSTAT          11/TCP          USERS</span><br><span class="line">[root@ip-172-31-5-191 ~]# awk -F &apos; &apos; &apos;&#123;print $1&#125;&apos; /etc/services |egrep -v &apos;^#|^$&apos;| sort| uniq -c| sort -n -k1,1 -r|head</span><br><span class="line">      4 exp2</span><br><span class="line">      4 exp1</span><br><span class="line">      4 discard</span><br><span class="line">      3 v5ua</span><br><span class="line">      3 syslog-tls</span><br><span class="line">      3 sua</span><br><span class="line">      3 ssh</span><br><span class="line">      3 nfsrdma</span><br><span class="line">      3 nfs</span><br><span class="line">      3 megaco-h248</span><br><span class="line"></span><br><span class="line">[root@ip-172-31-5-191 ~]# cp /etc/services /tmp/services</span><br><span class="line">[root@ip-172-31-5-191 ~]# gzip /tmp/services</span><br><span class="line">[root@ip-172-31-5-191 ~]# ls -lh /etc/services /tmp/services.gz</span><br><span class="line">-rw-r--r--. 1 root root 655K Jun  7  2013 /etc/services</span><br><span class="line">-rw-r--r--. 1 root root 133K Jun 19 06:01 /tmp/services.gz</span><br><span class="line">[root@ip-172-31-5-191 ~]# gunzip /tmp/services.gz</span><br><span class="line"></span><br><span class="line">[root@ip-172-31-5-191 ~]# tar zcf /tmp/archive.tar.gz /home/centos</span><br><span class="line">tar: Removing leading `/&apos; from member names</span><br><span class="line">[root@ip-172-31-5-191 ~]# mkdir /tmp/extracted</span><br><span class="line">[root@ip-172-31-5-191 ~]# tar xvf /tmp/archive.tar.gz -C /tmp/extracted</span><br><span class="line">home/centos/</span><br><span class="line">home/centos/.bash_logout</span><br><span class="line">home/centos/.bash_profile</span><br><span class="line">home/centos/.bashrc</span><br><span class="line">home/centos/.ssh/</span><br><span class="line">home/centos/.ssh/authorized_keys</span><br><span class="line">home/centos/.bash_history</span><br><span class="line">[root@ip-172-31-5-191 ~]# cat /proc/meminfo</span><br><span class="line">MemTotal:        3878872 kB</span><br><span class="line">MemFree:         2586524 kB</span><br><span class="line"></span><br><span class="line">[root@ip-172-31-5-191 ~]# free -mh</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           3.7G        716M        2.5G         16M        546M        2.7G</span><br><span class="line">Swap:            0B          0B          0B</span><br><span class="line">[root@ip-172-31-5-191 ~]# df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/xvda1       60G  2.2G   58G   4% /</span><br><span class="line">devtmpfs        1.9G     0  1.9G   0% /dev</span><br><span class="line">tmpfs           1.9G     0  1.9G   0% /dev/shm</span><br><span class="line">tmpfs           1.9G   17M  1.9G   1% /run</span><br><span class="line">tmpfs           1.9G     0  1.9G   0% /sys/fs/cgroup</span><br><span class="line">tmpfs           379M     0  379M   0% /run/user/1000</span><br><span class="line">[root@ip-172-31-5-191 ~]# du -h</span><br><span class="line">4.0K	./.ssh</span><br><span class="line">0	./.pki/nssdb</span><br><span class="line">0	./.pki</span><br><span class="line">52K	.</span><br><span class="line">[root@ip-172-31-5-191 ~]# du -h / --max-depth=1</span><br><span class="line">0	/dev</span><br><span class="line">du: cannot access ‘/proc/14331/task/14331/fd/3’: No such file or directory</span><br><span class="line">du: cannot access ‘/proc/14331/task/14331/fdinfo/3’: No such file or directory</span><br><span class="line">du: cannot access ‘/proc/14331/fd/4’: No such file or directory</span><br><span class="line">du: cannot access ‘/proc/14331/fdinfo/4’: No such file or directory</span><br><span class="line">0	/proc</span><br><span class="line">17M	/run</span><br><span class="line">0	/sys</span><br><span class="line">35M	/etc</span><br><span class="line">52K	/root</span><br><span class="line">641M	/var</span><br><span class="line">4.5M	/tmp</span><br><span class="line">1.3G	/usr</span><br><span class="line">183M	/boot</span><br><span class="line">76K	/home</span><br><span class="line">0	/media</span><br><span class="line">0	/mnt</span><br><span class="line">0	/opt</span><br><span class="line">0	/srv</span><br><span class="line">2.2G	/</span><br><span class="line">root@ip-172-31-5-191 ~]# dd if=/dev/zero of=/tmp/lgig_file.empty bs=1M count=1024</span><br><span class="line">1024+0 records in</span><br><span class="line">1024+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB) copied, 3.61028 s, 297 MB/s</span><br><span class="line">$ su -c &apos;dd if=/dev/sda1 of=/tmp/img.image&apos;</span><br><span class="line">[root@ip-172-31-5-191 ~]# dd if=/home/centos/.bashrc of=/tmp/.bashrc-copy</span><br><span class="line">0+1 records in</span><br><span class="line">0+1 records out</span><br><span class="line">231 bytes (231 B) copied, 0.000164855 s, 1.4 MB/s</span><br><span class="line">[root@ip-172-31-5-191 ~]# rsync -rav /home/centos/ /tmp/new-centos-home</span><br><span class="line">sending incremental file list</span><br><span class="line">created directory /tmp/new-centos-home</span><br><span class="line">./</span><br><span class="line">.bash_history</span><br><span class="line">.bash_logout</span><br><span class="line">.bash_profile</span><br><span class="line">.bashrc</span><br><span class="line">.ssh/</span><br><span class="line">.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">sent 1,280 bytes  received 169 bytes  2,898.00 bytes/sec</span><br><span class="line">total size is 843  speedup is 0.58</span><br><span class="line"></span><br><span class="line"># rsync -rav /home/centos/ stan@192.168.178.300:/tmp</span><br><span class="line"># rsync -rav stan@192.168.178.300:/tmp/stan /tmp/another-copy</span><br><span class="line"></span><br><span class="line">[root@ip-172-31-5-191 ~]# telnet google.com 80</span><br><span class="line">Trying 216.58.200.110...</span><br><span class="line">Connected to google.com.</span><br><span class="line">Escape character is &apos;^]&apos;.</span><br><span class="line">^]</span><br><span class="line">HTTP/1.0 400 Bad Request</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Referrer-Policy: no-referrer</span><br><span class="line">Content-Length: 1555</span><br><span class="line">Date: Wed, 19 Jun 2019 06:30:24 GMT</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=en&gt;</span><br><span class="line">  &lt;meta charset=utf-8&gt;</span><br><span class="line">  &lt;meta name=viewport content=&quot;initial-scale=1, minimum-scale=1, width=device-width&quot;&gt;</span><br><span class="line">  &lt;title&gt;Error 400 (Bad Request)!!1&lt;/title&gt;</span><br><span class="line">  &lt;style&gt;</span><br><span class="line">    *&#123;margin:0;padding:0&#125;html,code&#123;font:15px/22px arial,sans-serif&#125;html&#123;background:#fff;color:#222;padding:15px&#125;body&#123;margin:7% auto 0;max-width:390px;min-height:180px;padding:30px 0 15px&#125;* &gt; body&#123;background:url(//www.google.com/images/errors/robot.png) 100% 5px no-repeat;padding-right:205px&#125;p&#123;margin:11px 0 22px;overflow:hidden&#125;ins&#123;color:#777;text-decoration:none&#125;a img&#123;border:0&#125;@media screen and (max-width:772px)&#123;body&#123;background:none;margin-top:0;max-width:none;padding-right:0&#125;&#125;#logo&#123;background:url(//www.google.com/images/branding/googlelogo/1x/googlelogo_color_150x54dp.png) no-repeat;margin-left:-5px&#125;@media only screen and (min-resolution:192dpi)&#123;#logo&#123;background:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) no-repeat 0% 0%/100% 100%;-moz-border-image:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) 0&#125;&#125;@media only screen and (-webkit-min-device-pixel-ratio:2)&#123;#logo&#123;background:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) no-repeat;-webkit-background-size:100% 100%&#125;&#125;#logo&#123;display:inline-block;height:54px;width:150px&#125;</span><br><span class="line">  &lt;/style&gt;</span><br><span class="line">  &lt;a href=//www.google.com/&gt;&lt;span id=logo aria-label=Google&gt;&lt;/span&gt;&lt;/a&gt;</span><br><span class="line">  &lt;p&gt;&lt;b&gt;400.&lt;/b&gt; &lt;ins&gt;That’s an error.&lt;/ins&gt;</span><br><span class="line">  &lt;p&gt;Your client has issued a malformed or illegal request.  &lt;ins&gt;That’s all we know.&lt;/ins&gt;</span><br><span class="line">Connection closed by foreign host.</span><br><span class="line"></span><br><span class="line">[root@ip-172-31-5-191 ~]# wget -O /tmp/output.txt http://whatthecommit.com/index.txt</span><br><span class="line">--2019-06-19 06:32:13--  http://whatthecommit.com/index.txt</span><br><span class="line">Resolving whatthecommit.com (whatthecommit.com)... 52.86.186.182, 52.200.233.201, 52.202.60.111, ...</span><br><span class="line">Connecting to whatthecommit.com (whatthecommit.com)|52.86.186.182|:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 14 [text/plain]</span><br><span class="line">Saving to: ‘/tmp/output.txt’</span><br><span class="line"></span><br><span class="line">100%[=============================================================&gt;] 14          --.-K/s   in 0s</span><br><span class="line"></span><br><span class="line">2019-06-19 06:32:13 (1.88 MB/s) - ‘/tmp/output.txt’ saved [14/14]</span><br><span class="line"></span><br><span class="line">[root@ip-172-31-5-191 ~]# cat /tmp/output.txt</span><br><span class="line">Popping stash</span><br><span class="line">[root@ip-172-31-5-191 ~]# wget -qO- http://whatthecommit.com/index.txt</span><br><span class="line">clarify further the brokenness of C++. why the fuck are we using C++?</span><br><span class="line"></span><br><span class="line">root@stan-OptiPlex-380:~|⇒  nc -l -p 9999 &lt; /etc/lsb-release</span><br><span class="line">stan-OptiPlex-380% nc 192.168.199.178 9999 &gt; /tmp/redhat-release</span><br><span class="line">^C</span><br><span class="line">stan-OptiPlex-380% cat /tmp/redhat-release</span><br><span class="line">DISTRIB_ID=LinuxMint</span><br><span class="line">DISTRIB_RELEASE=19</span><br><span class="line">DISTRIB_CODENAME=tara</span><br><span class="line">DISTRIB_DESCRIPTION=&quot;Linux Mint 19 Tara&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># links www.duckduckgo.com</span><br><span class="line"></span><br><span class="line">[root@ip-172-31-5-191 ~]# echo &apos;(8-(3+1))/4&apos; |bc</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">[root@ip-172-31-5-191 ~]# screen</span><br><span class="line"></span><br><span class="line">Ctrl + A + D</span><br><span class="line"></span><br><span class="line">[detached from 17091.pts-0.ip-172-31-5-191]</span><br><span class="line">[root@ip-172-31-5-191 ~]# exit</span><br><span class="line">logout</span><br><span class="line">[centos@ip-172-31-5-191 ~]$ exit</span><br><span class="line">logout</span><br><span class="line">Connection to 54.66.232.147 closed.</span><br><span class="line"></span><br><span class="line">ssh cicd</span><br><span class="line">Last login: Wed Jun 19 05:39:48 2019 from 220.240.212.9</span><br><span class="line">[centos@ip-172-31-5-191 ~]$ sudo -i</span><br><span class="line">[root@ip-172-31-5-191 ~]# screen -list</span><br><span class="line">There is a screen on:</span><br><span class="line">	17091.pts-0.ip-172-31-5-191	(Detached)</span><br><span class="line">1 Socket in /var/run/screen/S-root.</span><br><span class="line"></span><br><span class="line">[root@ip-172-31-5-191 ~]# screen -r 17091.pts-0.ip-172-31-5-191</span><br><span class="line"></span><br><span class="line">Type exit for quit</span><br><span class="line">[screen is terminating]</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="various-top-like-programs"><a href="#various-top-like-programs" class="headerlink" title="various top-like programs"></a>various top-like programs</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iotop ## Get a live view on the input and output, or short I/O, bandwidth usage of your system</span><br><span class="line"></span><br><span class="line">iftop ## which gets a live view on network traffic and network bandwidth usage and monitor</span><br><span class="line"></span><br><span class="line">htop ## improved version of the normal top program</span><br><span class="line">lsof | grep lib64 ## To print out a list of all open files, which means programs accessing files at the moment</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Largest-files-and-directories-report"><a href="#Largest-files-and-directories-report" class="headerlink" title="Largest files and directories report"></a>Largest files and directories report</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">FS=&apos;./&apos;;resize;clear;echo &quot;== Server Time: ==&quot;;date;echo -e &quot;\n== Filesystem Information: ==&quot;;df -PTh $&#123;FS&#125; | column -t;echo -e &quot;\n== Inode Information: ==&quot;;df -PTi $&#123;FS&#125; | column -t;echo -e &quot;\n== Largest Directories: ==&quot;;du -hcx --max-depth=2 $&#123;FS&#125; 2&gt;/dev/null | grep -P &apos;^([0-9]\.*)*G(?!.*(\btotal\b|\./$))&apos; | sort -rnk1,1 | head -10 | column -t;echo -e &quot;\n== Largest Files: ==&quot;;find $&#123;FS&#125; -mount -ignore_readdir_race -type f -exec du &#123;&#125; + 2&gt;&amp;1 | sort -rnk1,1 | head -20 | awk &apos;BEGIN&#123; CONVFMT=&quot;%.2f&quot;;&#125;&#123; $1=( $1 / 1024 )&quot;M&quot;; print;&#125;&apos; | column -t;echo -e &quot;\n== Largest Files Older Than 30 Days: ==&quot;;find $&#123;FS&#125; -mount -ignore_readdir_race -type f -mtime +30 -exec du &#123;&#125; + 2&gt;&amp;1 | sort -rnk1,1 | head -20 | awk &apos;BEGIN&#123; CONVFMT=&quot;%.2f&quot;;&#125;&#123; $1=( $1 / 1024 )&quot;M&quot;; print; &#125;&apos; | column -t;</span><br><span class="line"></span><br><span class="line">== Server Time: ==</span><br><span class="line">Thu Jun 20 04:57:53 UTC 2019</span><br><span class="line"></span><br><span class="line">== Filesystem Information: ==</span><br><span class="line">Filesystem  Type  Size  Used  Avail  Use%  Mounted  on</span><br><span class="line">/dev/xvda1  xfs   60G   3.9G  57G    7%    /</span><br><span class="line"></span><br><span class="line">== Inode Information: ==</span><br><span class="line">Filesystem  Type  Inodes    IUsed  IFree     IUse%  Mounted  on</span><br><span class="line">/dev/xvda1  xfs   31456704  62835  31393869  1%     /</span><br><span class="line"></span><br><span class="line">== Largest Directories: ==</span><br><span class="line"></span><br><span class="line">== Largest Files: ==</span><br><span class="line">0.00M  ./.ssh/authorized_keys</span><br><span class="line">0.00M  ./.lesshst</span><br><span class="line">0.00M  ./.bashrc</span><br><span class="line">0.00M  ./.bash_profile</span><br><span class="line">0.00M  ./.bash_logout</span><br><span class="line">0.00M  ./.bash_history</span><br><span class="line">0M     ./stuff/5.txt</span><br><span class="line">0M     ./stuff/4.txt</span><br><span class="line">0M     ./stuff/3.txt</span><br><span class="line">0M     ./stuff/2.txt</span><br><span class="line">0M     ./stuff/1.txt</span><br><span class="line"></span><br><span class="line">== Largest Files Older Than 30 Days: ==</span><br><span class="line">0.00M  ./.bashrc</span><br><span class="line">0.00M  ./.bash_profile</span><br><span class="line">0.00M  ./.bash_logout</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="check-the-port-is-open-or-not"><a href="#check-the-port-is-open-or-not" class="headerlink" title="check the port is open or not"></a>check the port is open or not</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -vv -n -sS -sU -p443 52.62.248.48/32 | grep &quot;Discovered open port&quot; |awk &#123;&apos;print $6&apos;&#125; | awk -F/ &#123;&apos;print$1&apos;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="AWS-cli-commands"><a href="#AWS-cli-commands" class="headerlink" title="AWS cli commands"></a>AWS cli commands</h2><p>List all the ec2 instances details:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 describe-instances --output text --query &apos;Reservations[*].Instances[*].[InstanceId, InstanceType, ImageId, State.Name, LaunchTime, Placement.AvailabilityZone, Placement.Tenancy, PrivateIpAddress, PrivateDnsName, PublicDnsName, [Tags[?Key==`Name`].Value] [0][0], [Tags[?Key==`purpose`].Value] [0][0], [Tags[?Key==`environment`].Value] [0][0], [Tags[?Key==`team`].Value] [0][0] ]&apos;&#125;`</span><br></pre></td></tr></table></figure></p>
<hr>
<p><strong>List server files information</strong><br><code>FS=&#39;./&#39;;resize;clear;echo &quot;== Server Time: ==&quot;;date;echo -e &quot;\n== Filesystem Information: ==&quot;;df -PTh ${FS} | column -t;echo -e &quot;\n== Inode Information: ==&quot;;df -PTi ${FS} | column -t;echo -e &quot;\n== Largest Directories: ==&quot;;du -hcx --max-depth=2 ${FS} 2&gt;/dev/null | grep -P &#39;^([0-9]\.*)*G(?!.*(\btotal\b|\./$))&#39; | sort -rnk1,1 | head -10 | column -t;echo -e &quot;\n== Largest Files: ==&quot;;find ${FS} -mount -ignore_readdir_race -type f -exec du {} + 2&gt;&amp;1 | sort -rnk1,1 | head -20 | awk &#39;BEGIN{ CONVFMT=&quot;%.2f&quot;;}{ $1=( $1 / 1024 )&quot;M&quot;; print;}&#39; | column -t;echo -e &quot;\n== Largest Files Older Than 30 Days: ==&quot;;find ${FS} -mount -ignore_readdir_race -type f -mtime +30 -exec du {} + 2&gt;&amp;1 | sort -rnk1,1 | head -20 | awk &#39;BEGIN{ CONVFMT=&quot;%.2f&quot;;}{ $1=( $1 / 1024 )&quot;M&quot;; print; }&#39; | column -t;</code></p>
<hr>
<h1 id="about-file"><a href="#about-file" class="headerlink" title="about file"></a>about file</h1><p><strong>Change the extension of multiple files</strong></p>
<h2 id="add-an-extension-for-the-source-files"><a href="#add-an-extension-for-the-source-files" class="headerlink" title="add an extension for the source files"></a>add an extension for the source files</h2><p><code>for f in *; do mv -- &quot;$f&quot; &quot;${f%.\*}.pdf&quot;;done</code></p>
<h2 id="find-the-file-size"><a href="#find-the-file-size" class="headerlink" title="find the file size"></a>find the file size</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@stan-OptiPlex-380:~|⇒  du -sh /*</span><br><span class="line">17M     /bin</span><br><span class="line">77M     /boot</span><br><span class="line">4.0K    /cdrom</span><br><span class="line">0       /dev</span><br><span class="line">17M     /etc</span><br><span class="line">1.6G    /home</span><br><span class="line">0       /initrd.img</span><br><span class="line">0       /initrd.img.old</span><br><span class="line">582M    /lib</span><br><span class="line">4.0K    /lib64</span><br><span class="line">16K     /lost+found</span><br><span class="line">4.0K    /media</span><br></pre></td></tr></table></figure>
<p><strong>about node process</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat startApp.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">export NODE_ENV=production</span><br><span class="line">export DB_PRD_HOST=stantest-postgresql.c3mzoji03zxf.ap-southeast-2.rds.amazonaws.com</span><br><span class="line">export DB_PRD_USER=stantest</span><br><span class="line">export NODE_HOST=localhost</span><br><span class="line">export NODE_PORT=8080</span><br><span class="line">node /myapp/index.js&amp;</span><br><span class="line">exit 0</span><br><span class="line">cat stopApp.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">kill `ps -axf |grep node |grep -v grep|awk &apos;&#123;print $1&#125;&apos;` | exit 0</span><br></pre></td></tr></table></figure></p>
<p>pgrep: pgrep, pkill - look up or signal processes based on name and other attributes</p>
<hr>
<h1 id="python"><a href="#python" class="headerlink" title="python"></a>python</h1><p>create a random password:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stan@dockerfordevops:~/Projects/MobyDock$ python</span><br><span class="line">Python 2.7.12 (default, Nov 12 2018, 14:36:49) </span><br><span class="line">[GCC 5.4.0 20160609] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">&gt;&gt;&gt; import binascii</span><br><span class="line">&gt;&gt;&gt; binascii.b2a_hex(os.urandom(31))</span><br></pre></td></tr></table></figure></p>
<h1 id="postgres"><a href="#postgres" class="headerlink" title="postgres"></a>postgres</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubernetes-release-1.5 psql -h database -U postgres</span><br><span class="line">psql (11.4 (Ubuntu 11.4-1.pgdg18.04+1), server 9.4.23)</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres-# \dd</span><br><span class="line">         Object descriptions</span><br><span class="line"> Schema | Name | Object | Description</span><br><span class="line">--------+------+--------+-------------</span><br><span class="line">(0 rows)</span><br></pre></td></tr></table></figure>
<p>$ mkdir vagrant_ubuntu_xenial_1 &amp;&amp; cd $_</p>
<p>wget <a href="https://raw.githubusercontent.com/yogeshraheja/Effective-DevOps-with-AWS/master/Chapter02/helloworld.conf">https://raw.githubusercontent.com/yogeshraheja/Effective-DevOps-with-AWS/master/Chapter02/helloworld.conf</a> -O scripts/helloworld.conf</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/linux/">linux</a><a href="/tags/commands/">commands</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/06/04/k8s/" title="k8s" itemprop="url">k8s</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stan Zhou" target="_blank" itemprop="author">Stan Zhou</a>
		
  <p class="article-time">
    <time datetime="2019-06-04T01:37:00.000Z" itemprop="datePublished"> Published 2019-06-04</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="K8S"><a href="#K8S" class="headerlink" title="K8S"></a>K8S</h1><p>Big example is google</p>
<p>orchestration (computing)<br>automcatic management of them</p>
<p>manifests system robust </p>
<p>common question why use k8s instead of docker swarm</p>
<p>number 1 ad: docker swarm is built in<br>K8S: far richer, deploy do different cloud platforms<br>K8S is just far more popular<br>is a orchestration of choice.<br>K8S is the most in demand container orchestration system out there.</p>
<p>A Java-based with angular on the front-end.</p>
<h1 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h1><ul>
<li>Cluster: A group of physical or virtual machines</li>
<li>Node: Ap hysical or virtual machine that is part of a cluster</li>
<li>Control Plane: The set of processes that run the core k8s services (e.g. APi, scheduler, etcd …)</li>
<li>Pod: The lowest compute unit in Kubernetes, a group of containers that run on a Node.</li>
</ul>
<h1 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h1><p><strong>Head Node</strong><br>That’s the brain of Kubernetes</p>
<ul>
<li>API server</li>
<li>Scheduler: to place the containers where they need to go</li>
<li>Controller manager: makes sure that the state of the system is what it should be</li>
<li>Etcd: data store, used to store the state of the system</li>
<li>Sometimes:<ul>
<li>kubelet: a process manage all of this</li>
<li>docker: container engine<br><strong>Worker node</strong></li>
</ul>
</li>
<li>kubelet<br>That’s the Kubernetes agent that runs on all the Kubernetes cluster nodes. Kubelet talks with the Kubernetes API server and then talks to the local Docker daemon to be able to manage the Docker containers running on the node.</li>
<li>kube-proxy: a system that allos you to manage the IP tables in that node so that the traffic between the pods and the nodes is what it should be</li>
<li>docker<h1 id="Installing-k8s-in-3-easy-ways"><a href="#Installing-k8s-in-3-easy-ways" class="headerlink" title="Installing k8s in 3 easy ways"></a>Installing k8s in 3 easy ways</h1></li>
<li>minikube</li>
<li>gcloud container clusters</li>
<li>kubeadm<h1 id="Installing-Minikube"><a href="#Installing-Minikube" class="headerlink" title="Installing Minikube"></a>Installing Minikube</h1>cut-down version-minikube<br><a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">https://kubernetes.io/docs/tasks/tools/install-minikube/</a></li>
</ul>
<p>You might have an incompatibility between your distribution and the one that Minikube is expecting.<br>two command line tools: kubectl is the controller pogramme for k8s. and Minikube</p>
<p>Enable the Hyper-V role throught settings<br>when enable don’t use oracle virtual box</p>
<p>goo.gl/4yEFbF    for win 10 Professional</p>
<p>minikube start hangs forever on mac #2765</p>
<p>If you’re completely stuck then do ask me</p>
<h1 id="Docker-Overview"><a href="#Docker-Overview" class="headerlink" title="Docker Overview"></a>Docker Overview</h1><p>Difference between Docker Images and Container:<br>A container is an instance of docker images.<br>Docker container is the run time instance of images.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker image pull richardchesterwood/k8s-fleetman-webapp-angular:release0-5</span><br><span class="line">docker image ls</span><br><span class="line">docker container run -p 8080:80 -d richardchesterwood/k8s-fleetman-webapp-angular:release0-5</span><br><span class="line">docker container ls</span><br><span class="line">minikube ip</span><br><span class="line">docker container stop 2c5</span><br><span class="line">docker container rm 2c5</span><br></pre></td></tr></table></figure></p>
<h1 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h1><p>A pod is a group of one or more containers, with shared storage/network, and a specification for how to run the containers.</p>
<p>basic concept is Pod. A pod and a container are in a one to one relationship.</p>
<h2 id="writing-a-Pod"><a href="#writing-a-Pod" class="headerlink" title="writing a Pod"></a>writing a Pod</h2><p><code>kubectl get all</code> show everything we have defined in our Kubernetes cluster.</p>
<p><code>kubectl apply -f first-pod.yaml</code></p>
<p><code>kubectl describe pod webapp</code></p>
<p><code>kubectl exec webapp ls</code></p>
<p><code>kubectl -it exec webapp sh</code> it means get in interactively with teletype emulation. interactive</p>
<h2 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h2><p>Pods are not visible outside the cluster<br>Pods are designed to be very throw away things. Pods have short lifetimes. Pods regularly die.</p>
<p>Service has stable port, with a service we can connect to kubernetes cluster.</p>
<p>key vaule pairs app with some value.</p>
<p><img src="https://i.imgur.com/Vv0KFxA.png" alt="Services"></p>
<h2 id="NodePort-and-ClusterIP"><a href="#NodePort-and-ClusterIP" class="headerlink" title="NodePort and ClusterIP"></a>NodePort and ClusterIP</h2><p>ClusterIP</p>
<p>NodePort</p>
<h2 id="Pod-selection-with-Labels"><a href="#Pod-selection-with-Labels" class="headerlink" title="Pod selection with Labels"></a>Pod selection with Labels</h2><p><img src="https://i.imgur.com/nEb2kOH.png" alt="Pod secltion with Labels"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat first-pod.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp</span><br><span class="line">  labels:</span><br><span class="line">    app: webapp</span><br><span class="line">    release: &quot;0&quot;</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: webapp</span><br><span class="line">    image: richardchesterwood/k8s-fleetman-webapp-angular:release0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp-release-0-5</span><br><span class="line">  labels:</span><br><span class="line">    app: webapp</span><br><span class="line">    release: &quot;0-5&quot;</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: webapp</span><br><span class="line">    image: richardchesterwood/k8s-fleetman-webapp-angular:release0-5</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat webapp-service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-webapp</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: webapp</span><br><span class="line">   release: &quot;0-5&quot;</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 80</span><br><span class="line">     nodePort: 30080</span><br><span class="line"></span><br><span class="line"> type: NodePort</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f webapp-service.yaml</span><br><span class="line"></span><br><span class="line">kubectl describe svc fleetman-webapp</span><br><span class="line">Name:                     fleetman-webapp</span><br><span class="line">Namespace:                default</span><br><span class="line">Labels:                   &lt;none&gt;</span><br><span class="line">Annotations:              kubectl.kubernetes.io/last-applied-configuration=&#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Service&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;fleetman-webapp&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;ports&quot;:[&#123;&quot;name&quot;:&quot;http&quot;,&quot;nodeP...</span><br><span class="line">Selector:                 app=webapp,release=0</span><br><span class="line">Type:                     NodePort</span><br><span class="line">IP:                       10.108.217.186</span><br><span class="line">Port:                     http  80/TCP</span><br><span class="line">TargetPort:               80/TCP</span><br><span class="line">NodePort:                 http  30080/TCP</span><br><span class="line">Endpoints:                172.17.0.5:80</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br><span class="line"></span><br><span class="line">kubectl get po</span><br><span class="line">NAME                 READY     STATUS    RESTARTS   AGE</span><br><span class="line">webapp               1/1       Running   2          2h</span><br><span class="line">webapp-release-0-5   1/1       Running   0          8m</span><br><span class="line"></span><br><span class="line">kubectl get po --show-labels</span><br><span class="line">NAME                 READY     STATUS    RESTARTS   AGE       LABELS</span><br><span class="line">webapp               1/1       Running   2          2h        app=webapp,release=0</span><br><span class="line">webapp-release-0-5   1/1       Running   0          8m        app=webapp,release=0-5</span><br><span class="line"></span><br><span class="line">kubectl get po --show-labels -l release=0</span><br><span class="line">NAME      READY     STATUS    RESTARTS   AGE       LABELS</span><br><span class="line">webapp    1/1       Running   2          2h        app=webapp,release=0</span><br><span class="line"></span><br><span class="line">kubectl get po --show-labels -l release=1</span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure>
<h1 id="REPLICASETS"><a href="#REPLICASETS" class="headerlink" title="REPLICASETS"></a>REPLICASETS</h1><h2 id="ReplicaSets"><a href="#ReplicaSets" class="headerlink" title="ReplicaSets"></a>ReplicaSets</h2><p><img src="https://i.imgur.com/iUSOtXN.png" alt="ReplicaSets"><br>When Pod die, it will never come back.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all</span><br><span class="line"></span><br><span class="line">kubectl describe svc fleetman-webapp</span><br><span class="line"></span><br><span class="line">kubectl delete po webapp-release-0-5</span><br></pre></td></tr></table></figure>
<p>ReplicaSets specify how many instances of this pod do we want k8s running on time</p>
<h2 id="Writing-a-ReplicaSet"><a href="#Writing-a-ReplicaSet" class="headerlink" title="Writing a ReplicaSet"></a>Writing a ReplicaSet</h2><p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/#replicaset-v1-apps">ReplicaSet v1 apps</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat pods.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: ReplicaSet</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: webapp</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: webapp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-webapp-angular:release0-5</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: queue</span><br><span class="line">  labels:</span><br><span class="line">    app: queue</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: queue</span><br><span class="line">    image: richardchesterwood/k8s-fleetman-queue:release1</span><br></pre></td></tr></table></figure></p>
<h3 id="Applying-a-ReplicaSet"><a href="#Applying-a-ReplicaSet" class="headerlink" title="Applying a ReplicaSet"></a>Applying a ReplicaSet</h3><p>Delete all the Pods:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete po --all</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pods.yaml</span><br><span class="line">replicaset.apps &quot;webapp&quot; created</span><br><span class="line">pod &quot;queue&quot; created</span><br><span class="line"></span><br><span class="line">kubectl get all</span><br><span class="line">NAME               READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/queue          1/1       Running   0          58s</span><br><span class="line">pod/webapp-hzpcp   1/1       Running   0          58s</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.106.99.143    &lt;none&gt;        8161:30010/TCP   3h</span><br><span class="line">service/fleetman-webapp   NodePort    10.108.217.186   &lt;none&gt;        80:30080/TCP     23h</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          1d</span><br><span class="line"></span><br><span class="line">NAME                     DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/webapp   1         1         1         59s</span><br></pre></td></tr></table></figure>
<p>The difference between current and ready is, current is the number of containers that are running, and ready is the number of containers that are responding to requests.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe rs webapp</span><br><span class="line">Name:         webapp</span><br><span class="line">Namespace:    default</span><br><span class="line">Selector:     app=webapp</span><br><span class="line">Labels:       app=webapp</span><br><span class="line">Annotations:  kubectl.kubernetes.io/last-applied-configuration=&#123;&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;ReplicaSet&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;webapp&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;replicas&quot;:1,&quot;selector&quot;:&#123;&quot;match...</span><br><span class="line">Replicas:     1 current / 1 desired</span><br><span class="line">Pods Status:  1 Running / 0 Waiting / 0 Succeeded / 0 Failed</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=webapp</span><br><span class="line">  Containers:</span><br><span class="line">   webapp:</span><br><span class="line">    Image:        richardchesterwood/k8s-fleetman-webapp-angular:release0-5</span><br><span class="line">    Port:         &lt;none&gt;</span><br><span class="line">    Host Port:    &lt;none&gt;</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason            Age   From                   Message</span><br><span class="line">  ----    ------            ----  ----                   -------</span><br><span class="line">  Normal  SuccessfulCreate  4m    replicaset-controller  Created pod: webapp-hzpcp</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all</span><br><span class="line">NAME               READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/queue          1/1       Running   0          5m</span><br><span class="line">pod/webapp-hzpcp   1/1       Running   0          5m</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.106.99.143    &lt;none&gt;        8161:30010/TCP   3h</span><br><span class="line">service/fleetman-webapp   NodePort    10.108.217.186   &lt;none&gt;        80:30080/TCP     23h</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          1d</span><br><span class="line"></span><br><span class="line">NAME                     DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/webapp   1         1         1         5m</span><br><span class="line"></span><br><span class="line">kubectl delete po webapp-hzpcp</span><br><span class="line">pod &quot;webapp-hzpcp&quot; deleted</span><br><span class="line"></span><br><span class="line">kubectl get all</span><br><span class="line">NAME               READY     STATUS        RESTARTS   AGE</span><br><span class="line">pod/queue          1/1       Running       0          7m</span><br><span class="line">pod/webapp-hff5l   1/1       Running       0          3s</span><br><span class="line">pod/webapp-hzpcp   0/1       Terminating   0          7m</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.106.99.143    &lt;none&gt;        8161:30010/TCP   3h</span><br><span class="line">service/fleetman-webapp   NodePort    10.108.217.186   &lt;none&gt;        80:30080/TCP     23h</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          1d</span><br><span class="line"></span><br><span class="line">NAME                     DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/webapp   1         1         1         7m</span><br></pre></td></tr></table></figure>
<h1 id="Deployments"><a href="#Deployments" class="headerlink" title="Deployments"></a>Deployments</h1><p>It’s a replica set with one additional feature. With a deployment, we get automatic rolling updates with zero downtime.</p>
<p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/#deployment-v1-apps">Deployment API reference guide</a></p>
<p>A deployment as being an entity in Kubernetes that manages the replica set for you.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">cat pods.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: webapp</span><br><span class="line">  replicas: 2</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: webapp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-webapp-angular:release0</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: queue</span><br><span class="line">  labels:</span><br><span class="line">    app: queue</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: queue</span><br><span class="line">    image: richardchesterwood/k8s-fleetman-queue:release1</span><br><span class="line"></span><br><span class="line">kubectl apply -f pods.yaml</span><br><span class="line">deployment.apps &quot;webapp&quot; created</span><br><span class="line">pod &quot;queue&quot; unchanged</span><br><span class="line"></span><br><span class="line">kubectl get all</span><br><span class="line">NAME                          READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/queue                     1/1       Running   0          24m</span><br><span class="line">pod/webapp-7469fb7fd6-4mcth   1/1       Running   0          12s</span><br><span class="line">pod/webapp-7469fb7fd6-sv4rw   1/1       Running   0          12s</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.106.99.143    &lt;none&gt;        8161:30010/TCP   3h</span><br><span class="line">service/fleetman-webapp   NodePort    10.108.217.186   &lt;none&gt;        80:30080/TCP     23h</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          1d</span><br><span class="line"></span><br><span class="line">NAME                     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/webapp   2         2         2            2           12s</span><br><span class="line"></span><br><span class="line">NAME                                DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/webapp-7469fb7fd6   2         2         2         12s</span><br></pre></td></tr></table></figure>
<h2 id="Managing-Rollouts"><a href="#Managing-Rollouts" class="headerlink" title="Managing Rollouts"></a>Managing Rollouts</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout status deploy webapp</span><br><span class="line">deployment &quot;webapp&quot; successfully rolled out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl rollout status deploy webapp</span><br><span class="line">Waiting for rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for rollout to finish: 2 old replicas are pending termination...</span><br><span class="line">Waiting for rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting for rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting for rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">deployment &quot;webapp&quot; successfully rolled out</span><br><span class="line"></span><br><span class="line">kubectl rollout history deploy webapp</span><br><span class="line">deployments &quot;webapp&quot;</span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">2         &lt;none&gt;</span><br><span class="line">3         &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># Default command automatically go back to one version</span><br><span class="line"></span><br><span class="line">kubectl rollout undo deploy</span><br></pre></td></tr></table></figure>
<p>It’s really only for use in an emergency.</p>
<h1 id="Networking-and-service-discovery"><a href="#Networking-and-service-discovery" class="headerlink" title="Networking and service discovery"></a>Networking and service discovery</h1><h2 id="Networking-Overview"><a href="#Networking-Overview" class="headerlink" title="Networking Overview"></a>Networking Overview</h2><p><img src="https://i.imgur.com/G9GkqlS.png" alt="Networking Overview"></p>
<h2 id="Namespace-kube-system"><a href="#Namespace-kube-system" class="headerlink" title="Namespace-kube-system"></a>Namespace-kube-system</h2><p>A namespace is a way of partitioning your resources in Kubernetes into separate areas.</p>
<p><img src="https://i.imgur.com/9FRKlUT.png" alt="namespace"> </p>
<p><img src="https://i.imgur.com/9QF8vkE.png" alt="namespace"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ns</span><br><span class="line">NAME          STATUS    AGE</span><br><span class="line">default       Active    1d</span><br><span class="line">kube-public   Active    1d</span><br><span class="line">kube-system   Active    1d</span><br><span class="line"></span><br><span class="line">kubectl get po</span><br><span class="line">NAME                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">queue                     1/1       Running   0          3h</span><br><span class="line">webapp-7469fb7fd6-sg87f   1/1       Running   0          1h</span><br><span class="line">webapp-7469fb7fd6-znbxx   1/1       Running   0          1h</span><br><span class="line"></span><br><span class="line">kubectl get po -n kube-system</span><br><span class="line">NAME                                    READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns-576cbf47c7-kwq7n                1/1       Running   0          1d</span><br><span class="line">coredns-576cbf47c7-vt56b                1/1       Running   0          1d</span><br><span class="line">etcd-minikube                           1/1       Running   0          1d</span><br><span class="line">kube-addon-manager-minikube             1/1       Running   0          1d</span><br><span class="line">kube-apiserver-minikube                 1/1       Running   0          1d</span><br><span class="line">kube-controller-manager-minikube        1/1       Running   0          1d</span><br><span class="line">kube-proxy-cn982                        1/1       Running   0          1d</span><br><span class="line">kube-scheduler-minikube                 1/1       Running   0          1d</span><br><span class="line">kubernetes-dashboard-5bff5f8fb8-mqz9z   1/1       Running   0          1d</span><br><span class="line">storage-provisioner                     1/1       Running   0          1d</span><br><span class="line"></span><br><span class="line">kubectl get all -n kube-system</span><br><span class="line">NAME                                        READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-576cbf47c7-kwq7n                1/1       Running   0          1d</span><br><span class="line">pod/coredns-576cbf47c7-vt56b                1/1       Running   0          1d</span><br><span class="line">pod/etcd-minikube                           1/1       Running   0          1d</span><br><span class="line">pod/kube-addon-manager-minikube             1/1       Running   0          1d</span><br><span class="line">pod/kube-apiserver-minikube                 1/1       Running   0          1d</span><br><span class="line">pod/kube-controller-manager-minikube        1/1       Running   0          1d</span><br><span class="line">pod/kube-proxy-cn982                        1/1       Running   0          1d</span><br><span class="line">pod/kube-scheduler-minikube                 1/1       Running   0          1d</span><br><span class="line">pod/kubernetes-dashboard-5bff5f8fb8-mqz9z   1/1       Running   0          1d</span><br><span class="line">pod/storage-provisioner                     1/1       Running   0          1d</span><br><span class="line"></span><br><span class="line">NAME                           TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/kube-dns               ClusterIP   10.96.0.10     &lt;none&gt;        53/UDP,53/TCP   1d</span><br><span class="line">service/kubernetes-dashboard   ClusterIP   10.102.124.0   &lt;none&gt;        80/TCP          1d</span><br><span class="line"></span><br><span class="line">NAME                        DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/kube-proxy   1         1         1         1            1           &lt;none&gt;          1d</span><br><span class="line"></span><br><span class="line">NAME                                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/coredns                2         2         2            2           1d</span><br><span class="line">deployment.apps/kubernetes-dashboard   1         1         1            1           1d</span><br><span class="line"></span><br><span class="line">NAME                                              DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/coredns-576cbf47c7                2         2         2         1d</span><br><span class="line">replicaset.apps/kubernetes-dashboard-5bff5f8fb8   1         1         1         1d</span><br><span class="line"></span><br><span class="line">kubectl describe svc kube-dns -n kube-system</span><br><span class="line">Name:              kube-dns</span><br><span class="line">Namespace:         kube-system</span><br><span class="line">Labels:            k8s-app=kube-dns</span><br><span class="line">                   kubernetes.io/cluster-service=true</span><br><span class="line">                   kubernetes.io/name=KubeDNS</span><br><span class="line">Annotations:       prometheus.io/port=9153</span><br><span class="line">                   prometheus.io/scrape=true</span><br><span class="line">Selector:          k8s-app=kube-dns</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.96.0.10</span><br><span class="line">Port:              dns  53/UDP</span><br><span class="line">TargetPort:        53/UDP</span><br><span class="line">Endpoints:         172.17.0.2:53,172.17.0.3:53</span><br><span class="line">Port:              dns-tcp  53/TCP</span><br><span class="line">TargetPort:        53/TCP</span><br><span class="line">Endpoints:         172.17.0.2:53,172.17.0.3:53</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Accessing-MySQL-from-a-Pod"><a href="#Accessing-MySQL-from-a-Pod" class="headerlink" title="Accessing MySQL from a Pod"></a>Accessing MySQL from a Pod</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">cat networking-tests.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql</span><br><span class="line">  labels:</span><br><span class="line">     app: mysql</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">   - name: mysql</span><br><span class="line">     image: mysql:5</span><br><span class="line">     env:</span><br><span class="line">      # Use secret in real life</span><br><span class="line">      - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">        value: password</span><br><span class="line">      - name: MYSQL_DATABASE</span><br><span class="line">        value: fleetman</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: database</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">     app: mysql</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3306</span><br><span class="line">  type: ClusterIP</span><br><span class="line"></span><br><span class="line">kga</span><br><span class="line">NAME                          READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/mysql                     1/1       Running   0          3m</span><br><span class="line">pod/queue                     1/1       Running   0          18h</span><br><span class="line">pod/webapp-7469fb7fd6-sg87f   1/1       Running   0          17h</span><br><span class="line">pod/webapp-7469fb7fd6-znbxx   1/1       Running   0          17h</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/database          ClusterIP   10.101.3.159     &lt;none&gt;        3306/TCP         3m</span><br><span class="line">service/fleetman-queue    NodePort    10.106.99.143    &lt;none&gt;        8161:30010/TCP   21h</span><br><span class="line">service/fleetman-webapp   NodePort    10.108.217.186   &lt;none&gt;        80:30080/TCP     1d</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          1d</span><br><span class="line"></span><br><span class="line">NAME                     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/webapp   2         2         2            2           17h</span><br><span class="line"></span><br><span class="line">NAME                                DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/webapp-7469fb7fd6   2         2         2         17h</span><br><span class="line">replicaset.apps/webapp-74bd9697b4   0         0         0         17h</span><br><span class="line">replicaset.apps/webapp-8f948b66c    0         0         0         17h</span><br><span class="line"></span><br><span class="line">kubectl exec -it webapp-7469fb7fd6-sg87f sh</span><br><span class="line">/ # ls</span><br><span class="line">bin    etc    lib    mnt    root   sbin   sys    usr</span><br><span class="line">dev    home   media  proc   run    srv    tmp    var</span><br></pre></td></tr></table></figure>
<h2 id="Service-Discovery"><a href="#Service-Discovery" class="headerlink" title="Service Discovery"></a>Service Discovery</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">/ # nslookup database</span><br><span class="line">nslookup: can&apos;t resolve &apos;(null)&apos;: Name does not resolve</span><br><span class="line"></span><br><span class="line">Name:      database</span><br><span class="line">Address 1: 10.101.3.159 database.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line">kubectl exec -it webapp-7469fb7fd6-sg87f sh</span><br><span class="line">/ # mysql</span><br><span class="line">sh: mysql: not found</span><br><span class="line">/ # apk update</span><br><span class="line">fetch http://dl-cdn.alpinelinux.org/alpine/v3.7/main/x86_64/APKINDEX.tar.gz</span><br><span class="line">fetch http://dl-cdn.alpinelinux.org/alpine/v3.7/community/x86_64/APKINDEX.tar.gz</span><br><span class="line">v3.7.3-61-gd3d301001c [http://dl-cdn.alpinelinux.org/alpine/v3.7/main]</span><br><span class="line">v3.7.3-51-gf95d10fed7 [http://dl-cdn.alpinelinux.org/alpine/v3.7/community]</span><br><span class="line">OK: 9067 distinct packages available</span><br><span class="line">/ # apk add mysql-client</span><br><span class="line">(1/6) Installing mariadb-common (10.1.38-r1)</span><br><span class="line">(2/6) Installing ncurses-terminfo-base (6.0_p20171125-r1)</span><br><span class="line">(3/6) Installing ncurses-terminfo (6.0_p20171125-r1)</span><br><span class="line">(4/6) Installing ncurses-libs (6.0_p20171125-r1)</span><br><span class="line">(5/6) Installing mariadb-client (10.1.38-r1)</span><br><span class="line">(6/6) Installing mysql-client (10.1.38-r1)</span><br><span class="line">Executing busybox-1.27.2-r7.trigger</span><br><span class="line">OK: 53 MiB in 34 packages</span><br><span class="line"></span><br><span class="line"># mysql -h database -uroot -ppassword fleetman</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.26 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [fleetman]&gt; create table testable (test varchar(255));</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">MySQL [fleetman]&gt; show tables;</span><br><span class="line">+--------------------+</span><br><span class="line">| Tables_in_fleetman |</span><br><span class="line">+--------------------+</span><br><span class="line">| testable           |</span><br><span class="line">+--------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>Can find the ip address of any service that we like just by its name. And that’s called service discovery.</p>
<h2 id="Fully-Qualified-Domain-Names-FQDN"><a href="#Fully-Qualified-Domain-Names-FQDN" class="headerlink" title="Fully Qualified Domain Names (FQDN)"></a>Fully Qualified Domain Names (FQDN)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># nslookup database</span><br><span class="line">nslookup: can&apos;t resolve &apos;(null)&apos;: Name does not resolve</span><br><span class="line"></span><br><span class="line">Name:      database</span><br><span class="line">Address 1: 10.101.3.159 database.default.svc.cluster.local</span><br></pre></td></tr></table></figure>
<h2 id="An-introduction-to-Microservices"><a href="#An-introduction-to-Microservices" class="headerlink" title="An introduction to Microservices"></a>An introduction to Microservices</h2><p>Each microservice should be  Highly Cohesive and Lossely Coupled.</p>
<p>highly cohesive: each microservice should handlng one business requirement. Cohesive means that a microservice should have a single set of reponsibilities.</p>
<p>Each microservice will maintain its own data store. And that microservice will be really the only poart of the system that can read or write that data.</p>
<h2 id="Fleetman-Microservices-setting-the-scene"><a href="#Fleetman-Microservices-setting-the-scene" class="headerlink" title="Fleetman Microservices- setting the scene"></a>Fleetman Microservices- setting the scene</h2><p><img src="https://i.imgur.com/fkwUIA0.png" alt="scene"><br>The logic in the API gateway is typically some kind of a mapping. So it would be something like if the incoming request ends with /vehicles, then delegate the call to,<br>in this case, the position tracker.</p>
<p><a href="https://microservices.io/patterns/apigateway.html">API gateway pattern</a></p>
<h2 id="Deploying-the-Queue"><a href="#Deploying-the-Queue" class="headerlink" title="Deploying the Queue"></a>Deploying the Queue</h2><p><img src="https://i.imgur.com/fkwUIA0.png" alt="scene"></p>
<p>API gateway: a web front end which is implemented in Java script</p>
<p>Position tracker: back end, calcuating the speeds of vehicles and storing the positions of all the vehicles.</p>
<p>Queue: which is going to store the messages that are received from the vehicles as they move around the country.</p>
<p>Positon simulator: a testing microservice which is going to generate some positions of vehicles.</p>
<p>Delete all the Pods:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f .</span><br><span class="line">pod &quot;mysql&quot; deleted</span><br><span class="line">service &quot;database&quot; deleted</span><br><span class="line">deployment.apps &quot;webapp&quot; deleted</span><br><span class="line">pod &quot;queue&quot; deleted</span><br><span class="line">service &quot;fleetman-webapp&quot; deleted</span><br><span class="line">service &quot;fleetman-queue&quot; deleted</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f workloads.yaml</span><br><span class="line">kubectl describe pod queue-6bf9fd876-4xrqx</span><br><span class="line">Name:               queue-6bf9fd876-4xrqx</span><br><span class="line">Namespace:          default</span><br><span class="line">Priority:           0</span><br><span class="line">PriorityClassName:  &lt;none&gt;</span><br><span class="line">Node:               minikube/10.0.2.15</span><br><span class="line">Start Time:         Wed, 05 Jun 2019 15:14:40 +1000</span><br><span class="line">Labels:             app=queue</span><br><span class="line">                    pod-template-hash=6bf9fd876</span><br><span class="line">Annotations:        &lt;none&gt;</span><br><span class="line">Status:             Running</span><br><span class="line">IP:                 172.17.0.5</span><br><span class="line">Controlled By:      ReplicaSet/queue-6bf9fd876</span><br><span class="line">Containers:</span><br><span class="line">  webapp:</span><br><span class="line">    Container ID:   docker://f306dda43b8bf2eaab70449ecac022bb0b98e37b8b2be0d1b2e1b25eea9db1ac</span><br><span class="line">    Image:          richardchesterwood/k8s-fleetman-queue:release1</span><br><span class="line">    Image ID:       docker-pullable://richardchesterwood/k8s-fleetman-queue@sha256:bc2cb90a09aecdd8bce5d5f3a8dac17281ec7883077ddcfb8b7acfe2ab3b6afa</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Wed, 05 Jun 2019 15:14:41 +1000</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-nmqkz (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-nmqkz:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-nmqkz</span><br><span class="line">    Optional:    false</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  2m    default-scheduler  Successfully assigned default/queue-6bf9fd876-4xrqx to minikube</span><br><span class="line">  Normal  Pulled     2m    kubelet, minikube  Container image &quot;richardchesterwood/k8s-fleetman-queue:release1&quot; already present on machine</span><br><span class="line">  Normal  Created    2m    kubelet, minikube  Created container</span><br><span class="line">  Normal  Started    2m    kubelet, minikube  Started container</span><br><span class="line"></span><br><span class="line">kubectl apply -f services.yaml</span><br><span class="line">service &quot;fleetman-webapp&quot; created</span><br><span class="line">service &quot;fleetman-queue&quot; created</span><br><span class="line"></span><br><span class="line">kubectl apply -f services.yaml</span><br><span class="line">service &quot;fleetman-webapp&quot; created</span><br><span class="line">service &quot;fleetman-queue&quot; created</span><br><span class="line"></span><br><span class="line">minikube ip</span><br><span class="line">There is a newer version of minikube available (v1.1.0).  Download it here:</span><br><span class="line">https://github.com/kubernetes/minikube/releases/tag/v1.1.0</span><br><span class="line"></span><br><span class="line">To disable this notification, run the following:</span><br><span class="line">minikube config set WantUpdateNotification false</span><br><span class="line">192.168.99.118</span><br></pre></td></tr></table></figure>
<p>Open a web browser <a href="http://192.168.99.118:30010">http://192.168.99.118:30010</a>, click <strong>Manage ActiveMQ broker</strong>, enter username and password both admin.</p>
<h2 id="Deploying-the-Position-Simulator"><a href="#Deploying-the-Position-Simulator" class="headerlink" title="Deploying the Position Simulator"></a>Deploying the Position Simulator</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">cat workloads.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: queue</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: queue</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: queue</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-queue:release1</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: position-simulator</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: position-simulator</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: position-simulator</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-position-simulator:release1</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: producadskfjsjfsislfslsj</span><br><span class="line"></span><br><span class="line">kubectl apply -f workloads.yaml</span><br><span class="line">deployment.apps &quot;queue&quot; unchanged</span><br><span class="line">deployment.apps &quot;position-simulator&quot; configured</span><br><span class="line"></span><br><span class="line">kga</span><br><span class="line">NAME                                      READY     STATUS              RESTARTS   AGE</span><br><span class="line">pod/position-simulator-6f97fd485f-gplr8   0/1       ContainerCreating   0          7s</span><br><span class="line">pod/position-simulator-dff7b7599-2vbdd    0/1       ImagePullBackOff    0          2m</span><br><span class="line">pod/queue-6bf9fd876-4xrqx                 1/1       Running             0          50m</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.110.95.121    &lt;none&gt;        8161:30010/TCP,61616:30536/TCP   47m</span><br><span class="line">service/fleetman-webapp   NodePort    10.103.224.156   &lt;none&gt;        80:30080/TCP                     47m</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                          2d</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/position-simulator   1         2         1            0           2m</span><br><span class="line">deployment.apps/queue                1         1         1            1           50m</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/position-simulator-6f97fd485f   1         1         0         7s</span><br><span class="line">replicaset.apps/position-simulator-dff7b7599    1         1         0         2m</span><br><span class="line">replicaset.apps/queue-6bf9fd876                 1         1         1         50m</span><br><span class="line"></span><br><span class="line">kubectl describe pod position-simulator-6f97fd485f-gplr8</span><br><span class="line">Name:               position-simulator-6f97fd485f-gplr8</span><br><span class="line">Namespace:          default</span><br><span class="line">Priority:           0</span><br><span class="line">PriorityClassName:  &lt;none&gt;</span><br><span class="line">Node:               minikube/10.0.2.15</span><br><span class="line">Start Time:         Wed, 05 Jun 2019 16:05:27 +1000</span><br><span class="line">Labels:             app=position-simulator</span><br><span class="line">                    pod-template-hash=6f97fd485f</span><br><span class="line">Annotations:        &lt;none&gt;</span><br><span class="line">Status:             Running</span><br><span class="line">IP:                 172.17.0.7</span><br><span class="line">Controlled By:      ReplicaSet/position-simulator-6f97fd485f</span><br><span class="line">Containers:</span><br><span class="line">  webapp:</span><br><span class="line">    Container ID:   docker://2a4f677af3a8bd72f674543e13a4b84c3c86148791106a19270d86878091b09d</span><br><span class="line">    Image:          richardchesterwood/k8s-fleetman-position-simulator:release1</span><br><span class="line">    Image ID:       docker-pullable://richardchesterwood/k8s-fleetman-position-simulator@sha256:58ce4aa156469115a58be0bcfcec84bb7e42dd4552f83dcf5b6381234001108b</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Terminated</span><br><span class="line">      Reason:       Error</span><br><span class="line">      Exit Code:    1</span><br><span class="line">      Started:      Wed, 05 Jun 2019 16:05:56 +1000</span><br><span class="line">      Finished:     Wed, 05 Jun 2019 16:05:59 +1000</span><br><span class="line">    Ready:          False</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:</span><br><span class="line">      SPRING_PROFILES_ACTIVE:  producadskfjsjfsislfslsj</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-nmqkz (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             False</span><br><span class="line">  ContainersReady   False</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-nmqkz:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-nmqkz</span><br><span class="line">    Optional:    false</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age              From               Message</span><br><span class="line">  ----    ------     ----             ----               -------</span><br><span class="line">  Normal  Scheduled  33s              default-scheduler  Successfully assigned default/position-simulator-6f97fd485f-gplr8 to minikube</span><br><span class="line">  Normal  Pulling    32s              kubelet, minikube  pulling image &quot;richardchesterwood/k8s-fleetman-position-simulator:release1&quot;</span><br><span class="line">  Normal  Pulled     4s               kubelet, minikube  Successfully pulled image &quot;richardchesterwood/k8s-fleetman-position-simulator:release1&quot;</span><br><span class="line">  Normal  Created    0s (x2 over 4s)  kubelet, minikube  Created container</span><br><span class="line">  Normal  Started    0s (x2 over 4s)  kubelet, minikube  Started container</span><br><span class="line">  Normal  Pulled     0s               kubelet, minikube  Container image &quot;richardchesterwood/k8s-fleetman-position-simulator:release1&quot; already present on machine</span><br></pre></td></tr></table></figure>
<h3 id="inspecting-Pod-Logs"><a href="#inspecting-Pod-Logs" class="headerlink" title="inspecting Pod Logs"></a>inspecting Pod Logs</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs position-simulator-6f97fd485f-gplr8</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&apos;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &apos;_ | &apos;_| | &apos;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &apos;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::        (v1.4.0.RELEASE)</span><br><span class="line"></span><br><span class="line">2019-06-05 06:09:06.044  INFO 1 --- [           main] c.v.s.PositionsimulatorApplication       : Starting PositionsimulatorApplication v0.0.1-SNAPSHOT on position-simulator-6f97fd485f-gplr8 with PID 1 (/webapp.jar started by root in /)</span><br><span class="line">2019-06-05 06:09:06.056  INFO 1 --- [           main] c.v.s.PositionsimulatorApplication       : The following profiles are active: producadskfjsjfsislfslsj</span><br><span class="line">2019-06-05 06:09:06.151  INFO 1 --- [           main] s.c.a.AnnotationConfigApplicationContext : Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@5f4da5c3: startup date [Wed Jun 05 06:09:06 UTC 2019]; root of context hierarchy</span><br><span class="line">2019-06-05 06:09:07.265  WARN 1 --- [           main] s.c.a.AnnotationConfigApplicationContext : Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;journeySimulator&apos;: Injection of autowired dependencies failed; nested exception is java.lang.IllegalArgumentException: Could not resolve placeholder &apos;fleetman.position.queue&apos; in string value &quot;$&#123;fleetman.position.queue&#125;&quot;</span><br><span class="line">2019-06-05 06:09:07.273  INFO 1 --- [           main] utoConfigurationReportLoggingInitializer :</span><br><span class="line"></span><br><span class="line">Error starting ApplicationContext. To display the auto-configuration report enable debug logging (start with --debug)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2019-06-05 06:09:07.286 ERROR 1 --- [           main] o.s.boot.SpringApplication               : Application startup failed</span><br><span class="line"></span><br><span class="line">org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;journeySimulator&apos;: Injection of autowired dependencies failed; nested exception is java.lang.IllegalArgumentException: Could not resolve placeholder &apos;fleetman.position.queue&apos; in string value &quot;$&#123;fleetman.position.queue&#125;&quot;</span><br><span class="line">	at org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor.postProcessPropertyValues(AutowiredAnnotationBeanPostProcessor.java:355) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1214) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:543) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:482) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:306) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:230) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:302) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:197) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:776) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:861) ~[spring-context-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:541) ~[spring-context-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:759) [spring-boot-1.4.0.RELEASE.jar!/:1.4.0.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:369) [spring-boot-1.4.0.RELEASE.jar!/:1.4.0.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:313) [spring-boot-1.4.0.RELEASE.jar!/:1.4.0.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1185) [spring-boot-1.4.0.RELEASE.jar!/:1.4.0.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1174) [spring-boot-1.4.0.RELEASE.jar!/:1.4.0.RELEASE]</span><br><span class="line">	at com.virtualpairprogrammers.simulator.PositionsimulatorApplication.main(PositionsimulatorApplication.java:28) [classes!/:0.0.1-SNAPSHOT]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_131]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_131]</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_131]</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_131]</span><br><span class="line">	at org.springframework.boot.loader.MainMethodRunner.run(MainMethodRunner.java:48) [webapp.jar:0.0.1-SNAPSHOT]</span><br><span class="line">	at org.springframework.boot.loader.Launcher.launch(Launcher.java:87) [webapp.jar:0.0.1-SNAPSHOT]</span><br><span class="line">	at org.springframework.boot.loader.Launcher.launch(Launcher.java:50) [webapp.jar:0.0.1-SNAPSHOT]</span><br><span class="line">	at org.springframework.boot.loader.JarLauncher.main(JarLauncher.java:58) [webapp.jar:0.0.1-SNAPSHOT]</span><br><span class="line">Caused by: java.lang.IllegalArgumentException: Could not resolve placeholder &apos;fleetman.position.queue&apos; in string value &quot;$&#123;fleetman.position.queue&#125;&quot;</span><br><span class="line">	at org.springframework.util.PropertyPlaceholderHelper.parseStringValue(PropertyPlaceholderHelper.java:174) ~[spring-core-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.util.PropertyPlaceholderHelper.replacePlaceholders(PropertyPlaceholderHelper.java:126) ~[spring-core-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.core.env.AbstractPropertyResolver.doResolvePlaceholders(AbstractPropertyResolver.java:219) ~[spring-core-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.core.env.AbstractPropertyResolver.resolveRequiredPlaceholders(AbstractPropertyResolver.java:193) ~[spring-core-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.context.support.PropertySourcesPlaceholderConfigurer$2.resolveStringValue(PropertySourcesPlaceholderConfigurer.java:172) ~[spring-context-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory.resolveEmbeddedValue(AbstractBeanFactory.java:813) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.DefaultListableBeanFactory.doResolveDependency(DefaultListableBeanFactory.java:1039) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.DefaultListableBeanFactory.resolveDependency(DefaultListableBeanFactory.java:1019) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor$AutowiredFieldElement.inject(AutowiredAnnotationBeanPostProcessor.java:566) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.annotation.InjectionMetadata.inject(InjectionMetadata.java:88) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor.postProcessPropertyValues(AutowiredAnnotationBeanPostProcessor.java:349) ~[spring-beans-4.3.2.RELEASE.jar!/:4.3.2.RELEASE]</span><br><span class="line">	... 24 common frames omitted</span><br></pre></td></tr></table></figure>
<p><code>kubectl logs -f position-simulator-6f97fd485f-gplr8</code> follow the log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">cat workloads.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: queue</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: queue</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: queue</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-queue:release1</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: position-simulator</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: position-simulator</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: position-simulator</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-position-simulator:release1</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line"></span><br><span class="line">kubectl apply -f workloads.yaml</span><br><span class="line">deployment.apps &quot;queue&quot; unchanged</span><br><span class="line">deployment.apps &quot;position-simulator&quot; configured</span><br><span class="line"></span><br><span class="line">kga</span><br><span class="line">NAME                                      READY     STATUS        RESTARTS   AGE</span><br><span class="line">pod/position-simulator-6d8769d8-ghtmw     1/1       Running       0          9s</span><br><span class="line">pod/position-simulator-6f97fd485f-gplr8   0/1       Terminating   6          8m</span><br><span class="line">pod/queue-6bf9fd876-4xrqx                 1/1       Running       0          59m</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.110.95.121    &lt;none&gt;        8161:30010/TCP,61616:30536/TCP   55m</span><br><span class="line">service/fleetman-webapp   NodePort    10.103.224.156   &lt;none&gt;        80:30080/TCP                     55m</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                          2d</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/position-simulator   1         1         1            1           10m</span><br><span class="line">deployment.apps/queue                1         1         1            1           59m</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/position-simulator-6d8769d8     1         1         1         9s</span><br><span class="line">replicaset.apps/position-simulator-6f97fd485f   0         0         0         8m</span><br><span class="line">replicaset.apps/position-simulator-dff7b7599    0         0         0         10m</span><br><span class="line">replicaset.apps/queue-6bf9fd876                 1         1         1         59m</span><br><span class="line"></span><br><span class="line">kubectl logs -f position-simulator-6d8769d8-ghtmw</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&apos;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &apos;_ | &apos;_| | &apos;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &apos;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::        (v1.4.0.RELEASE)</span><br><span class="line"></span><br><span class="line">2019-06-05 06:13:36.205  INFO 1 --- [           main] c.v.s.PositionsimulatorApplication       : Starting PositionsimulatorApplication v0.0.1-SNAPSHOT on position-simulator-6d8769d8-ghtmw with PID 1 (/webapp.jar started by root in /)</span><br><span class="line">2019-06-05 06:13:36.213  INFO 1 --- [           main] c.v.s.PositionsimulatorApplication       : The following profiles are active: production-microservice</span><br><span class="line">2019-06-05 06:13:36.361  INFO 1 --- [           main] s.c.a.AnnotationConfigApplicationContext : Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@443b7951: startup date [Wed Jun 05 06:13:36 UTC 2019]; root of context hierarchy</span><br><span class="line">2019-06-05 06:13:38.011  INFO 1 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup</span><br><span class="line">2019-06-05 06:13:38.016  INFO 1 --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Starting beans in phase 2147483647</span><br><span class="line">2019-06-05 06:13:38.041  INFO 1 --- [           main] c.v.s.PositionsimulatorApplication       : Started PositionsimulatorApplication in 2.487 seconds (JVM running for 3.201)</span><br><span class="line">2019-06-05 06:13:38.046  INFO 1 --- [           main] s.c.a.AnnotationConfigApplicationContext : Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@443b7951: startup date [Wed Jun 05 06:13:36 UTC 2019]; root of context hierarchy</span><br><span class="line">2019-06-05 06:13:38.048  INFO 1 --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Stopping beans in phase 2147483647</span><br><span class="line">2019-06-05 06:13:38.049  INFO 1 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Unregistering JMX-exposed beans on shutdown</span><br><span class="line">ca^H^H^C</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/QhM7LEN.png" alt="Digram"></p>
<h2 id="Deploying-the-Position-Tracker"><a href="#Deploying-the-Position-Tracker" class="headerlink" title="Deploying the Position Tracker"></a>Deploying the Position Tracker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">cat workloads.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: queue</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: queue</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: queue</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: queue</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-queue:release1</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: position-simulator</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: position-simulator</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: position-simulator</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: position-simulator</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-position-simulator:release1</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: position-tracker</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: position-tracker</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: position-tracker</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: position-tracker</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-position-tracker:release1</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line"></span><br><span class="line">kubectl apply -f workloads.yaml</span><br><span class="line">deployment.apps &quot;queue&quot; configured</span><br><span class="line">deployment.apps &quot;position-simulator&quot; configured</span><br><span class="line">deployment.apps &quot;position-tracker&quot; created</span><br><span class="line"></span><br><span class="line">kga</span><br><span class="line">NAME                                      READY     STATUS        RESTARTS   AGE</span><br><span class="line">pod/position-simulator-6d8769d8-ghtmw     0/1       Terminating   0          13m</span><br><span class="line">pod/position-simulator-7889db8b94-49qz2   1/1       Running       0          10s</span><br><span class="line">pod/position-tracker-86d694f997-5j6fm     1/1       Running       0          10s</span><br><span class="line">pod/queue-6bf9fd876-4xrqx                 1/1       Terminating   0          1h</span><br><span class="line">pod/queue-9668b9bb4-4pqxr                 1/1       Running       0          10s</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">service/fleetman-queue    NodePort    10.110.95.121    &lt;none&gt;        8161:30010/TCP,61616:30536/TCP   1h</span><br><span class="line">service/fleetman-webapp   NodePort    10.103.224.156   &lt;none&gt;        80:30080/TCP                     1h</span><br><span class="line">service/kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                          2d</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/position-simulator   1         1         1            1           24m</span><br><span class="line">deployment.apps/position-tracker     1         1         1            1           10s</span><br><span class="line">deployment.apps/queue                1         1         1            1           1h</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/position-simulator-6d8769d8     0         0         0         13m</span><br><span class="line">replicaset.apps/position-simulator-6f97fd485f   0         0         0         21m</span><br><span class="line">replicaset.apps/position-simulator-7889db8b94   1         1         1         10s</span><br><span class="line">replicaset.apps/position-simulator-dff7b7599    0         0         0         24m</span><br><span class="line">replicaset.apps/position-tracker-86d694f997     1         1         1         10s</span><br><span class="line">replicaset.apps/queue-6bf9fd876                 0         0         0         1h</span><br><span class="line">replicaset.apps/queue-9668b9bb4                 1         1         1         10s</span><br><span class="line"></span><br><span class="line">kubectl describe pod position-tracker-86d694f997-5j6fm</span><br><span class="line">Name:               position-tracker-86d694f997-5j6fm</span><br><span class="line">Namespace:          default</span><br><span class="line">Priority:           0</span><br><span class="line">PriorityClassName:  &lt;none&gt;</span><br><span class="line">Node:               minikube/10.0.2.15</span><br><span class="line">Start Time:         Wed, 05 Jun 2019 16:26:58 +1000</span><br><span class="line">Labels:             app=position-tracker</span><br><span class="line">                    pod-template-hash=86d694f997</span><br><span class="line">Annotations:        &lt;none&gt;</span><br><span class="line">Status:             Running</span><br><span class="line">IP:                 172.17.0.7</span><br><span class="line">Controlled By:      ReplicaSet/position-tracker-86d694f997</span><br><span class="line">Containers:</span><br><span class="line">  position-tracker:</span><br><span class="line">    Container ID:   docker://c0203a7654c944a92f1b18b48d5c84917b9ecc791536429e6b02ca6248edb78f</span><br><span class="line">    Image:          richardchesterwood/k8s-fleetman-position-tracker:release1</span><br><span class="line">    Image ID:       docker-pullable://richardchesterwood/k8s-fleetman-position-tracker@sha256:5da78e936eb77677fbf30e528253a543badc76a5dd3a356b6d13e716da187298</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Wed, 05 Jun 2019 16:27:08 +1000</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:</span><br><span class="line">      SPRING_PROFILES_ACTIVE:  production-microservice</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-nmqkz (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-nmqkz:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-nmqkz</span><br><span class="line">    Optional:    false</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  1m    default-scheduler  Successfully assigned default/position-tracker-86d694f997-5j6fm to minikube</span><br><span class="line">  Normal  Pulling    1m    kubelet, minikube  pulling image &quot;richardchesterwood/k8s-fleetman-position-tracker:release1&quot;</span><br><span class="line">  Normal  Pulled     1m    kubelet, minikube  Successfully pulled image &quot;richardchesterwood/k8s-fleetman-position-tracker:release1&quot;</span><br><span class="line">  Normal  Created    1m    kubelet, minikube  Created container</span><br><span class="line">  Normal  Started    1m    kubelet, minikube  Started container</span><br><span class="line"></span><br><span class="line">kubectl logs -f position-tracker-86d694f997-5j6fm</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&apos;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &apos;_ | &apos;_| | &apos;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &apos;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::        (v1.4.0.RELEASE)</span><br><span class="line"></span><br><span class="line">2019-06-05 06:27:14.242  INFO 1 --- [           main] c.v.tracker.PositionTrackerApplication   : Starting PositionTrackerApplication v0.0.1-SNAPSHOT on position-tracker-86d694f997-5j6fm with PID 1 (/webapp.jar started by root in /)</span><br><span class="line">2019-06-05 06:27:14.297  INFO 1 --- [           main] c.v.tracker.PositionTrackerApplication   : The following profiles are active: production-microservice</span><br><span class="line">2019-06-05 06:27:15.147  INFO 1 --- [           main] ationConfigEmbeddedWebApplicationContext : Refreshing org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext@108c4c35: startup date [Wed Jun 05 06:27:15 UTC 2019]; root of context hierarchy</span><br><span class="line">2019-06-05 06:27:25.787  INFO 1 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat initialized with port(s): 8080 (http)</span><br><span class="line">2019-06-05 06:27:25.852  INFO 1 --- [           main] o.apache.catalina.core.StandardService   : Starting service Tomcat</span><br><span class="line">2019-06-05 06:27:25.854  INFO 1 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet Engine: Apache Tomcat/8.5.4</span><br><span class="line">2019-06-05 06:27:25.985  INFO 1 --- [ost-startStop-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line">2019-06-05 06:27:25.986  INFO 1 --- [ost-startStop-1] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 10877 ms</span><br><span class="line">2019-06-05 06:27:26.212  INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.ServletRegistrationBean  : Mapping servlet: &apos;dispatcherServlet&apos; to [/]</span><br><span class="line">2019-06-05 06:27:26.221  INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: &apos;characterEncodingFilter&apos; to: [/*]</span><br><span class="line">2019-06-05 06:27:26.222  INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: &apos;hiddenHttpMethodFilter&apos; to: [/*]</span><br><span class="line">2019-06-05 06:27:26.223  INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: &apos;httpPutFormContentFilter&apos; to: [/*]</span><br><span class="line">2019-06-05 06:27:26.223  INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: &apos;requestContextFilter&apos; to: [/*]</span><br><span class="line">2019-06-05 06:27:26.789  INFO 1 --- [           main] s.w.s.m.m.a.RequestMappingHandlerAdapter : Looking for @ControllerAdvice: org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext@108c4c35: startup date [Wed Jun 05 06:27:15 UTC 2019]; root of context hierarchy</span><br><span class="line">2019-06-05 06:27:26.900  INFO 1 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped &quot;&#123;[/vehicles/&#123;vehicleName&#125;],methods=[GET]&#125;&quot; onto public org.springframework.http.ResponseEntity&lt;com.virtualpairprogrammers.tracker.domain.VehiclePosition&gt; com.virtualpairprogrammers.tracker.rest.PositionReportsController.getLatestReportForVehicle(java.lang.String)</span><br><span class="line">2019-06-05 06:27:26.901  INFO 1 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped &quot;&#123;[/vehicles/],methods=[GET]&#125;&quot; onto public java.util.Collection&lt;com.virtualpairprogrammers.tracker.domain.VehiclePosition&gt; com.virtualpairprogrammers.tracker.rest.PositionReportsController.getUpdatedPositions(java.util.Date)</span><br><span class="line">2019-06-05 06:27:26.903  INFO 1 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped &quot;&#123;[/error],produces=[text/html]&#125;&quot; onto public org.springframework.web.servlet.ModelAndView org.springframework.boot.autoconfigure.web.BasicErrorController.errorHtml(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)</span><br><span class="line">2019-06-05 06:27:26.904  INFO 1 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped &quot;&#123;[/error]&#125;&quot; onto public org.springframework.http.ResponseEntity&lt;java.util.Map&lt;java.lang.String, java.lang.Object&gt;&gt; org.springframework.boot.autoconfigure.web.BasicErrorController.error(javax.servlet.http.HttpServletRequest)</span><br><span class="line">2019-06-05 06:27:26.948  INFO 1 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/webjars/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]</span><br><span class="line">2019-06-05 06:27:26.948  INFO 1 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]</span><br><span class="line">2019-06-05 06:27:26.991  INFO 1 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**/favicon.ico] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]</span><br><span class="line">2019-06-05 06:27:27.364  INFO 1 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup</span><br><span class="line">2019-06-05 06:27:27.414  INFO 1 --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Starting beans in phase 2147483647</span><br><span class="line">2019-06-05 06:27:28.408  INFO 1 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat started on port(s): 8080 (http)</span><br><span class="line">2019-06-05 06:27:28.436  INFO 1 --- [           main] c.v.tracker.PositionTrackerApplication   : Started PositionTrackerApplication in 17.136 seconds (JVM running for 20.295)</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/MrwaPyf.png" alt="ActiveMQ screenshot"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">cat services.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-webapp</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: webapp</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 80</span><br><span class="line">     nodePort: 30080</span><br><span class="line"></span><br><span class="line"> type: NodePort</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-queue</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: queue</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 8161</span><br><span class="line">     nodePort: 30010</span><br><span class="line"></span><br><span class="line">   - name: endpoint</span><br><span class="line">     port: 61616</span><br><span class="line"></span><br><span class="line"> type: NodePort</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-position-tracker</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: position-tracker</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 8080</span><br><span class="line"></span><br><span class="line"> type: ClusterIP</span><br><span class="line"></span><br><span class="line">kubectl apply -f services.yaml</span><br><span class="line">service &quot;fleetman-webapp&quot; unchanged</span><br><span class="line">service &quot;fleetman-queue&quot; unchanged</span><br><span class="line">service &quot;fleetman-position-tracker&quot; configured</span><br><span class="line"></span><br><span class="line">kga</span><br><span class="line">NAME                                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/position-simulator-589c64887f-lhl8g   1/1       Running   0          38m</span><br><span class="line">pod/position-tracker-86d694f997-5j6fm     1/1       Running   0          45m</span><br><span class="line">pod/queue-9668b9bb4-4pqxr                 1/1       Running   0          45m</span><br><span class="line"></span><br><span class="line">NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">service/fleetman-position-tracker   ClusterIP   10.104.177.133   &lt;none&gt;        8080/TCP                         3m</span><br><span class="line">service/fleetman-queue              NodePort    10.110.95.121    &lt;none&gt;        8161:30010/TCP,61616:30536/TCP   1h</span><br><span class="line">service/fleetman-webapp             NodePort    10.103.224.156   &lt;none&gt;        80:30080/TCP                     1h</span><br><span class="line">service/kubernetes                  ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                          2d</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/position-simulator   1         1         1            1           1h</span><br><span class="line">deployment.apps/position-tracker     1         1         1            1           45m</span><br><span class="line">deployment.apps/queue                1         1         1            1           1h</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/position-simulator-589c64887f   1         1         1         38m</span><br><span class="line">replicaset.apps/position-simulator-6d8769d8     0         0         0         58m</span><br><span class="line">replicaset.apps/position-simulator-6f97fd485f   0         0         0         1h</span><br><span class="line">replicaset.apps/position-simulator-7889db8b94   0         0         0         45m</span><br><span class="line">replicaset.apps/position-simulator-dff7b7599    0         0         0         1h</span><br><span class="line">replicaset.apps/position-tracker-86d694f997     1         1         1         45m</span><br><span class="line">replicaset.apps/queue-6bf9fd876                 0         0         0         1h</span><br><span class="line">replicaset.apps/queue-9668b9bb4                 1         1         1         45m</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/3tgbP7M.png" alt="Check"></p>
<h2 id="Deploying-the-API-Gateway"><a href="#Deploying-the-API-Gateway" class="headerlink" title="Deploying the API Gateway"></a>Deploying the API Gateway</h2><p>Add code in services.yaml file:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-api-gateway</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: api-gateway</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 8080</span><br><span class="line"></span><br><span class="line"> type: ClusterIP</span><br></pre></td></tr></table></figure></p>
<p>Add code in workloads.yaml file:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: api-gateway</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: api-gateway</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: api-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: api-gateway</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-api-gateway:release1</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br></pre></td></tr></table></figure></p>
<p><code>kubectl apply -f .</code></p>
<h2 id="Deploying-the-Webapp"><a href="#Deploying-the-Webapp" class="headerlink" title="Deploying the Webapp"></a>Deploying the Webapp</h2><p>Add for workloads.yaml file:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: webapp</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: webapp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-webapp-angular:release1</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br></pre></td></tr></table></figure></p>
<p>For serivce.yaml no change.</p>
<p><img src="https://i.imgur.com/dadMM2m.jpg" alt="final"></p>
<h1 id="Persistence"><a href="#Persistence" class="headerlink" title="Persistence"></a>Persistence</h1><h2 id="New-Release"><a href="#New-Release" class="headerlink" title="New Release!!"></a><strong>New Release!!</strong></h2><p>Release 2 is now available!</p>
<p>Please update all images to :release2 tag</p>
<p>New feature: vehicle tracking shows the history of each vehicle</p>
<hr>
<p>Change image in workloads.yaml from release1 to release2 by <code>:%s/release1/release2/g</code><br><img src="https://i.imgur.com/oOLbvYT.jpg" alt="release2"></p>
<h2 id="Upgrading-to-a-Mongo-Pod"><a href="#Upgrading-to-a-Mongo-Pod" class="headerlink" title="Upgrading to a Mongo Pod"></a>Upgrading to a Mongo Pod</h2><p><img src="https://i.imgur.com/zT2lk5f.jpg" alt="release3"></p>
<h2 id="Volume-Mounts"><a href="#Volume-Mounts" class="headerlink" title="Volume Mounts"></a>Volume Mounts</h2><p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/#volume-v1-core">Volume v1 core</a></p>
<h2 id="PersistentVolumeClaims"><a href="#PersistentVolumeClaims" class="headerlink" title="PersistentVolumeClaims"></a>PersistentVolumeClaims</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat storage.yaml</span><br><span class="line"># What do want?</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClain</span><br><span class="line">metadata:</span><br><span class="line">  name: mongo-pvc</span><br><span class="line">spec:</span><br><span class="line">  accessMode:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resouces:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># How do we want it implemented</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: local-storage</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 20Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: &quot;/mnt/somenew/dirctory/structure/&quot;</span><br><span class="line">    type: DirectoryOrCreate</span><br></pre></td></tr></table></figure>
<h2 id="StorageClasses-and-Binding"><a href="#StorageClasses-and-Binding" class="headerlink" title="StorageClasses and Binding"></a>StorageClasses and Binding</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"> cat mongo-stack.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mongodb</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mongodb</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: mongodb</span><br><span class="line">        image: mongo:3.6.12-xenial</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - name: mongo-persistent-storage</span><br><span class="line">            mountPath: /data/db</span><br><span class="line">      volumes:</span><br><span class="line">        - name: mongo-persistent-storage</span><br><span class="line">          # pointer to the configuration of HOW we want the mount to be implemented</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">             claimName: mongo-pvc</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fleetman-mongodb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: mongodb</span><br><span class="line">  ports:</span><br><span class="line">    - name: mongoport</span><br><span class="line">      port: 27017</span><br><span class="line">  type: ClusterIP</span><br><span class="line"></span><br><span class="line"> cat storage.yaml</span><br><span class="line"># What do want?</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: mongo-pvc</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: mylocalstorage</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># How do we want it implemented</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: local-storage</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: mylocalstorage</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 20Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: &quot;/mnt/somenew/dirctory/structure/&quot;</span><br><span class="line">    type: DirectoryOrCreate</span><br></pre></td></tr></table></figure>
<h1 id="DEPLOYING-TO-THE-AWS-CLOUD"><a href="#DEPLOYING-TO-THE-AWS-CLOUD" class="headerlink" title="DEPLOYING TO THE AWS CLOUD"></a>DEPLOYING TO THE AWS CLOUD</h1><h2 id="Getting-started-with-AWS"><a href="#Getting-started-with-AWS" class="headerlink" title="Getting started with AWS"></a>Getting started with AWS</h2><p><img src="https://i.imgur.com/FvK1lg2.png" alt="image1"></p>
<p><img src="https://i.imgur.com/1pQD2XE.png" alt="image2"></p>
<p><img src="https://i.imgur.com/KD5pigA.png" alt="image3"></p>
<p><img src="https://i.imgur.com/yZoC4kE.png" alt="ebs"></p>
<h2 id="Introducing-Kops"><a href="#Introducing-Kops" class="headerlink" title="Introducing Kops"></a>Introducing Kops</h2><p><a href="https://github.com/kubernetes/kops">Kops</a></p>
<p>This apparently is the easiest way to get a production-grade Kubernetes cluster up and running.</p>
<h2 id="Installing-the-Kops-Environment"><a href="#Installing-the-Kops-Environment" class="headerlink" title="Installing the Kops Environment"></a>Installing the Kops Environment</h2><p><a href="https://github.com/kubernetes/kops/blob/master/docs/aws.md">Deploy to aws</a></p>
<h2 id="Configuring-your-first-cluster"><a href="#Configuring-your-first-cluster" class="headerlink" title="Configuring your first cluster"></a>Configuring your first cluster</h2><p><a href="https://github.com/kubernetes/kops/blob/master/docs/aws.md#cluster-state-storage">Cluster State storage</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@foobar ~]$ export AWS_ACCESS_KEY_ID=$(aws configure get aws_access_key_id)</span><br><span class="line">[ec2-user@foobar ~]$ export AWS_SECRET_ACCESS_KEY=$(aws configure get aws_secret_access_key)</span><br><span class="line">[ec2-user@foobar ~]$ export NAME=fleetman.k8s.local</span><br><span class="line">[ec2-user@foobar ~]$ export KOPS_STATE_STORE=s3://stanzhou-state-storage</span><br><span class="line">[ec2-user@foobar ~]$ aws ec2 describe-availability-zones --region ap-southeast-2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;AvailabilityZones&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;State&quot;: &quot;available&quot;,</span><br><span class="line">            &quot;ZoneName&quot;: &quot;ap-southeast-2a&quot;,</span><br><span class="line">            &quot;Messages&quot;: [],</span><br><span class="line">            &quot;ZoneId&quot;: &quot;apse2-az1&quot;,</span><br><span class="line">            &quot;RegionName&quot;: &quot;ap-southeast-2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;State&quot;: &quot;available&quot;,</span><br><span class="line">            &quot;ZoneName&quot;: &quot;ap-southeast-2b&quot;,</span><br><span class="line">            &quot;Messages&quot;: [],</span><br><span class="line">            &quot;ZoneId&quot;: &quot;apse2-az3&quot;,</span><br><span class="line">            &quot;RegionName&quot;: &quot;ap-southeast-2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;State&quot;: &quot;available&quot;,</span><br><span class="line">            &quot;ZoneName&quot;: &quot;ap-southeast-2c&quot;,</span><br><span class="line">            &quot;Messages&quot;: [],</span><br><span class="line">            &quot;ZoneId&quot;: &quot;apse2-az2&quot;,</span><br><span class="line">            &quot;RegionName&quot;: &quot;ap-southeast-2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ kops create cluster --zones ap-southeast-2a,ap-southeast-2b,ap-southeast-2c $&#123;NAME&#125;</span><br><span class="line">I0607 06:10:02.189636    3468 create_cluster.go:519] Inferred --cloud=aws from zone &quot;ap-southeast-2a&quot;</span><br><span class="line">I0607 06:10:02.243690    3468 subnets.go:184] Assigned CIDR 172.20.32.0/19 to subnet ap-southeast-2a</span><br><span class="line">I0607 06:10:02.243802    3468 subnets.go:184] Assigned CIDR 172.20.64.0/19 to subnet ap-southeast-2b</span><br><span class="line">I0607 06:10:02.243857    3468 subnets.go:184] Assigned CIDR 172.20.96.0/19 to subnet ap-southeast-2c</span><br><span class="line">Previewing changes that will be made:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SSH public key must be specified when running with AWS (create with `kops create secret --name fleetman.k8s.local sshpublickey admin -i ~/.ssh/id_rsa.pub`)</span><br><span class="line"></span><br><span class="line">[ec2-user@foobar ~]$ ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa</span><br><span class="line">[ec2-user@foobar ~]$ kops create secret --name $&#123;NAME&#125; sshpublickey admin -i ~/.ssh/id_rsa.pub</span><br><span class="line">[ec2-user@foobar ~]$ kops edit ig nodes --name $&#123;NAME&#125;</span><br><span class="line">[ec2-user@foobar ~]$ kops get ig --name $&#123;NAME&#125;</span><br><span class="line">NAME                    ROLE    MACHINETYPE     MIN     MAX     ZONES</span><br><span class="line">master-ap-southeast-2a  Master  m3.medium       1       1       ap-southeast-2a</span><br><span class="line">nodes                   Node    t2.medium       3       5       ap-southeast-2a,ap-southeast-2b,ap-southeast-2c</span><br><span class="line">[ec2-user@foobar ~]$ kops edit ig master-ap-southeast-2a --name $&#123;NAME&#125;</span><br><span class="line">Edit cancelled, no changes made.</span><br></pre></td></tr></table></figure>
<h2 id="Running-the-Cluster"><a href="#Running-the-Cluster" class="headerlink" title="Running the Cluster"></a>Running the Cluster</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@i ~]$ kops update cluster $&#123;NAME&#125; --yes</span><br><span class="line">I0607 06:28:38.011102   32239 apply_cluster.go:559] Gossip DNS: skipping DNS validation</span><br><span class="line">I0607 06:28:38.263244   32239 executor.go:103] Tasks: 0 done / 94 total; 42 can run</span><br><span class="line">I0607 06:28:39.702035   32239 vfs_castore.go:729] Issuing new certificate: &quot;apiserver-aggregator-ca&quot;</span><br><span class="line">I0607 06:28:40.216189   32239 vfs_castore.go:729] Issuing new certificate: &quot;etcd-clients-ca&quot;</span><br><span class="line">I0607 06:28:40.356654   32239 vfs_castore.go:729] Issuing new certificate: &quot;etcd-peers-ca-main&quot;</span><br><span class="line">I0607 06:28:40.743191   32239 vfs_castore.go:729] Issuing new certificate: &quot;etcd-peers-ca-events&quot;</span><br><span class="line">I0607 06:28:40.824760   32239 vfs_castore.go:729] Issuing new certificate: &quot;etcd-manager-ca-events&quot;</span><br><span class="line">I0607 06:28:41.265388   32239 vfs_castore.go:729] Issuing new certificate: &quot;etcd-manager-ca-main&quot;</span><br><span class="line">I0607 06:28:41.373174   32239 vfs_castore.go:729] Issuing new certificate: &quot;ca&quot;</span><br><span class="line">I0607 06:28:41.551597   32239 executor.go:103] Tasks: 42 done / 94 total; 26 can run</span><br><span class="line">I0607 06:28:42.539134   32239 vfs_castore.go:729] Issuing new certificate: &quot;kube-scheduler&quot;</span><br><span class="line">I0607 06:28:42.891972   32239 vfs_castore.go:729] Issuing new certificate: &quot;kubecfg&quot;</span><br><span class="line">I0607 06:28:43.157916   32239 vfs_castore.go:729] Issuing new certificate: &quot;apiserver-proxy-client&quot;</span><br><span class="line">I0607 06:28:43.556052   32239 vfs_castore.go:729] Issuing new certificate: &quot;kubelet&quot;</span><br><span class="line">I0607 06:28:43.677894   32239 vfs_castore.go:729] Issuing new certificate: &quot;apiserver-aggregator&quot;</span><br><span class="line">I0607 06:28:43.748079   32239 vfs_castore.go:729] Issuing new certificate: &quot;kube-proxy&quot;</span><br><span class="line">I0607 06:28:44.025132   32239 vfs_castore.go:729] Issuing new certificate: &quot;kubelet-api&quot;</span><br><span class="line">I0607 06:28:44.589696   32239 vfs_castore.go:729] Issuing new certificate: &quot;kube-controller-manager&quot;</span><br><span class="line">I0607 06:28:44.730038   32239 vfs_castore.go:729] Issuing new certificate: &quot;kops&quot;</span><br><span class="line">I0607 06:28:44.864527   32239 executor.go:103] Tasks: 68 done / 94 total; 22 can run</span><br><span class="line">I0607 06:28:45.089177   32239 launchconfiguration.go:364] waiting for IAM instance profile &quot;masters.fleetman.k8s.local&quot; to be ready</span><br><span class="line">I0607 06:28:45.101954   32239 launchconfiguration.go:364] waiting for IAM instance profile &quot;nodes.fleetman.k8s.local&quot; to be ready</span><br><span class="line">I0607 06:28:55.483430   32239 executor.go:103] Tasks: 90 done / 94 total; 3 can run</span><br><span class="line">I0607 06:28:55.974524   32239 vfs_castore.go:729] Issuing new certificate: &quot;master&quot;</span><br><span class="line">I0607 06:28:56.119668   32239 executor.go:103] Tasks: 93 done / 94 total; 1 can run</span><br><span class="line">I0607 06:28:56.336766   32239 executor.go:103] Tasks: 94 done / 94 total; 0 can run</span><br><span class="line">I0607 06:28:56.407976   32239 update_cluster.go:291] Exporting kubecfg for cluster</span><br><span class="line">kops has set your kubectl context to fleetman.k8s.local</span><br><span class="line"></span><br><span class="line">Cluster is starting.  It should be ready in a few minutes.</span><br><span class="line"></span><br><span class="line">Suggestions:</span><br><span class="line"> * validate cluster: kops validate cluster</span><br><span class="line"> * list nodes: kubectl get nodes --show-labels</span><br><span class="line"> * ssh to the master: ssh -i ~/.ssh/id_rsa admin@api.fleetman.k8s.local</span><br><span class="line"> * the admin user is specific to Debian. If not using Debian please use the appropriate user based on your OS.</span><br><span class="line"> * read about installing addons at: https://github.com/kubernetes/kops/blob/master/docs/addons.md.</span><br><span class="line"></span><br><span class="line">[ec2-user@i ~]$ kops validate cluster</span><br><span class="line">Using cluster from kubectl context: fleetman.k8s.local</span><br><span class="line"></span><br><span class="line">Validating cluster fleetman.k8s.local</span><br><span class="line"></span><br><span class="line">INSTANCE GROUPS</span><br><span class="line">NAME                    ROLE    MACHINETYPE     MIN     MAX     SUBNETS</span><br><span class="line">master-ap-southeast-2a  Master  m3.medium       1       1       ap-southeast-2a</span><br><span class="line">nodes                   Node    t2.medium       3       5       ap-southeast-2a,ap-southeast-2b,ap-southeast-2c</span><br><span class="line"></span><br><span class="line">NODE STATUS</span><br><span class="line">NAME                                                    ROLE    READY</span><br><span class="line">ip-172-20-115-253.ap-southeast-2.compute.internal       node    True</span><br><span class="line">ip-172-20-39-212.ap-southeast-2.compute.internal        node    True</span><br><span class="line">ip-172-20-45-219.ap-southeast-2.compute.internal        master  True</span><br><span class="line">ip-172-20-89-8.ap-southeast-2.compute.internal          node    True</span><br><span class="line"></span><br><span class="line">Your cluster fleetman.k8s.local is ready</span><br><span class="line"></span><br><span class="line">[ec2-user@i ~]$ kubectl get all</span><br><span class="line">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes   ClusterIP   100.64.0.1   &lt;none&gt;        443/TCP   4m50s</span><br></pre></td></tr></table></figure>
<h2 id="Provisioning-SSD-drives-with-a-StorageClass"><a href="#Provisioning-SSD-drives-with-a-StorageClass" class="headerlink" title="Provisioning SSD drives with a StorageClass"></a>Provisioning SSD drives with a StorageClass</h2><p>We have a workloads yaml file, where we’d be finding the pods that we want to deploy to our cluster. We have mongostack which is a specialist file, just for the mongo database. We have storage.yaml, which is currently defining that we want to store the mongo data in a local directory on the host machine. And we have a yaml file for the services.</p>
<p>[aws ebs])<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#aws-ebs">https://kubernetes.io/docs/concepts/storage/storage-classes/#aws-ebs</a>)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@i ~]$ cat storage-aws.yaml</span><br><span class="line"># What do want?</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: mongo-pvc</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: cloud-ssd</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 7Gi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># How do we want it implemented</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: cloud-ssd</span><br><span class="line">provisioner: kubernetes.io/aws-ebs</span><br><span class="line">parameters:</span><br><span class="line">  type: gp2</span><br><span class="line"></span><br><span class="line">[ec2-user@ip-1 ~]$ kubectl get pvc</span><br><span class="line">NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">mongo-pvc   Bound    pvc-b2ed286e-88f3-11e9-b509-02985f983814   7Gi        RWO            cloud-ssd      3m45s</span><br><span class="line"></span><br><span class="line">[ec2-user@ip-1 ~]$ kubectl get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-b2ed286e-88f3-11e9-b509-02985f983814   7Gi        RWO            Delete           Bound    default/mongo-pvc   cloud-ssd               18s</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.imgur.com/91K0spE.png" alt="ebs volume created"></p>
<h2 id="Deploying-the-Fleetman-Workload"><a href="#Deploying-the-Fleetman-Workload" class="headerlink" title="Deploying the Fleetman Workload"></a>Deploying the Fleetman Workload</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-1-9 ~]$ cat services.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-webapp</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: webapp</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 80</span><br><span class="line"> type: LoadBalancer</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-queue</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: queue</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 8161</span><br><span class="line"></span><br><span class="line">   - name: endpoint</span><br><span class="line">     port: 61616</span><br><span class="line"></span><br><span class="line"> type: ClusterIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-position-tracker</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: position-tracker</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 8080</span><br><span class="line"></span><br><span class="line"> type: ClusterIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"> name: fleetman-api-gateway</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line"> # This defines which pods are going to be represented by this Service</span><br><span class="line"> # The service becomes a network endpoint for either other services</span><br><span class="line"> #  or maybe external users to connect to (eg browser)</span><br><span class="line"> selector:</span><br><span class="line">   app: api-gateway</span><br><span class="line"></span><br><span class="line"> ports:</span><br><span class="line">   - name: http</span><br><span class="line">     port: 8080</span><br><span class="line"></span><br><span class="line"> type: ClusterIP</span><br><span class="line"></span><br><span class="line">[ec2-user@ip-1-4-9 ~]$ cat workloads.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: queue</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: queue</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: queue</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: queue</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-queue:release2</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: position-simulator</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: position-simulator</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: position-simulator</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: position-simulator</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-position-simulator:release2</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: position-tracker</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: position-tracker</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: position-tracker</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: position-tracker</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-position-tracker:release3</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: api-gateway</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: api-gateway</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: api-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: api-gateway</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-api-gateway:release2</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: webapp</span><br><span class="line">  replicas: 1</span><br><span class="line">  template: # template for the pods</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: webapp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webapp</span><br><span class="line">        image: richardchesterwood/k8s-fleetman-webapp-angular:release2</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: production-microservice</span><br><span class="line">[ec2-user@-4-9 ~]$ kubectl apply -f .</span><br><span class="line">deployment.apps/mongodb unchanged</span><br><span class="line">service/fleetman-mongodb unchanged</span><br><span class="line">service/fleetman-webapp unchanged</span><br><span class="line">service/fleetman-queue unchanged</span><br><span class="line">service/fleetman-position-tracker unchanged</span><br><span class="line">service/fleetman-api-gateway unchanged</span><br><span class="line">persistentvolumeclaim/mongo-pvc unchanged</span><br><span class="line">storageclass.storage.k8s.io/cloud-ssd unchanged</span><br><span class="line">deployment.apps/queue configured</span><br><span class="line">deployment.apps/position-simulator configured</span><br><span class="line">deployment.apps/position-tracker unchanged</span><br><span class="line">deployment.apps/api-gateway configured</span><br><span class="line">deployment.apps/webapp configured</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get all</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/api-gateway-5d445d6f69-5gmm4          1/1     Running   0          82s</span><br><span class="line">pod/mongodb-5559556bf-jjkpw               1/1     Running   0          20m</span><br><span class="line">pod/position-simulator-7ffd4f8f68-2gnjr   1/1     Running   0          82s</span><br><span class="line">pod/position-tracker-5ff4fb7479-jjj9f     1/1     Running   0          11m</span><br><span class="line">pod/queue-75f4ddd795-6vn9d                1/1     Running   0          82s</span><br><span class="line">pod/webapp-689dd9b4f4-ntdpz               1/1     Running   0          82s</span><br><span class="line"></span><br><span class="line">NAME                                TYPE           CLUSTER-IP       EXTERNAL-IP                                                                    PORT(S)              AGE</span><br><span class="line">service/fleetman-api-gateway        ClusterIP      100.65.245.184   &lt;none&gt;                                                                         8080/TCP             11m</span><br><span class="line">service/fleetman-mongodb            ClusterIP      100.70.242.251   &lt;none&gt;                                                                         27017/TCP            20m</span><br><span class="line">service/fleetman-position-tracker   ClusterIP      100.70.48.51     &lt;none&gt;                                                                         8080/TCP             11m</span><br><span class="line">service/fleetman-queue              ClusterIP      100.65.176.119   &lt;none&gt;                                                                         8161/TCP,61616/TCP   11m</span><br><span class="line">service/fleetman-webapp             LoadBalancer   100.70.56.219    a660e0c5e88f611e9b50902985f98381-1044209190.ap-southeast-2.elb.amazonaws.com   80:30149/TCP         11m</span><br><span class="line">service/kubernetes                  ClusterIP      100.64.0.1       &lt;none&gt;                                                                         443/TCP              68m</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/api-gateway          1         1         1            1           11m</span><br><span class="line">deployment.apps/mongodb              1         1         1            1           20m</span><br><span class="line">deployment.apps/position-simulator   1         1         1            1           11m</span><br><span class="line">deployment.apps/position-tracker     1         1         1            1           11m</span><br><span class="line">deployment.apps/queue                1         1         1            1           11m</span><br><span class="line">deployment.apps/webapp               1         1         1            1           11m</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/api-gateway-5d445d6f69          1         1         1       82s</span><br><span class="line">replicaset.apps/api-gateway-6d7dccc464          0         0         0       11m</span><br><span class="line">replicaset.apps/mongodb-5559556bf               1         1         1       20m</span><br><span class="line">replicaset.apps/position-simulator-549554f4d9   0         0         0       11m</span><br><span class="line">replicaset.apps/position-simulator-7ffd4f8f68   1         1         1       82s</span><br><span class="line">replicaset.apps/position-tracker-5ff4fb7479     1         1         1       11m</span><br><span class="line">replicaset.apps/queue-75f4ddd795                1         1         1       82s</span><br><span class="line">replicaset.apps/queue-b46577b46                 0         0         0       11m</span><br><span class="line">replicaset.apps/webapp-689dd9b4f4               1         1         1       82s</span><br><span class="line">replicaset.apps/webapp-6cdd565c5                0         0         0       11m</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl log -f pod/position-tracker-5ff4fb7479-jjj9f</span><br><span class="line">log is DEPRECATED and will be removed in a future version. Use logs instead.</span><br><span class="line">2019-06-07 07:42:40.878 ERROR 1 --- [enerContainer-1] o.s.j.l.DefaultMessageListenerContainer  : Could not refresh JMS Connection for destination &apos;positionQueue&apos; - retrying using FixedBackOff&#123;interval=5000, currentAttempts=15, maxAttempts=unlimited&#125;. Cause: Could not connect to broker URL: tcp://fleetman-queue.default.svc.cluster.local:61616. Reason: java.net.SocketException: Socket closed</span><br><span class="line">2019-06-07 07:42:46.002  INFO 1 --- [enerContainer-1] o.s.j.l.DefaultMessageListenerContainer  : Successfully refreshed JMS Connection</span><br><span class="line">2019-06-07 07:42:47.440  INFO 1 --- [nio-8080-exec-8] org.mongodb.driver.connection            : Opened connection [connectionId&#123;localValue:3, serverValue:3&#125;] to fleetman-mongodb.default.svc.cluster.local:27017</span><br><span class="line">illljffkkkkerror: unexpected EOF</span><br></pre></td></tr></table></figure>
<p>Docker swarm uses a concept called a rooting, or routing, mesh to find the node that your web application is running on. None of that is used here, it uses a standard AWS load balancer to find the correct node.</p>
<h2 id="Setting-up-a-real-Domain-Name"><a href="#Setting-up-a-real-Domain-Name" class="headerlink" title="Setting up a real Domain Name"></a>Setting up a real Domain Name</h2><p>Add a CNAME record in your own domain to ELB address.</p>
<h2 id="Surviving-Node-Failure"><a href="#Surviving-Node-Failure" class="headerlink" title="Surviving Node Failure"></a>Surviving Node Failure</h2><h3 id="Requirement"><a href="#Requirement" class="headerlink" title="Requirement"></a>Requirement</h3><hr>
<p>Even in the vent of a Node (or Availability Zone) failure, the web site must be accessible</p>
<p>It doesn’t matter if reports from vehicles stop coming in, as long as service is restored within a few minutes</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@foobar ~]$ kubectl get pods</span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">api-gateway-5d445d6f69-5gmm4          1/1     Running   0          93m</span><br><span class="line">mongodb-5559556bf-jjkpw               1/1     Running   0          112m</span><br><span class="line">position-simulator-7ffd4f8f68-2gnjr   1/1     Running   0          93m</span><br><span class="line">position-tracker-5ff4fb7479-jjj9f     1/1     Running   0          103m</span><br><span class="line">queue-75f4ddd795-6vn9d                1/1     Running   0          93m</span><br><span class="line">webapp-689dd9b4f4-ntdpz               1/1     Running   0          93m</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get pods -o wide</span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE    IP           NODE                                                NOMINATED NODE</span><br><span class="line">api-gateway-5d445d6f69-5gmm4          1/1     Running   0          93m    100.96.3.5   ip-172-20-39-212.ap-southeast-2.compute.internal    &lt;none&gt;</span><br><span class="line">mongodb-5559556bf-jjkpw               1/1     Running   0          112m   100.96.1.4   ip-172-20-89-8.ap-southeast-2.compute.internal      &lt;none&gt;</span><br><span class="line">position-simulator-7ffd4f8f68-2gnjr   1/1     Running   0          93m    100.96.2.5   ip-172-20-115-253.ap-southeast-2.compute.internal   &lt;none&gt;</span><br><span class="line">position-tracker-5ff4fb7479-jjj9f     1/1     Running   0          103m   100.96.3.4   ip-172-20-39-212.ap-southeast-2.compute.internal    &lt;none&gt;</span><br><span class="line">queue-75f4ddd795-6vn9d                1/1     Running   0          93m    100.96.1.5   ip-172-20-89-8.ap-southeast-2.compute.internal      &lt;none&gt;</span><br><span class="line">webapp-689dd9b4f4-ntdpz               1/1     Running   0          93m    100.96.2.6   ip-172-20-115-253.ap-southeast-2.compute.internal   &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Replicating-Pods"><a href="#Replicating-Pods" class="headerlink" title="Replicating Pods"></a>Replicating Pods</h2><p>For our example, take the queue pod, give it two replicas and therefore, in the event of a node failure, one of the nodes will always survive. Unfortunately you can’t do that because this particular pod, the queue pod is stateful. In other words, it contains data. And because it contains data, if you replicate it, you’re going to end up with a kind of a split brain situation, where half the data is in one part, half the data is in the other part. And all kinds of chaos will follow on from that. Really what you’re aiming for with any pod is to make it stateless, so it’s not holding data.</p>
<h2 id="Deleting-the-Cluster"><a href="#Deleting-the-Cluster" class="headerlink" title="Deleting the Cluster"></a>Deleting the Cluster</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@foobar ~]$ export NAME=fleetman.k8s.local</span><br><span class="line">[ec2-user@foobar ~]$ kops delete cluster --name $&#123;NAME&#125; --yes</span><br><span class="line"></span><br><span class="line">State Store: Required value: Please set the --state flag or export KOPS_STATE_STORE.</span><br><span class="line">For example, a valid value follows the format s3://&lt;bucket&gt;.</span><br><span class="line">You can find the supported stores in https://github.com/kubernetes/kops/blob/master/docs/state.md.</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ export KOPS_STATE_STORE=s3://stanzhou-state-storage</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kops delete cluster --name $&#123;NAME&#125; --yes</span><br><span class="line">TYPE                    NAME                                                                            ID</span><br><span class="line">autoscaling-config      master-ap-southeast-2a.masters.fleetman.k8s.local-20190607062844                master-ap-southeast-2a.masters.fleetman.k8s.local-20190607062844</span><br><span class="line">autoscaling-config      nodes.fleetman.k8s.local-20190607062844                                         nodes.fleetman.k8s.local-20190607062844</span><br><span class="line">autoscaling-group       master-ap-southeast-2a.masters.fleetman.k8s.local                               master-ap-southeast-2a.masters.fleetman.k8s.local</span><br><span class="line">autoscaling-group       nodes.fleetman.k8s.local                                                        nodes.fleetman.k8s.local</span><br><span class="line">dhcp-options            fleetman.k8s.local                                                              dopt-0a0be88814a0c83a9</span><br><span class="line">iam-instance-profile    masters.fleetman.k8s.local                                                      masters.fleetman.k8s.local</span><br><span class="line">iam-instance-profile    nodes.fleetman.k8s.local                                                        nodes.fleetman.k8s.local</span><br><span class="line">iam-role                masters.fleetman.k8s.local                                                      masters.fleetman.k8s.local</span><br><span class="line">iam-role                nodes.fleetman.k8s.local                                                        nodes.fleetman.k8s.local</span><br><span class="line">instance                master-ap-southeast-2a.masters.fleetman.k8s.local                               i-012c7c446b65343d4</span><br><span class="line">instance                nodes.fleetman.k8s.local                                                        i-07583ee103342be9a</span><br><span class="line">instance                nodes.fleetman.k8s.local                                                        i-079cea61e4a7736b9</span><br><span class="line">instance                nodes.fleetman.k8s.local                                                        i-0bf949dbd290d81c3</span><br><span class="line">internet-gateway        fleetman.k8s.local                                                              igw-0a939d66d6e93e0d5</span><br><span class="line">keypair                 kubernetes.fleetman.k8s.local-fc:11:5b:a8:1d:16:4a:36:36:15:2d:9f:f3:69:d2:0a   kubernetes.fleetman.k8s.local-fc:11:5b:a8:1d:16:4a:36:36:15:2d:9f:f3:69:d2:0a</span><br><span class="line">load-balancer                                                                                           a660e0c5e88f611e9b50902985f98381</span><br><span class="line">load-balancer           api.fleetman.k8s.local                                                          api-fleetman-k8s-local-tkmafs</span><br><span class="line">route-table             fleetman.k8s.local                                                              rtb-06b591f24a01973f6</span><br><span class="line">security-group                                                                                          sg-07b79756088cf753c</span><br><span class="line">security-group          api-elb.fleetman.k8s.local                                                      sg-005c9b49b63793004</span><br><span class="line">security-group          masters.fleetman.k8s.local                                                      sg-07ef00367ce1a7b62</span><br><span class="line">security-group          nodes.fleetman.k8s.local                                                        sg-01f81918cdbaba212</span><br><span class="line">subnet                  ap-southeast-2a.fleetman.k8s.local                                              subnet-060ec2db19027cf6a</span><br><span class="line">subnet                  ap-southeast-2b.fleetman.k8s.local                                              subnet-0def003bdbfd97915</span><br><span class="line">subnet                  ap-southeast-2c.fleetman.k8s.local                                              subnet-0016862a30fe5f443</span><br><span class="line">volume                  a.etcd-events.fleetman.k8s.local                                                vol-0d21c97044fcc06dd</span><br><span class="line">volume                  a.etcd-main.fleetman.k8s.local                                                  vol-0f1c9f3e983c5848a</span><br><span class="line">volume                  fleetman.k8s.local-dynamic-pvc-b2ed286e-88f3-11e9-b509-02985f983814             vol-074914e494e4b656d</span><br><span class="line">vpc                     fleetman.k8s.local                                                              vpc-0775d4b463932d2f7</span><br><span class="line"></span><br><span class="line">load-balancer:api-fleetman-k8s-local-tkmafs     ok</span><br><span class="line">load-balancer:a660e0c5e88f611e9b50902985f98381  ok</span><br><span class="line">autoscaling-group:nodes.fleetman.k8s.local      ok</span><br><span class="line">keypair:kubernetes.fleetman.k8s.local-fc:11:5b:a8:1d:16:4a:36:36:15:2d:9f:f3:69:d2:0a   ok</span><br><span class="line">internet-gateway:igw-0a939d66d6e93e0d5  still has dependencies, will retry</span><br><span class="line">autoscaling-group:master-ap-southeast-2a.masters.fleetman.k8s.local     ok</span><br><span class="line">instance:i-012c7c446b65343d4    ok</span><br><span class="line">instance:i-07583ee103342be9a    ok</span><br><span class="line">instance:i-0bf949dbd290d81c3    ok</span><br><span class="line">instance:i-079cea61e4a7736b9    ok</span><br><span class="line">iam-instance-profile:nodes.fleetman.k8s.local   ok</span><br><span class="line">iam-instance-profile:masters.fleetman.k8s.local ok</span><br><span class="line">iam-role:nodes.fleetman.k8s.local       ok</span><br><span class="line">iam-role:masters.fleetman.k8s.local     ok</span><br><span class="line">subnet:subnet-0def003bdbfd97915 still has dependencies, will retry</span><br><span class="line">subnet:subnet-0016862a30fe5f443 still has dependencies, will retry</span><br><span class="line">autoscaling-config:nodes.fleetman.k8s.local-20190607062844      ok</span><br><span class="line">volume:vol-0d21c97044fcc06dd    still has dependencies, will retry</span><br><span class="line">autoscaling-config:master-ap-southeast-2a.masters.fleetman.k8s.local-20190607062844     ok</span><br><span class="line">volume:vol-0f1c9f3e983c5848a    still has dependencies, will retry</span><br><span class="line">subnet:subnet-060ec2db19027cf6a still has dependencies, will retry</span><br><span class="line">volume:vol-074914e494e4b656d    still has dependencies, will retry</span><br><span class="line">security-group:sg-005c9b49b63793004     still has dependencies, will retry</span><br><span class="line">security-group:sg-01f81918cdbaba212     still has dependencies, will retry</span><br><span class="line">security-group:sg-07b79756088cf753c     still has dependencies, will retry</span><br><span class="line">security-group:sg-07ef00367ce1a7b62     still has dependencies, will retry</span><br><span class="line">Not all resources deleted; waiting before reattempting deletion</span><br><span class="line">        route-table:rtb-06b591f24a01973f6</span><br><span class="line">        internet-gateway:igw-0a939d66d6e93e0d5</span><br><span class="line">        security-group:sg-005c9b49b63793004</span><br><span class="line">        subnet:subnet-060ec2db19027cf6a</span><br><span class="line">        security-group:sg-07b79756088cf753c</span><br><span class="line">        subnet:subnet-0016862a30fe5f443</span><br><span class="line">        subnet:subnet-0def003bdbfd97915</span><br><span class="line">        security-group:sg-07ef00367ce1a7b62</span><br><span class="line">        volume:vol-0d21c97044fcc06dd</span><br><span class="line">        dhcp-options:dopt-0a0be88814a0c83a9</span><br><span class="line">        volume:vol-074914e494e4b656d</span><br><span class="line">        security-group:sg-01f81918cdbaba212</span><br><span class="line">        volume:vol-0f1c9f3e983c5848a</span><br><span class="line">        vpc:vpc-0775d4b463932d2f7</span><br><span class="line">subnet:subnet-060ec2db19027cf6a still has dependencies, will retry</span><br><span class="line">subnet:subnet-0def003bdbfd97915 still has dependencies, will retry</span><br><span class="line">subnet:subnet-0016862a30fe5f443 still has dependencies, will retry</span><br><span class="line">volume:vol-074914e494e4b656d    still has dependencies, will retry</span><br><span class="line">volume:vol-0f1c9f3e983c5848a    still has dependencies, will retry</span><br><span class="line">internet-gateway:igw-0a939d66d6e93e0d5  still has dependencies, will retry</span><br><span class="line">volume:vol-0d21c97044fcc06dd    still has dependencies, will retry</span><br><span class="line">security-group:sg-01f81918cdbaba212     still has dependencies, will retry</span><br><span class="line">security-group:sg-005c9b49b63793004     still has dependencies, will retry</span><br><span class="line">security-group:sg-07ef00367ce1a7b62     still has dependencies, will retry</span><br><span class="line">security-group:sg-07b79756088cf753c     still has dependencies, will retry</span><br><span class="line">Not all resources deleted; waiting before reattempting deletion</span><br><span class="line">        volume:vol-074914e494e4b656d</span><br><span class="line">        security-group:sg-01f81918cdbaba212</span><br><span class="line">        volume:vol-0f1c9f3e983c5848a</span><br><span class="line">        vpc:vpc-0775d4b463932d2f7</span><br><span class="line">        route-table:rtb-06b591f24a01973f6</span><br><span class="line">        internet-gateway:igw-0a939d66d6e93e0d5</span><br><span class="line">        security-group:sg-005c9b49b63793004</span><br><span class="line">        subnet:subnet-060ec2db19027cf6a</span><br><span class="line">        subnet:subnet-0016862a30fe5f443</span><br><span class="line">        security-group:sg-07b79756088cf753c</span><br><span class="line">        volume:vol-0d21c97044fcc06dd</span><br><span class="line">        subnet:subnet-0def003bdbfd97915</span><br><span class="line">        security-group:sg-07ef00367ce1a7b62</span><br><span class="line">        dhcp-options:dopt-0a0be88814a0c83a9</span><br><span class="line">subnet:subnet-060ec2db19027cf6a still has dependencies, will retry</span><br><span class="line">subnet:subnet-0def003bdbfd97915 still has dependencies, will retry</span><br><span class="line">volume:vol-0f1c9f3e983c5848a    still has dependencies, will retry</span><br><span class="line">volume:vol-0d21c97044fcc06dd    still has dependencies, will retry</span><br><span class="line">internet-gateway:igw-0a939d66d6e93e0d5  still has dependencies, will retry</span><br><span class="line">volume:vol-074914e494e4b656d    still has dependencies, will retry</span><br><span class="line">subnet:subnet-0016862a30fe5f443 still has dependencies, will retry</span><br><span class="line">security-group:sg-07b79756088cf753c     still has dependencies, will retry</span><br><span class="line">security-group:sg-01f81918cdbaba212     still has dependencies, will retry</span><br><span class="line">security-group:sg-07ef00367ce1a7b62     still has dependencies, will retry</span><br><span class="line">security-group:sg-005c9b49b63793004     still has dependencies, will retry</span><br><span class="line">Not all resources deleted; waiting before reattempting deletion</span><br><span class="line">        route-table:rtb-06b591f24a01973f6</span><br><span class="line">        internet-gateway:igw-0a939d66d6e93e0d5</span><br><span class="line">        security-group:sg-005c9b49b63793004</span><br><span class="line">        subnet:subnet-060ec2db19027cf6a</span><br><span class="line">        subnet:subnet-0016862a30fe5f443</span><br><span class="line">        security-group:sg-07b79756088cf753c</span><br><span class="line">        volume:vol-0d21c97044fcc06dd</span><br><span class="line">        subnet:subnet-0def003bdbfd97915</span><br><span class="line">        security-group:sg-07ef00367ce1a7b62</span><br><span class="line">        dhcp-options:dopt-0a0be88814a0c83a9</span><br><span class="line">        volume:vol-074914e494e4b656d</span><br><span class="line">        security-group:sg-01f81918cdbaba212</span><br><span class="line">        volume:vol-0f1c9f3e983c5848a</span><br><span class="line">        vpc:vpc-0775d4b463932d2f7</span><br><span class="line">subnet:subnet-0def003bdbfd97915 still has dependencies, will retry</span><br><span class="line">subnet:subnet-060ec2db19027cf6a still has dependencies, will retry</span><br><span class="line">internet-gateway:igw-0a939d66d6e93e0d5  still has dependencies, will retry</span><br><span class="line">volume:vol-074914e494e4b656d    still has dependencies, will retry</span><br><span class="line">volume:vol-0d21c97044fcc06dd    ok</span><br><span class="line">volume:vol-0f1c9f3e983c5848a    ok</span><br><span class="line">security-group:sg-01f81918cdbaba212     still has dependencies, will retry</span><br><span class="line">subnet:subnet-0016862a30fe5f443 ok</span><br><span class="line">security-group:sg-07b79756088cf753c     still has dependencies, will retry</span><br><span class="line">security-group:sg-07ef00367ce1a7b62     still has dependencies, will retry</span><br><span class="line">security-group:sg-005c9b49b63793004     still has dependencies, will retry</span><br><span class="line">Not all resources deleted; waiting before reattempting deletion</span><br><span class="line">        dhcp-options:dopt-0a0be88814a0c83a9</span><br><span class="line">        volume:vol-074914e494e4b656d</span><br><span class="line">        security-group:sg-01f81918cdbaba212</span><br><span class="line">        vpc:vpc-0775d4b463932d2f7</span><br><span class="line">        route-table:rtb-06b591f24a01973f6</span><br><span class="line">        internet-gateway:igw-0a939d66d6e93e0d5</span><br><span class="line">        security-group:sg-005c9b49b63793004</span><br><span class="line">        subnet:subnet-060ec2db19027cf6a</span><br><span class="line">        security-group:sg-07b79756088cf753c</span><br><span class="line">        subnet:subnet-0def003bdbfd97915</span><br><span class="line">        security-group:sg-07ef00367ce1a7b62</span><br><span class="line">internet-gateway:igw-0a939d66d6e93e0d5  still has dependencies, will retry</span><br><span class="line">volume:vol-074914e494e4b656d    ok</span><br><span class="line">subnet:subnet-060ec2db19027cf6a still has dependencies, will retry</span><br><span class="line">security-group:sg-01f81918cdbaba212     still has dependencies, will retry</span><br><span class="line">security-group:sg-005c9b49b63793004     still has dependencies, will retry</span><br><span class="line">security-group:sg-07b79756088cf753c     still has dependencies, will retry</span><br><span class="line">subnet:subnet-0def003bdbfd97915 ok</span><br><span class="line">security-group:sg-07ef00367ce1a7b62     ok</span><br><span class="line">Not all resources deleted; waiting before reattempting deletion</span><br><span class="line">        security-group:sg-01f81918cdbaba212</span><br><span class="line">        vpc:vpc-0775d4b463932d2f7</span><br><span class="line">        route-table:rtb-06b591f24a01973f6</span><br><span class="line">        internet-gateway:igw-0a939d66d6e93e0d5</span><br><span class="line">        security-group:sg-005c9b49b63793004</span><br><span class="line">        subnet:subnet-060ec2db19027cf6a</span><br><span class="line">        security-group:sg-07b79756088cf753c</span><br><span class="line">        dhcp-options:dopt-0a0be88814a0c83a9</span><br><span class="line">subnet:subnet-060ec2db19027cf6a still has dependencies, will retry</span><br><span class="line">security-group:sg-005c9b49b63793004     still has dependencies, will retry</span><br><span class="line">security-group:sg-07b79756088cf753c     still has dependencies, will retry</span><br><span class="line">internet-gateway:igw-0a939d66d6e93e0d5  ok</span><br><span class="line">security-group:sg-01f81918cdbaba212     ok</span><br><span class="line">Not all resources deleted; waiting before reattempting deletion</span><br><span class="line">        dhcp-options:dopt-0a0be88814a0c83a9</span><br><span class="line">        vpc:vpc-0775d4b463932d2f7</span><br><span class="line">        route-table:rtb-06b591f24a01973f6</span><br><span class="line">        security-group:sg-005c9b49b63793004</span><br><span class="line">        subnet:subnet-060ec2db19027cf6a</span><br><span class="line">        security-group:sg-07b79756088cf753c</span><br><span class="line">subnet:subnet-060ec2db19027cf6a ok</span><br><span class="line">security-group:sg-005c9b49b63793004     ok</span><br><span class="line">security-group:sg-07b79756088cf753c     ok</span><br><span class="line">route-table:rtb-06b591f24a01973f6       ok</span><br><span class="line">vpc:vpc-0775d4b463932d2f7       ok</span><br><span class="line">dhcp-options:dopt-0a0be88814a0c83a9     ok</span><br><span class="line">Deleted kubectl config for fleetman.k8s.local</span><br><span class="line"></span><br><span class="line">Deleted cluster: &quot;fleetman.k8s.local&quot;</span><br></pre></td></tr></table></figure>
<h3 id="Restarting-the-Cluster"><a href="#Restarting-the-Cluster" class="headerlink" title="Restarting the Cluster"></a>Restarting the Cluster</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@foobar ~]$ history|grep export</span><br><span class="line">    4  export NAME=fleetman.k8s.local</span><br><span class="line">    6  export KOPS_STATE_STORE=s3://stanzhou-state-storage</span><br><span class="line"></span><br><span class="line">kops create cluster --zones ap-southeast-2a,ap-southeast-2b,ap-southeast-2c $&#123;NAME&#125;</span><br><span class="line"></span><br><span class="line">kops edit ig --name=fleetman.k8s.local nodes</span><br><span class="line">kops update cluster $&#123;NAME&#125; --yes</span><br><span class="line">kops validate cluster</span><br><span class="line">kubectl apply -f .</span><br><span class="line">kubectl get svc</span><br><span class="line">kubectl describe svc fleetman-webapp</span><br></pre></td></tr></table></figure>
<h1 id="Logging-a-Cluster"><a href="#Logging-a-Cluster" class="headerlink" title="Logging a Cluster"></a>Logging a Cluster</h1><h2 id="Introducing-the-ELK-ElasticStack"><a href="#Introducing-the-ELK-ElasticStack" class="headerlink" title="Introducing the ELK/ElasticStack"></a>Introducing the ELK/ElasticStack</h2><p><img src="https://i.imgur.com/YRocsbG.png" alt="ELK Stack"><br><img src="https://i.imgur.com/VZihLCY.png" alt="ELK Stack2"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get po</span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">api-gateway-5d445d6f69-kg68n          1/1     Running   0          19h</span><br><span class="line">mongodb-5559556bf-ghq5p               1/1     Running   0          19h</span><br><span class="line">position-simulator-7ffd4f8f68-kwlcb   1/1     Running   0          19h</span><br><span class="line">position-tracker-5ff4fb7479-2ctzt     1/1     Running   0          19h</span><br><span class="line">queue-75f4ddd795-wp2mh                1/1     Running   0          10h</span><br><span class="line">webapp-689dd9b4f4-php92               1/1     Running   0          19h</span><br><span class="line">webapp-689dd9b4f4-vgtpg               1/1     Running   0          19h</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get svc</span><br><span class="line">NAME                        TYPE           CLUSTER-IP       EXTERNAL-IP                                                                    PORT(S)              AGE</span><br><span class="line">fleetman-api-gateway        ClusterIP      100.67.195.111   &lt;none&gt;                                                                         8080/TCP             20h</span><br><span class="line">fleetman-mongodb            ClusterIP      100.68.143.136   &lt;none&gt;                                                                         27017/TCP            20h</span><br><span class="line">fleetman-position-tracker   ClusterIP      100.69.119.23    &lt;none&gt;                                                                         8080/TCP             20h</span><br><span class="line">fleetman-queue              ClusterIP      100.65.16.172    &lt;none&gt;                                                                         8161/TCP,61616/TCP   20h</span><br><span class="line">fleetman-webapp             LoadBalancer   100.70.168.148   ac185d1638c0311e9bef7028ed3b83c9-1696162465.ap-southeast-2.elb.amazonaws.com   80:31504/TCP         20h</span><br><span class="line">kubernetes                  ClusterIP      100.64.0.1       &lt;none&gt;                                                                         443/TCP              20h</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get svc -n kube-system</span><br><span class="line">NAME                    TYPE           CLUSTER-IP       EXTERNAL-IP                                                                   PORT(S)          AGE</span><br><span class="line">elasticsearch-logging   ClusterIP      100.68.193.244   &lt;none&gt;                                                                        9200/TCP         19h</span><br><span class="line">kibana-logging          LoadBalancer   100.67.153.183   a3c20f00a8c0811e9bef7028ed3b83c9-306741856.ap-southeast-2.elb.amazonaws.com   5601:32716/TCP   19h</span><br><span class="line">kube-dns                ClusterIP      100.64.0.10      &lt;none&gt;                                                                        53/UDP,53/TCP    20h</span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl describe svc kibana-logging -n kube-system</span><br><span class="line">Name:                     kibana-logging</span><br><span class="line">Namespace:                kube-system</span><br><span class="line">Labels:                   addonmanager.kubernetes.io/mode=Reconcile</span><br><span class="line">                          k8s-app=kibana-logging</span><br><span class="line">                          kubernetes.io/cluster-service=true</span><br><span class="line">                          kubernetes.io/name=Kibana</span><br><span class="line">Annotations:              kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                            &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Service&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;addonmanager.kubernetes.io/mode&quot;:&quot;Reconcile&quot;,&quot;k8s-app&quot;:&quot;kibana...</span><br><span class="line">Selector:                 k8s-app=kibana-logging</span><br><span class="line">Type:                     LoadBalancer</span><br><span class="line">IP:                       100.67.153.183</span><br><span class="line">LoadBalancer Ingress:     a3c20f00a8c0811e9bef7028ed3b83c9-306741856.ap-southeast-2.elb.amazonaws.com</span><br><span class="line">Port:                     &lt;unset&gt;  5601/TCP</span><br><span class="line">TargetPort:               ui/TCP</span><br><span class="line">NodePort:                 &lt;unset&gt;  32716/TCP</span><br><span class="line">Endpoints:                100.96.1.5:5601</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h1 id="MONITORING-WITH-PROMETHEUS-AND-GRAFANA"><a href="#MONITORING-WITH-PROMETHEUS-AND-GRAFANA" class="headerlink" title="MONITORING WITH PROMETHEUS AND GRAFANA"></a>MONITORING WITH PROMETHEUS AND GRAFANA</h1><h2 id="Monitoring-a-Cluster"><a href="#Monitoring-a-Cluster" class="headerlink" title="Monitoring a Cluster"></a>Monitoring a Cluster</h2><p><a href="https://prometheus.io/">Prometheus</a><br><a href="https://grafana.com">Grafana</a><br>Concerntrate solely on integrating Grafana with Prometheus.</p>
<h2 id="Helm-Package-Manager"><a href="#Helm-Package-Manager" class="headerlink" title="Helm Package Manager"></a>Helm Package Manager</h2><p>The Kubernetes package manager <a href="https://helm.sh">Helm</a></p>
<p>Install Helm:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">wget https://get.helm.sh/helm-v2.14.1-linux-amd64.tar.gz</span><br><span class="line">tar zxvf helm-v2.14.1-linux-amd64.tar.gz</span><br><span class="line">sudo mv linux-amd64/helm /usr/local/bin/</span><br><span class="line">rm helm-v2.14.1-linux-amd64.tar.gz</span><br><span class="line">rm -rf ./linux-amd64/</span><br><span class="line">helm --help</span><br><span class="line">helm version</span><br><span class="line">helm init</span><br><span class="line"></span><br><span class="line">kubectl create serviceaccount --namespace kube-system tiller</span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span><br><span class="line"></span><br><span class="line">kubectl patch deploy --namespace kube-system tiller-deploy -p &apos;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;spec&quot;:&#123;&quot;serviceAccount&quot;:&quot;tiller&quot;&#125;&#125;&#125;&#125;&apos;</span><br></pre></td></tr></table></figure></p>
<p>Delete Helm:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm ls</span><br><span class="line">helm delete --purge my-special-installation</span><br><span class="line">kubectl get po</span><br></pre></td></tr></table></figure></p>
<h2 id="Installing-Prometheus-Operator"><a href="#Installing-Prometheus-Operator" class="headerlink" title="Installing Prometheus Operator"></a>Installing Prometheus Operator</h2><p><a href="https://github.com/helm/charts/tree/master/stable/prometheus-operator">install</a></p>
<p><code>helm install --name monitoring --namespace monitoring stable/prometheus-operator</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get all -n monitoring</span><br><span class="line">NAME                                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/alertmanager-monitoring-prometheus-oper-alertmanager-0   2/2     Running   0          4m</span><br><span class="line">pod/monitoring-grafana-c768bb86f-cgmj8                       2/2     Running   0          4m27s</span><br><span class="line">pod/monitoring-kube-state-metrics-6488587c6-zrjmg            1/1     Running   0          4m27s</span><br><span class="line">pod/monitoring-prometheus-node-exporter-5cp7v                1/1     Running   0          4m27s</span><br><span class="line">pod/monitoring-prometheus-node-exporter-75v99                1/1     Running   0          4m27s</span><br><span class="line">pod/monitoring-prometheus-node-exporter-jcl7r                1/1     Running   0          4m27s</span><br><span class="line">pod/monitoring-prometheus-node-exporter-vptns                1/1     Running   0          4m27s</span><br><span class="line">pod/monitoring-prometheus-oper-operator-7b54f56766-j8k6c     1/1     Running   0          4m27s</span><br><span class="line">pod/prometheus-monitoring-prometheus-oper-prometheus-0       3/3     Running   1          3m52s</span><br><span class="line"></span><br><span class="line">NAME                                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">service/alertmanager-operated                     ClusterIP   None             &lt;none&gt;        9093/TCP,6783/TCP   4m</span><br><span class="line">service/monitoring-grafana                        ClusterIP   100.70.116.236   &lt;none&gt;        80/TCP              4m28s</span><br><span class="line">service/monitoring-kube-state-metrics             ClusterIP   100.67.183.154   &lt;none&gt;        8080/TCP            4m28s</span><br><span class="line">service/monitoring-prometheus-node-exporter       ClusterIP   100.68.145.110   &lt;none&gt;        9100/TCP            4m28s</span><br><span class="line">service/monitoring-prometheus-oper-alertmanager   ClusterIP   100.70.75.68     &lt;none&gt;        9093/TCP            4m28s</span><br><span class="line">service/monitoring-prometheus-oper-operator       ClusterIP   100.66.237.147   &lt;none&gt;        8080/TCP            4m28s</span><br><span class="line">service/monitoring-prometheus-oper-prometheus     ClusterIP   100.67.205.22    &lt;none&gt;        9090/TCP            4m28s</span><br><span class="line">service/prometheus-operated                       ClusterIP   None             &lt;none&gt;        9090/TCP            3m53s</span><br><span class="line"></span><br><span class="line">NAME                                                 DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/monitoring-prometheus-node-exporter   4         4         4       4            4           &lt;none&gt;          4m27s</span><br><span class="line"></span><br><span class="line">NAME                                                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/monitoring-grafana                    1         1         1            1           4m27s</span><br><span class="line">deployment.apps/monitoring-kube-state-metrics         1         1         1            1           4m27s</span><br><span class="line">deployment.apps/monitoring-prometheus-oper-operator   1         1         1            1           4m27s</span><br><span class="line"></span><br><span class="line">NAME                                                             DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/monitoring-grafana-c768bb86f                     1         1         1       4m27s</span><br><span class="line">replicaset.apps/monitoring-kube-state-metrics-6488587c6          1         1         1       4m27s</span><br><span class="line">replicaset.apps/monitoring-prometheus-oper-operator-7b54f56766   1         1         1       4m27s</span><br><span class="line"></span><br><span class="line">NAME                                                                    DESIRED   CURRENT   AGE</span><br><span class="line">statefulset.apps/alertmanager-monitoring-prometheus-oper-alertmanager   1         1         4m</span><br><span class="line">statefulset.apps/prometheus-monitoring-prometheus-oper-prometheus       1         1         3m53s</span><br><span class="line"></span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl edit -n monitoring service/monitoring-prometheus-oper-prometheus</span><br><span class="line"></span><br><span class="line">Change type from ClusterIP to LoadBalancer</span><br><span class="line"></span><br><span class="line">[ec2-user@ip-172-31-4-9 ~]$ kubectl get all -n monitoring</span><br><span class="line">NAME                                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/alertmanager-monitoring-prometheus-oper-alertmanager-0   2/2     Running   0          16m</span><br><span class="line">pod/monitoring-grafana-c768bb86f-cgmj8                       2/2     Running   0          17m</span><br><span class="line">pod/monitoring-kube-state-metrics-6488587c6-zrjmg            1/1     Running   0          17m</span><br><span class="line">pod/monitoring-prometheus-node-exporter-5cp7v                1/1     Running   0          17m</span><br><span class="line">pod/monitoring-prometheus-node-exporter-75v99                1/1     Running   0          17m</span><br><span class="line">pod/monitoring-prometheus-node-exporter-jcl7r                1/1     Running   0          17m</span><br><span class="line">pod/monitoring-prometheus-node-exporter-vptns                1/1     Running   0          17m</span><br><span class="line">pod/monitoring-prometheus-oper-operator-7b54f56766-j8k6c     1/1     Running   0          17m</span><br><span class="line">pod/prometheus-monitoring-prometheus-oper-prometheus-0       3/3     Running   1          16m</span><br><span class="line"></span><br><span class="line">NAME                                              TYPE           CLUSTER-IP       EXTERNAL-IP                                                                    PORT(S)             AGE</span><br><span class="line">service/alertmanager-operated                     ClusterIP      None             &lt;none&gt;                                                                         9093/TCP,6783/TCP   16m</span><br><span class="line">service/monitoring-grafana                        ClusterIP      100.70.116.236   &lt;none&gt;                                                                         80/TCP              17m</span><br><span class="line">service/monitoring-kube-state-metrics             ClusterIP      100.67.183.154   &lt;none&gt;                                                                         8080/TCP            17m</span><br><span class="line">service/monitoring-prometheus-node-exporter       ClusterIP      100.68.145.110   &lt;none&gt;                                                                         9100/TCP            17m</span><br><span class="line">service/monitoring-prometheus-oper-alertmanager   ClusterIP      100.70.75.68     &lt;none&gt;                                                                         9093/TCP            17m</span><br><span class="line">service/monitoring-prometheus-oper-operator       ClusterIP      100.66.237.147   &lt;none&gt;                                                                         8080/TCP            17m</span><br><span class="line">service/monitoring-prometheus-oper-prometheus     LoadBalancer   100.67.205.22    a86903ccd8ce211e9bef7028ed3b83c9-1698452662.ap-southeast-2.elb.amazonaws.com   9090:32096/TCP      17m</span><br><span class="line">service/prometheus-operated                       ClusterIP      None             &lt;none&gt;                                                                         9090/TCP            16m</span><br><span class="line"></span><br><span class="line">NAME                                                 DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/monitoring-prometheus-node-exporter   4         4         4       4            4           &lt;none&gt;          17m</span><br><span class="line"></span><br><span class="line">NAME                                                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/monitoring-grafana                    1         1         1            1           17m</span><br><span class="line">deployment.apps/monitoring-kube-state-metrics         1         1         1            1           17m</span><br><span class="line">deployment.apps/monitoring-prometheus-oper-operator   1         1         1            1           17m</span><br><span class="line"></span><br><span class="line">NAME                                                             DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/monitoring-grafana-c768bb86f                     1         1         1       17m</span><br><span class="line">replicaset.apps/monitoring-kube-state-metrics-6488587c6          1         1         1       17m</span><br><span class="line">replicaset.apps/monitoring-prometheus-oper-operator-7b54f56766   1         1         1       17m</span><br><span class="line"></span><br><span class="line">NAME                                                                    DESIRED   CURRENT   AGE</span><br><span class="line">statefulset.apps/alertmanager-monitoring-prometheus-oper-alertmanager   1         1         16m</span><br><span class="line">statefulset.apps/prometheus-monitoring-prometheus-oper-prometheus       1         1         16m</span><br></pre></td></tr></table></figure>
<h2 id="Working-with-Grafana"><a href="#Working-with-Grafana" class="headerlink" title="Working with Grafana"></a>Working with Grafana</h2><p>change back from LoadBalancer to ClusterIP on service/monitoring-prometheus-oper-prometheus<br>change from ClusterIP to LoadBalancer on service/monitoring-grafana </p>
<h1 id="The-Alert-Manager"><a href="#The-Alert-Manager" class="headerlink" title="The Alert Manager"></a>The Alert Manager</h1><h2 id="Alerting"><a href="#Alerting" class="headerlink" title="Alerting"></a>Alerting</h2>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/kubernetes/">kubernetes</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/05/08/beginningDevOpsWithDocker/" title="Beginning DevOps with Docker" itemprop="url">Beginning DevOps with Docker</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stan Zhou" target="_blank" itemprop="author">Stan Zhou</a>
		
  <p class="article-time">
    <time datetime="2019-05-08T13:20:43.000Z" itemprop="datePublished"> Published 2019-05-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="https://docs.00root.com">see</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Devops/">Devops</a><a href="/tags/Docker/">Docker</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/2/"><span></span>Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github Card</p>
<div class="github-card" data-github="stanosaka" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Devops/" title="Devops">Devops<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/aws/" title="aws">aws<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/centos/" title="centos">centos<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Jenkins/" title="Jenkins">Jenkins<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/CD-CI/" title="CD/CI">CD/CI<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/docker/" title="docker">docker<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/linux/" title="linux">linux<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/git/" title="git">git<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/tomcat/" title="tomcat">tomcat<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/saltstack/" title="saltstack">saltstack<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/zabbix/" title="zabbix">zabbix<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/ec2/" title="ec2">ec2<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/backup/" title="backup">backup<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/github/" title="github">github<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/nginx/" title="nginx">nginx<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Pipeline/" title="Pipeline">Pipeline<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Blue-Ocean/" title="Blue Ocean">Blue Ocean<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/python/" title="python">python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SRE/" title="SRE">SRE<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://kupczynski.info/2018/04/18/spacemacs.html" target="_blank" title="Learning Spacemacs">Learning Spacemacs</a>
            
          </li>
        
          <li>
            
            	<a href="https://cloud.ibm.com/docs/tutorials?topic=solution-tutorials-tutorials" target="_blank" title="IBM cloud solution tutorial">IBM cloud solution tutorial</a>
            
          </li>
        
          <li>
            
            	<a href="https://github.com/aws-samples" target="_blank" title="AWS Samples">AWS Samples</a>
            
          </li>
        
          <li>
            
            	<a href="https://github.com/bikrambora/devlab-launchpad" target="_blank" title="Welcome to Dev Labs">Dev Labs</a>
            
          </li>
        
          <li>
            
            	<a href="https://github.com/ansible/ansible-examples" target="_blank" title="Ansible GitHub repo">Ansible GitHub repo</a>
            
          </li>
        
          <li>
            
            	<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html" target="_blank" title="Ansible Best Practices">Ansible Best Practices</a>
            
          </li>
        
          <li>
            
            	<a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/" target="_blank" title="kubectl cheat sheet">kubectl cheat sheet</a>
            
          </li>
        
          <li>
            
            	<a href="http://rogerdudler.github.io/git-guide" target="_blank" title="Git commands">Git commands</a>
            
          </li>
        
          <li>
            
            	<a href="https://docs.docker.com/engine/reference/builder/" target="_blank" title="Dockerfile reference">Dockerfile reference</a>
            
          </li>
        
          <li>
            
            	<a href="http://bit.ly/2mTQr8l" target="_blank" title="Linux Command line cheat sheet">Linux Command line cheat sheet</a>
            
          </li>
        
          <li>
            
            	<a href="http://bit.ly/2EPHxze" target="_blank" title="PowerShell Basic Cheat Sheet">PowerShell Basic Cheat Sheet</a>
            
          </li>
        
          <li>
            
            	<a href="http://sed.sourceforge.net/sed1line_zh-CN.html" target="_blank" title="sed cheatsheet">sed cheatsheet</a>
            
          </li>
        
          <li>
            
            	<a href="http://obsavus1p.bkt.clouddn.com/vim_cheat_sheet_for_programmers_print.png" target="_blank" title="vim cheatsheet">vim cheatsheet</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.gitbook.com/book/yeasy/docker_practice/details" target="_blank" title="Learn Docker">Learn Docker</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.unixhot.com/page/ops" target="_blank" title="运维知识体系">运维知识体系</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.tecmint.com/" target="_blank" title="tecmint">tecmint</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.lib.uts.edu.au" target="_blank" title="shoujin.wang@student.uts.edu.au">UTS Library</a>
            
          </li>
        
          <li>
            
            	<a href="https://7esl.com" target="_blank" title="ESL">ESL</a>
            
          </li>
        
          <li>
            
            	<a href="https://stanchou.wordpress.com" target="_blank" title="Stan&#39;s wordpress">Stan&#39;s wordpress</a>
            
          </li>
        
          <li>
            
            	<a href="https://docs.00root.com" target="_blank" title="Stan&#39;s gitbook">Stan&#39;s gitbook</a>
            
          </li>
        
          <li>
            
            	<a href="https://api.ipify.org" target="_blank" title="Your IP address">Your IP address</a>
            
          </li>
        
          <li>
            
            	<a href="https://github.com/stanosaka/oreilly_sql_fundamentals_for_data/blob/master/notes_and_slides/sql_fundamentals_notes.md" target="_blank" title="sql fundamentials">sql fundamentials</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.nerdfonts.com" target="_blank" title="Nred Fonts">Nred Fonts</a>
            
          </li>
        
          <li>
            
            	<a href="http://cb.vu/unixtoolbox.xhtml" target="_blank" title="UNIX TOOLBOX">UNIX TOOLBOX</a>
            
          </li>
        
          <li>
            
            	<a href="https://github.com/Ben-PH/spacemacs-cheatsheet" target="_blank" title="spacemacs-cheatsheet">spacemacs-cheatsheet</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Stan living in Sydney. <br/>
			I am a lifelong technology learner.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/stanosaka" target="_blank" class="icon-github" title="github"></a>
		
		
		<a href="http://stackoverflow.com/users/6724938" target="_blank" class="icon-stack-overflow" title="stackoverflow"></a>
		
		
		<a href="https://twitter.com/stanosaka" target="_blank" class="icon-twitter" title="twitter"></a>
		
		
		<a href="https://www.facebook.com/stan.osaka" target="_blank" class="icon-facebook" title="facebook"></a>
		
		
		<a href="https://www.linkedin.com/in/00root" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		<a href="https://www.douban.com/people/btw01v" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/stan-22-82" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
		<a href="mailto:devops@cwzhou.win" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="Stan Zhou">Stan Zhou</a>
		
		
		</p>
</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>


        
  	    <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
            <script>
               if (window.mermaid) {
                  mermaid.initialize({theme: 'forest'});
               }
            </script>
        












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
